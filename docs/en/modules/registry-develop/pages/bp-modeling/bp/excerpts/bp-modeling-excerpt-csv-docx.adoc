:toc-title: On this page:
:toc: auto
:toclevels: 5
:experimental:
:sectnums:
:sectnumlevels: 5
:sectanchors:
:sectlinks:
:partnums:
= Modeling business processes for generating extracts in csv and docx format
//= Моделювання бізнес-процесу з формування витягів у форматі csv та docx
//:toc:
//:toc-title: ЗМІСТ
//:experimental:
//:example-caption: Приклад
//:important-caption: ВАЖЛИВО
//:note-caption: ПРИМІТКА
//:tip-caption: ПІДКАЗКА
//:warning-caption: ПОПЕРЕДЖЕННЯ
//:caution-caption: УВАГА
//:figure-caption: Figure
//:table-caption: Table
//:appendix-caption: Appendix
//:toclevels: 5
//:sectnums:
//:sectnumlevels: 5
//:sectanchors:
//:sectlinks:
//:partnums:

The description of the business process modeling mechanism is given in the example of Register of certified laboratories, namely in creation of the "Laboratory report in csv format" excerpt. Modeling a business process for generating excerpts in the docx format is similar, except for the step where the file format is selected.
//Опис механізму моделювання бізнес-процесу наведений на прикладі Реєстру атестованих лабораторій, а саме формування витягу "Звіт по лабораторіям у форматі csv". Моделювання бізнес-процесу з витягом у форматі docx є аналогічним, за винятком кроку, де зазначається формат файлу.

[TIP]
Fulfil the required preconditions for creating a business process, follow the xref:bp-modeling/bp/bp-modeling-instruction.adoc#bp-modelling-preconditions[link] for instructions.
//Виконайте необхідні передумови для створення бізнес-процесу, інструкція за xref:bp-modeling/bp/bp-modeling-instruction.adoc#bp-modelling-preconditions[посиланням].

== Initial steps for creating a business process
//== Початкові кроки створення бізнес-процесу

. Create a new BPMN diagram.
//. Створіть нову BPMN-діаграму.
+
image:registry-develop:bp-modeling/bp/modeling-instruction/bp-1.png[]
. Add the Create pool/Participant element.
//. Додайте елемент Create pool/Participant.
+
In the right-hand side window with parameters, you have to enter the appropriate values into the fields:
//У правому вікні з параметрами необхідно заповнити поля відповідними значеннями:

* In the `Participant Name` field, enter the pool name -- `Generate a report on laboratories in csv format`.
//* в полі `Participant Name` введіть назву пулу `Формування звіту по лабораторіям в форматі csv`;
* In the `Process id` field, enter the ID of the business process -- `zvit-csv-bp`.
//* в полі `Process id` введіть ідентифікатор бізнес-процесу `zvit-csv-bp`;
* In the `Process name` field, enter the business name of the process -- `Generate a report on laboratories in csv format`.
//* в полі `Process name` вкажіть бізнес-назву процесу `Формування звіту по лабораторіям в форматі csv`.

+
image:registry-develop:bp-modeling/bp/excerpt-csv-docx/bp-modeling-excerpt-csv-docx-01.png[]
[#create-start-event]
. Create the start event for starting the business process by a user.
//. Створіть початкову подію для запуску бізнес-процесу користувачем.
+
In the settings panel on the right-hand side, enter the appropriate values into the following parameters:
//На панелі налаштувань справа заповніть наступні параметри відповідними значеннями:

* In the `General` tab:
//* на вкладці `General`:
** In the `Id` field, enter the `StartEvent_lab1` value.
//** в полі `Id` введіть значення `StartEvent_lab1`;
** In the `Name` field, enter the name of the start event -- `Start Form`.
//** в полі `Name` введіть назву початкової події `Стартова форма`;
** in the `Initiator` field, enter the `initiator` value.
//** в полі `Initiator` введіть значення `initiator`.
+
[TIP]
====
`initiator` is a special variable set for the user, which initiated the process.
//`initiator` — спеціальна змінна, що встановлюється для користувача, який розпочав процес.
====
+
image:registry-develop:bp-modeling/bp/excerpt-csv-docx/bp-modeling-excerpt-csv-docx-02.png[]

* In the ``Form'' tab:
//* на вкладці `Form`:
** in the `FormKey` field, enter the form ID -- `add-startform-zvit`.
//** в полі `FormKey` введіть ідентифікатор форми `add-startform-zvit`.
+
[TIP]
====
In the `FormKey` field, enter the service name of the created UI form in the Regulations administrator portal.
//В полі `FormKey` зазначається службова назва створеної UI-форми в Кабінеті адміністратора регламентів.

image:registry-develop:bp-modeling/bp/excerpt-csv-docx/bp-modeling-excerpt-csv-docx-02.1.png[]
The following steps describe xref:#create-ui-form-1[modelling of the start form].
//На подальших кроках буде розглянуто xref:#create-ui-form-1[моделювання стартової форми].

====

== Data preparation and signing
//== Підготування даних та їх підписання

. Create a service task "Read data by laboratoryId".
//. Створіть сервісну задачу "Читання даних по laboratoryId".
+
Select the customized `Read entity from data factory` template.
//Оберіть налаштований шаблон (Template) `Read entity from data factory`.
+
[TIP]
====
You can find more details about the `Read entity from data factory` delegate by following the xref:bp-modeling/bp/element-templates/bp-element-templates-installation-configuration.adoc#_читання_сутності_із_фабрики_даних_read_entity_from_data_factory[link].
//Детальніше ознайомитися з описом делегата Читання сутності із фабрики даних (`Read entity from data factory`) ви можете за xref:bp-modeling/bp/element-templates/bp-element-templates-installation-configuration.adoc#_читання_сутності_із_фабрики_даних_read_entity_from_data_factory[посиланням].
====
+
In the settings panel, enter the following values:
//На панелі налаштувань вкажіть наступні значення:

* In the `Name` field, enter the name of the task -- `Data reading by laboratoryId`.
//* в полі `Name` вкажіть назву задачі `Читання даних по laboratoryId`;
* In the `Resource` field, enter the `laboratory` resource.
//* в полі `Resource` вкажіть ресурс `laboratory`;
* in the `Resource id` field, enter the resource ID -- `${submission('StartEvent_lab1').formData.prop('laboratory').prop('laboratoryId').value()}`.
//* в полі `Resource id` введіть ідентифікатор ресурсу `${submission('StartEvent_lab1').formData.prop('laboratory').prop('laboratoryId').value()}`;
+
[TIP]
====
In our case, we pass the `StartEvent_lab1` resource identifier from the start form of the business process using the `submission()` function.
//В нашому випадку ми передаємо ідентифікатор ресурсу `StartEvent_lab1` за допомогою функції `submission()` зі стартової форми бізнес-процесу.
====
* In the `X-Access-Token` field, specify the access token to the user's system that is used to perform the `${initiator().accessToken}` operation.
//* в полі `X-Access-Token` вкажіть токен доступу до системи користувача, під яким виконується операція `${initiator().accessToken}`;
* In the `Result Variable` field, enter the output parameter name -- `labResponse`.
//* в полі `Result Variable` вкажіть назву для вихідного параметра -- `labResponse`.

+
image:registry-develop:bp-modeling/bp/excerpt-csv-docx/bp-modeling-excerpt-csv-docx-03.png[]

. Create the "Search for employee data" service task.
//. Створіть сервісну задачу "Пошук даних про співробітників".
+
Select the configured `Search for entities in data factory` template.
//Оберіть налаштований шаблон (Template) `Search for entities in data factory`.
+
[TIP]
====
You can find more details about the `Search for entities in data factory` delegate by following the xref:bp-modeling/bp/element-templates/bp-element-templates-installation-configuration.adoc#_пошук_сутностей_у_фабриці_даних_search_for_entities_in_data_factory[link].
//Детальніше ознайомитися з описом делегата Пошук сутностей у фабриці даних (`Search for entities in data factory`) ви можете за xref:bp-modeling/bp/element-templates/bp-element-templates-installation-configuration.adoc#_пошук_сутностей_у_фабриці_даних_search_for_entities_in_data_factory[посиланням].
====
+
In the settings panel, enter the following values:
//На панелі налаштувань вкажіть наступні значення:

* In the `Name` field, enter the name of the task -- `Search for employee data`.
//* У полі `Name` вкажіть назву задачі `Пошук даних про співробітників`;
* In the `Input Parameters` section:
//* У розділі `Input Parameters`:
** Expand the `Resource` block:
//** Розгорніть блок `Resource`:
*** `Local Variable Assignment` is set to `on`. This allows creation of a local variable for the request body.
//*** `Local Variable Assigment` має значення `on`, це дозволить створити локальну змінну для тіла запита;
*** `Variable Assignment Type`, select the `String of Expression` variable assignment type from the dropdown list.
//*** `Variable Assignment Type`  оберіть з випадного списку тип призначення змінної `String of Expression`;
*** `Variable Assignment Value`, enter `staff-equal-laboratory-id`.
//*** `Variable Assignment Value` введіть `staff-equal-laboratory-id`.
+
[TIP]
====
`staff-equal-laboratory-id` is the endpoint name for the search criteria, where a request is made to find entities.
//`staff-equal-laboratory-id` -- це назва ендпоінту для критерію пошуку куди здійснюється запит для пошуку сутностей.
====
** Expand the `Search variable` block:
//** Розгорніть блок `Search variable`:
*** `Local Variable Assignment` has the `on` value.
//*** `Local Variable Assigment` має значення `on`;
*** `Variable Assignment Type`, select `Map`.
//*** `Variable Assignment Type` виберіть `Map`;
*** `Add Entry`, enter `laboratoryId` in `Key`, and enter `${submission('StartEvent_lab1').formData.prop('laboratory').prop('laboratoryId').value()}` in `Value`.
** Expand the `X-Access-Token` block:
//** Розгорніть блок `X-Access-Token`:
*** `Local Variable Assignment` has the `on` value.
//*** `Local Variable Assigment` має значення `on`;
*** `Variable Assignment Type`, select `String of Expression`.
//*** `Variable Assignment Type` оберіть `String of Expression`;
*** `Variable Assignment Value`, enter `${initiator().accessToken}`.
//*** `Variable Assignment Value` введіть значення `${initiator().accessToken}`.
* In the `Output Parameters` section:
//* У розділі `Output Parameters`:
** Expand the `Result variable` block:
//** Розгорніть блок `Result variable`:
*** `Local Variable Assignment` has the `on` value.
//*** `Local Variable Assigment` має значення `on`;
*** `Assign to Process Variable`, enter the value of the variable used for writing the request result -- `staffResponse`.
//*** `Assign to Process Variable` введіть значення змінної до якої буде записано результат запита -- `staffResponse`.

+
image:registry-develop:bp-modeling/bp/excerpt-csv-docx/bp-modeling-excerpt-csv-docx-04.png[]

. Create the "Prepare data for displaying" script task.
//. Створіть задачу скриптування "Підготовка даних для показу".
+
In the settings panel, enter the following values:
//На панелі налаштувань вкажіть наступні значення:

* In the `Name` field, enter the `Prepare data for displaying` name.
//* в полі `Name` вкажіть назву `Підготовка даних для показу`;
* In the `Script Format` field, enter the script type (language)  — `groovy`.
//* в полі `Script Format` вкажіть тип (мову) скриптування — `groovy`;
* In the `Script Type` field, select the script type -- `Inline Script`.
//* в полі `Script Type` вкажіть тип скрипту `Inline Script`;
* In the `Script` field, insert the following groovy script:
//* в полі `Script` вставте безпосередньо groovy-скрипт:
+
[source, groovy]
----
def labResponseBody = labResponse.responseBody
def payload = [:]
def personnelGrid = []

def addPersonPropClosure = { person, staffIt, key ->
if (staffIt.hasProp(key)) {
if (!staffIt.prop(key).isNull()) {
person[key] = staffIt.prop(key).value()
}
}
}

staffResponse.responseBody.elements().each {
def person = [:]

    addPersonPropClosure(person, it, 'fullName')
    addPersonPropClosure(person, it, 'specializationDate')
    addPersonPropClosure(person, it, 'salary')
    addPersonPropClosure(person, it, 'hygienistFlag')
    addPersonPropClosure(person, it, 'fullTimeFlag')

    personnelGrid.add(person)
}

payload['name'] = labResponseBody .prop('name').value()
payload['edrpou'] = labResponseBody .prop('edrpou').value()
payload['address'] = labResponseBody .prop('address').value()
payload['headName'] = labResponseBody .prop('headName').value()
payload['personnelGrid'] = personnelGrid

execution.removeVariable('payload')
set_transient_variable('payload', S(payload, 'application/json'))
----

+
image:registry-develop:bp-modeling/bp/excerpt-csv-docx/bp-modeling-excerpt-csv-docx-05.png[]
[#create_user-task-1]
. Create the "Display personnel data" custom task.
//. Створіть користувацьку задачу "Відобразити дані про персонал".
+
In the settings panel, set the following values:
//На панелі налаштувань вкажіть наступні значення:

* In the `Id` field, enter the `personnelDataZvitForm` value.
//* в полі `Id` введіть значення `personnelDataZvitForm`;
* In the `Name` field, enter the `Display personnel data` name.
//* в полі `Name` вкажіть назву `Відобразити дані про персонал`;
* In the `Form key` field, enter the `read-personnel-data-zvit` value.
//* в полі `Form key` введіть значення `read-personnel-data-zvit`;
+
[TIP]
====
In the `FormKey` field, you have to enter the service name of the created UI form in the Regulations administrator portal.
//В полі `FormKey` зазначається службова назва створеної UI-форми в Кабінеті адміністратора регламентів.

The following steps describe xref:#create-ui-form-2[modelling of the personnel data display form].
//На подальших кроках буде розглянуто xref:#create-ui-form-2[моделювання форми відображення даних про персонал].
====
* In the `Assignee` field, enter the `${initiator}` value.
//* в полі `Assignee` введіть значення `${initiator}`;
+
[TIP]
====
`${initiator}` indicates that the business process will be assigned to the user who initiated the business process.
//`${initiator}` вказує на те, що бізнес-процес буде призначено користувачеві, що ініціював бізнес-процес.
====

* In the `Form data pre-population` field, enter the `${payload}` value.
//* в полі `Form data pre-population` введіть значення `${payload}`.

+
image:registry-develop:bp-modeling/bp/excerpt-csv-docx/bp-modeling-excerpt-csv-docx-06.png[]

. Create the "Prepare data for writing (transient var)" script task.
//. Створіть задачу скриптування "Підготовка даних для запису (transient var)".
+
In the settings panel, set the following values:
//На панелі налаштувань вкажіть наступні значення:

* In the `Name` field, enter the `Prepare data for writing (transient var)` value.
//* в полі `Name` введіть значення `Підготовка даних для запису (transient var)`;
* In the `Script Format` field, enter the script type (language) — `groovy`.
//* в полі `Script Format` вкажіть тип (мову) скриптування — `groovy`;
* In the `Script Type` field, select the `Inline Script` script type.
//* в полі `Script Type` вкажіть тип скрипту `Inline Script`;
* In the `Script` field, insert the following groovy script:
//* в полі `Script` вставте безпосередньо groovy-скрипт:
+
[source, groovy]
----
def personnelFormData = submission('personnelDataZvitForm').formData

def excerptInputData = [:]
def requests = []

def prepopulatedDataMap = [:]
prepopulatedDataMap['name'] = personnelFormData.prop('name').value()
prepopulatedDataMap['address'] = personnelFormData.prop('address').value()
prepopulatedDataMap['headName'] = personnelFormData.prop('headName').value()
prepopulatedDataMap['edrpou'] = personnelFormData.prop('edrpou').value()

personnelFormData.prop('personnelGrid').elements().each {
    def request = [:]
    request.putAll(prepopulatedDataMap)
    it.fieldNames().each { fieldName ->
        request[fieldName] = it.prop(fieldName).value()
    }
    request['hygienistFlag'] = it.prop('hygienistFlag').boolValue() ? '1' : '0'
    request['fullTimeFlag'] = it.prop('fullTimeFlag').boolValue() ? '1' : '0'

    requests.add(request)
}

excerptInputData['requests'] = requests

def request = [:]
request['recordId'] = null
request['excerptType'] = 'lab-staff-excerpt-csv'
request['excerptInputData'] = excerptInputData
request['requiresSystemSignature'] = false

def payload = S(request, 'application/json')
execution.removeVariable('payload')
set_transient_variable('payload', payload)

execution.removeVariable('excerpt')
set_transient_variable('excerpt', excerptInputData)
----

+
image:registry-develop:bp-modeling/bp/excerpt-csv-docx/bp-modeling-excerpt-csv-docx-07.png[]

. Add the task for calling an external business process (Call Activity) "Signing data using the system key".
//. Додайте задачу виклику зовнішнього бізнес-процесу (Call Activity) "Підпис даних системним ключем".
+
[TIP]
====
You can find more details about the `System digital signature` delegate by following the xref:bp-modeling/bp/element-templates/bp-element-templates-installation-configuration.adoc#element-temp-system-digital-signature[link].
//Детальніше ознайомитися з описом делегата виклику підпроцесу для підпису даних системним ключем (`System digital signature`) ви можете за xref:bp-modeling/bp/element-templates/bp-element-templates-installation-configuration.adoc#element-temp-system-digital-signature[посиланням].
====
+
Select the configured `System digital signature` template.
//Оберіть налаштований шаблон (Template) `System digital signature`.
+
In the settings panel, enter the following values:
//На панелі налаштувань вкажіть наступні значення:

* In the `Name` field, enter the name of the task -- `Signing data using the system key`.
//* в полі `Name` вкажіть назву задачі `Підпис даних системним ключем`;
* In the `Input Parameters` section enter the input data that must be signed and passed to a business process called by `${payload}`;
//* в полі `Input Data` вкажіть вхідні дані, які необхідно підписати та передати бізнес-процесу, що викликається `${payload}`;
* In the `Output variable name` field, enter the `system_signature_ceph_key` variable, where the system signature key, obtained as a result of execution of the called subprocess, has to be saved.
//* в полі `Output variable name` вкажіть назву змінної `system_signature_ceph_key`, до якої необхідно зберегти системний ключ для підпису, отриманий в результаті виконання підпроцесу, що викликається.

+
image:registry-develop:bp-modeling/bp/excerpt-csv-docx/bp-modeling-excerpt-csv-docx-08.png[]

== Generating a report
//== Формування звіту
[#create-service-task-1]
. Create a service task "Request for generating an excerpt report".
//. Створіть сервісну задачу "Запит на формування витягу-звіту".
+
Select the `Generate Excerpt' configured template.
//Оберіть налаштований шаблон (Template) `Generate Excerpt`.

* In the `Name field`, enter the `Request for generating an excerpt report` name.
//* в полі `Name` введіть назву `Запит на формування витягу-звіту`;
* In the `Excerpt Type` field, enter the name of the file that defines the format -- `lab-staff-excerpt-csv`.
//* в полі `Excerpt Type` введіть назву файлу, яким визначено формат  `lab-staff-excerpt-csv`;
* In the `Excerpt Input Data`  field, enter the `${excerpt}` value.
//* в полі `Excerpt Input Data` введіть значення `${excerpt}`;
* In the `Requires System Signature` field, enter the `false` value.
//* в полі `Requires System Signature` введіть значення `false`;
+
[IMPORTANT]
====
A possibility to sign excerpt data in .csv and .docx formats using a system key [.underline]#is not available#. Therefore, the `Requires System Signature` parameter should contain the `false` value by default. If `true` is set, the business process will not run. _Signing using the system key is only available for the .pdf format_.
//Можливість підписання даних витягів у форматі .csv і .docx системним ключем [.underline]#відсутня#, тому за замовчуванням параметр `Requires System Signature` має містити значення `false`. Якщо буде вказано значення `true`, бізнес-процес не буде працювати. _Підписання системним ключем доступно лише для формату .pdf_.
====
* In the `X-Access-Token` field, enter the token to access the user system, which is used to perform the `${initiator().accessToken}` operation.
//* в полі `X-Access-Token` зазначте токен доступу до системи користувача, під яким виконується операція `${initiator().accessToken}`;
* In the `X-Digital-Signature source` field, enter the source of the digital signature -- `${sign_submission('StartEvent_lab1').signatureDocumentId}`.
//* в полі `X-Digital-Signature source` вкажіть джерело цифрового підпису `${sign_submission('StartEvent_lab1').signatureDocumentId}`;
* In the `X-Digital-Signature-Derived source` field, enter the source of the system digital signature -- `${system_signature_ceph_key}`.
//* в полі `X-Digital-Signature-Derived source` вкажіть джерело системного цифрового підпису `${system_signature_ceph_key}`;
* In the `Result variable` field, enter the `response` output parameter name.
//* в полі `Result variable` вкажіть назву для вихідного параметра `response`.

+
image:registry-develop:bp-modeling/bp/excerpt-csv-docx/bp-modeling-excerpt-csv-docx-09.png[]

+
[TIP]
====
The data transmitted to generate the `excerptInputData` excerpt must have the following format:
//Дані, що передаються для генерації витягу `excerptInputData` повинні мати відповідний формат:
[source, groovy]
----
{
   "requests":[
      {
         "field1":"value1"
      },
      {
         "field2":"value2"
      }

..........
   ]
}
----
====

. Create a file in the root of the cluster, placing it in the corresponding project directory.
//. Створіть файл у корені кластера, розмістивши його у відповідному каталозі проєкту.
+
The file name has to be identical to the name entered in `Excerpt Type` (xref:#create-service-task-1[at the previous step]). In our example, that is `lab-staff-excerpt-csv.csv`.
//Файл повинен мати назву ідентичну зазначеній у полі `Excerpt Type` (xref:#create-service-task-1[на попередньому кроці]), у нашому прикладі -- `lab-staff-excerpt-csv.csv`.
+
[plantuml]
----
@startsalt
{
{T
+ <&folder> registry-regulations

++ <&folder> bp-auth
+++ <&file> role.yml
+++ ...

++ <&folder> bp-trembita
+++ <&file> config.yml
+++ ...

++ <&folder> bpmn
+++ <&file> process.bpmn
+++ ...

++ <&folder>data-model
+++ <&folder> data-load
++++ <&file> dict.csv
++++ ...
+++ <&file> model.xml
+++ ...

++ <&folder> dmn

++ <&folder> excerpts

++ <&folder> excerpts-csv
+++ <&file> **lab-staff-excerpt-csv.csv**
+++ ...

++ <&folder> forms
+++ <&file> form.json
++++ ...

++ <&folder> global-vars
+++ <&file> global-vars.yml

++ <&folder> reports
+++ <&file> report.json
+++ ...

++ <&folder> roles
+++ <&file> role.yml
+++ ...

+ <&file> settings.yaml

}
}
@endsalt
----
+
[TIP]
====
At this stage, the .csv and .docx file format is determined.
//На цьому етапі визначається формат файлу .csv та .docx.
====

. Create a "Save extract report request ID" script task.
//. Створіть задачу скриптування "Зберегти Id запиту витягу-звіту".
+
In the settings panel, set the following values:
//На панелі налаштувань вкажіть наступні значення:

* In the `Name` field, enter the name of the task -- "Save extract report request ID".
//* в полі `Name` введіть назву задачі `Зберегти Id запиту витягу-звіту`;
* In the `Script Format` field, enter the script type (language) — `groovy`.
//* в полі `Script Format` вкажіть тип (мову) скриптування — `groovy`;
* In the `Script Type` field, select the `Inline Script` script type.
//* в полі `Script Type` вкажіть тип скрипту `Inline Script`;
* In the `Script` field, insert the following groovy script:
//* в полі `Script` вставте безпосередньо groovy-скрипт:
+
[source, groovy]
----
response.responseBody.prop('excerptIdentifier').value()
----
* In the `Result Variable` field, enter the name of the variable to which the extract identifier will be written, -- `excerptIdentifier`.
//* в полі `Result Variable` вкажіть назву змінної, до якої буде записано ідентифікатор витягу, -- `excerptIdentifier`.

+
image:registry-develop:bp-modeling/bp/excerpt-csv-docx/bp-modeling-excerpt-csv-docx-11.png[]

== Setting the conditions of the output generation result checks
//== Налаштування умов перевірок результату генерації витягу

. Add the task for calling an external business process (Call Activity) "Check excerpt generation status".
//. Додайте задачу виклику зовнішнього бізнес-процесу (Call Activity) "Перевірка статусу генерації витягу-звіту".
+
Select the configured `Check excerpt status` template.
//Оберіть налаштований шаблон (Template) `Check excerpt status`.
+
[TIP]
====
Follow the xref:bp-modeling/bp/element-templates/bp-element-templates-installation-configuration.adoc#element-temp-check-excerpt-status[link] to find more details about the `Check excerpt status` delegate.
//Детальніше ознайомитися з описом делегата `Check excerpt status` ви можете за xref:bp-modeling/bp/element-templates/bp-element-templates-installation-configuration.adoc#element-temp-check-excerpt-status[посиланням].
====
+
In the settings panel, enter the following values:
//На панелі налаштувань вкажіть наступні значення:

* In the `Name` field, enter the name of the task -- `Check the status of excerpt generation`.
//* в полі `Name` вкажіть назву задачі `Перевірка статусу генерації витягу-звіту`;
* In the `Input excerpt identifier` field, enter the excerpt ID that has to be passed to the called business process -- `${excerptIdentifier}`.
//* в полі `Input excerpt identifier` вкажіть ID витягу, який необхідно передати бізнес-процесу, що викликається, -- `${excerptIdentifier}`;
* In the `Output variable name` field, enter the `excerptStatus` variable, where the excerpt status, recived as the result of a sub-process execution, has to be saved.
//* в полі `Output variable name`  вкажіть назву змінної -- `excerptStatus`, до якої необхідно зберегти статус витягу, отриманий в результаті виконання підпроцесу, що викликається.

+
image:registry-develop:bp-modeling/bp/excerpt-csv-docx/bp-modeling-excerpt-csv-docx-12.1.png[]

+


."Check excerpt generation status" business process
//.Бізнес процес "Перевірка статусу генерації витягу"
====
image:registry-develop:bp-modeling/bp/excerpt-csv-docx/bp-modeling-excerpt-csv-docx-13.png[]
====


. Add the Create Intermediate/Boundary Event element, define its type by clicking the key icon (Change type) and selecting the Timer Boundary Event item from the menu.
//. Додайте елемент Create Intermediate/Boundary Event, визначте її тип, натиснувши іконку ключа (Change type) та обравши з меню пункт Timer Boundary Event.
+
[TIP]
====
Follow the xref:registry-develop:bp-modeling/bp/bpmn/events/timer-event.adoc[link] to find more detailed description of the "Timer" event modeling element.
//Детальніше ознайомитися з описом елемента моделювання події "Timer" ви можете за xref:registry-develop:bp-modeling/bp/bpmn/events/timer-event.adoc[посиланням].
====
+
Go to the settings panel and configure the event:
//Перейдіть до панелі налаштувань та сконфігуруйте подію:

* In the `Name` field, enter the `P2M waiting time expired`.
//* в полі `Name` введіть значення `Вичерпано час на очікування P2M`;
* In the `Timer Definition Type` field, set the `Duration` timer type;
//* в полі `Timer Definition Type` вкажіть тип таймера `Duration` (тривалість);
* In the `Timer Definition` field, set the `P2M` timer duration.
//* в полі `Timer Definition` зазначте тривалість таймера `P2M`.

+
image:registry-develop:bp-modeling/bp/excerpt-csv-docx/bp-modeling-excerpt-csv-docx-12.2.png[]

. Add XOR gateways for the "Check excerpt generation status" Call Activity and for the "P2M Timed Out" Timer Boundary Event.
//. Додайте XOR-шлюзи для Call Activity "Перевірка статусу генерації витягу-звіту" і Timer Boundary Event "Вичерпано час на очікування P2M".
+
image:registry-develop:bp-modeling/bp/excerpt-csv-docx/bp-modeling-excerpt-csv-docx-14.png[]

. Create the "Save the identifier of the generated excerpt to the system BP" service task.
//. Створіть сервісну задачу "Зберегти ідентифікатор згенерованого витягу-звіту у системну БП".
+
In the settings panel, set the following values:
//На панелі налаштувань вкажіть наступні значення:

* In the `General` tab:
//* на вкладці `General`:
** In the `Name` field, enter the value `Save the identifier of the generated excerpt to the system BP`.
//** в полі `Name` введіть значення `Зберегти ідентифікатор згенерованого витягу-звіту у системну БП`;
** in the `Implementation` field ,select the `Delegate Expression` value.
//** в полі `Implementation` виберіть значення `Delegate Expression`;
** In the `Delegate Expression` field, enter `${defineProcessExcerptIdDelegate}`.
//** в полі `Delegate Expression` введіть значення `${defineProcessExcerptIdDelegate}`.
* In the `Input/Output` tab:
//* на вкладці `Intup/Output`:
** In the `Local Variable Name` field, enter the `excerptId` value.
//** в полі `Local Variable Name` введіть значення `excerptId`;
** In the `Variable Assignment Type` field, select `String or Expression`.
//** в полі `Variable Assignment Type` виберіть значення `String or Expression`;
** In the `Variable Assignment Value` field, enter `${excerptIdentifier}`.
//** в полі `Variable Assignment Value` введіть значення `${excerptIdentifier}`.

+
image:registry-develop:bp-modeling/bp/excerpt-csv-docx/bp-modeling-excerpt-csv-docx-15.1.png[]
[.text-center]
↓
image:registry-develop:bp-modeling/bp/excerpt-csv-docx/bp-modeling-excerpt-csv-docx-15.2.png[]

+
[TIP]
====
The value specified in the `Id` field is used as the name of the file that a user downloads from the portal.
//Значення, що вказано в полі `Id` використовується як назва файлу, який користувач буде завантажувати з Кабінету.
====

. Configure the flow process for the XOR gateway.
//. Налаштуйте процес потоку для XOR-шлюзу.
+
Create Connect using sequence (branches):
//Створіть Connect using sequence (гілки):
+
.. To the "Save the identifier of the generated excerpt to the system BP" service task:
//.. до сервісної задачі "Зберегти ідентифікатор згенерованого витягу-звіту у системну БП":
* Enter `yes` in the `Name` field.
//* у полі `Name` введіть значення `так`;
* In the `Condition Type` field, select `Expression`.
//* у полі `Condition Type` виберіть значення `Expression`;
* In the `Expression` field, enter the `${excerptStatus.equals('COMPLETED')}` value.
//* у полі `Expression` введіть значення `${excerptStatus.equals('COMPLETED')}`.
+
image:registry-develop:bp-modeling/bp/excerpt-csv-docx/bp-modeling-excerpt-csv-docx-16.png[]
.. To another XOR gateway:
//.. до іншого XOR-шлюзу:
* In the `Name` field, enter `no`.
//* у полі `Name` введіть значення `ні`;
* In the `Condition Type` field, select `Expression`.
//* у полі `Condition Type` виберіть значення `Expression`;
* In the `Expression` field, enter `${excerptStatus.equals('FAILED')}`.
//* у полі `Expression` введіть значення `${excerptStatus.equals('FAILED')}`.
+
image:registry-develop:bp-modeling/bp/excerpt-csv-docx/bp-modeling-excerpt-csv-docx-17.png[]

== Process execution result
//== Результат виконання процесу

=== Unsuccessful result of business process execution
//=== Неусіпішний результат виконання бізнес-процесу

. Create the "Execution result "Excerpt not generated"" service task.
//. Створіть сервісну задачу "Результат виконання "Витяг-звіт не сформовано"".
+
Choose the `Define business process status` configured template.
//Оберіть налаштований шаблон (Template) `Define business process status`.
+
In the settings panel, set the following values:
//На панелі налаштувань вкажіть наступні значення:

* In the `Name` field, enter the `Execution result "Excerpt not generated"` value.
//* у полі `Name` введіть значення `Результат виконання "Витяг-звіт не сформовано"`;
* In the `Status` field, enter the `Excerpt not generated` value. This status is displayed after process completion.
//* у полі `Status` введіть значення `Витяг не сформовано` статус, що відображатиметься після завершення процесу.

+
image:registry-develop:bp-modeling/bp/excerpt-csv-docx/bp-modeling-excerpt-csv-docx-18.png[]

. Configure the flow process from the XOR gateway to the service task "Execution result "Excerpt not generated"" by creating a Connect using sequence (branch).
//. Налаштуйте процес потоку від XOR-шлюзу до сервісної задачі "Результат виконання "Витяг-звіт не сформовано"", створивши Connect using sequence (гілку).
+
And create the business process completion event.
//І створіть подію завершення бізнес-процесу.

* In the `Name` field, enter the `Excerpt document not generated` value.
//* у полі `Name` введіть значення `Документ витяг-звіт не сформовано`.

+
image:registry-develop:bp-modeling/bp/excerpt-csv-docx/bp-modeling-excerpt-csv-docx-19.png[]

=== Successful result of business process execution
//=== Успішний результат виконання бізнес-процесу

. Create the "Execution result "Excerpt generated"" service task.
//. Створіть сервісну задачу "Результат виконання "Витяг-звіт сформовано"".
+
Choose the `Define business process status` configured template.
//Оберіть налаштований шаблон (Template) `Define business process status`.
+
In the settings panel, set the following values:
//На панелі налаштувань вкажіть наступні значення:

* In the `Name` field, enter the `Execution result "Excerpt generated"` value.
//* у полі `Name` введіть значення `Результат виконання "Витяг-звіт сформовано"`;
* In the `Status` field, enter the `Excerpt generated` value. This status is displayed after process completion.
//* у полі `Status` введіть значення `Витяг сформовано` статус, що відображатиметься після завершення процесу.

+
image:registry-develop:bp-modeling/bp/excerpt-csv-docx/bp-modeling-excerpt-csv-docx-20.png[]

. Create the business process completion event.
//. Cтворіть подію завершення бізнес-процесу.

* In the `Name` field, enter the `Excerpt document generated` value.
//* у полі `Name` введіть значення `Документ витяг-звіт сформовано`.

+
image:registry-develop:bp-modeling/bp/excerpt-csv-docx/bp-modeling-excerpt-csv-docx-21.png[]

== Modeling forms
//== Моделювання форм

Model the forms in accordance with the instructions at the xref:registry-develop:bp-modeling/forms/registry-admin-modelling-forms.adoc[link].
//Змоделюйте форми згідно з інструкцією за xref:registry-develop:bp-modeling/forms/registry-admin-modelling-forms.adoc[посиланням].

[#create-ui-form-1]
=== Modeling the starting form
//=== Моделювання стартової форми

Modeling the starting form involves creation of a form for searching a laboratory by its name.
//Моделювання стартової форми передбачає створення форми для пошуку лабораторії за назвою.

* In the `Form business name` field, enter the `Start form lab report` value.
//* У полі `Бізнес-назва форми` введіть значення `Стартова форма лаб звіт`.
* In the `Form service name` field, enter the `add-startform-zvit` value (which is used at the xref:#create-start-event[previous step] as the value of the `Form Key` parameter).
//* У полі `Службова назва форми` введіть значення `add-startform-zvit` (що використовувалось на xref:#create-start-event[минулому кроці] як значення параметра `Form Key`).

image:bp-modeling/bp/excerpt-csv-docx/bp-modeling-excerpt-csv-docx-22.png[]

[TIP]
====
The configured form can be downloaded from the following link:
//Завантажити налаштовану форму можливо за посиланням:
_link:{attachmentsdir}/bp-modeling/add-startform-zvit.json[add-startform-zvit.json]_
====

[#create-ui-form-2]
=== Modeling the personnel data display form
//=== Моделювання форми відображення даних про персонал

Modeling the personnel data display form involves creation of a form for generating the data of the called laboratory.
//Моделювання форми відображення даних про персонал передбачає створення форми для формування даних запитуваної лабораторії.

* In the `Business name of the form` field, enter the `Display personnel data report` value.
//* У полі `Бізнес-назва форми` введіть значення `Відобразити дані про персонал звіт`.
* In the `Form service name` field, enter the `read-personnel-data-zvit` value (which is used at the xref:#create_user-task-1[previous step] as the value of the `Form Key` parameter).
//* У полі `Службова назва форми` введіть значення `read-personnel-data-zvit`,(що використовувалось на xref:#create_user-task-1[минулому кроці] як значення параметра `Form Key`).

image:bp-modeling/bp/excerpt-csv-docx/bp-modeling-excerpt-csv-docx-23.png[]

[TIP]
====
The configured form can be downloaded from the following link:
//Завантажити налаштовану форму можливо за посиланням:
_link:{attachmentsdir}/bp-modeling/read-personnel-data-zvit.json[read-personnel-data-zvit.json]_
====

== An example of using the business process by a user
//== Приклад використання бізнес-процесу користувачем

You can learn more about the process of creating excerpts by users, based on the result of the modeled business process, at following the links:
//Детальніше ознайомитися з процесом формування витягів користувачем за результатом змодельованого бізнес-процесу ви можете за посиланнями:

* xref:user:officer/reports/reports-csv.adoc[]
* xref:user:officer/reports/reports-docx.adoc[]

