:toc-title: On this page:
:toc: auto
:toclevels: 5
:experimental:
:sectnums:
:sectnumlevels: 5
:sectanchors:
:sectlinks:
:partnums:

= Business processes execution history

NOTE: üåê This document is available in both English and Ukrainian. Use the language toggle in the top right corner to switch between versions.

== General context

//_–°–µ—Ä–≤—ñ—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –±—ñ–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—ñ–≤_ –∑–±–µ—Ä—ñ–≥–∞—î –º—ñ–Ω—ñ–º–∞–ª—å–Ω–æ –Ω–µ–æ–±—Ö—ñ–¥–Ω–∏–π —Ç–∞ –¥–æ—Å—Ç–∞—Ç–Ω—ñ–π –Ω–∞–±—ñ—Ä –¥–∞–Ω–∏—Ö –ø—Ä–æ —Å—Ç–∞–Ω –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –æ–∫—Ä–µ–º–∏—Ö –µ–∫–∑–µ–º–ø–ª—è—Ä—ñ–≤ –ë–ü —É —Å—Ö–æ–≤–∏—â—ñ –¥–∞–Ω–∏—Ö —É –≤–∏–≥–ª—è–¥—ñ –æ–∫—Ä–µ–º–æ—ó –≥—Ä—É–ø–∏ —Å–ª—É–∂–±–æ–≤–∏—Ö —Ç–∞–±–ª–∏—Ü—å –∑ —É–º–æ–≤–Ω–æ—é –Ω–∞–∑–≤–æ—é _Runtime Database_.

The _Business Process Management Service_ (BPMS) keeps a minimal set of necessary data on the state of running business process (BP) instances inside the database. We provisionally call this group of dedicated tables the _Runtime Database_.

//–î–æ–¥–∞—Ç–∫–æ–≤–æ, –¥–ª—è —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó –≤–∏–º–æ–≥ –∞—É–¥–∏—Ç—É, —Ñ–æ—Ä–º—É—î—Ç—å—Å—è –æ–∫—Ä–µ–º–∏–π –ª–æ–≥ –∑–Ω–∞—á—É—â–∏—Ö –ø–æ–¥—ñ–π _History Event Stream_, —è–∫–∏–π –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –≤ _History Database_ –≥—Ä—É–ø—É —Ç–∞–±–ª–∏—Ü—å —Å—Ö–æ–≤–∏—â–∞.

Additionally, to meet audit requirements, the system creates a separate audit log of meaningful events we call the _History Event Stream_. By default, this event stream is saved to the _History Database_ group of database tables.

//–û–±'—î–º —Ç–∞ —Ä—ñ–≤–µ–Ω—å –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó –ø–æ–¥—ñ–π –Ω–∞–ª–∞—à—Ç–æ–≤—É—î—Ç—å—Å—è –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é _HistoryLevel_, —è–∫–∏–π –≤–∏–∑–Ω–∞—á–∞—î—Ç—å—Å—è –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ _camunda.bpm.history-level_

The _HistoryLevel_ setting controls the amount and level of events generated. _HistoryLevel_ is defined using the _camunda.bpm.history-level_ property.

[NOTE]
--
//–í–ª–∞—Å—Ç–∏–≤—ñ—Å—Ç—å _camunda.bpm.history-level_ –º–æ–∂–µ –±—É—Ç–∏ –≤–∏–∑–Ω–∞—á–µ–Ω–∞ —Ç—ñ–ª—å–∫–∏ –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –ø–µ—Ä–≤–∏–Ω–Ω–æ–º—É –∑–∞–ø—É—Å–∫—É –¥–æ–¥–∞—Ç–∫—É Camunda. –î–ª—è —Ç–æ–≥–æ, —â–æ–± –∑–º—ñ–Ω–∏—Ç–∏ —Ü—é –≤–ª–∞—Å—Ç–∏–≤—ñ—Å—Ç—å, —Ç—Ä–µ–±–∞ —Ç–∞–∫–æ–∂ –∑–º—ñ–Ω–∏—Ç–∏ —Ä—ñ–≤–µ–Ω—å —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏—Ö –ø–æ–¥—ñ–π —É –±–∞–∑—ñ –¥–∞–Ω–∏—Ö Camunda
The _camunda.bpm.history-level_ property is defined once during the initial run of the Camunda application. To change this property, you also need to change the history level in the Camunda database:

[source, sql]
UPDATE ACT_GE_PROPERTY SET VALUE_ = ?
WHERE NAME_ = 'historyLevel';
--

////
.–ú–æ–∂–ª–∏–≤—ñ –∑–Ω–∞—á–µ–Ω–Ω—è *camunda.bpm.history-level*:
- *NONE* (VALUE_ = 0) -- –∑–∞–ø–∏—Å —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏—Ö –ø–æ–¥—ñ–π –≤ –ë–î –Ω–µ –ø—Ä–æ–≤–æ–¥–∏—Ç—å—Å—è, —Ç–∞–∫–∏–º —á–∏–Ω–æ–º –º—ñ–Ω—ñ–º—ñ–∑—É—î—Ç—å—Å—è –≤–ø–ª–∏–≤ –Ω–∞ —à–≤–∏–¥–∫–æ–¥—ñ—é
- *ACTIVITY* (VALUE_ = 1) -- –≥–µ–Ω–µ—Ä—É—é—Ç—å—Å—è –∑–Ω–∞—á—É—â—ñ —ñ—Å—Ç–æ—Ä–∏—á–Ω—ñ –ø–æ–¥—ñ—ó –Ω–∞–¥ –æ–±'—î–∫—Ç–∞–º–∏: PROCESS, ACTIVITY, TASK
- *AUDIT* (VALUE_ = 2) -- –¥–æ–¥–∞—Ç–∫–æ–≤–æ –≥–µ–Ω–µ—Ä—É—é—Ç—å—Å—è –ø–æ–¥—ñ—ó –Ω–∞–¥ –∑–º—ñ–Ω–Ω–∏–º–∏ –ë–ü
- *FULL* (VALUE_ = 3) -- –¥–æ–¥–∞—Ç–∫–æ–≤–æ –≥–µ–Ω–µ—Ä—É—î—Ç—å—Å—è —ñ—Å—Ç–æ—Ä—ñ—è –∑–º—ñ–Ω –∑–º—ñ–Ω–Ω–∏—Ö –ë–ü. –ù–µ —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ –¥–ª—è –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –ø–æ –ø—Ä–∏—á–∏–Ω—ñ –Ω–∞–π–±—ñ–ª—å—à–æ–≥–æ –≤–ø–ª–∏–≤—É –Ω–∞ —à–≤–∏–¥–∫–æ–¥—ñ—é
////

.The *camunda.bpm.history-level* property can have the following properties:
* *NONE* (VALUE_ = 0) -- No history events are logged into the database, which minimizes impact on performance.
* *ACTIVITY* (VALUE_ = 1) -- Meaningful history events are logged for these objects: PROCESS, ACTIVITY, TASK.
* *AUDIT* (VALUE_ = 2) -- In addition to the events provided by the ACTIVITY history level, BP variables events are logged.
* *FULL* (VALUE_ = 3) -- In addition to the events provided by the AUDIT history level, BP variables change history is logged. Not recommended due to maximum impact on performance.

[WARNING]
//–ó–±–µ—Ä—ñ–≥–∞–Ω–Ω—è —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏—Ö –¥–∞–Ω–∏—Ö —É —Å—Ö–æ–≤–∏—â–µ _History Database_ —î —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∏–º, –∞ –æ–±'—î–º —Ç–∞ —Ä—ñ–≤–µ–Ω—å *–≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó*  –ø–æ–¥—ñ–π –Ω–∞–ª–∞—à—Ç–æ–≤—É—î—Ç—å—Å—è –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é _HistoryLevel_. –í–∞–∂–ª–∏–≤–∏–º —Ç–∞–∫–æ–∂ —î —Ç–æ–π —Ñ–∞–∫—Ç, —â–æ —Ä—ñ—Å—Ç —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏—Ö –¥–∞–Ω–∏—Ö –Ω–µ –æ–±–º–µ–∂–µ–Ω–æ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º.
Saving history data to the _History Database_ works synchronously, while the amount and level of events *generated* is controlled by _HistoryLevel_. Note that history data accumulation is not limited by default.

//–ù–∞ –¥–∞–Ω—ñ–π –¥—ñ–∞–≥—Ä–∞–º—ñ –ø–æ—Å–ª—ñ–¥–æ–≤–Ω–æ—Å—Ç—ñ —Å—Ö–µ–º–∞—Ç–∏—á–Ω–æ –∑–æ–±—Ä–∞–∂–µ–Ω–æ –∞–ª–≥–æ—Ä–∏—Ç–º –¥—ñ–π —Ñ—ñ–∫—Å–∞—Ü—ñ—ó —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏—Ö –ø–æ–¥—ñ–π —É –ø—Ä–æ—Ü–µ—Å—ñ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –ë–ü:

The following sequence diagram presents the algorithm of logging history events when running BPs:

[plantuml]
----
@startuml
skinparam shadowing false
skinparam DatabaseBackgroundColor white
skinparam DatabaseBorderColor #2688d4
skinparam sequence {
    ArrowColor #2688d4
    ActorBorderColor #2688d4
    LifeLineBorderColor #2688d4
    ParticipantBorderColor #2688d4
    ParticipantBackgroundColor white
    BoxBorderColor #2688d4
    BoxBackgroundColor white
}

box "Business Process Management Service"
    participant "BPMN \nCore Engine" as engine
    participant "History Level" as history_level
    participant "History \nEvent Producer" as producer
    participant "Composite History \nEvent Handler" as composite_handler
    participant "DB History \nEvent Handler" as db_handler
end box

box "BPM Database"
    database "History \nDatabase" as history_db
end box

engine -> history_level ++: isHistoryEventProduced()
note right: Events are generated according to the HistoryLevel
alt return false
  engine <-- history_level: false
else return true
  return true
  engine -> producer ++: createEvent()
  return event
  engine -> composite_handler ++: handleEvent()
  composite_handler -> db_handler ++: handleEvent()
  db_handler -> history_db++: saveRecord()
  return
  return
  return
end
@enduml
----

//== –ê–Ω—Ç–∏–ø–∞—Ç—Ç–µ—Ä–Ω–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —ñ—Å—Ç–æ—Ä–∏—á–Ω–æ—Å—Ç—ñ
== Anti-patterns of history usage

//–Ü—Å–Ω—É—î –¥–µ–∫—ñ–ª—å–∫–∞ –∞–Ω—Ç–∏–ø–∞—Ç—Ç–µ—Ä–Ω—ñ–≤ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —ñ—Å—Ç–æ—Ä–∏—á–Ω–æ—Å—Ç—ñ, —è–∫—ñ –Ω–∞–ø—Ä—è–º—É –≤–ø–ª–∏–≤–∞—é—Ç—å –Ω–∞ —à–≤–∏–¥–∫–æ–¥—ñ—é _–°–µ—Ä–≤—ñ—Å—É –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –±—ñ–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—ñ–≤_:

Several anti-patterns of history usage directly influence the _Business Process Management Service_ performance:

////
- –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è _History Database_ —É —è–∫–æ—Å—Ç—ñ —Å—Ö–æ–≤–∏—â–∞ –¥–æ–≤–≥–æ—Å—Ç—Ä–æ–∫–æ–≤–æ–≥–æ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏—Ö –¥–∞–Ω–∏—Ö –∑ —Ü—ñ–ª–ª—é –ø–æ–¥–∞–ª—å—à–æ–≥–æ —Ñ–æ—Ä–º—É–≤–∞–Ω–Ω—è –ø–æ—à—É–∫–æ–≤–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤
- –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –Ω–∞–¥–ª–∏—à–∫–æ–≤–æ–≥–æ —Ä—ñ–≤–Ω—è –ª–æ–≥—É–≤–∞–Ω–Ω—è –ø–æ–¥—ñ–π _HistoryLevel_, —è–∫–∏–π —Å–ø—Ä–∏—á–∏–Ω—è—î —Å—É—Ç—Ç—î–≤–∏–π —Ä—ñ—Å—Ç –∫—ñ–ª—å–∫–æ—Å—Ç—ñ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π –Ω–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ç–∞ —Ä—ñ—Å—Ç –æ–±'—î–º—É —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏—Ö –¥–∞–Ω–∏—Ö
- –í—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª—é –∑–∞ —Ä–æ—Å—Ç–æ–º –æ–±'—î–º—É —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏—Ö –¥–∞–Ω–∏—Ö –≤ _History Database_
- –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏—Ö –¥–∞–Ω–∏—Ö –∑ _History Database_ –ø—Ä–∏ –æ–±—Å–ª—É–≥–æ–≤—É–≤–∞–Ω–Ω—ñ –æ–ø–µ—Ä–∞—Ü—ñ–π–Ω–∏—Ö —Å—Ü–µ–Ω–∞—Ä—ñ—ó–≤ –≤–∑–∞—î–º–æ–¥—ñ—ó –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ —á–µ—Ä–µ–∑ –∫–∞–±—ñ–Ω–µ—Ç
- –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è _History Database_ –¥–ª—è –æ–±—Å–ª—É–≥–æ–≤—É–≤–∞–Ω–Ω—è —Å—Ü–µ–Ω–∞—Ä—ñ—ó–≤ –ø–µ—Ä–µ–≥–ª—è–¥—É —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏—Ö –¥–∞–Ω–∏—Ö —á–µ—Ä–µ–∑ –∫–∞–±—ñ–Ω–µ—Ç –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
////

* Using _History Database_ for long-term storage and further querying.
* Setting _HistoryLevel_ to a redundant level of events logging leads to a considerable increase in the amount of synchronous storage operations and volume of history data.
* Having no control over the accumulation of history data in the _History Database_.
* Using history data from the _History Database_ to serve operational scenarios of user interactions through the cabinet.
* Using _History Database_ to serve scenarios of viewing history data through the cabinet.

//== –ü—Ä–∏–Ω—Ü–∏–ø–∏, –∑–∞–∫–ª–∞–¥–µ–Ω—ñ –≤ –¥–∏–∑–∞–π–Ω —Ä—ñ—à–µ–Ω–Ω—è –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ —ñ—Å—Ç–æ—Ä–∏—á–Ω–æ—Å—Ç—ñ
== Principles built into the solution design to support proper history usage

////
- –†–æ–∑–º–µ–∂—É–≤–∞–Ω–Ω—è —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ–π –æ–ø–µ—Ä–∞—Ü—ñ–π–Ω–∏—Ö —Å—Ü–µ–Ω–∞—Ä—ñ—ó–≤ —Ç–∞ —Å—Ü–µ–Ω–∞—Ä—ñ—ó–≤ —Ä–æ–±–æ—Ç–∏ –∑ —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏–º–∏ –¥–∞–Ω–∏—Ö –Ω–∞ —Ä—ñ–≤–Ω—ñ –æ–∫—Ä–µ–º–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Ç–∞ —Å—Ö–æ–≤–∏—â –¥–∞–Ω–∏—Ö, —è–∫—ñ —ó—Ö –æ–±—Å–ª—É–≥–æ–≤—É—é—Ç—å
- –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –º—ñ–Ω—ñ–º–∞–ª—å–Ω–æ –¥–æ—Å—Ç–∞—Ç–Ω—å–æ–≥–æ –¥–ª—è –æ–±—Å–ª—É–≥–æ–≤—É–≤–∞–Ω–Ω—è —Å–∏—Å—Ç–µ–º–∏ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º —Ç–∞ —Å–ª—É–∂–±–æ—é –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ —Ä—ñ–≤–Ω—è –ª–æ–≥—É–≤–∞–Ω–Ω—è –ø–æ–¥—ñ–π _HistoryLevel_
- –û–±–º–µ–∂–µ–Ω–Ω—è –∑—Ä–æ—Å—Ç–∞–Ω–Ω—è –æ–±'—î–º—É —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏—Ö –¥–∞–Ω–∏—Ö –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –±—ñ–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—ñ–≤ —É —Å—Ö–æ–≤–∏—â—ñ —Å–µ—Ä–≤—ñ—Å—É –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –ë–ü –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—É —ó—Ö –≤–∏–¥–∞–ª–µ–Ω–Ω—è
- –û–±–º–µ–∂–µ–Ω–Ω—è –∂–∏—Ç—Ç—î–≤–æ–≥–æ —Ü–∏–∫–ª—É —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏—Ö –¥–∞–Ω–∏—Ö (_TTL_) —á–∞—Å–æ–º –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏—Ö –ë–ü –∑ –º–µ—Ç–æ—é –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö —É —è–∫–æ—Å—Ç—ñ –¥–æ–ø–æ–º—ñ–∂–Ω–∏—Ö –¥–ª—è —Å–ª—É–∂–±–∏ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏
- –§–æ—Ä–º—É–≤–∞–Ω–Ω—è –æ–∫—Ä–µ–º–æ–≥–æ –ø–æ—Ç–æ–∫—É –∑–Ω–∞—á—É—â–∏—Ö —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏—Ö –ø–æ–¥—ñ–π –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –ë–ü —Ç–∞ —ó—Ö –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞ –ø—É–±–ª—ñ–∫–∞—Ü—ñ—è —á–µ—Ä–µ–∑ –±—Ä–æ–∫–µ—Ä–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å _Kafka_ –∑ —Ü—ñ–ª–ª—é –ø–æ–¥–∞–ª—å—à–æ—ó –æ–±—Ä–æ–±–∫–∏ —Ç–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
- –û–±—Ä–æ–±–∫–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏—Ö –ø–æ–¥—ñ–π –ë–ü, –æ—Ç—Ä–∏–º–∞–Ω–∏—Ö —á–µ—Ä–µ–∑ –±—Ä–æ–∫–µ—Ä–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å _Kafka_ —Ç–∞ —ó—Ö –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤ –æ–∫—Ä–µ–º–µ _–°—Ö–æ–≤–∏—â–µ —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏—Ö –¥–∞–Ω–∏—Ö –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –ë–ü_ —É –¥–µ–Ω–æ—Ä–º–∞–ª—ñ–∑–æ–≤–∞–Ω—ñ–π —Ñ–æ—Ä–º—ñ
- –í–∏–∫–ª—é—á–µ–Ω–Ω—è –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏—Ö –¥–∞–Ω–∏—Ö –∑ _History Database_ —É —è–∫–æ—Å—Ç—ñ –¥–æ–ø–æ–º—ñ–∂–Ω–∏—Ö –ø—Ä–∏ –æ–±—Å–ª—É–≥–æ–≤—É–≤–∞–Ω–Ω—ñ –æ–ø–µ—Ä–∞—Ü—ñ–π–Ω–∏—Ö —Å—Ü–µ–Ω–∞—Ä—ñ—ó–≤
- –†–µ–∞–ª—ñ–∑–∞—Ü—ñ—è —Å—Ü–µ–Ω–∞—Ä—ñ—ó–≤ –ø–µ—Ä–µ–≥–ª—è–¥—É —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏—Ö –¥–∞–Ω–∏—Ö –∑ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è–º _–°—Ö–æ–≤–∏—â–µ —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏—Ö –¥–∞–Ω–∏—Ö –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –ë–ü_
////

* Implementing operational and history data usage scenarios separately on the level of individual components and databases.
* Setting _HistoryLevel_ to the minimal level of logging sufficient for administrators and support engineers to maintain the system.
* Enabling automatic history cleanup to limit the accumulation of business processes run history data in the BPMS database.
* Limiting history data's time to live (TTL) to the corresponding BP execution time when providing this data to support engineers.
* Generating a separate stream of meaningful BP run history events and publishing them asynchronously through the _Kafka_ message broker for further processing and storage.
* Processing BP history events messages from the _Kafka_ message broker and saving them to a separate _Process Execution History Database_ in a denormalized form.
* Making sure history data from the _History Database_ is not used as utility data for operational scenarios.
* Implementing history data viewing scenarios using the _Process Execution History Database_.

//== –¢–µ—Ö–Ω—ñ—á–Ω–∏–π –¥–∏–∑–∞–π–Ω —Ä—ñ—à–µ–Ω–Ω—è
== Solution technical design

//–ù–∞ –¥–∞–Ω—ñ–π –¥—ñ–∞–≥—Ä–∞–º—ñ –∑–æ–±—Ä–∞–∂–µ–Ω–æ –∑–∞–ª—É—á–µ–Ω—ñ –¥–ª—è —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó –≤–∏–º–æ–≥ —Å–µ—Ä–≤—ñ—Å–∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∏ —Ç–∞ –≤–∑–∞—î–º–æ–¥—ñ—é –º—ñ–∂ –Ω–∏–º–∏. –î–æ–¥–∞—Ç–∫–æ–≤–æ –∑–æ–±—Ä–∞–∂–µ–Ω–æ –≤–∞–∂–ª–∏–≤—ñ –æ—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ, —è–∫—ñ –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ –±—Ä–∞—Ç–∏ –¥–æ —É–≤–∞–≥–∏ –≤ —Ä–∞–º–∫–∞—Ö —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó.

The following diagram presents platform services involved in the implementation and their interactions. The diagram also outlines aspects that are important to consider during the implementation.

image::architecture/registry/operational/bpms/bpm-history.svg[]

//=== –ö–æ–º–ø–æ–Ω–µ–Ω—Ç–∏ –æ–±—Å–ª—É–≥–æ–≤—É–≤–∞–Ω–Ω—è —ñ—Å—Ç–æ—Ä–∏—á–Ω–æ—Å—Ç—ñ
=== Components of history maintenance

//==== –ü—É–±–ª—ñ–∫–∞—Ü—ñ—è —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏—Ö –ø–æ–¥—ñ–π
==== Publishing history events

//–ó –º–µ—Ç–æ—é –º—ñ–Ω—ñ–º—ñ–∑–∞—Ü—ñ—ó –≤–ø–ª–∏–≤—É –Ω–∞ —à–≤–∏–¥–∫–æ–¥—ñ—é –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –±—ñ–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—ñ–≤ —Ç–∞ —Ñ–æ—Ä–º—É–≤–∞–Ω–Ω—è –æ–∫—Ä–µ–º–æ–≥–æ —Å—Ö–æ–≤–∏—â–∞ —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏—Ö –¥–∞–Ω–∏—Ö, –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ —Ä–µ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ _Process Engine Plugin_ –∑ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–º _Process History Event Publisher_, —è–∫–∏–π –±—É–¥–µ –æ–±—Ä–æ–±–ª—è—Ç–∏ –ø–æ–¥—ñ—ó –∑ _HistoryLevel=AUDIT_ –≤—ñ–¥ _BPMN Core Engine_ —Ç–∞ –ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏ —ó—Ö –≤ –æ–∫—Ä–µ–º–∏–π —Ç–æ–ø—ñ–∫ –±—Ä–æ–∫–µ—Ä–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å _Kafka_.

To minimize the impact on the business processes performance and generate a separate history data storage,
we need
to implement the _Process Engine Plugin_ with the _Process History Event Publisher_ component
that will handle events with AUDIT history level from the _BPMN Core Engine_
and publish them to a separate topic of the _Kafka_ message broker.

//–†–æ–∑–≥–ª—è–Ω—É—Ç–∏ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó _–∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ —Ä—ñ–≤–Ω—è –ª–æ–≥—É–≤–∞–Ω–Ω—è —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏—Ö –ø–æ–¥—ñ–π_ –¥–ª—è –ø—É–±–ª—ñ–∫–∞—Ü—ñ—ó –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å —É _Kafka_ –∑–≥—ñ–¥–Ω–æ –∑ –Ω–∞—Å—Ç—É–ø–Ω–∏–º–∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏:

We need to consider implementing a _custom level of history events logging_ to publish messages to _Kafka_ using the following rules:

|===
|Resource|Event type|Resource identifier|Save operation

|*Process Instance*
|START, UPDATE, END
|-
|_INSERT OR UPDATE BPM_HISTORY_PROCESS BY PROCESS_INSTANCE_ID_

|*Task Instance*
|CREATE, UPDATE, COMPLETE
|-
|_INSERT OR UPDATE BPM_HISTORY_TASK BY ACTIVITY_INSTANCE_ID_

|*Variable Instance*
|CREATE, UPDATE, DELETE
|System variables: *sys-var-process-completion-result*, *sys-var-process-excerpt-id*
|_UPDATE BPM_HISTORY_PROCESS BY PROCESS_INSTANCE_ID_
|===

//==== –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –æ–ø—É–±–ª—ñ–∫–æ–≤–∞–Ω–∏—Ö —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏—Ö –ø–æ–¥—ñ–π
==== Saving published historical events

//–ó –º–µ—Ç–æ—é –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏—Ö –¥–∞–Ω–∏—Ö –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –±—ñ–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—ñ–≤, –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ —Ä–µ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç _User Process History Event Subscriber_, —è–∫–∏–π –±—É–¥–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω–∏–π –∑–∞ –æ–±—Ä–æ–±–∫—É –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å —Ç–æ–ø—ñ–∫–∞ —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏—Ö –ø–æ–¥—ñ–π –±—Ä–æ–∫–µ—Ä–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å _Kafka_ —Ç–∞ –ø–æ–¥–∞–ª—å—à–µ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤ –æ–∫—Ä–µ–º–µ —Å—Ö–æ–≤–∏—â–µ —É –¥–µ–Ω–æ—Ä–º–æ–ª—ñ–∑–æ–≤–∞–Ω–æ–º—É –≤–∏–≥–ª—è–¥—ñ.

To save business processes run history, we need to implement the _User Process History Event Subscriber_ component that will handle the messages from the history events topic of the _Kafka_ message broker and save them into a separate database in a denormalized form.

//==== API –¥–æ—Å—Ç—É–ø—É –¥–æ —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏—Ö –¥–∞–Ω–∏—Ö
==== History data access API

//–ó –º–µ—Ç–æ—é –Ω–∞–¥–∞–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º –∫–∞–±—ñ–Ω–µ—Ç—ñ–≤ –¥–æ—Å—Ç—É–ø—É –¥–æ —ó—Ö –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∏—Ö —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏—Ö –¥–∞–Ω–∏—Ö –ø—Ä–æ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –±—ñ–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—ñ–≤ —Ç–∞ –∑–∞–¥–∞—á, –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ —Ä–µ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –æ–∫—Ä–µ–º–∏–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç _User Process History Management_, —è–∫–∏–π –Ω–∞–¥–∞—î –Ω–µ–æ–±—Ö—ñ–¥–Ω–∏–π API –¥–ª—è –æ–±—Å–ª—É–≥–æ–≤—É–≤–∞–Ω–Ω—è —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤ –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–æ–≤–∞–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤.

To give cabinet users access to their personal history of business processes and tasks, we need to implement a separate _User Process History Management_ component that will provide the API necessary to support historical querying by authenticated users.

//=== –í–∑–∞—î–º–æ–¥—ñ—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ–≤ —Å–∏—Å—Ç–µ–º–∏
=== System components interaction

//–ù–∞ –¥–∞–Ω—ñ–π –¥—ñ–∞–≥—Ä–∞–º—ñ –ø–æ—Å–ª—ñ–¥–æ–≤–Ω–æ—Å—Ç—ñ —Å—Ö–µ–º–∞—Ç–∏—á–Ω–æ –∑–æ–±—Ä–∞–∂–µ–Ω–æ –∞–ª–≥–æ—Ä–∏—Ç–º –¥—ñ–π —Ñ—ñ–∫—Å–∞—Ü—ñ—ó —ñ—Å—Ç–æ—Ä–∏—á–Ω–æ—ó –ø–æ–¥—ñ—ó —É –ø—Ä–æ—Ü–µ—Å—ñ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –ë–ü:

The following sequence diagram presents the algorithm of logging history events when running a BP:

[plantuml]
----
@startuml
skinparam shadowing false
skinparam DatabaseBackgroundColor white
skinparam DatabaseBorderColor #2688d4
skinparam QueueBackgroundColor white
skinparam QueueBorderColor #2688d4
skinparam sequence {
    ArrowColor #2688d4
    ActorBorderColor #2688d4
    LifeLineBorderColor #2688d4
    ParticipantBorderColor #2688d4
    ParticipantBackgroundColor white
    BoxBorderColor #2688d4
    BoxBackgroundColor white
}

box "BPMS"
    participant "BPMN \nCore Engine" as engine
    participant "Composite History \nEvent Handler" as composite_handler
    participant "DB History \nEvent Handler" as db_handler
    participant "Process History \nEvent Publisher" as kafka_publisher
end box

box "BPM Database"
    database "History \nDatabase" as history_db
end box

box "Data Factory"
  queue "Kafka" as kafka
  participant "User Process History \nEvent Subscriber" as kafka_subscriber
end box

box "Citus"
  database "Process Execution \nHistory Database" as user_process_history_db
end box

engine -> composite_handler: handleEvent()
composite_handler -> db_handler: handleEvent()
  db_handler -> history_db: saveRecord()
  history_db --> db_handler
  db_handler --> composite_handler

composite_handler -> kafka_publisher
  kafka_publisher -> kafka: send()
    kafka --> kafka_publisher
  kafka_publisher --> composite_handler
composite_handler --> engine

kafka_subscriber -> kafka: consume()
kafka_subscriber -> user_process_history_db: saveRecord()
  user_process_history_db --> kafka_subscriber
kafka_subscriber --> kafka

@enduml
----

//== API –¥–æ—Å—Ç—É–ø—É –¥–æ —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏—Ö –¥–∞–Ω–∏—Ö –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –±—ñ–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—ñ–≤ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
== Get user's business processes history data API

//=== –û—Ç—Ä–∏–º–∞–Ω–Ω—è –ø–æ—Ç–æ—á–Ω–∏—Ö —ñ–Ω—ñ—Ü—ñ–π–æ–≤–∞–Ω–∏—Ö –±—ñ–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—ñ–≤
=== Get currently initiated business processes

[WARNING]
//–û—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–æ—Å—Ç—É–ø—É –¥–æ –¥–∞–Ω–∏—Ö –º–æ–∂–ª–∏–≤–µ –ª–∏—à–µ –≤ —Ä–∞–º–∫–∞—Ö –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∑–∞–ø–∏—Ç—É –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–æ–≤–∞–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –≤ —Å–∏—Å—Ç–µ–º—ñ.
Data access is limited to the requests from authenticated users.

//–Ü–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, –æ—Ç—Ä–∏–º–∞–Ω–∏–π –∑ _X-Access-Token_ HTTP-–∑–∞–≥–æ–ª–æ–≤–∫–∞ –∑–∞–ø–∏—Ç—É, –±–µ–∑—É–º–æ–≤–Ω–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è —É —è–∫–æ—Å—Ç—ñ –æ–±–æ–≤'—è–∑–∫–æ–≤–æ–≥–æ –∫—Ä–∏—Ç–µ—Ä—ñ—è –¥–ª—è —Ñ–æ—Ä–º—É–≤–∞–Ω–Ω—è –≤–∏–±—ñ—Ä–∫–∏ –¥–∞–Ω–∏—Ö –∑–∞ –ø–æ–ª–µ–º *"startUserId"*.

The user ID obtained from the request's _X-Access-Token_ HTTP header is mandatory when generating a data sample using the *startUserId* field.

[NOTE]
//–ü—Ä–∏ —Ñ–æ—Ä–º—É–≤–∞–Ω–Ω—ñ –∑–∞–ø–∏—Ç—ñ–≤ –Ω–∞ –≤–∏–±—ñ—Ä–∫—É –¥–∞–Ω–∏—Ö –±—ñ–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—ñ–≤ –±–µ–∑—É–º–æ–≤–Ω–æ –¥–æ–¥–∞—î—Ç—å—Å—è –∫—Ä–∏—Ç–µ—Ä—ñ–π –Ω–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –ë–ü –≤–µ—Ä—Ö–Ω—å–æ–≥–æ —Ä—ñ–≤–Ω—è (_SUPER_PROCESS_INSTANCE_ID IS NULL_)
When generating a business processes data sample request, a criterion for obtaining a top-level BP is added unconditionally (_SUPER_PROCESS_INSTANCE_ID IS NULL_).

*GET /api/process-instances*

|===
|Parameter|Type|Request part|Optional|Default value|Description

|*X-Access-Token*
|JWT
|HTTP header
|No
|-
|User access token

|*offset*
|Number
|Request parameter
|Yes
|_0_
|Record offset

|*limit*
|Number
|Request parameter
|Yes
|_10_
|Records limit

|*sort*
|String
|Request parameter
|Yes
|_desc(endTime)_
|Field to sort by and sort order.

_Example: asc(<field>) / desc(<field>)_
|===

.Sample response
[source, json]
----
[
    {
      "processInstanceId":  "",
      "superProcessInstanceId": "",
      "processDefinitionId": "",
      "processDefinitionKey": "",
      "processDefinitionName": "",
      "businessKey": "",
      "startTime": "",
      "startUserId": "",
      "status": {
        "code": "",
        "title": ""
      }
    }
]
----

.Error codes
|===
|Code|Description

a|[green]#200#
|OK with the request results in the message body
a|[red]#400#
|Incorrect request (wrong data format)
a|[yellow]#401#
|Authentication error (no access token)
a|[red]#500#
|Server-side error when processing the request
|===

//.–î—ñ–∞–≥—Ä–∞–º–∞ –ø–æ—Å–ª—ñ–¥–æ–≤–Ω–æ—Å—Ç—ñ –∑–∞–ø–∏—Ç—É –ø–æ—Ç–æ—á–Ω–∏—Ö –¥–∞–Ω–∏—Ö –±—ñ–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—ñ–≤
.Sequence diagram of the request to business processes current data
[plantuml]
----
@startuml
skinparam shadowing false
skinparam DatabaseBackgroundColor white
skinparam DatabaseBorderColor #2688d4
skinparam sequence {
    ArrowColor #2688d4
    ActorBorderColor #2688d4
    LifeLineBorderColor #2688d4
    ParticipantBorderColor #2688d4
    ParticipantBackgroundColor white
    BoxBorderColor #2688d4
    BoxBackgroundColor white
}

participant "Process History \nservice" as historyService
database "History \nDatabase" as history_db

-> historyService ++: Request \nprocess-instance list
historyService -> history_db ++: Select process-instance list with state in \n("ACTIVE", "SUSPENDED")
return requested list
historyService -> history_db ++: Select list of unfinished tasks by ACTIVE\nroot-process-instance-id list assigned to current user
return requested tasks
historyService -> historyService: Replace ACTIVE state with PENDING \nif there exists an unfinished task by process-instance id
historyService -> historyService: remap database "state" to status.code and define localized status.title
return Requested list
@enduml
----

//TODO: Omit localization table for en version?
.Statuses localization
|===
|Status|Localized status (Ukrainian)

|ACTIVE|–£ –≤–∏–∫–æ–Ω–∞–Ω–Ω—ñ
|PENDING|–û—á—ñ–∫—É—î –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∑–∞–¥–∞—á—ñ
|SUSPENDED|–ü—Ä–∏–∑—É–ø–∏–Ω–µ–Ω–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
|===

//=== –û—Ç—Ä–∏–º–∞–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó —ñ–Ω—ñ—Ü—ñ–π–æ–≤–∞–Ω–∏—Ö –±—ñ–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—ñ–≤
=== Get initiated business processes history

[WARNING]
//–û—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–æ—Å—Ç—É–ø—É –¥–æ —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏—Ö –¥–∞–Ω–∏—Ö –º–æ–∂–ª–∏–≤–µ –ª–∏—à–µ –≤ —Ä–∞–º–∫–∞—Ö –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∑–∞–ø–∏—Ç—É –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–æ–≤–∞–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –≤ —Å–∏—Å—Ç–µ–º—ñ.
Data access is limited to the requests from authenticated users.

//–Ü–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, –æ—Ç—Ä–∏–º–∞–Ω–∏–π –∑ _X-Access-Token_ HTTP-–∑–∞–≥–æ–ª–æ–≤–∫–∞ –∑–∞–ø–∏—Ç—É, –±–µ–∑—É–º–æ–≤–Ω–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è —É —è–∫–æ—Å—Ç—ñ –æ–±–æ–≤'—è–∑–∫–æ–≤–æ–≥–æ –∫—Ä–∏—Ç–µ—Ä—ñ—è –¥–ª—è —Ñ–æ—Ä–º—É–≤–∞–Ω–Ω—è –≤–∏–±—ñ—Ä–∫–∏ –¥–∞–Ω–∏—Ö –∑–∞ –ø–æ–ª–µ–º *"startUserId"*.

The user ID obtained from the request's _X-Access-Token_ HTTP header is mandatory when generating a data sample using the *startUserId* field.

[NOTE]
//–ü—Ä–∏ —Ñ–æ—Ä–º—É–≤–∞–Ω–Ω—ñ –∑–∞–ø–∏—Ç—ñ–≤ –Ω–∞ –≤–∏–±—ñ—Ä–∫—É —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏—Ö –¥–∞–Ω–∏—Ö –±—ñ–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—ñ–≤ –±–µ–∑—É–º–æ–≤–Ω–æ –¥–æ–¥–∞—î—Ç—å—Å—è –∫—Ä–∏—Ç–µ—Ä—ñ–π –Ω–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –ë–ü –≤–µ—Ä—Ö–Ω—å–æ–≥–æ —Ä—ñ–≤–Ω—è (_SUPER_PROCESS_INSTANCE_ID IS NULL_)
When generating a business processes data sample request, a criterion for obtaining a top-level BP is added unconditionally (_SUPER_PROCESS_INSTANCE_ID IS NULL_).

*GET /api/history/process-instances*

|===
|Parameter|Type|Request part|Optional|Default value|Description

|*X-Access-Token*
|JWT
|HTTP header
|No
|-
|User access token

|*offset*
|Number
|Request parameter
|Yes
|_0_
|Record offset

|*limit*
|Number
|Request parameter
|Yes
|_10_
|Records limit

|*sort*
|String
|Request parameter
|Yes
|_desc(endTime)_
|Field to sort by and sort order.

_Example: asc(<field>) / desc(<field>)_
|===

.Sample response
[source, json]
----
[
    {
      "processInstanceId":  "",
      "superProcessInstanceId": "",
      "processDefinitionId": "",
      "processDefinitionKey": "",
      "processDefinitionName": "",
      "businessKey": "",
      "startTime": "",
      "endTime": "",
      "startUserId": "",
      "excerptId": "",
      "status": {
        "code": "",
        "title": ""
      }
    }
]
----

.Error codes
|===
|Code|Description

a|[green]#200#
|OK with the request results in the message body
a|[red]#400#
|Incorrect request (wrong data format)
a|[yellow]#401#
|Authentication error (no access token)
a|[red]#500#
|Server-side error when processing the request
|===

//.–î—ñ–∞–≥—Ä–∞–º–∞ –ø–æ—Å–ª—ñ–¥–æ–≤–Ω–æ—Å—Ç—ñ –∑–∞–ø–∏—Ç—É —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏—Ö –¥–∞–Ω–∏—Ö –±—ñ–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—ñ–≤
.Sequence diagram of the request to business processes history data
[plantuml]
----
@startuml
skinparam shadowing false
skinparam DatabaseBackgroundColor white
skinparam DatabaseBorderColor #2688d4
skinparam sequence {
    ArrowColor #2688d4
    ActorBorderColor #2688d4
    LifeLineBorderColor #2688d4
    ParticipantBorderColor #2688d4
    ParticipantBackgroundColor white
    BoxBorderColor #2688d4
    BoxBackgroundColor white
}

participant "Process History \nservice" as historyService
database "History \nDatabase" as history_db

-> historyService ++: Request \nprocess-instance list
historyService -> history_db ++: Select process-instance list with state in \n("COMPLETED", "EXTERNALLY_TERMINATED")
return requested list
historyService -> historyService: remap database "state" to status.code and define localized status.title
return Requested list
@enduml
----

//TODO: Omit localization table for en version?
.Statuses localization
|===
|Status|Localized status (Ukrainian)

|completionResult != null| –ó–Ω–∞—á–µ–Ω–Ω—è completionResult
|COMPLETED|–ù–∞–¥–∞–Ω–Ω—è –ø–æ—Å–ª—É–≥–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–æ
|EXTERNALLY_TERMINATED|–í—ñ–¥–º—ñ–Ω–µ–Ω–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
|===

//=== –û—Ç—Ä–∏–º–∞–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó –≤–∏–∫–æ–Ω–∞–Ω–∏—Ö –∑–∞–¥–∞—á –±—ñ–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—ñ–≤
=== Get completed business process tasks history

[WARNING]
//–û—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–æ—Å—Ç—É–ø—É –¥–æ —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏—Ö –¥–∞–Ω–∏—Ö –º–æ–∂–ª–∏–≤–µ –ª–∏—à–µ –≤ —Ä–∞–º–∫–∞—Ö –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∑–∞–ø–∏—Ç—É –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–æ–≤–∞–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –≤ —Å–∏—Å—Ç–µ–º—ñ.
Data access is limited to the requests from authenticated users.

//–Ü–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, –æ—Ç—Ä–∏–º–∞–Ω–∏–π –∑ _X-Access-Token_ HTTP-–∑–∞–≥–æ–ª–æ–≤–∫–∞ –∑–∞–ø–∏—Ç—É, –±–µ–∑—É–º–æ–≤–Ω–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è —É —è–∫–æ—Å—Ç—ñ –æ–±–æ–≤'—è–∑–∫–æ–≤–æ–≥–æ –∫—Ä–∏—Ç–µ—Ä—ñ—è –¥–ª—è —Ñ–æ—Ä–º—É–≤–∞–Ω–Ω—è –≤–∏–±—ñ—Ä–∫–∏ –¥–∞–Ω–∏—Ö –∑–∞ –ø–æ–ª–µ–º *"assignee"*.

The user ID obtained from the request's _X-Access-Token_ HTTP header is mandatory when generating a data sample using the *assignee* field.

*GET /api/history/tasks*

|===
|Parameter|Type|Request part|Optional|Default value|Description

|*X-Access-Token*
|JWT
|HTTP header
|No
|-
|User access token

|*offset*
|Number
|Request parameter
|Yes
|_0_
|Record offset

|*limit*
|Number
|Request parameter
|Yes
|_10_
|Records limit

|*sort*
|String
|Request parameter
|Yes
|_desc(endTime)_
|Field to sort by and sort order.

_Example: asc(<field>) / desc(<field>)_
|===

.Sample response
[source, json]
----
[
    {
      "activityInstanceId":  "",
      "taskDefinitionKey": "",
      "taskDefinitionName": "",
      "processInstanceId": "",
      "processDefinitionId": "",
      "processDefinitionKey": "",
      "processDefinitionName": "",
      "startTime": "",
      "endTime": "",
      "assignee": ""
    }
]
----

.Error codes
|===
|Code|Description

a|[green]#200#
|OK with the request results in the message body
a|[red]#400#
|Incorrect request (wrong data format)
a|[yellow]#401#
|Authentication error (no access token)
a|[red]#500#
|Server-side error when processing the request
|===

//== –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —ñ—Å—Ç–æ—Ä–∏—á–Ω–æ—Å—Ç—ñ –¥–∞–Ω–∏—Ö –≤ _–°–µ—Ä–≤—ñ—Å—ñ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –±—ñ–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—ñ–≤_
== Configuring history data in Business Process Management Service

//=== –§—ñ–∫—Å–∞—Ü—ñ—è —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏—Ö –ø–æ–¥—ñ–π –±—ñ–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—ñ–≤
=== Logging business processes history events

//–í –ø—Ä–æ—Ü–µ—Å—ñ –µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—ó —Å–∏—Å—Ç–µ–º–∏ –º–æ–∂–µ –≤–∏–Ω–∏–∫–∞—Ç–∏ –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ—Å—Ç—å –∑–∞–ª—É—á–µ–Ω–Ω—è —Å–ª—É–∂–±–∏ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ –¥–ª—è –¥–æ—Å–ª—ñ–¥–∂–µ–Ω–Ω—è –ø–æ–º–∏–ª–æ–∫ —Ç–∞ –ø—Ä–∏—á–∏–Ω –∑—É–ø–∏–Ω–∫–∏ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –±—ñ–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—ñ–≤ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤. –î–ª—è –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è –º–æ–∂–ª–∏–≤–æ—Å—Ç–µ–π –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ–≥–æ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É _Camunda Cockpit_ –∑ –º–µ—Ç–æ—é –ø–µ—Ä–µ–≥–ª—è–¥—É —Å—Ç–∞–Ω—É –±—ñ–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—É —Ç–∞ –π–æ–≥–æ –∑–º—ñ–Ω–Ω–∏—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è —Ä—ñ–≤–Ω—è –ª–æ–≥—É–≤–∞–Ω–Ω—è —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏—Ö –ø–æ–¥—ñ–π –∑–∞ –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ—Å—Ç—é –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ _camunda.bpm.database-history-level_.

When working with the system, users may require the support team to investigate errors and find the reasons why the users' business processes have stopped. To fully utilize the _Camunda Cockpit_ admin interface to monitor business process status and variables, we recommend setting the required level of history events logging using the _camunda.bpm.database-history-level_ property.

////
.–ú–æ–∂–ª–∏–≤—ñ –∑–Ω–∞—á–µ–Ω–Ω—è *camunda.bpm.database-history-level*:
- *NONE* (–∑–∞–ø–∏—Å —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏—Ö –ø–æ–¥—ñ–π –≤ –ë–î –Ω–µ –ø—Ä–æ–≤–æ–¥–∏—Ç—å—Å—è, —Ç–∞–∫–∏–º —á–∏–Ω–æ–º –º—ñ–Ω—ñ–º—ñ–∑—É—î—Ç—å—Å—è –≤–ø–ª–∏–≤ –Ω–∞ —à–≤–∏–¥–∫–æ–¥—ñ—é)
- *ACTIVITY* (—Ñ—ñ–∫—Å—É—é—Ç—å—Å—è –∑–Ω–∞—á—É—â—ñ —ñ—Å—Ç–æ—Ä–∏—á–Ω—ñ –ø–æ–¥—ñ—ó –Ω–∞–¥ –æ–±'—î–∫—Ç–∞–º–∏: PROCESS, ACTIVITY, TASK)
- *AUDIT* (–¥–æ–¥–∞—Ç–∫–æ–≤–æ —Ñ—ñ–∫—Å—É—é—Ç—å—Å—è –ø–æ–¥—ñ—ó –Ω–∞–¥ –∑–º—ñ–Ω–Ω–∏–º–∏ –ë–ü)
- *FULL* (–¥–æ–¥–∞—Ç–∫–æ–≤–æ –ª–æ–≥—É—î—Ç—å—Å—è —ñ—Å—Ç–æ—Ä—ñ—è –∑–º—ñ–Ω –∑–º—ñ–Ω–Ω–∏—Ö –ë–ü. –ù–µ —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ –¥–ª—è –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –ø–æ –ø—Ä–∏—á–∏–Ω—ñ –Ω–∞–π–±—ñ–ª—å—à–æ–≥–æ –≤–ø–ª–∏–≤—É –Ω–∞ —à–≤–∏–¥–∫–æ–¥—ñ—é)
////

.The *camunda.bpm.database-history-level* property can have the following values:
* *NONE* -- No history events are logged into the database, which minimizes impact on performance.
* *ACTIVITY* -- Meaningful history events are logged for these objects: PROCESS, ACTIVITY, TASK.
* *AUDIT* -- In addition to the events provided by the ACTIVITY history level, BP variables events are logged.
* *FULL* -- In addition to the events provided by the AUDIT history level, BP variables change history is logged. Not recommended due to maximum impact on performance.

[NOTE]
--
////
–ó–∞ –∑–∞–º–æ–≤—á–µ–Ω–Ω—è–º, —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –Ω–∞—Å—Ç—É–ø–Ω—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è:

- camunda.bpm.history-level: AUDIT
- camunda.bpm.database-history-level: ACTIVITY

–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ø–æ—Ç—Ä–µ–±—É—é—Ç—å –∫–æ—Ä–µ–≥—É–≤–∞–Ω–Ω—è –≤ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –≤—ñ–¥ —Å—Ç–∞–±—ñ–ª—å–Ω–æ—Å—Ç—ñ —Å–∏—Å—Ç–µ–º–∏ —Ç–∞ –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ—Å—Ç—ñ –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è —à–≤–∏–¥–∫–æ–¥—ñ—ó / —Ä—ñ–≤–Ω—è –¥–µ—Ç–∞–ª—ñ–∑–∞—Ü—ñ—ó –ø–æ–¥—ñ–π –≤ —Å–∏—Å—Ç–µ–º—ñ.
////
The following default settings are recommended:

* camunda.bpm.history-level: AUDIT
* camunda.bpm.database-history-level: ACTIVITY

The settings need to be adjusted depending on the system's stability and the need to improve performance or increase the level of events detail.
--

[TIP]
//–ó –º–µ—Ç–æ—é –ø–æ–¥–∞–ª—å—à–æ—ó –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó —à–≤–∏–¥–∫–æ–¥—ñ—ó, —ñ—Å–Ω—É—î –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ —Ä—ñ–≤–Ω—è –ª–æ–≥—É–≤–∞–Ω–Ω—è —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏—Ö –ø–æ–¥—ñ–π —É –≤–∏–≥–ª—è–¥—ñ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó _TypeBasedHistoryLevel_ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É —Ç–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –≤ Process Engine –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó.
To further improve performance, it is possible to provide a custom level of history events logging by implementing the _TypeBasedHistoryLevel_ interface and registering it in the Process Engine configuration.

[WARNING]
//–î–ª—è –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è —Ä—ñ–≤–Ω—è —Ñ—ñ–∫—Å–∞—Ü—ñ—ó —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏—Ö –ø–æ–¥—ñ–π –Ω–µ —Å–ª—ñ–¥ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ _camunda.bpm.history-level_ –æ—Å–∫—ñ–ª—å–∫–∏ —Ü—è –ø—Ä–æ–ø–µ—Ä—Ç—ñ –≤–∏–∑–Ω–∞—á–∞—î —Ä—ñ–≤–µ–Ω—å *—Å—Ç–≤–æ—Ä–µ–Ω–Ω—è* —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏—Ö –ø–æ–¥—ñ–π, –∞ –Ω–µ —Ä—ñ–≤–µ–Ω—å —Ñ—ñ–ª—å—Ç—Ä—É–≤–∞–Ω–Ω—è —ó—Ö –ø–µ—Ä–µ–¥ –æ–±—Ä–æ–±–ª–µ–Ω–Ω—è–º. –°–ª—ñ–¥ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –∫–∞—Å—Ç–æ–º–Ω—É –ø—Ä–æ–ø–µ—Ä—Ç—ñ _camunda.bpm.database-history-level_.
The _camunda.bpm.history-level_ property should not be used to define the history events logging level because this property defines the level of *generating* history events, not the level of their filtering prior to processing. The _camunda.bpm.database-history-level_ custom property should be used instead.

//=== –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –≤–∏–¥–∞–ª–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏—Ö –ø–æ–¥—ñ–π
=== Automatic history cleanup

[WARNING]
//–ó–∞–ø—Ä–æ–ø–æ–Ω–æ–≤–∞–Ω–∏–π –º–µ—Ö–∞–Ω—ñ–∑–º –≤–∏–¥–∞–ª–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏—Ö –¥–∞–Ω–∏—Ö –±—ñ–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—ñ–≤ –æ—Ä—ñ—î–Ω—Ç–æ–≤–∞–Ω–∏–π –Ω–∞ –µ–∫–∑–µ–º–ø–ª—è—Ä–∏ –ø—Ä–æ—Ü–µ—Å—ñ–≤ —Ç–∞ –Ω–µ –º–∞—î –≤—ñ–¥–Ω–æ—à–µ–Ω–Ω—è –¥–æ "–º–µ—Ç–∞–¥–∞–Ω–∏—Ö", —è–∫—ñ –Ω–∞–ª–µ–∂–∞—Ç—å –∑–∞—Å—Ç–∞—Ä—ñ–ª–∏–º –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–º –≤–µ—Ä—Å—ñ—è–º _Deployment_.–£ —Ä–∞–∑—ñ –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ—Å—Ç—ñ, –≤–∏–¥–∞–ª–µ–Ω–Ω—è –∑–∞—Å—Ç–∞—Ä—ñ–ª–∏—Ö –≤–µ—Ä—Å—ñ–π –º–∞—î –±—É—Ç–∏ —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ –æ–∫—Ä–µ–º–æ.
The suggested mechanism of business processes history cleanup is intended for process instances and has no impact on the metadata that belongs to the currently installed and outdated versions of _Deployment_. Should the need arise, removing outdated versions can be implemented separately.

//–î–ª—è –ø–æ–ª—ñ–ø—à–µ–Ω–Ω—è —à–≤–∏–¥–∫–æ–¥—ñ—ó —Ç–∞ –∑–º–µ–Ω—à–µ–Ω–Ω—è —Ä–æ—Å—Ç—É –æ–±'—î–º—É —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏—Ö –¥–∞–Ω–∏—Ö, –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ –≤–ø—Ä–æ–≤–∞–¥–∏—Ç–∏ –Ω–∞—Å—Ç—É–ø–Ω—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –¥–ª—è _–°–µ—Ä–≤—ñ—Å—É –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –±—ñ–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—ñ–≤_ –∑–∞–¥–ª—è –≤–ø—Ä–æ–≤–∞–¥–∂–µ–Ω–Ω—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—É –≤–∏–¥–∞–ª–µ–Ω–Ω—è –∑–∞—Å—Ç–∞—Ä—ñ–ª–∏—Ö –¥–∞–Ω–∏—Ö –∑–∞ _Removal-Time-based_ —Å—Ç—Ä–∞—Ç–µ–≥—ñ—î—é:

To improve performance and reduce the accumulation of history data, it is necessary to apply the following settings to the _Business Process Management Service_. This implements the automatic process of deleting outdated data using the _Removal-Time-based_ strategy:

|===
|Setting|Value|Description

|*historyCleanupEnabled*
|_true_
//|–ê–∫—Ç–∏–≤–∞—Ü—ñ—è –º–µ—Ö–∞–Ω—ñ–∑–º—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –ø–µ—Ä—ñ–æ–¥–∏—á–Ω–æ–≥–æ –≤–∏–¥–∞–ª–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏—Ö –¥–∞–Ω–∏—Ö
|Enable history cleanup execution on a regular basis.

|*historyCleanupStrategy*
|_removalTimeBased_
//|–°—Ç—Ä–∞—Ç–µ–≥—ñ—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏—Ö –¥–∞–Ω–∏—Ö –∑–∞ –ø—Ä–∏–Ω—Ü–∏–ø–æ–º _removal time = base time + TTL_
|Enable the Removal-Time-based history cleanup strategy (_removal time = base time + TTL_).

|*historyRemovalTimeStrategy*
|_end_
//|–í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è _base time_ –¥–ª—è —Ñ–æ—Ä–º—É–≤–∞–Ω–Ω—è _removal time_ —á–∞—Å—É –≤–∏–¥–∞–ª–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏—Ö –¥–∞–Ω–∏—Ö –ë–ü
|Configure _base time_ to define _removal time_ for BP history cleanup.

|*historyTimeToLive*
|_P1D_
//|–í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è _TTL_ –¥–ª—è —Ñ–æ—Ä–º—É–≤–∞–Ω–Ω—è _removal time_ —á–∞—Å—É –≤–∏–¥–∞–ª–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏—Ö –¥–∞–Ω–∏—Ö –ë–ü
|Configure _TTL_ to define _removal time_ for BP history cleanup.

|*historyCleanupBatchWindowStartTime*
|_20:00_
//|–Ü–Ω—ñ—Ü—ñ—é–≤–∞–Ω–Ω—è –ø—Ä–æ—Ü–µ—Å—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –∫–æ–∂–Ω–æ–≥–æ –¥–Ω—è, –ø–æ—á–∏–Ω–∞—é—á–∏ –∑ –≤–∫–∞–∑–∞–Ω–æ–≥–æ —á–∞—Å—É
|Specify the start time of the batch window during which daily cleanup should run.

|*historyCleanupBatchWindowEndTime*
|_22:00_
//|–ó–∞–∫—ñ–Ω—á–µ–Ω–Ω—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –∫–æ–∂–Ω–æ–≥–æ –¥–Ω—è —É –≤–∫–∞–∑–∞–Ω–∏–π —á–∞—Å
|Specify the end time of the batch window during which daily cleanup should run.

|*historyCleanupDegreeOfParallelism*
|_1_
//|–°—Ç—É–ø—ñ–Ω—å –ø–∞—Ä–∞–ª–µ–ª—ñ–∑–∞—Ü—ñ—ó –ø—Ä–æ—Ü–µ—Å—É –≤–∏–¥–∞–ª–µ–Ω–Ω—è (–∫—ñ–ª—å–∫—ñ—Å—Ç—å –∑–∞–ª—É—á–µ–Ω–∏—Ö –ø–æ—Ç–æ–∫—ñ–≤)
|Set the degree of parallel execution for history cleanup (the number of job executor threads).

|*historyCleanupBatchSize*
|_500_
//|–ö—ñ–ª—å–∫—ñ—Å—Ç—å –µ–∫–∑–µ–º–ø–ª—è—Ä—ñ–≤ –ë–ü –¥–ª—è —è–∫–∏—Ö –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏—Ö –¥–∞–Ω–∏—Ö –≤ —Ä–∞–º–∫–∞—Ö –æ–¥–Ω—ñ—î—ó —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó
|Set the number of BP instances removed in one cleanup transaction.
|===

== Business processes history data model

//–£ –∫–æ–Ω—Ç–µ–∫—Å—Ç—ñ —Ä–æ–±–æ—Ç–∏ –∑ —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏–º–∏ –¥–∞–Ω–∏–º–∏, —ñ—Å–Ω—É—î –¥–≤–∞ –æ—Å–Ω–æ–≤–Ω–∏—Ö —Å—Ü–µ–Ω–∞—Ä—ñ—ó –≤–∑–∞—î–º–æ–¥—ñ—ó –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ —á–µ—Ä–µ–∑ –∫–∞–±—ñ–Ω–µ—Ç:

When working with history data, there are two main scenarios of user interaction through the cabinet:

////
- –û—Ç—Ä–∏–º–∞–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó —ñ–Ω—ñ—Ü—ñ–π–æ–≤–∞–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º —Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—Ö –±—ñ–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—ñ–≤
- –û—Ç—Ä–∏–º–∞–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó –≤–∏–∫–æ–Ω–∞–Ω–∏—Ö –∑–∞–¥–∞—á –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
////

* Getting the history of business processes started and finished by the user
* Getting the history of user's completed tasks

//–î–ª—è –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∑–∞–ø–∏—Ç—ñ–≤, —ñ—Å—Ç–æ—Ä–∏—á–Ω—ñ –¥–∞–Ω—ñ –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ –∑–±–µ—Ä—ñ–≥–∞—Ç–∏ —É –¥–µ–Ω–æ—Ä–º–∞–ª—ñ–∑–æ–≤–∞–Ω–æ–º—É –≤–∏–≥–ª—è–¥—ñ –≤  –æ–∫—Ä–µ–º–æ–º—É —Å—Ö–æ–≤–∏—â—ñ:

To optimize these requests, history data should be stored in a denormalized form in a separate storage:

////
- *BPM_HISTORY_PROCESS* - —ñ—Å—Ç–æ—Ä–∏—á–Ω—ñ –¥–∞–Ω—ñ –±—ñ–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—ñ–≤
- *BPM_HISTORY_TASK* - —ñ—Å—Ç–æ—Ä–∏—á–Ω—ñ –¥–∞–Ω—ñ –∑–∞–¥–∞—á
////

* *BPM_HISTORY_PROCESS* - Business processes history
* *BPM_HISTORY_TASK* - Tasks history

[NOTE]
//–í—ñ–¥–Ω–æ—à–µ–Ω–Ω—è/–∑–≤'—è–∑–æ–∫ –º—ñ–∂ —Ç–∞–±–ª–∏—Ü—è–º–∏ –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞–≤–º–∏—Å–Ω–æ, –æ—Å–∫—ñ–ª—å–∫–∏ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ –¥–µ–Ω–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—ó –º—ñ—Å—Ç—è—Ç—å –≤–µ—Å—å –Ω–µ–æ–±—Ö—ñ–¥–Ω–∏–π –Ω–∞–±—ñ—Ä –∞—Ç—Ä–∏–±—É—Ç—ñ–≤ –¥–ª—è –æ–±—Å–ª—É–≥–æ–≤—É–≤–∞–Ω–Ω—è —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤ —Ç–∞ –Ω–∞–ø–æ–≤–Ω—é—é—Ç—å—Å—è –¥–∞–Ω–∏–º–∏ –Ω–µ–∑–∞–ª–µ–∂–Ω–æ –æ–¥–Ω–∞ –≤—ñ–¥ –æ–¥–Ω–æ—ó.
A relationship between these tables was not defined on purpose. After denormalization both tables contain all the necessary attributes to serve historical requests and get data independently.

[plantuml]
----
@startuml

skinparam shadowing false
skinparam class {
    BackgroundColor white
    BorderColor #2688d4
}
!define table(x) entity x << (T, white) >>
!define primary_key(x) <b><color:#b8861b><&key></color> x</b>
!define column(x) <color:#efefef><&media-record></color> x
hide methods
hide stereotypes

table( BPM_HISTORY_PROCESS ) {
    primary_key( PROCESS_INSTANCE_ID ): VARCHAR
    column( SUPER_PROCESS_INSTANCE_ID ): VARCHAR
    column( PROCESS_DEFINITION_ID ): VARCHAR
    column( PROCESS_DEFINITION_KEY ): VARCHAR
    column( PROCESS_DEFINITION_NAME ): VARCHAR
    column( BUSINESS_KEY ): VARCHAR
    column( START_TIME ): DATETIME
    column( END_TIME ): DATETIME
    column( START_USER_ID ): VARCHAR
    column( STATE ): VARCHAR
    column( EXCERPT_ID ): VARCHAR
    column( COMPLETION_RESULT ): VARCHAR
}

table( BPM_HISTORY_TASK ) {
    primary_key( ACTIVITY_INSTANCE_ID ): VARCHAR
    column( TASK_DEFINITION_KEY ): VARCHAR
    column( TASK_DEFINITION_NAME ): VARCHAR
    column( PROCESS_INSTANCE_ID ): VARCHAR
    column( PROCESS_DEFINITION_ID ): VARCHAR
    column( PROCESS_DEFINITION_KEY ): VARCHAR
    column( PROCESS_DEFINITION_NAME ): VARCHAR
    column( START_TIME ): DATETIME
    column( END_TIME ): DATETIME
    column( ASSIGNEE ): VARCHAR
}
@enduml
----