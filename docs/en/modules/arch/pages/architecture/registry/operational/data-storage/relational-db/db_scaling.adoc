:toc-title: On this page:
:toc: auto
:toclevels: 5
:experimental:
:sectnums:
:sectnumlevels: 5
:sectanchors:
:sectlinks:
:partnums:

= Scaling PostgreSQL instances

NOTE: üåê This document is available in both English and Ukrainian. Use the language toggle in the top right corner to switch between versions.

//–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–µ –º–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è —Ç—Ä–∞–¥–∏—Ü—ñ–π–Ω–∏—Ö –±–∞–∑ –¥–∞–Ω–∏—Ö —Ä–æ–∑–ø–∞–¥–∞—î—Ç—å—Å—è –Ω–∞ –¥–≤—ñ –¥—É–∂–µ —Ä—ñ–∑–Ω—ñ –ø—ñ–¥—Ö–æ–¥–∏: –º–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è —á–∏—Ç–∞–Ω–Ω—è —ñ –º–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è –∑–∞–ø–∏—Å—É. –Ñ–¥–∏–Ω–∏–π —Å–ø–æ—Å—ñ–± –º–∞—Å—à—Ç–∞–±—É–≤–∞—Ç–∏ –∑–∞–ø–∏—Å –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—ñ - —Ü–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —à–∞—Ä–¥—ñ–Ω–≥ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö. –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–µ –º–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è —á–∏—Ç–∞–Ω–Ω—è –º–æ–∂–ª–∏–≤–µ —à–ª—è—Ö–æ–º —Ä–æ–∑–¥—ñ–ª–µ–Ω–Ω—è —á–∏—Ç–∞–Ω–Ω—è/–∑–∞–ø–∏—Å—É.

There are two vastly different approaches to horizontal scaling of traditional databases: read scalability and write scalability. The only way to achieve horizontal write scalability is by using database sharding. Horizontal read scalability is achievable by separating reads and writes.

//–ü–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º –Ω–∞—à–∏—Ö –¥–æ—Å–ª—ñ–¥–∂–µ–Ω–Ω—å —ñ —Ç–µ—Å—Ç—ñ–≤ —Ä—ñ—à–µ–Ω–Ω—è Citus, –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —à–∞—Ä–¥—É–≤–∞–Ω–Ω—è –≤–∏—è–≤–∏–ª–æ—Å—å –Ω–µ–¥–æ—Ü—ñ–ª—å–Ω–∏–º. –ë—É–ª–∏ –≤–∏—è–≤–ª–µ–Ω—ñ –¥–≤—ñ –æ—Å–Ω–æ–≤–Ω—ñ –ø—Ä–æ–±–ª–µ–º–∏. –ü–µ—Ä—à–∞ - —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑–∏ –¥–∞–Ω–Ω–∏—Ö BPMS (camunda) –Ω–µ –¥–æ–∑–≤–æ–ª—è—î —à–∞—Ä–¥—É–≤–∞—Ç–∏ —Ç–∞–±–ª–∏—Ü—ñ —Ç–∞–∫–∏–º —á–∏–Ω–æ–º —â–æ–± –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ –∑–±—ñ–ª—å—à–µ–Ω–Ω—è –∫—ñ–ª—å–∫–æ—Å—Ç—ñ —Ä–æ–±–æ—á–∏—Ö –ø–æ–¥—ñ–≤ –∑–±—ñ–ª—å—à—É–≤–∞–ª–∞—Å—å –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å. –í —É—Å—ñ—Ö –≤–∏–ø—Ä–æ–±—É–≤–∞–Ω–∏—Ö –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è—Ö –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å –Ω–∞–≤–ø–∞–∫–∏ –ø–∞–¥–∞—î. –î—Ä—É–≥–∞ - –ø—Ä–∏ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ –∑–∞–ø–∏—Ç–∞–º–∏ –Ω–∞ —à–∞—Ä–¥–æ–≤–∞–Ω—ñ —Ç–∞–±–ª–∏—Ü—ñ —á–∞—Å–æ–º –≤–∏–Ω–∏–∫–∞—é—Ç—å —Ä–æ–∑–ø–æ–¥—ñ–ª–µ–Ω–Ω—ñ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è.

Based on our research and Citus solution tests, sharding turned out to be impractical. We found two key issues. First, BPMS (Camunda) database structure does not allow sharding the tables in such a way that increasing the number of working pods would increase performance. On the contrary, performance decreased in all the configurations that were tested. Second, loading the sharded tables with requests sometimes leads to distributed locks.

//–©–æ —Å—Ç–æ—Å—É—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –º–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è, —Ç–æ —Ü–µ –º–æ–∂–ª–∏–≤–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç, –∞–ª–µ –º–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è –ø–æ–≤‚Äô—è–∑–∞–Ω–µ –∑ —Ç–∏–º—á–∞—Å–æ–≤–∏–º –≤–µ–ª–∏–∫–∏–º –ø–∞–¥—ñ–Ω–Ω—è–º –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ. –¢–æ–º—É –∑–∞–∑–≤–∏—á–∞–π —Ü–µ –º–∞—î —Å–µ–Ω—Å —è–∫ –º–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è –∑–∞ –≥—Ä–∞—Ñ—ñ–∫–æ–º, –ø–æ–≤‚Äô—è–∑–∞–Ω–µ —ñ–∑ –∑–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–æ—é –∑–º—ñ–Ω–æ—é –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è.

Automatic horizontal scaling is a viable option, but it involves a substantial drop in performance, albeit temporarily. This scaling approach usually makes sense to use on a schedule tied to planned load changes.

//== –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–ª–∞—Å—Ç–µ—Ä–∞ PostgreSQL
== PostgreSQL cluster structure

image::architecture/registry/operational/data-storage/relational-db/postgres_cluster.svg[PostgreSQL cluster]

Applications::
BPMS, data fabric, User/Excerpt/Audit/etc. services

Pgpool-II::
//–±–∞–ª–∞–Ω—Å—É–≤–∞–ª—å–Ω–∏–∫ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è. Pgpool-II –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –ø–µ—Ä–µ–≤–∞–≥–∏ —Ñ—É–Ω–∫—Ü—ñ—ó —Ä–µ–ø–ª—ñ–∫–∞—Ü—ñ—ó, —â–æ–± –∑–º–µ–Ω—à–∏—Ç–∏ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–∞ –∫–æ–∂–µ–Ω —Å–µ—Ä–≤–µ—Ä PostgreSQL, —Ä–æ–∑–ø–æ–¥—ñ–ª—è—é—á–∏ –∑–∞–ø–∏—Ç–∏ SELECT –º—ñ–∂ –∫—ñ–ª—å–∫–æ–º–∞ —Å–µ—Ä–≤–µ—Ä–∞–º–∏, –ø–æ–∫—Ä–∞—â—É—é—á–∏ –∑–∞–≥–∞–ª—å–Ω—É –ø—Ä–æ–ø—É—Å–∫–Ω—É –∑–¥–∞—Ç–Ω—ñ—Å—Ç—å —Å–∏—Å—Ç–µ–º–∏. –ó–∞–ø–∏—Ç–∏ –Ω–∞ –∑–∞–ø–∏—Å –Ω–∞–¥—Å–∏–ª–∞—é—Ç—å—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–Ω–∏–π —Å–µ—Ä–≤–µ—Ä (Master)
A load balancer. Pgpool-II takes advantage of the replication feature to reduce the load on each PostgreSQL server by distributing SELECT queries among multiple servers, improving system's overall throughput. Write requests are sent to the master server.

PGO::
//Postgres –æ–ø–µ—Ä–∞—Ç–æ—Ä –≤—ñ–¥ Crunchy Data, —è–∫–∏–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∫–µ—Ä—É—î –∫–ª–∞—Å—Ç–µ—Ä–∞–º–∏ PostgreSQL –Ω–∞ –æ—Å–Ω–æ–≤—ñ –ø—Ä–æ—Å—Ç–æ–≥–æ –¥–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω–æ–≥–æ –æ–ø–∏—Å—É. –ù–∞—Å—Ç—É–ø–Ω—ñ —ç–ª–µ–º–µ–Ω—Ç–∏ –∫–µ—Ä—É—é—Ç—å—Å—è postgres –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º:
Postgres Operator from Crunchy Data automatically manages PostgreSQL clusters based on a simple declarative description. Postgres Operator controls the following elements:

Master DB;; 
//—ç–∫–∑–µ–º–ø–ª—è—Ä PostgreSQL —è–∫–∏–π –≤–∏–∫–æ–Ω—É–µ —Ä–æ–ª—å –º–∞—Å—Ç–µ—Ä–∞ —Ä–µ–ø–ª—ñ–∫–∞—Ü—ñ—ó
A PostgreSQL instance that acts as a replication master.
Replica DB;;
//—ç–∫–∑–µ–º–ø–ª—è—Ä–∏ PostgreSQL —è–∫—ñ –≤–∏–∫–æ–Ω—É—é—Ç—å —Ä–æ–ª—å —Ä–µ–ø–ª—ñ–∫–∏ —Ç–∞ –æ—Ç—Ä–∏–º—É—é—Ç—å –¥–∞–Ω–Ω—ñ –∑ –º–∞—Å—Ç–µ—Ä–∞ –≤ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–º—É —Ä–µ–∂–∏–º—ñ
PostgreSQL instances that act as replicas and receive data from the master synchronously.
Master Service;;
//Kubernetes —Å–µ—Ä–≤—ñ—Å —è–∫–∏–π –Ω–∞–¥–∞—î —ñ–º‚Äô—è DNS –¥–ª—è –ø–æ–¥–∞ —è–∫–∏–π –≤–∏–∫–æ–Ω—É—î —Ä–æ–ª—å –º–∞—Å—Ç–µ—Ä–∞.
A Kubernetes service that provides a DNS name to the pod that acts as a master.
Replica Service;;
//Kubernetes —Å–µ—Ä–≤—ñ—Å —è–∫–∏–π –Ω–∞–¥–∞—î —î–¥–∏–Ω–µ —ñ–º‚Äô—è DNS –¥–ª—è –Ω–∞–±–æ—Ä—É –ø–æ–¥—ñ–≤, —è–∫—ñ –≤–∏–∫–æ–Ω—É—é—Ç—å —Ä–æ–ª—å —Ä–µ–ø–ª—ñ–∫–∏, —ñ –º–æ–∂–µ —Ä–æ–∑–ø–æ–¥—ñ–ª—è—Ç–∏ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º—ñ–∂ –Ω–∏–º–∏.
A Kubernetes service that provides a single DNS name to a number of pods that act as a replica. It can balance the load between them.
Cluster Service;;
//Kubernetes —Å–µ—Ä–≤—ñ—Å —è–∫–∏–π –Ω–∞–¥–∞—î —î–¥–∏–Ω–µ —ñ–º‚Äô—è DNS –¥–ª—è –≤—Å—ñ—Ö –ø–æ–¥—ñ–≤ –∫–ª–∞—Å—Ç–µ—Ä—É, —ñ –º–æ–∂–µ —Ä–æ–∑–ø–æ–¥—ñ–ª—è—Ç–∏ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º—ñ–∂ –Ω–∏–º–∏.
A Kubernetes service that provides a single DNS name to all pods in a cluster. It can balance the load between them.

S3::
//AWS S3 (–∞–±–æ S3-compatible)  —Å—Ö–æ–≤–∏—â–µ –Ω–∞ —è–∫–æ–º—É –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è —Ä–µ–∑–µ—Ä–≤–Ω—ñ –∫–æ–ø—ñ—ó —Ç–∞ –∞—Ä—Ö—ñ–≤–Ω—ñ wal –ª–æ–≥–∏. –ú–æ–∂–ª–∏–≤–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —ñ–Ω—à—ñ —Ç–∏–ø–∏ —Å—Ö–æ–≤–∏—â, —Ç–∞–∫—ñ —è–∫ azure, gcs –∞–±–æ kubernetes persistent volume
AWS S3 (or S3-compatible) storage that keeps backups and archived WAL logs. It is possible to use other storage types such as Azure, GCS, or Kubernetes persistent volume.

Operational Cluster::
//–∫–ª–∞—Å—Ç–µ—Ä —è–∫–∏–π –æ–±—Å–ª—É–≥–æ–≤—É—î –¥–æ–¥–∞—Ç–∫–∏ —Ç–∞ —Å–µ—Ä–≤—ñ—Å–∏ —Ä–µ—î—Å—Ç—Ä—É
A cluster that serves the registry's applications and services.

Analytical Cluster::
//–∫–ª–∞—Å—Ç–µ—Ä —è–∫–∏–π –æ–±—Å–ª—É–≥–æ–≤—É—î –∞–Ω–∞–ª—ñ—Ç–∏—á–Ω—ñ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏, –∑–æ–∫—Ä–µ–º–∞ Redash. –û—Ç—Ä–∏–º—É—î –¥–∞–Ω–Ω—ñ —á–µ—Ä–µ–∑ –ª–æ–≥—ñ—á–Ω—É —Ä–µ–ø–ª—ñ–∫–∞—Ü—ñ—é –∑ –æ–ø–µ—Ä–∞—Ü—ñ–π–Ω–æ–≥–æ –∫–ª–∞—Å—Ç–µ—Ä—É. –î–æ—Å—Ç—É–ø–Ω–∏–π –∑–∑–æ–≤–Ω—ñ –ª–∏—à–µ –Ω–∞ —á–∏—Ç–∞–Ω–Ω—è.
A cluster that serves analytical tools such as Redash. It receives data through logical replication from the operational cluster. External access is read-only.

[manifest-examples]
=== Manifest examples

.Operational cluster sample definition
====
[source,yaml]
----
apiVersion: postgres-operator.crunchydata.com/v1beta1
kind: PostgresCluster
metadata:
  name: operational
spec:
  image: registry.developers.crunchydata.com/crunchydata/crunchy-postgres:centos8-14.2-0
  postgresVersion: 14
  instances:
    - name: instance1
      replicas: 3
  backups:
     pgbackrest:
       image: registry.developers.crunchydata.com/crunchydata/crunchy-pgbackrest:centos8-2.36-1
  patroni:
    dynamicConfiguration:
      synchronous_mode: true 
      synchronous_node_count: 2
      pause: false
      postgresql:
        parameters:
          synchronous_standby_names: "*"
        use_slots: true
        pg_hba:
        - host all all all md5
  users:
    - name: postgres
----
====

.Pgpool-II sample definition
====
[source,yaml]
----
apiVersion: apps/v1
kind: Deployment
metadata:
  name: pgpool
spec:
  replicas: 1
  selector:
    matchLabels:
      app: pgpool
  template:
    metadata:
      labels:
        app: pgpool
    spec:
      containers:
      - name: pgpool
        image: pgpool/pgpool
        env:
        - name: POSTGRES_USERNAME
          valueFrom:
            secretKeyRef:
              name: operational-pguser-postgres
              key: user
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: operational-pguser-postgres
              key: password
        volumeMounts:
        - name: pgpool-config
          mountPath: /config
      volumes:
      - name: pgpool-config
        configMap:
          name: pgpool-config
----
====

.Pgpool-II sample config
====
[source,yaml]
----
apiVersion: v1
kind: ConfigMap
metadata:
  name: pgpool-config
  labels:
    name: pgpool-config
data:
  pgpool.conf: |-
    listen_addresses = '*'
    port = 5432
    pool_passwd = /config/pool_passwd
    socket_dir = '/var/run/pgpool'
    pcp_listen_addresses = '*'
    pcp_port = 9898
    pcp_socket_dir = '/var/run/pgpool'
    backend_hostname0 = 'operational-primary'
    backend_port0 = 5432
    backend_weight0 = 0
    backend_flag0 = 'ALWAYS_PRIMARY|DISALLOW_TO_FAILOVER'
    backend_hostname1 = 'operational-replicas'
    backend_port1 = 5432
    backend_weight1 = 1
    backend_flag1 = 'DISALLOW_TO_FAILOVER'
    sr_check_period = 0
    enable_pool_hba = off
    backend_clustering_mode = 'streaming_replication'
    num_init_children = 200
    max_pool = 1
    reserved_connections = 0
    child_life_time = 300
    child_max_connections = 0
    connection_life_time = 0
    client_idle_limit = 0
    connection_cache = on
    load_balance_mode = on
    statement_level_load_balance = off
    ssl = off
    failover_on_backend_error = off
    logging_collector = off
  pool_hba.conf: |-
    local   all         all                               trust
    host    all         all         127.0.0.1/32          trust
    host    all         all         ::1/128               trust
    host    all         all         0.0.0.0/0             md5
----
====

//== –ú–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è –∫–ª–∞—Å—Ç–µ—Ä—É
== Cluster scaling

//–û–ø–µ—Ä–∞—Ü—ñ–π–Ω–∏–π —Ç–∞ –∞–Ω–∞–ª—ñ—Ç–∏—á–Ω–∏–π –∫–ª–∞—Å—Ç–µ—Ä–∏ –º–æ–∂—É—Ç—å –º–∞—Å—à—Ç–∞–±—É–≤–∞—Ç–∏—Å—è –Ω–µ–∑–∞–ª–µ–∂–Ω–æ –æ–¥–∏–Ω –≤—ñ–¥ –æ–¥–Ω–æ–≥–æ. –ö–ª–∞—Å—Ç–µ—Ä –º–æ–∂–µ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ —è–∫ —É —Ä–µ–∂–∏–º—ñ _—Ç—ñ–ª—å–∫–∏ –º–∞—Å—Ç–µ—Ä_, —Ç–æ–±—Ç–æ –±–µ–∑ –º–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è, —Ç–∞–∫ —ñ —É —Ä–µ–∂–∏–º—ñ _–º–∞—Å—Ç–µ—Ä + —Ä–µ–ø–ª—ñ–∫–∏_, –∑ —Ä–æ–∑–¥—ñ–ª–µ–Ω–Ω—è–º —á–∏—Ç–∞–Ω–Ω—è/–∑–∞–ø–∏—Å—É.

Operational and analytical clusters can be scaled independently. A cluster can work both in the _master-only_ mode, without scaling, and in _master + replicas_ mode, with separate reads and writes.

//–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –∑–º—ñ–Ω —É CRD PostgresCluster —Ç–∞ ConfigMap –∑ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—î—é PgPool II —è–∫—â–æ —Ä–æ–∑–¥—ñ–ª–µ–Ω–Ω—è —á–∏—Ç–∞–Ω–Ω—è/–∑–∞–ø–∏—Å—É –≤–º–∏–∫–∞—î—Ç—å—Å—è –∞–±–æ –≤–∏–º–∏–∫–∞—î—Ç—å—Å—è.

Cluster scaling is configured by changing PostgresCluster CRD and Pgpool-II configuration in ConfigMap if separate reads and writes are enabled or disabled.

////
IMPORTANT: –ü–µ—Ä–µ—Ö—ñ–¥ –∑ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó _—Ç—ñ–ª—å–∫–∏ –º–∞—Å—Ç–µ—Ä_ –Ω–∞ _–º–∞—Å—Ç–µ—Ä + —Ä–µ–ø–ª—ñ–∫–∏_ —ñ –Ω–∞–≤–ø–∞–∫–∏ –≤–µ–¥–µ –¥–æ —Ä–æ–∑—Ä–∏–≤—É –≤—Å—ñ—Ö –∑‚Äô—î–¥–Ω–∞–Ω–Ω—å –∑ –∫–ª–∞—Å—Ç–µ—Ä–æ–º –±–∞–∑ –¥–∞–Ω–Ω–∏—Ö +
   +
–ü—Ä–∏ –∑–º–µ–Ω—à–µ–Ω–Ω—ñ –∫—ñ–ª—å–∫–æ—Å—Ç—ñ –ø–æ–¥—ñ–≤ —Ä–æ–∑—Ä–∏–≤–∞—î—Ç—å—Å—è —Ç–∞ —á–∞—Å—Ç–∏–Ω–∞ –∑‚Äô—î–¥–Ω–∞–Ω–Ω—å —è–∫–∞ –±—É–ª–∞ —Å—Ç–≤–æ—Ä–µ–Ω–∞ –Ω–∞ –≤–∏–¥–∞–ª–µ–Ω–∏—Ö –ø–æ–¥–∞—Ö +
 +
–í –æ–±–æ—Ö –≤–∏–ø–∞–¥–∫–∞—Ö –∑‚Äô—î–¥–Ω–∞–Ω–Ω—è –≤—ñ–¥–Ω–æ–≤–ª—é—é—Ç—å—Å—è —á–µ—Ä–µ–∑
–¥–µ–∫—ñ–ª—å–∫–∞ —Å–µ–∫—É–Ω–¥, –∞–ª–µ —É –º–æ–º–µ–Ω—Ç —Ç–∞–∫–æ–≥–æ –º–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è –º–æ–∂—É—Ç—å —Å–ø–æ—Å—Ç–µ—Ä—ñ–≥–∞—Ç–∏—Å—è –ø–æ–º–∏–ª–∫–∏ —É —Å–µ—Ä–≤—ñ—Å–∞—Ö
////

[IMPORTANT]
====
Switching the configuration from _master-only_ to _master + replicas_ and vice versa causes all connections to the database cluster to be broken.

Reducing the number of pods breaks connections created for the deleted pods.

In both cases connections are renewed after several seconds, but during this scaling operation services may return errors.
====

//.–ê–Ω–∞–ª—ñ—Ç–∏—á–Ω–∏–π –∫–ª–∞—Å—Ç–µ—Ä
.Analytical cluster
====
////
* –ó–º—ñ–Ω–∏—Ç–∏ *spec.instances.replicas* –Ω–∞ –±–∞–∂–∞–Ω—É –∫—ñ–ª—å–∫—ñ—Å—Ç—å –ø–æ–¥—ñ–≤. –ü–∞—Ä–∞–º–µ—Ç—Ä –≤–∫–ª—é—á–∞—î –º–∞—Å—Ç–µ—Ä —Ç–∞ —Ä–µ–ø–ª—ñ–∫–∏. –¢–æ–±—Ç–æ –ø—Ä–∏ –∑–Ω–∞—á–µ–Ω–Ω—ñ 1 –±—É–¥–µ —Ä–æ–∑–≥–æ—Ä–Ω—É—Ç–æ —Ç—ñ–ª—å–∫–∏ –º–∞—Å—Ç–µ—Ä –±–µ–∑ —Ä–µ–ø–ª—ñ–∫.
* –ó–º—ñ–Ω–∏—Ç–∏ *spec.patroni.dynamicConfiguration.synchronous_node_count* –Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ä–µ–ø–ª—ñ–∫. –ü–∞—Ä–∞–º–µ—Ç—Ä –∑–∞–≤–∂–¥–∏ –º–µ–Ω—à–∏–π –Ω–∞ 1 –Ω—ñ–∂ –∑–∞–≥–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –ø–æ–¥—ñ–≤ (spec.instances.replicas)
* –ó–∞—Å—Ç–æ—Å–æ–≤—É–≤–∞—Ç–∏ –∑–º—ñ–Ω–∏ –º–∞–Ω—ñ—Ñ–µ—Å—Ç—É
////
* Set *spec.instances.replicas* to the total number of pods. This parameter includes the master and replicas. When set to 1, only the master without replicas is deployed.
* Set *spec.patroni.dynamicConfiguration.synchronous_node_count* to the number of replicas. This parameter is always 1 less than the total number of pods (spec.instances.replicas).
* Apply manifest changes.
====

//.–û–ø–µ—Ä–∞—Ü—ñ–π–Ω–∏–π –∫–ª–∞—Å—Ç–µ—Ä
.Operational cluster
====
////
* –í–∏–∫–æ–Ω–∞—Ç–∏ –≤—Å—ñ –¥—ñ—ó —è–∫ –Ω–∞ –∞–Ω–∞–ª—ñ—Ç–∏—á–Ω–æ–º—É –∫–ª–∞—Å—Ç–µ—Ä—ñ
* –ü—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥—ñ –∑ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó –∑ –æ–¥–Ω—ñ—î—é –ø–æ–¥–æ—é (spec.instances.replicas=1) –Ω–∞ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é –∑ –¥–≤–æ–º–∞ —ñ –±—ñ–ª—å—à–µ, –¥–æ–¥–∞—Ç–∏/—Ä–æ–∑–∫–æ–º–µ–Ω—Ç—É–≤–∞—Ç–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –µ–Ω–ø–æ—ñ–Ω—Ç—É —Ä–µ–ø–ª—ñ–∫ –≤ pgpool.conf
////
* Perform the steps described for the analytical cluster.
* When switching from a single-pod configuration (spec.instances.replicas=1) to a configuration with two or more pods, add or uncomment the replicas endpoint settings in pgpool.conf:

[source,bash]
----
    backend_hostname1 = 'operational-replicas'
    backend_port1 = 5432
    backend_weight1 = 1
    backend_flag1 = 'DISALLOW_TO_FAILOVER'
----

//* –ü—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥—ñ –∑ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó –∑ –∑ –¥–≤–æ–º–∞ —ñ –±—ñ–ª—å—à–µ –ø–æ–¥–∞–º–∏ –Ω–∞ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é –∑ –æ–¥–Ω—ñ—î—é –ø–æ–¥–æ—é, –≤–∏–ª—É—á–∏—Ç–∏/–∑–∞–∫–æ–º–µ–Ω—Ç—É–≤–∞—Ç–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –µ–Ω–ø–æ—ñ–Ω—Ç—É —Ä–µ–ø–ª—ñ–∫ –≤ pgpool.conf
* When switching from a configuration with two or more pods to a single-pod configuration, delete or comment out the replicas endpoint settings in pgpool.conf:

[source,bash]
----
    #backend_hostname1 = 'operational-replicas'
    #backend_port1 = 5432
    #backend_weight1 = 1
    #backend_flag1 = 'DISALLOW_TO_FAILOVER'
----

//* –ü—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥—ñ –∑ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó –∑ –¥–≤–æ–º–∞ —ñ –±—ñ–ª—å—à–µ –ø–æ–¥–∞–º–∏ –Ω–∞ —ñ–Ω—à—É –∑ –¥–≤–æ–º–∞ —ñ –±—ñ–ª—å—à–µ –ø–æ–¥–∞–º–∏, –Ω—ñ—è–∫–∏—Ö –¥–æ–¥–∞—Ç–∫–æ–≤–∏—Ö –¥—ñ–π –Ω–µ–ø–æ—Ç—Ä—ñ–±–Ω–æ. –¢–æ–±—Ç–æ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥—ñ –Ω–∞–ø—Ä–∏–∫–ª–∞–¥ –∑ 2 –ø–æ–¥ –Ω–∞ 5, –∞–±–æ –∑ 5 –Ω–∞ 3, –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é pgpool –∑–º—ñ–Ω—é–≤–∞—Ç–∏ –Ω–µ —Ç—Ä–µ–±–∞
* When switching from a configuration with two or more pods to a different configuration with two or more pods, no additional steps are necessary. For example, when switching from 2 to 5 pods, or from 5 to 3 pods, there is no need to change the pgpool config.
====