= Externalizing UI form scripts
include::platform:ROOT:partial$templates/document-attributes/arch-set-en.adoc[]

include::platform:ROOT:partial$admonitions/language-en.adoc[]

== General description

When modeling forms for tasks, it is often necessary to use the same Javascript functions that have to be duplicated. This relates both to functions that are relevant for any registry, and to those that make sense to reuse within specific regulations or even a business process.
//При моделюванні форм для задач часто виникає необхідність використовувати одні й ті самі Javascript функції які доводиться дублювати. Це стосується як функцій актуальних для будь-якого реєстру, так і тих які мають сенс перевикористовувати саме у рамках конкретного регламенту або навіть бізнес процесу.

To process all these scenarios, it is suggested to save individual javascript files *at the regulations level*. These files are available through API in form-schema-provider and are used when performing tasks.
//Для обробки всіх цих сценаріїв пропонується використовувати збереження окремих javascript файлів *на рівні регламенту*. Ці файли доступні через API у form-schema-provider та використовуються при виконанні задач.

[user-roles]
=== User roles
//=== Ролі користувачів

* Registry regulations developer

== Functional scenarios
//== Функціональні сценарії

* Reusing Javascript repeated functions within Javascript inserts when modeling forms. The following form parameters are supported:
//* Перевикористання Javascript функцій, що повторюються у рамках Javascript вставок при моделюванні форм. Підтримуються такі параметри форм:
** Custom Default Value
** Calculated Value
** Custom Validation
** Advanced Conditions
** others, including specific to some components (for example, Filter Query and Custom Filter on the Select component)
//** інші, включаючи специфічні для деяких компонентів (наприклад, Filter Query та Custom Filter на компоненті Select)

== Target design
//== Цільовий дизайн

=== Example of a file containing an externalized script
//=== Приклад файла який містить екстерналізований скрипт

After adding such a file, users are able to use the `myUtil` function and the `myConst` variable in their Javascript inserts:
//Після додавання такого файлу користувачі зможуть використовувати функцію `myUtil` та змінну `myConst` у своїх Javascript вставках:

[source,javascript]
----
function myUtil() {
  return JSON.stringify(data); // you can use common formio variables here
}

var myConst = 'veryCustom';
----

=== System components and their purpose in the solution design
//=== Компоненти системи та їх призначення в рамках дизайну рішення

This section provides a list of system components that are involved or need to be changed/created as part of the implementation of functional requirements according to the technical design of the solution.
//У даному розділі наведено перелік компонент системи, які задіяні або потребують змін/створення в рамках реалізації функціональних вимог згідно технічного дизайну рішення.

|===
|Component|Official name|Purpose / Essence of changes
//|Компонент|Службова назва|Призначення / Суть змін

|_Register regulations_
//|_Регламент реєстру_
|*registry-regulations-publications*
|Add the form-scripts folder for storing externalized scripts.
//|Додати папку form-scripts для зберігання екстерналізованих скриптів.

|_Regulations publication pipeline_
//|_Пайплайн публікації регламенту_
|*registry-regulations-publication-pipeline*
|Add processing of externalized scripts -- their storage and updating in the *form-schema-provider* service (similar to forms).
//|Додати обробку екстерналізованих скриптів - їх зберігання та оновлення у сервісі *form-schema-provider* (аналогічно до форм).

|_Form providing service_
//|_Сервіс постачання форм_
|*form-schema-provider*
|Forms will now require externalized scripts. In the form-schema-provider service, it is necessary to add the ability to store and update scripts separately from forms. You also need to add a separate GET formScriptList endpoint so that it returns all scripts together in the String format.
//|Для роботи форм тепер будуть потрібні екстерналізовані скрипти. На сервісі form-schema-provider треба додати можливість зберігати та оновлювати скрипти окремо від форм. Також треба додати окремий ендпоінт GET formScriptList для того, щоб він віддавав усі скрепти разом у форматі String.

|_Regulations management service_
//|_Сервіс управління регламентом_
|*registry-regulation-management*
|For correct work with form preview on *admin-portal*, externalized scripts must be connected to the form. Therefore, in addition to *form-schema-provider*, changes are also required in the regulation management service. As part of these changes, one more endpoint should be added for the candidate and master versions that will read script files and return them in String format.
//|Для правильної роботи з попереднім переглядом форми на *admin-portal* екстерналізовані скрипти повинні буди підключені до форми. Тому окрім *form-schema-provider* зміни необхідні також і у сервісі управління регламентом. У рамках цих змін треба додати ще один ендпоінт для кандидат та майстер версій який буде зчитувати файли скриптів та віддавати їх у форматі String.

|_UI form data validation service_
//|_Сервіс валідації даних UI-форм_
|*form-submission-validation*
|For the correct validation of entered data, it is necessary to make the same computations as in the portals. Therefore, the validation service must also take into account externalized scripts.
//|Для правильної валідації введених даних необхідно зробити ті самі обчислення, що і на кабінетах. Тому сервіс валідації повинен теж враховувати екстерналізовані скрипти.

|_Register administrator portal_
//|_Кабінет адміністратора реєстру_
|*admin-portal*
|Change the form component so that it accepts arbitrary scripts as text and performs all Javascript computations based on these scripts.
//|Змінити компонент форми так щоб він приймав довільні скрипти у вигляді текста та виконував усі Javascript обчислення з урахуванням цих скриптів.

|_Officer portalи_
//|_Кабінет посадової особи_
|*officer-portal*
|Add script data processing and transfer it to the form component as text
//|Додати обробку даних скриптів та передати їх у компонент форми у вигляді тексту)

|_Citizen portal_
//|_Кабінет громадянина_
|*citizen-portal*
|Add script data processing and transfer it to the form component as text
//|Додати обробку даних скриптів та передати їх у компонент форми у вигляді тексту)

|===

=== Registry regulations
//=== Регламент реєстру

Add the *form-scripts* folder to regulations' Gerrit for storing scripts:
//Додати папку *form-scripts* у герріт регламента для зберігання скриптів:

.Structure of the registry regulations
//.Структура регламенту реєстру
[plantuml, registry-config-regulation-structure, svg]
----
include::partial$architecture/registry/administrative/regulation-management/platform-evolution/form-scripts/form-scripts-structure.puml[]
----

=== Registry regulations publications pipeline

The `UploadFormScripts.groovy` file in `/platform/pipelines/stages/impl/lowcode` must be added to *registry-regulations-publications*. The implementation of this script is similar to the `UploadFormChanges.groovy` script for saving forms.
//Необхідно додати у *registry-regulations-publications* файл `UploadFormScripts.groovy` у `/platform/pipelines/stages/impl/lowcode`. Реалізація цього скрипта буде подібна до `UploadFormChanges.groovy` - скрипта по зберіганню форм.

=== Portals and validation service
//=== Портали та сервіс валідації

One way or another, portals will receive externalized scripts in the `String` format and pass them to the form component. The form component will add the script text to any Javascript attribute of the form components. This way, all functions and constants will be available when computing Javascript attributes. This applies to officer-portal, citizen-portal, admin-portal and form-submission-validation.
//Портали будуть так чи інакше отримувати екстерналізовані скрити у форматі `String` та передавати у компонент форми. Компонент форми до будь-якого Javascript атрибута компонентів форм буде додавати текст скриптів. Таким чином усі функції та константи будуть доступні при обчисленні Javascript атрибутів. Це стосується officer-portal, citizen-portal, admin-portal та form-submission-validation.

.Execution order of the Javascript attribute
//.Порядок виконання Javascript атрибута
[plantuml, registry-config-regulation-attribute, svg]
----
include::partial$architecture/registry/administrative/regulation-management/platform-evolution/form-scripts/form-scripts-attribute.puml[]
----

=== Form providing service
//=== Сервіс постачання форм

==== Changes in Redis
//==== Зміни у Redis

- Create the new namespace (keyspace): `bpm-form-scripts`
//- Створити новий простір імен (keyspace): `bpm-form-scripts`

==== Endpoints

.form-schema-provider new API
//.form-schema-provider нові API
[%collapsible]
====
swagger::{attachmentsdir}/architecture/registry/administrative/regulation-management/platform-evolution/form-scripts/form-provider-swagger.yml[]
====

=== Registry regulations management service

==== Endpoints

.registry-regulation new API
//.registry-regulation нові API
[%collapsible]
====
swagger::{attachmentsdir}/architecture/registry/administrative/regulation-management/platform-evolution/form-scripts/registry-regulation-swagger.yml[]
====

== Development plan
//== План розробки
=== Technical assessments
//=== Технічні експертизи
- FE (changes in portals)
//- FE (зміни у порталах)
- BE (changes in services)
//- BE (зміни в сервісах)
- DevOps (changes in the publication pipeline)
//- DevOps (зміни у пайплайні публікації)

=== Plan
//=== План

- Add an endpoint to the *registry-regulation-management* service for getting scripts
//- Додати ендпоінт до сервіса *registry-regulation-management* для отримання скриптів
- Add endpoints to the *form-schema-provider* service for saving, changing and getting scripts
//- Додати ендпоінти до сервіса *form-schema-provider* для збереження, зміни та отримання скриптів
- Update the form component
//- Оновити компонент форми
- Request externalized scripts on the admin-portal and transfer them to the form component
//- Запросити екстреналізовані скрипти на admin-portal та передати у компонент форми
- Process the parameter of the externalized scripts on the citizen and officer portal and pass it to the form component
//- Обробити параметр екстреналізованих скриптів на citizen та officer portal та передати у компонент форми
- Add request for *form-schema-provider* in *form-submission-validation* and process scripts
//- Додати запит на *form-schema-provider* у *form-submission-validation* та обробити скрипти
- Add changes to the publication pipeline
//- Додати зміни у пайплайн публікації
- Add a reference business process to consent
//- Додати референтний бізнес процес у consent
