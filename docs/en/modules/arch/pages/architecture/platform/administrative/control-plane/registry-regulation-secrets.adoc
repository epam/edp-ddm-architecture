//= Управління налаштуваннями та секретами зовнішніх інтеграцій
= Managing settings and secrets for external integrations

//== Контекст
== Context

//=== Інформаційний обмін з зовнішніми системами
=== Information exchange with external systems

//Перелік зовнішніх систем, з якими реалізована взаємодія в рамках бізнес-сценаріїв:

Interaction in the context of business scenarios was implemented with the following external systems:

//- Публічні сервіси "_Дія_" (з детальною інформацією можна ознайомитись у розділі xref:architecture/registry/operational/notifications/diia-notifications-api.adoc[])

//TODO: Change link to en version
* _Diia_ public services (for details, see xref:architecture/registry/operational/notifications/diia-notifications-api.adoc[])

//Перелік реєстрів, з якими реалізовано інформаційний обмін (з детальною інформацією можна ознайомитись у розділі xref:registry-develop:registry-admin/external-integration/api-call/trembita/overview.adoc[]):

//TODO: Change link to en version
Information exchange was implemented with the following registries (for details, see xref:registry-develop:registry-admin/external-integration/api-call/trembita/overview.adoc[]):

////
- Єдиний державний реєстр (ЄДР)
- Державний реєстр актів цивільного стану (ДРАЦС)
- Єдина інформаційна база даних внутрішньо переміщених осіб (ЄІБДВПО)
////

* Unified State Register (USR)
* State Register of Civil Status Acts (SRCSA)
* Unified Information Database of Internally Displaced Persons (UIDIDP)

//=== Інтеграційни сценарії
=== Integration scenarios

|===
|Component|Level|External system/registry|Configuration|Integration method|Scenario

|*dso-citizen-authenticator*
|Platform
|USR
//|Конфігурація інтеграцій та секретів в регламенті реєстру
|Integrations and secrets are configured in the registry regulation
|Built-in
//|Аутентифікація представників бізнесу у _Кабінеті Громадянина_ (перевірка наявності активованого запису в реєстрі)
|Authenticating business representatives in the electronic cabinet of a citizen (checking for an activated entry in the registry)

|*notification-service*
|Registry
|Diia
//|Конфігурація інтеграції та секрету через інтерфейс _control-plane_
|Integration and secret are configured through the _control-plane_ interface
|Built-in
//|Відправлення інформаційних push-повідомлень громадянам
|Sending push-notifications to citizens

.3+|*bpms*
.3+|Registry
|USR

SRCSA

UIDIDP
//|Конфігурація інтеграцій та секретів в регламенті реєстру
|Integrations and secrets are configured in the registry regulation
//|Типові інтеграційні _SOAP_-конектори
|Standard _SOAP_ connectors for integration
//|Інформаційний обмін з реєстрами через Трембіту в рамках виконання бізнес-процесів
|Information exchange with the registries through _Trembita_ as part of business processes

|Diia
//|Конфігурація інтеграцій в регламенті та _ручне_ створення секрету
|Integrations are configured in the registry regulation, and secret is created _manually_
//|Універсальний інтеграційний _REST_-конектор
|Universal _REST_ connector for integration
//|Інформаційний обмін в рамках виконання бізнес-процесів
|Information exchange as part of business processes

|<External system>
//|Конфігурація інтеграцій в регламенті та _ручне_ створення секретів
|Integrations are configured in the registry regulation, and secrets are created _manually_
//|Універсальний інтеграційний _REST_-конектор
|Universal _REST_ connector for integration
//|Інформаційний обмін через в рамках виконання бізнес-процесів
|Information exchange as part of business processes
|===

//== Поточний технічний дизайн
== Current technical design

image::architecture/platform/administrative/control-plane/ext-secrets-management/registry-ext-systems-secrets-baseline.svg[registry-ext-systems-secrets-baseline,700]

//=== Налаштування аутентифікатора громадян
=== Configuring the citizen authenticator

//В рамках аутентифікації громадян, система отримує дані користувача з ЄДР. Конфігурація інтеграції та секрет зберігаються на рівні регламенту та застосовуються _Пайплайном публікації регламенту_ для налаштування _dso-citizen-authenticator_ реєстру:

To authenticate citizens, the system fetches user data from USR. Integration configuration and secret are stored at the regulation level and are used by the _Regulation publishing pipeline_ to configure the registry's _dso-citizen-authenticator_:

image::architecture/platform/administrative/control-plane/ext-secrets-management/dso-citizen-authenticator.png[dso-citizen-authenticator, 300]

//=== Налаштування зовнішніх інтеграцій на рівні регламенту
=== Configuring external integrations at the regulation level

//Наразі інтеграції з реєстрами через Трембіту реалізовані за допомогою типових інтеграційних _SOAP_-конекторів.

Currently, integrations with registries through _Trembita_ are implemented via standard _SOAP_ connectors for integration.

//TIP: Детальніше можна ознайомитись у розділі xref:registry-develop:bp-modeling/external-integration/api-call/connectors-external-registry.adoc[]

//TODO: Change link to en version
TIP: For details, see xref:registry-develop:bp-modeling/external-integration/api-call/connectors-external-registry.adoc[]

//Для _REST_-інтеграцій з зовнішніми системами реалізовано _Універсальний REST-конектор_, який підтримує наступні способи авторизації:

REST-based integrations with external systems are implemented using the _Universal REST connector_, which supports the following authorization methods:

* _BASIC_ (username + password)
* _PARTNER_TOKEN_ (partner_token + Bearer token)

//TIP: Детальніше можна ознайомитись у розділі xref:registry-develop:bp-modeling/bp/rest-connector.adoc[]

//TODO: Change link to en version
TIP: For details, see xref:registry-develop:bp-modeling/bp/rest-connector.adoc[]

.registry-gerrit:<registry-regulation>.git/bp-trembita/configuration.yml
[source, yaml]
----
trembita-exchange-gateway:
  registries:
    edr-registry:
      user-id: 'DDM'
      protocol-version: '4.0'
      trembita-url: 'trembita.url/mockEDRService'
      authorization-token: 'token'
      client:
        x-road-instance: 'SEVDEIR-TEST'
        member-class: 'GOV'
        member-code: '43395033'
        subsystem-code: 'IDGOV_TEST_01'
      service:
        x-road-instance: 'SEVDEIR-TEST'
        member-class: 'GOV'
        member-code: '00015622'
        subsystem-code: '2_MJU_EDR_prod'
external-systems:
  diia:
    url: http://api2.diia.gov.ua
    methods:
      get-damaged-property:
        path: /api/v1/public-service/damaged-property/filtered
        method: GET
    auth:
      type: PARTNER_TOKEN
      secret-name: diia-partner-token
      partner-token-auth-url: https://api2t.diia.gov.ua/api/v1/auth/partner
      token-json-path: $.token
  httpbin:
    url: http://httpbin.org/
    methods:
      get:
        path: /get
        method: GET
    auth:
      type: BASIC
      secret-name: httpbin-basic-authentication
----

//=== Недоліки поточної реалізації
=== Disadvantages of the current implementation

////
* Визначення налаштувань інтеграцій, які залежать від оточення, на рівні регламенту, що унеможливлює промоцію регламенту між екземплярами реєстру (адреси та секрети зовнішніх систем, тощо.)
* Визначення секретів для доступу до зовнішніх систем на рівні регламенту
* Необхідність виконання ротації секретів адміністратором регламенту
* Необхідність ручного створення _OpenShift_-секретів зовнішніх систем адміністратором реєстру
* Необхідність ручного налаштування мережевих політик (створення _Istio Service Entry_ для зовнішніх систем)
* Дублювання налаштувань клієнта _Трембіти_ для реєстру на рівні регламенту
////

* Environment-specific integration settings are defined at the regulation level, which prohibits promoting the regulation between registry instances (such as locations and secrets of external systems).
* The secrets for accessing external systems are defined at the regulation level.
* Regulation administrator needs to handle secrets rotation.
* Registry administrator needs to manually create _OpenShift_ secrets for external systems.
* Network policies must be configured manually (this includes creating _Istio Service Entry_ for external systems).
* _Trembita_ client settings for the registry are duplicated at the regulation level.

//== Цільовий технічний дизайн
== Target technical design

//=== Загальні принципи
=== General principles

////
- Регламент реєстру не має містити налаштувань, які залежать від "оточення" / екземпляра реєстру
- Регламент реєстру не має містити конфіденційних даних ні в якій формі
- Налаштування параметрів зовнішніх інтеграцій не мають дублюватись та використовуються централізовано
- Додання зовнішніх систем для інтеграції з реєстром не потребує ручних дій налаштування мережевих політик
- Секрети з параметрами доступу до зовнішніх систем зберігаються в захищеному сховищі сервісу управління секретами _HashiCorp Vault_
- Адміністратор реєстру та Адміністратор безпеки визначають правомірність взаємодії реєстру з зовнішніми системами
- Адміністратор реєстру налаштовує інтеграції з зовнішніми системами (протокол інтеграції, адреса, протокол аутентифікації, секрети, тощо.) на рівні екземпляра реєстру
- Адміністратор реєстру відповідає за ротацію секретів з параметрами доступу до зовнішніх систем
- Адміністратор регламенту виконує мінімальний об'єм попередньої конфігурації на рівні регламенту для використання зовнішніх інтеграцій в бізнес-процесах
- Між-реєстрова інтеграція через Трембіту реалізується у вигляді каталогу типових розширень-конекторів до реєстрів та не потребує додаткової конфігурації на рівні регламенту
- Інтеграція з 3rd-party системами потребує додаткової конфігурації на рівні регламенту у вигляді переліку операцій та їх типів, які використовує реєстр через типове розширення БП _Універсальний REST-конектор_
- Доступ до захищеного сховища сервісу управління секретами _HashiCorp Vault_ має Control Plane Console та External Secrets Operator через окремого сервісного користувача
- Кожний сервісний користувач для доступу в _HashiCorp Vault_ повинен мати налаштовану полісі з мінімально необхідними _Сapabilities_ для виконання своїх задач (Principle of least privilege)
////

* Registry regulation should not contain environment- or instance-specific settings.
* Registry regulation should not contain confidential data in any form.
* External integration parameters are stored centrally and not duplicated.
* Integrating the registry with additional external systems does not require configuring network policies manually.
* Secrets with access parameters to external systems are stored in a secure storage of the _HashiCorp Vault_ secrets management service.
* Registry administrator and security administrator determine the validity of registry's interactions with external systems.
* Registry administrator configures integrations with external systems (including integration protocol, locations, authentication protocol, and secrets) at the registry instance level.
* Registry administrator handles rotation of secrets with access parameters to external systems.
* Regulation administrator performs minimal initial configuration at the regulation level to use external integrations in business processes (BPs).
* Integration between registries through _Trembita_ is implemented as a catalogue of typical extensions-connectors to registries and does not require additional configuration at the regulation level.
* Integration with third-party systems requires additional configuration at the regulation level in the form of a list of operations and their types used by the registry through a typical BP extension called _Universal REST connector_.
* Control Plane Console and External Secrets Operator access the _HashiCorp Vault_ secrets management service using a dedicated service account.
* Every service account used to access _HashiCorp Vault_ must have a configured policy with a minimum set of _Capabilities_ to perform their tasks (using the principle of least privilege).

//=== Технічний дизайн рішення
=== Technical design of the solution

[NOTE]
--
//Для синхронізації змін між секретами _HashiCorp Vault_ та _Secret_-ресурсами реєстру використовується https://external-secrets.io/[External Secrets Operator].
Changes between _HashiCorp Vault_ secrets and registry's _Secret_ resources are synchronized via https://external-secrets.io/[External Secrets Operator].
--

[CAUTION]
--
//В рамках реалізації дизайну необхідно внести відповідні зміни до налаштування та використання конфігурації каналу зв'язку з _Дією_ у підсистемі нотифікацій xref:architecture/registry/operational/notifications/notifications-channels-configuration.adoc#_налаштування_каналу_звязку_для_відправки_push_повідомлень_у_мобільний_додаток_дія[]

//TODO: Change link to en version
Implementing this design requires making corresponding changes to the settings and usage of the notifications channels configuration with _Diia_ within the notifications subsystem xref:architecture/registry/operational/notifications/notifications-channels-configuration.adoc#_налаштування_каналу_звязку_для_відправки_push_повідомлень_у_мобільний_додаток_дія[].
--

image::architecture/platform/administrative/control-plane/ext-secrets-management/registry-ext-secrets-operator.svg[registry-ext-secrets-operator,700]

////
// TODO: Double-check the first list item in ua for correctness (+typo)
* Адміністратор реєстру створює/редагую конфігурацію реєстру та вносить налаштування реєстру-клієнта _ШБО Трембіта_ через *control-plane-console*, що призводить до:
** збереження _trembita.consumer_-запису про конфігурацію у *control-plane-gerrit:<registry>.git/deployment-templates/values.yaml*
** ініціювання *platform-jenkins* пайплайну та застосування відповідного _Helm_-чарту з використанням отриманих з *git*-репозиторію налаштувань до неймспейсу реєстру
* Адміністратор реєстру створює/редагую конфігурацію реєстру та вносить налаштування інтеграції з _Дією_ через *control-plane-console*, що призводить до:
** збереження секрету та мета-даних у *user-management:hashicorp-vault* за шляхом "*registry-kv/registry/<registry/>external-systems/diia*" в залежності від обраного способу аутентифікації (_AUTH_TOKEN+BEARER_)
** збереження _external-systems.diia_-запису про конфігурацію та _vault:_-посилання на зовнішній _Vault_-секрет у *control-plane-gerrit:<registry>.git/deployment-templates/values.yaml*
** ініціювання *platform-jenkins* пайплайну та застосування відповідного _Helm_-чарту з використанням отриманих з *git*-репозиторію налаштувань до неймспейсу реєстру
** створення _ConfigMap_-ресурсу "*diia-configuration*" у неймспейсі реєстру для використання сервісами *bpms* та *ddm-notification-service*
** створення _Istio ServiceEntry_-ресурсу для забезпечення доступу до зовнішньої системи сервісам *bpms* та *ddm-notification-service* реєстру
** створення _Secret_-ресурсу "*diia-secret*" оператором _External Secrets Operator_ як результат опрацювання _ExternalSecret_-ресурсу *diia-external-secret* та отримання даних з *user-management:hashicorp-vault* для використання сервісами *bpms* та *ddm-notification-service*
- ...
////

* The registry administrator creates and edits the registry configuration and enters the settings of the client registry into _SEG Trembita_ through the *control-plane-console*. This results in:
** Saving the _trembita.consumer_ configuration entry to *control-plane-gerrit:<registry>.git/deployment-templates/values.yaml*
** Initializing the *platform-jenkins* pipeline and applying the corresponding _Helm_ chart to the registry namespace using the settings obtained from the _Git_ repository.
* The registry administrator creates and edits the registry configuration and defines the _Diia_ integration properties through the *control-plane-console*. This results in:
** Saving the secret and metadata to *user-management:hashicorp-vault* using the *registry-kv/registry/<registry/>external-systems/diia* path depending on the selected authentication method (_AUTH_TOKEN+BEARER_).
** Saving the _external-systems.diia_ configuration entry and the _vault:_-link for external _Vault_-secret to *control-plane-gerrit:<registry>.git/deployment-templates/values.yaml*
** Initializing the *platform-jenkins* pipeline and applying the corresponding _Helm_ chart to the registry namespace using the settings obtained from the _Git_ repository.
** Creating the _ConfigMap_ resource *diia-configuration* in the registry namespace to be used by the *bpms* and *ddm-notification-service* services.
** Creating the _Istio ServiceEntry_ resource to give the *bpms* and *ddm-notification-service* services access to the external system.
** _External Secrets Operator_ creating the _Secret_ resource *diia-secret* after processing the _ExternalSecret_ resource *diia-external-secret* and receiving data from *user-management:hashicorp-vault* to be used by the *bpms* and *ddm-notification-service* services.

//=== Налаштування зовнішніх інтеграцій реєстру через _Центр управління платформою_
=== Configuring external integrations of the registry through the Platform Management Center

[NOTE]
--
//Для налаштувань реєстру у якості учасника інформаційного обміну, необхідно задати адресу ШБО Трембіти, яка є єдиним екземпляром для інтеграції з іншими реєстрами. Необхідно розглянути можливість її глобального визначення замість дублювання для кожного з реєстрів.

Connecting a registry to the information exchange requires specifying the location of _SEG Trembita_ that serves as the only means of integration with other registries. We need to consider the possibility of defining it globally instead of duplicating it across each registry.

//Наразі, ціллю дублювання є можливість визначення окремих мок-сервісів для реєстрів - необхідно змінити цей підхід в майбутньому.

Currently, duplicating enables us to define separate mock services for the registries, but this approach needs to change going forward.
--

[IMPORTANT]
--
//Наразі при внесенні змін через *control-plane-console* система автоматично створює _Gerrit MR_ та інтегрує його до репозиторію конфігурації цільового реєстру _<registry>.git_.

//TODO: Double-check that MR = merge request in this context
Currently, when making changes through the *control-plane-console*, the system automatically creates a merge request in _Gerrit_ and integrates it into the target registry's configuration repository: _<registry>.git_.
--

.control-plane-gerrit:<registry>.git/deployment-templates/values.yaml
[source,yaml]
----
trembita:
# External registries used through Trembita / business processes specific integration connectors - can be updated & can't be removed by "control-plane" administrator
  registries:
    edr-registry:
      user-id: "DDM"
      protocol-version: "4.0"
      url: "https://trembita.mdtu-ddm.projects.epam.com"
      type: "platform" # non-removable record + secret metadata
      protocol: "SOAP"
      client:
        x-road-instance: "SEVDEIR-TEST"
        member-class: "GOV"
        member-code: "43395033"
        subsystem-code: "IDGOV_TEST_01"
      service:
        x-road-instance: "SEVDEIR-TEST"
        member-class: "GOV"
        member-code: "00015622"
        subsystem-code: "2_MJU_EDR_prod"
      auth:
        type: "AUTH_TOKEN"
        secret: "vault:registry-kv/registry/<registry>/trembita-registries/<trembita-registry-name>"
    dracs-registry:
      user-id: "DDM"
      protocol-version: "4.0"
      url: "https://trembita.mdtu-ddm.projects.epam.com"
      type: "platform" # non-removable record + secret metadata
      protocol: "SOAP"
      client:
        x-road-instance: "SEVDEIR-TEST"
        member-class: "GOV"
        member-code: "43395033"
        subsystem-code: "IDGOV_TEST_01"
      service:
        x-road-instance: "SEVDEIR-TEST"
        member-class: "GOV"
        member-code: "00015622"
        subsystem-code: "2_MJU_EDR_prod"
    idp-exchange-service-registry:
      user-id: "DDM"
      protocol-version: "4.0"
      url: "https://trembita.mdtu-ddm.projects.epam.com"
      type: "platform" # non-removable record + secret metadata
      protocol: "SOAP"
      client:
        x-road-instance: "SEVDEIR-TEST"
        member-class: "GOV"
        member-code: "43395033"
        subsystem-code: "IDGOV_TEST_01"
      service:
        x-road-instance: "SEVDEIR-TEST"
        member-class: "GOV"
        member-code: "00015622"
        subsystem-code: "2_MJU_EDR_prod"
external-systems:
# External system used both by registry services and business processes - can be updated & can't be removed by "control-plane" administrator
  diia:
    url: "https://api2t.diia.gov.ua"
    protocol: "REST"
    type: "platform" # non-removable record + secret metadata
    auth:
      type: "AUTH_TOKEN+BEARER"
      auth-url: "https://api2t-auth.diia.gov.ua/api/v1/auth/partner" # can be used both as an absolute url to external auth server or relative path to external system base url ('/api/v1/auth/partner')
      access-token-json-path: "$.token"
      secret: "vault:registry-kv/registry/<registry>/external-systems/<ext-system-name>"
# Example external systems added for particular registry and explicitly "used" on regulation level - can be added/updated/removed if necessary by "control-plane" administrator
  http-bin:
    url: "http://httpbin.org/"
    protocol: "REST"
    type: "registry" # removable record + secret metadata
    auth:
      type: "BASIC"
      secret: "vault:registry-kv/registry/<registry>/external-systems/<ext-system-name>"
  secured-service:
    url: "http://secured-service.org/"
    protocol: "REST"
    type: "registry" # removable record + secret metadata
    auth:
      type: "BEARER"
      secret: "vault:registry-kv/registry/<registry>/external-systems/<ext-system-name>"
----

[NOTE]
--
//Для кожного запису налаштувань інтеграції з зовнішніми системами, має бути автоматично створений ресурс _Istio Service Entry_ для надання дозволу взаємодії згідно дизайну.

For each record containing integration settings for external systems, an _Istio Service Entry_ resource must be created automatically to allow the exchange according to the design.
--

//=== Налаштування зовнішніх інтеграцій на рівні регламенту
=== Configuring external integrations at the regulation level

.registry-gerrit:<registry-regulation>.git/bp-trembita/configuration.yml
[source, yaml]
----
# reusing external system names configured on registry level
external-systems:
  diia:
    operations:
      get-damaged-property:
        resource-path: "/api/v1/public-service/damaged-property/filtered"
        method: "GET"
      create-distribution:
        resource-path: "/api/v1/notification/distribution/push"
        method: "POST"
  http-bin:
    operations:
      get-operation:
        resource-path: "/get"
        method: "GET"
----

//=== Створення _ConfigMap_ ресурсів при публікації змін регламенту
=== Creating ConfigMap resources when publishing regulation changes

.ConfigMap: "external-systems-endpoint-configuration"
[source,yaml]
----
kind: ConfigMap
apiVersion: v1
metadata:
  name: external-systems-endpoint-configuration
  namespace: <registry-namespace>
data:
  external-systems-endpoint-configuration.yml: |
    external-systems:
      diia:
        operations:
          get-damaged-property:
            resource-path: "/api/v1/public-service/damaged-property/filtered"
            method: "GET"
          create-distribution:
            resource-path: "/api/v1/notification/distribution/push"
            method: "POST"
      http-bin:
        operations:
          get-operation:
            resource-path: "/get"
            method: "GET"
----

//=== Створення _ConfigMap_ ресурсів при застосуванні змін до налаштувань реєстру
=== Creating ConfigMap resources when applying changes to registry settings

.ConfigMap: "trembita-registries-configuration"
[source,yaml]
----
kind: ConfigMap
apiVersion: v1
metadata:
  name: trembita-registries-configuration
  namespace: <registry-namespace>
data:
  trembita-registries-configuration.yml: |
    trembita:
     registries:
        edr-registry:
          user-id: "DDM"
          protocol-version: "4.0"
          url: "https://trembita.mdtu-ddm.projects.epam.com"
          protocol: "SOAP"
          client:
            x-road-instance: "SEVDEIR-TEST"
            member-class: "GOV"
            member-code: "43395033"
            subsystem-code: "IDGOV_TEST_01"
          service:
            x-road-instance: "SEVDEIR-TEST"
            member-class: "GOV"
            member-code: "00015622"
            subsystem-code: "2_MJU_EDR_prod"
          auth:
            type: "AUTH_TOKEN"
        dracs-registry:
          user-id: "DDM"
          protocol-version: "4.0"
          url: "https://trembita.mdtu-ddm.projects.epam.com"
          protocol: "SOAP"
          client:
            x-road-instance: "SEVDEIR-TEST"
            member-class: "GOV"
            member-code: "43395033"
            subsystem-code: "IDGOV_TEST_01"
          service:
            x-road-instance: "SEVDEIR-TEST"
            member-class: "GOV"
            member-code: "00015622"
            subsystem-code: "2_MJU_EDR_prod"
        idp-exchange-service-registry:
          user-id: "DDM"
          protocol-version: "4.0"
          url: "https://trembita.mdtu-ddm.projects.epam.com"
          protocol: "SOAP"
          client:
            x-road-instance: "SEVDEIR-TEST"
            member-class: "GOV"
            member-code: "43395033"
            subsystem-code: "IDGOV_TEST_01"
          service:
            x-road-instance: "SEVDEIR-TEST"
            member-class: "GOV"
            member-code: "00015622"
            subsystem-code: "2_MJU_EDR_prod"
----

.ConfigMap: "external-systems-configuration"
[source,yaml]
----
kind: ConfigMap
apiVersion: v1
metadata:
  name: external-systems-configuration
  namespace: <registry-namespace>
data:
  external-systems-configuration.yml: |
    external-systems:
      http-bin:
        url: "http://httpbin.org/"
        protocol: "REST"
        auth:
          type: "BASIC"
      secured-service:
        url: "http://secured-service.org/"
        protocol: "REST"
        auth:
          type: "BEARER"
----

.ConfigMap: "diia-configuration"
[source,yaml]
----
kind: ConfigMap
apiVersion: v1
metadata:
  name: diia-configuration
  namespace: <registry-namespace>
data:
  diia-configuration.yml: |
    external-systems:
      diia:
        url: "https://api2t.diia.gov.ua"
        protocol: "REST"
        auth:
          type: "AUTH_TOKEN+BEARER"
          auth-url: "https://api2t-auth.diia.gov.ua/api/v1/auth/partner"
          access-token-json-path: "$.token"
----

//=== Створення _ExternalSecret_ ресурсів при застосуванні змін до налаштувань реєстру
=== Creating ExternalSecret resources when applying changes to registry settings

.ExternalSecret: "trembita-registries-external-secrets"
[source,yaml]
----
kind: ExternalSecret
apiVersion: external-secrets.io/v1beta1
metadata:
  name: trembita-registries-external-secrets
  namespace: <registry-namespace>
spec:
  refreshInterval: "10s"
  secretStoreRef:
    name: user-management:hashicorp-vault
    kind: SecretStore
  target:
    name: trembita-registries-secrets
  dataFrom:
  - extract:
      key: "registry/<registry>/trembita-registries"
----

.ExternalSecret: "external-systems-external-secrets"
[source,yaml]
----
kind: ExternalSecret
apiVersion: external-secrets.io/v1beta1
metadata:
  name: external-systems-external-secrets
  namespace: <registry-namespace>
spec:
  refreshInterval: "10s"
  secretStoreRef:
    name: user-management:hashicorp-vault
    kind: SecretStore
  target:
    name: external-systems-secrets
  dataFrom:
  - extract:
      key: "registry/<registry>/external-systems"

----

.ExternalSecret: "diia-external-secret"
[source,yaml]
----
kind: ExternalSecret
apiVersion: external-secrets.io/v1beta1
metadata:
  name: diia-external-secret
  namespace: <registry-namespace>
spec:
  refreshInterval: "10s"
  secretStoreRef:
    name: user-management:hashicorp-vault
    kind: SecretStore
  target:
    name: diia-secret
data:
  - secretKey: "external-systems.diia.auth.secret.token"
    remoteRef:
      key: "registry/<registry>/external-systems"
      property: "external-systems.diia.auth.secret.token"
----

//=== Застосування змін до _Secret_ ресурсів _Kubernetes_ оператором _External Secrets Operator_
=== Applying changes to Kubernetes Secret resources via External Secrets Operator

[TIP]
--
//_External Secrets Operator_ підтримує створення єдиного _Secret_-ресурсу на базі N записів секретів з _HashiCorp Vault_ з можливостями проведення трансформацій.

// TODO: Clarify: "на базі N записів" = "based on a number of records"?
_External Secrets Operator_ supports creating a unified _Secret_ resource based on N secret records from _HashiCorp Vault_ with transformation options.
--

.Secret: "trembita-registries-secrets"
[source,yaml]
----
kind: Secret
apiVersion: v1
metadata:
  name: trembita-registries-secrets
  namespace: <registry-namespace>
data:
  trembita.registries.<registry-name-1>.auth.secret.token: "<token>"
  trembita.registries.<registry-name-2>.auth.secret.token: "<token>"
  trembita.registries.<registry-name-3>.auth.secret.token: "<token>"
----

.Secret: "external-systems-secrets"
[source,yaml]
----
kind: Secret
apiVersion: v1
metadata:
  name: external-systems-secrets
  namespace: <registry-namespace>
data:
  external-systems.<external-system-name-1>.auth.secret.username: "<username>"
  external-systems.<external-system-name-1>.auth.secret.password: "<password>"
  external-systems.<external-system-name-2>.auth.secret.token: "<token>"
  external-systems.diia.auth.secret.token: "<token>"
----

.Secret: "diia-secret"
[source,yaml]
----
kind: Secret
apiVersion: v1
metadata:
  name: diia-secret
  namespace: <registry-namespace>
data:
  external-systems.diia.auth.secret.token: "<token>"
----

//=== Маунтинг _Secret_ ресурсів на файлову систему
=== Mounting Secret resources onto the file system

.Deployment: "bpms"
[source,yaml]
----
apiVersion: apps/v1
kind: Deployment
metadata:
  name: bpms
spec:
  template:
      containers:
        - name: bpms
          volumeMounts:
            - name: bpms-trembita-registries-secrets
              mountPath: /app/secrets/trembita-registries
            - name: bpms-external-systems-secrets
              mountPath: /app/secrets/external-systems
            - name: bpms-diia-secret
              mountPath: /app/secrets/diia
      volumes:
        - name: bpms-trembita-registries-secrets
          secret:
            secretName: trembita-registries-secrets
        - name: bpms-external-systems-secrets
          secret:
            secretName: external-systems-secrets
        - name: bpms-diia-secret
          secret:
            secretName: diia-secret
----

.File system
[plantuml, secret-mount-structure, svg]
----
@startsalt
{
{T
+ <&folder> /app/secrets
++++ <&folder> <b>trembita-registries</b>
++++++ <&file> trembita.registries.<registry-name-1>.auth.secret.token
++++++ <&file> trembita.registries.<registry-name-2>.auth.secret.token
++++++ <&file> trembita.registries.<registry-name-3>.auth.secret.token
++++ <&folder> <b>external-systems</b>
++++++ <&file> external-systems.<external-system-name-1>.auth.secret.username
++++++ <&file> external-systems.<external-system-name-1>.auth.secret.password
++++++ <&file> external-systems.<external-system-name-2>.auth.secret.token
++++ <&folder> <b>diia</b>
++++++ <&file> external-systems.diia.auth.secret.token
}
}
@endsalt
----

//=== Типи підтримуваних протоколів аутентифікації для інтеграцій та зберігання секретів у _HashiCorp Vault_
=== Types of supported authentication protocols used for integrations and secret storage in HashiCorp Vault

[IMPORTANT]
--
//При збереженні секретів у *user-management:hashicorp-vault* необхідно додатково вносити мета-дані в залежності від типу запису інтеграції для подальшого використання при фільтруванні секретів:

When saving secrets to *user-management:hashicorp-vault*, adding metadata related to the integration record type is required to enable further secrets filtering:

* _type_: platform
* _type_: registry
--

//==== Інтеграції з іншими реєстрами через Трембіту:
==== Integrations with other registries through Trembita

////
- _NO_AUTH_ - взаємодія з реєстром через _ШБО Трембіта_ не потребує додаткової авторизації
- _AUTH_TOKEN_ - взаємодія з реєстром через _ШБО Трембіта_ потребує додаткової авторизації з використанням авторизаційного токену
////

* _NO_AUTH_ -- Interaction with the registry through _SEG Trembita_ does not require additional authorization.
* _AUTH_TOKEN_ -- Interaction with the registry through _SEG Trembita_ requires additional authorization using an authorization token.

//Секрети для взаємодії з реєстрами зберігаються у _HashiCorp Vault_ (*user-management:hashicorp-vault*) за шляхом, згенерованим згідно конвенції:

Secrets used to interact with the registries are stored in _HashiCorp Vault_ (*user-management:hashicorp-vault*) using the path generated according to the following convention:

[source]
----
registry-kv/registry/<registry>/trembita-registries/<trembita-registry-name>
----

////
- _<registry>_ - службова назва реєстру
- _<trembita-registry-name>_ - службова назва реєстру, для якого налаштована інтеграція через _ШБО Трембіта_
////

Where:

* _<registry>_ is the service name of the registry
* _<trembita-registry-name>_ is the service name of the registry for which the integration is configured through _SEG Trembita_

//.Приклад зберігання "AUTH_TOKEN" секрету у _HashiCorp Vault_: "registry-kv/registry/<registry>/trembita-registries/<trembita-registry-name>"
.An example of storing the "AUTH_TOKEN" secret in _HashiCorp Vault_: "registry-kv/registry/<registry>/trembita-registries/<trembita-registry-name>"
[source, json]
----
{
  "trembita.registries.<registry-name>.auth.secret.token": "<authorization-token>"
}
----

//==== Інтеграції з іншими системами:
==== Integrations with other systems

////
- _NO_AUTH_ - взаємодія з зовнішньою системою не потребує авторизації
- _BASIC_ - взаємодія з зовнішньою системою потребую проходження стандартної аутентифікації з використанням _username_ та _password_
- _AUTH_TOKEN_ - взаємодія з зовнішньою системою потребує авторизації з використанням авторизаційного токену
- _AUTH_TOKEN+BEARER_ - взаємодія з зовнішньою системою потребує двоетапної авторизації з отриманням токену доступу за авторизаційним токеном
- _BEARER_ - взаємодія з зовнішньою системою потребує авторизації з використанням авторизаційного токену
////

* _NO_AUTH_ -- Interaction with an external system does not require authorization.
* _BASIC_ -- Interaction with an external system requires standard authentication with a username and password.
* _AUTH_TOKEN_ -- Interaction with an external system requires authorization with an authorization token.
* _AUTH_TOKEN+BEARER_ -- Interaction with an external system requires two-step authorization, using the authorization token to obtain an access token.
* _BEARER_ -- Interaction with an external system requires authorization with an authorization token.

//Секрети для взаємодії з зовнішніми системами зберігаються у _HashiCorp Vault_ (*user-management:hashicorp-vault*) за шляхом, згенерованим згідно конвенції:

Secrets used to interact with external systems are stored in _HashiCorp Vault_ (*user-management:hashicorp-vault*) using the path generated according to the following convention:

[source]
----
registry-kv/registry/<registry/>external-systems/<ext-system-name>
----

////
- _<registry>_ - службова назва реєстру
- _<ext-system-name>_ - службова назва системи, для якої налаштована інтеграція
////

Where:

* _<registry>_ is the service name of the registry
* _<ext-system-name>_ is the service name of the system for which the integration is configured

//.Приклад зберігання "BASIC" секрету у _HashiCorp Vault_: registry-kv/registry/<registry/>external-systems/<ext-system-name>
.An example of storing a "BASIC" secret in _HashiCorp Vault_: registry-kv/registry/<registry/>external-systems/<ext-system-name>
[source, json]
----
{
  "external-systems.<external-system-name>.auth.secret.username": "<username>",
  "external-systems.<external-system-name>.auth.secret.password": "<password>"
}
----

//.Приклад зберігання "BEARER" | "AUTH_TOKEN" | "AUTH_TOKEN+BEARER" секретів у _HashiCorp Vault_: registry-kv/registry/<registry>/external-systems/<ext-system-name>
.An example of storing the "BEARER" | "AUTH_TOKEN" | "AUTH_TOKEN+BEARER" secrets in _HashiCorp Vault_: registry-kv/registry/<registry>/external-systems/<ext-system-name>
[source, json]
----
{
  "external-systems.<external-system-name>.auth.secret.token": "<authorization-token>"
}
----

//==== Сервісні користувачі для доступу в _HashiCorp Vault_:
==== Service accounts for accessing HashiCorp Vault

//Кожний компонент, що отримує доступ до Vault повинен запускатись від окремого OpenShift сервіс акаунта. Сервісні користувачі створені в _HashiCorp Vault_ повинні бути типу https://developer.hashicorp.com/vault/docs/auth/kubernetes[Kubernetes Auth Method] та створюватись під час початкового налаштування _HashiCorp Vault_ через виконання `script-init` ConfigMap.

Every component accessing Vault must use a dedicated OpenShift service account. Service accounts created in _HashiCorp Vault_ must have the https://developer.hashicorp.com/vault/docs/auth/kubernetes[Kubernetes Auth Method] type and must be created during the initial _HashiCorp Vault_ setup by running `script-init` ConfigMap.

|===
|Component|Service account name|Bound namespaces|Capabilities
|External Secrets Operator|external-secrets-operator|Registry namespace|["read"]

|Admin console|control-plane-console|control-plane|["create", "update"]

|===

//.Приклад Capability Policy _HashiCorp Vault_
//TODO: OK to have extra closing curly bracket in the json example?
.An example of _HashiCorp Vault_ Capability Policy
[source, json]
----
{
      "policy": "path \"registry-kv/registry/<registry/>external-systems/\" \"{ capabilities = [ \"read\" ]}\""}
}
----

//.Приклад привʼязки сервіс акаунта OpenShift в _HashiCorp Vault_
.An example of binding an OpenShift service account in _HashiCorp Vault_
[source, json]
----
{
      "bound_service_account_names": ["control-plane-console"],
      "bound_service_account_namespaces": "ns",
      "policies": ["policy-name"],
      "ttl": "1h"
}
----

//== Моделювання регламенту
== Regulation modeling

//=== Зміни до інтеграційних конекторів ЄДР:
=== Changes to the USR connectors for integration

//Перейти до використання змінної оточення "_trembita.registries.edr-registry.auth.secret.token_", яка була створена на базі  xref:architecture/platform/administrative/control-plane/registry-regulation-secrets.adoc#_застосування_змін_до_secret_ресурсів_kubernetes_оператором_external_secrets_operator["trembita-registries-secrets"-секрету] , для отримання авторизаційного токену у типових розширеннях:

//TODO: Change link to en version
We need to switch to using the environment variable _trembita.registries.edr-registry.auth.secret.token_, which is based on the xref:architecture/platform/administrative/control-plane/registry-regulation-secrets.adoc#_застосування_змін_до_secret_ресурсів_kubernetes_оператором_external_secrets_operator["trembita-registries-secrets" secret], to receive the authorization token in these typical extensions:

* _com.epam.digital.data.platform.bpms.extension.delegate.connector.registry.edr.SearchSubjectsEdrRegistryConnectorDelegate_
* _com.epam.digital.data.platform.bpms.extension.delegate.connector.registry.edr.SubjectDetailEdrRegistryConnectorDelegate_

//=== Зміни до універсального REST-конектора:
=== Changes to the Universal REST connector

//Для вказаної на рівні REST-конектора назви зовнішньої системи, необхідно визначити тип авторизації зі змінної оточення "_external-systems.<ext-system-name>.auth-type_", який було налаштовано адміністратором реєстру (_"NO_AUTH" | "BASIC" | "BEARER" | "AUTH_TOKEN+BEARER"_), та в залежності від  типу отримати необхідні дані для проведення авторизації запиту з xref:architecture/platform/administrative/control-plane/registry-regulation-secrets.adoc#_застосування_змін_до_secret_ресурсів_kubernetes_оператором_external_secrets_operator["external-systems-secrets"-секрету]:

//TODO: Change link to en version
For an external system defined at the REST connector level, authorization type is identified by the environment variable _external-systems.<ext-system-name>.auth-type_ set by the registry administrator (_"NO_AUTH" | "BASIC" | "BEARER" | "AUTH_TOKEN+BEARER"_). Depending on the type, the credentials required to authorize the request are obtained from the xref:architecture/platform/administrative/control-plane/registry-regulation-secrets.adoc#_застосування_змін_до_secret_ресурсів_kubernetes_оператором_external_secrets_operator["external-systems-secrets" secret]:

* _com.epam.digital.data.platform.bpms.extension.delegate.connector.rest.ExternalSystemConnectorDelegate_

//== Управління налаштуваннями реєстру
== Registry settings management

//=== Інтерфейси управління зовнішніми інтеграціями реєстру
=== Registry's external integrations management interfaces

//.Управління зовнішніми інтеграціями реєстру
.Registry's external integrations management
image::architecture/platform/administrative/control-plane/registry-integrations/registry-integrations-management.png[registry-integrations-management, 500]

//.Налаштування взаємодії з реєстром через Трембіту
.Managing interactions with a registry through Trembita
image::architecture/platform/administrative/control-plane/registry-integrations/trembita-registry-integration-configuration.png[trembita-registry-integration-configuration, 300]

//.Налаштування взаємодії з зовнішньою системою
.Managing interactions with an external system
image::architecture/platform/administrative/control-plane/registry-integrations/external-system-integration-configuration.png[external-system-integration-configuration, 300]

//== Безпека
== Security

//=== Бізнес Дані
=== Business data

|===
|Data category|Description|Confidentiality|Integrity|Availability

//|Технічні дані що містять інформацію з обмеженим доступом
|Technical data that contains information with restricted access
//|Налаштування системи, конфіги, параметри що містять інформацію з обмеженим доступом зміна яких може негативно вплинути на атрибути системи
|System settings, configs, and parameters that contain information with restricted access, modifying which can negatively affect system attributes
|Medium
|High
|High

//|Технічні дані що містять службову інформацію
|Technical data that contains service information
//|Налаштування системи, конфіги, параметри які являються службовою інформацію
|System settings, configs, and parameters that constitute service information
|High
|High
|High
|===

//=== Спрощена модель загроз
=== Simplified threat model

image::architecture/platform/administrative/control-plane/ext-secrets-management/ext_sec_TM.svg[]

//=== Механізми протидії ризикам безпеки та відповідність вимогам безпеки
=== Ways of countering security risks and meeting security requirements

|===
|Risk|Security controls|Implementation|Priority

//|Компрометація данних у Vault через корневий токен. Зараз корневий токен який має доступ до всього а також до ансілу сховища використовується усіма сервісами як основний.
|Vault data compromise through a root token. Currently, a root token that has access to everything, including vault unseal, is used as the primary token by all services.
a|
//- Створити сервісних користувачів та налаштувати розмежування доступу у Vault
//- Налаштувати RBAC для доступу до секретів в яких лежить корневий токен
* Create service accounts and differentiate access to Vault.
* Set up RBAC for accessing secrets containing the root token.
|Risk eliminated
|Critical

//|Компрометація облікових даних зовнішніх інтеграцій через невірне налаштування системи обробки помилок. При використанні секретів опеншифту, їх монтування в цільовий сервіс як змінна середовища може привести до їх розкриття якщо ПЗ надає інформацію про все операційне середовище при виникненні помилки.
|Compromise of external integrations account data due to incorrect configuration of the error-handling system. Mounting OpenShift secrets onto the target service as an environment variable may lead to their reveal if software returns all information about operating environment when an error occurs.
a| 
//- Монтувати секрети до цільових сервісів як файли.
//- Налаштувати механізм загальної обробки помилок
* Mount secrets for target services as files.
* Set up a general error-handling mechanism.
|Considered in the initial design
|Critical

//|Компрометація данних у Vault через токен доступу оператора секретів. Оператор зовнішніх секретів створює свої кастомні ресурси в яких можуть зберігатись облікові дані доступу до сховища.
|Vault data compromise through the secret operator's access token. External Secrets Operator creates its own custom resources which may contain account information with access to Vault.
a| 
//- Створити окремого сервісного користувача для інтеграції з оператором зовнішніх секретів відповідаючи принципу найменьших привілеїв
//- Налаштувати RBAC для доступу до CRD оператора зовнішніх секретів
* Create a dedicated service account to integrate with External Secrets Operator using the principle of least privilege.
* Set up RBAC for accessing External Secrets Operator custom resource definition (CRD).
|Not considered in the initial design
|High

//|Відмова від авторства. Відсутність аудит логу і інформації про доступ до секретів у Vault.
|Lack of accountability. Absence of an audit log and information about accessing the Vault secrets.
a| 
//- Налаштувати систему логування та аудиту для Vault
Set up the logging and audit system for Vault.
|Not considered in the initial design
|High

//|Ризик бекдору у компоненті external secrets operator
|Backdoor risk in the External Secrets Operator component.
a| 
//- Заборонити на рівні мережевих політик будь яке спілкування сервісу external secrets operator з зовнішніми ресурсами і дозволити комунікацію з сервісами задіяними згідно бізнес логіки.
Prohibit any communications between External Secrets Operator and external resources at the network policies level and allow communication with services involved according to business logic.
|Not considered in the initial design
|High

a|
//- Несанкціонований доступ до даних у датацентрі.
//- Неправильне регламентне виведення з обігу компонентів датацентру
//- Несанкціонований доступ до резервних копій
* Unauthorized data access in the data center.
* Incorrect decommissioning of data center components.
* Unauthorized access to backups.
a| 
//- Налаштувати шифрування для розділів які використовуються Vault-ом
Set up encryption for partitions that use Vault.
|Not considered in the initial design
|Medium

//|Ризик ухилення від виявлення та закріплення в системі за відсутності ротації секретів
|Risk of detection evasion and anchoring in the system due to the absence of secrets rotation.
a| 
//- Налаштувати систему\процес ротації секретів
Set up the system/process of secrets rotation.
|Not considered in the initial design
|Medium
|===