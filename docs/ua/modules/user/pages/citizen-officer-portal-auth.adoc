= Автентифікація користувачів реєстру та підпис даних
include::platform:ROOT:partial$templates/document-attributes/default-set-ua.adoc[]

include::platform:ROOT:partial$admonitions/language-ua.adoc[]

== Загальний опис

Платформа реалізує складні механізми автентифікації кінцевих користувачів, які забезпечують належний захист даних та нівелюють можливість несанкціонованого доступу до інформації.

В основі механізму автентифікації лежить [.underline]#Система управління ідентифікацією та доступом (IAM) *Keycloak*#, яка взаємодіє з [.underline]#Сервісом для роботи з КЕП# та інтегрованою системою електронної ідентифікації *ID.GOV.UA (ICEI)*. Також на платформі функціонують специфічні сервіси автентифікації посадових осіб та отримувачів послуг реєстру -- автентифікатори (_див. детальніше -- xref:#auth-logic[]_).

Окрім цього, платформа використовує *Kong API Gateway* для управління, захисту та моніторингу доступу до API, що забезпечує додатковий рівень захисту та контролю над доступом до даних та сервісів платформи.

Взаємодія між усіма компонентами гарантує надійний механізм автентифікації, який адаптується до різних типів користувачів та їхніх ролей у системі. В результаті, користувачі можуть впевнено працювати з реєстрами, знаючи, що їх особисті дані та інформація знаходяться під надійним захистом, а можливість несанкціонованого доступу до системи зведена до мінімуму.

+++<b style="font-weight: 700">Наразі Платформа підтримує 2 типи автентифікації </b>+++: ::

* [*] автентифікація користувача за допомогою кваліфікованого електронного підпису (КЕП);
* [*] автентифікація користувача за допомогою інтегрованої системи електронної ідентифікації ID.GOV.UA (ІСЕІ) -- зовнішнього постачальника ідентифікаційних даних.

[#auth-logic]
== Логіка автентифікації користувачів

За автентифікацію користувачів реєстру відповідають такі сервіси:

* [.underline]#Сервіс автентифікації отримувачів послуг# -- `*keycloak-ds-citizen-authenticator*`;
* [.underline]#Сервіс автентифікації посадових осіб# -- `*keycloak-ds-officer-authenticator*`.

Для ідентифікації користувача у системі, сервіс автентифікації має отримати з КЕП, або від зовнішнього надавача послуг (`id.gov.ua`) як обов'язкові вхідні параметри наступні атрибути:

* `*drfo*` (`РНОКПП`) -- ідентифікаційний номер, або серія і номер паспорта особи.

* `*edrpou*` (`ЄДРПОУ`) -- код організації, до якої належить особа.

* `*fullName*` (`ПІБ`) -- прізвище, ім'я та по батькові особи.

У процесі автентифікації відбувається пошук користувача у базі даних за атрибутом `drfo`. Якщо користувача з відповідним атрибутом знайдено, то відбувається порівняння атрибутів `fullName` та `edrpou` (за наявності). [.underline]#Порівняння атрибутів `drfo` та `edrpou` відбувається за повним збігом їх значень#.

[TIP]
====
Наприклад: ::

Сервіс автентифікації посадових осіб отримує, РНОКПП особи, виконує запит до сервісу Keycloak, отримує там необхідний атрибут та звіряє його з тим, що вказано у КЕП. Якщо значення у Keycloak та КЕП повністю збігаються, то перевірка проходить успішно, якщо ні -- користувач отримає помилку автентифікації.
+
При автентифікації отримувачів послуг, якщо атрибути не збігаються, тобто користувача не знайдено, то система створить нового користувача.
====

Для атрибута `*fullName*` (`ПІБ`) застосовується інша стратегія -- [.underline]#нечітке порівняння рядків, що не враховує спеціальні символи#.

[NOTE]
====
Проблематика використання стратегії чіткого порівняння (strictIgnoreCase)::

Атрибут `*fullName*` в КЕП, який містить ПІБ особи та є нестандартизованим. Його заповнюють працівники АЦСК без єдиного підходу. Це призводить до незбігу значення `fullName` при перевипуску або використанні КЕП, виданого іншим АЦСК. Наприклад, інший КЕП може містити декілька пробілів замість одного, містити, або не містити спеціальні символи, як-от апостроф або дефіс.
+
Ці зміни в атрибуті `fullName` призводять до того, що користувач не може увійти до Кабінету з новим ключем, оскільки значення атрибута `fullName` у КЕП не збігається зі значенням, що збережене у базі даних сервісу Keycloak. [.underline]#У Keycloak зберігається значення атрибута `fullName` з КЕП користувача, який використовувався при першому вході до реєстру (автореєстрації)#.
+
Реалізація [.underline]#стратегії автентифікації `strictIgnoreCase`# не враховує цю проблему та [.underline]#працює за принципом приведення стрічки до нижнього регістру та видалення лише символів пробілу#.
+
Для розв'язання впроваджено нову стратегію нечіткого порівняння рядків, яка не враховує спецсимволи (`*alphanumericIgnoreCase*`).
====

Стратегія нечіткого порівняння рядків передбачає застосування наступних валідаційних правил:

* Перед порівнянням рядки приводяться до нижнього регістру.
* Видаляються усі символи, окрім латинських та кириличних літер та цифр.
* Довжина рядка після нормалізації має бути не менш як 50% від оригінального.

[TIP]
====
Наприклад: ::

Якщо користувач заведений у Keycloak як `fullName: "Маряна-Іриna  Сергіївна"`, а у КЕП вказано `fullName: "Мар'яна-Іриna Сергіївна!%?"`, то користувач зможе пройти автентифікацію та увійти до Кабінету.
====

== Автентифікація через IIT-віджет

[#kep-auth]
=== Автентифікація за допомогою КЕП

Автентифікація користувачів за допомогою [.underline]#кваліфікованого електронного підпису (КЕП)# відбувається з використанням встановленого на стороні браузера стороннього віджета https://iit.com.ua/downloads[IIT] для виконання операцій, що вимагають шифрування та підпису даних, а також сервісу для роботи з КЕП, що використовує окрему криптобібліотеку від IIT на стороні Платформи для перевірки цілісності та незмінності даних, що передаються з вебклієнта.

Взаємодія користувачів з Платформою та розгорнутими на її базі реєстрами відбувається виключно через імплементовані вебінтерфейси -- додатки **Кабінет отримувача послуг** та **Кабінет посадової особи** -- із будь-якого визнаного індустрією браузера останньої версії.

Автентифікація з КЕП передбачає використання асиметричних алгоритмів шифрування, що забезпечують криптографічний захист даних користувачів.

Для отримання доступу до функцій Кабінету, користувач має увійти до системи, виконавши кроки, описані нижче в інструкції.

CAUTION: Автентифікація з КЕП доступна для користувачів Кабінетів посадової особи та отримувача послуг реєстру.

==== Передумови

Отримайте особистий ключ для підпису даних в одному з https://czo.gov.ua/ca-registry[акредитованих центрів сертифікації ключів (АЦСК)]. Відкритий ключ зберігатиметься на сервері постачальника, в той час, як секретний (закритий) ключ необхідно буде зберегти на одному із захищених носіїв, доступних для використання при вході до системи за допомогою КЕП (_див. крок 3 в підрозділі  xref:auth-process-pass[]_).

[#auth-process-pass]
==== Проходження автентифікації

NOTE: Процес автентифікації за допомогою КЕП є ідентичним як для посадових осіб, так і для отримувачів послуг реєстру.

Розглянемо процес проходження автентифікації на прикладі Кабінету отримувача послуг.

[#auth-step-1]
Крок 1 ::

* Відкрийте сторінку входу до [.underline]#Кабінету отримувача послуг# за адресою `http://citizen-portal-<назва-реєстру>-main.apps.envone.dev.registry.eua.gov.ua/`, якщо ви фізична, або юридична особа, або ФОП і хочете замовити послугу.

* Відкрийте сторінку входу до [.underline]#Кабінету посадової особи# за адресою `http://officer-portal-<назва-реєстру>-main.apps.envone.dev.registry.eua.gov.ua/officer/`, якщо ви посадова особа, що уповноважена надавати послуги.
+
CAUTION: Адреси сервісів, що наведені у тексті вище, є шаблонними. Підставте назву свого реєстру в URL сервісу. При виникненні будь-яких питань, зверніться до адміністратора.

[#auth-step-2]
Крок 2 ::

Натисніть kbd:[Увійти до кабінету].
+
image:user:cp-auth-1.png[]

[#iit-digital-sign-widget]
Крок 3 ::

. Оберіть тип послуг:

* [.underline]#Для громадян# -- якщо ви бажаєте увійти як фізична особа (параметр встановлюється за замовчуванням);
* Для бізнесу -- якщо ви бажаєте увійти як ФОП або юридична особа.

. Оберіть тип носія особистого ключа. +
Оберіть [.underline]#Файловий носій# (параметр встановлюється за замовчуванням).
+
image:user:cp-auth-2.png[]

. У полі `Кваліфікований надавач ел. довірчих послуг` оберіть один з акредитованих центрів сертифікації ключів (АЦСК), натиснувши на елемент випадного списку, або залиште значення `Визначити автоматично`, встановлене за замовчуванням.
+
image:user:cp-auth-3.png[]

. Оберіть особистий ключ:

* У полі `Особистий ключ` натисніть kbd:[Обрати].
* Знайдіть особистий ключ (наприклад `key-6.dat`) та натисніть kbd:[Open] для підтвердження.
+
image:user:cp-auth-4.png[]

. У полі `Пароль захисту ключа` введіть пароль захисту ключа.
. Натисніть kbd:[Зчитати] для перевірки введених даних.
+
image:user:cp-auth-5.png[]

Крок 4 ::

. На формі _підпису даних_ натисніть kbd:[Увійти] для входу до Кабінету.
. (_Альтернативно_) Натисніть kbd:[Змінити ключ], якщо необхідно обрати інший ключ для входу.
+
image:user:cp-auth-6.png[]
+
[WARNING]
====
У разі використання невірного ключа, на кроці підпису даних сервер повертає помилку:

image:user:cp-auth-7-wrong-key.png[]
====
+
[WARNING]
====
У разі введення невірних ідентифікаційних даних (як-от пароль захисту ключа тощо), на кроці підпису даних сервер повертає таку помилку:

image:user:cp-auth-8-wrong-credentials.png[]
====

[NOTE]
====
Після успішного проходження автентифікації у Кабінеті отримувача послуг, під час першого входу, особі буде запропоновано пройти процес онбордингуfootnote:[[.underline]#Онбординг# -- реєстрація в системі для надання прав доступу до функцій Кабінету отримувача послуг.]. Після проходження цього процесу, особа отримає доступ до функцій Кабінету.
====

NOTE: У Кабінеті посадової особи процес онбордингу не передбачений. Тому перед входом до Кабінету необхідно переконатися, що адміністратор доступу створив відповідного користувача.

[#cloud-key]
=== Автентифікація за допомогою хмарного ключа

NOTE: Опція автентифікації за допомогою хмарного ключа доступна як _надавачам,_ так й отримувачам послуг, які мають в наявності хмарний ключ.

. Відкрийте логін-сторінку вашого Кабінету та перейдіть до опцій автентифікації.
. Для вибору автентифікації з використанням хмарного ключа, оберіть на віджеті _Носій у складі сервісу_.
+
TIP: Для деяких віджетів це значення відображається із назвою _Хмарний ключ_ або _Хмарне сховище (як-от для id.gov.ua)_.
+
image:user:cp-auth-9.png[]

. Оберіть емітента (видавця) хмарного ключа з випадного списку у полі _Тип сервісу підпису_. Наприклад, `DepositSign - хмарний підпис`.
+
image:user:cp-auth-10.png[]

. Залежно від значення, яке було обрано в полі _Тип сервісу підпису_, на екрані відобразиться або _QR-код для сканування_, або _ідентифікатор користувача_.
+
.QR-код для сканування
image::user:cp-auth-11.png[]
+
.Ідентифікатор користувача
image::user:cp-auth-12.png[]

. У обох випадках процес подальшого підтвердження автентифікації здійснюється через мобільний телефон. Для автентифікації з використанням ключа від DepositSign необхідно ввести ідентифікатор. Після цього на мобільний телефон користувача надсилається повідомлення з проханням підтвердити дію. Якщо підтвердження успішне, з’являється сторінка входу до кабінету, де необхідно знову виконати процедуру підтвердження.
+
image::user:cp-auth-13.png[]

. Після цього користувач успішно автентифікується у Кабінеті.

[#auth-id-gov-ua]
== Автентифікація з ID.GOV.UA

Платформа надає можливість здійснювати автентифікацію за вбудованого віджета `*id.gov.ua*` -- [.underline]#Інтегрованої системи електронної ідентифікації (ІСЕІ)#.

Автентифікація через зовнішнього провайдера можлива як [.underline]#для отримувачів послуг#, так і [.underline]#для посадових осіб (надавачів послуг)# реєстру.

ІСЕІ `*id.gov.ua*` має атестат відповідності комплексної системи захисту інформації (КСЗІ), тому персональні дані користувачів надійно захищені.

TIP: Для отримання деталей підключення та використання ID.GOV.UA, будь ласка, зверніться до https://id.gov.ua/downloads/IDInfoProcessingD.pdf[технічної документації] або https://id.gov.ua/[офіційного сайту].

[#auth-officers]
=== Автентифікація посадових осіб (надавачів послуг)

. Відкрийте логін-сторінку вашого Кабінету та перейдіть до опцій автентифікації.
. Натисніть на відповідний елемент для автентифікації з ID.GOV.UA.
+
image:user:cp-auth-idgovua-1.png[]

. Оберіть вхід за допомогою [.underline]#Електронного підпису#.
+
image:user-auth/user-auth-idgovua-4-02.png[]

. Оберіть метод автентифікації -- [.underline]#Файловий носій# або [.underline]#Хмарний ключ#.
+
[TIP]
====
Посадові особи можуть автентифікуватися як через _файловий носій_, так і _хмарний ключ_.

Файловий носій – це спеціальний файл, який містить ваш особистий ключ.
Зазвичай цей файл має назву `*Key-6*` з розширенням `*.dat` (зустрічаються також розширення *.pfx, *.pk8, *.zs2, *.jks).
====
+
image:user-auth/user-auth-idgovua-1.png[]

. Завантажте із зовнішнього носія чи власного комп'ютера файл із вашим особистим ключем.
+
image:user-auth/user-auth-idgovua-2.png[]

. Вкажіть пароль доступу до особистого ключа у відповідному полі та натисніть kbd:[Продовжити].
+
image:user-auth/user-auth-idgovua-3.png[]

+
У разі успішного зчитування ключа та проходження автентифікації, посадова особа зможе увійти до Кабінету.

[#citizen-portal-auth]
=== Автентифікація отримувачів послуг

[NOTE]
====
Автентифікація за допомогою `id.gov.ua` доступна як фізичним особам, так і представникам бізнесу, зокрема:

. Автентифікація з використанням методу КЕП доступна користувачам ФОП та представникам ФОП та ЮО.
+
Процес автентифікації представників бізнесу є аналогічним процесу для фізичних осіб і описаний у розділі xref:#kep-auth[] для випадку, коли користувач обирає _Файловий носій_.

. Автентифікація з використанням *Bank-ID* доступна також користувачам-ФОП і є аналогічною процесу для фізичних осіб, описаному у розділі xref:#auth-bank-id[].

. Автентифікація з _Дія.Підпис_ доступна також користувачам-ФОП. Детальніше описано у розділі xref:#auth-dia-signature[].

Зверніть увагу, що користувач більше не може обирати спосіб автентифікації на одній сторінці. В один момент часу доступний лише один з двох способів автентифікації, налаштований адміністратором реєстру -- IIT-віджет або id.gov.ua.
====

Процес автентифікації є наступним: ::
. Відкрийте логін-сторінку вашого Кабінету та перейдіть до опцій автентифікації.
+
image:user:cp-auth-1.png[]

. Оберіть опцію [.underline]#Для громадян# або [.underline]#Для бізнесу#.

. Автентифікуйтеся через віджет `*ID.GOV.UA*`.
+
.Автентифікація через id.gov.ua
image::registry-develop:registry-admin/cp-auth-setup-citizens/cp-auth-setup-citizens-08.png[]

. Оберіть бажану схему (спосіб) автентифікації.
+
[NOTE]
====
Отримувачі послуг реєстру можуть використовувати такі способи автентифікації з `id.gov.ua`:

* Електронний підпис
* Bank ID НБУ
* Дія.Підпис
====
+
image:user:user-auth/user-auth-idgovua-4.png[]

. Дотримуйтеся інструкцій, описаних у підрозділах нижче.
+
NOTE: Уся обробка даних відбувається на стороні `id.gov.ua`. Детальніше про кожен тип автентифікації ви можете дізнатися на https://id.gov.ua/verify[офіційному сайті].

==== Автентифікація з електронним підписом

Електронний підпис є аналогом власноручного підпису та забезпечує правдивість і цілісність інформації, викладеної у документі, а також дає змогу підтвердити цілісність електронного документа та ідентифікувати особу, яка підписала документ.

image:user:user-auth/user-auth-idgovua-5.png[]

. Оберіть опцію _Увійти за допомогою електронного підпису_.
. Оберіть тип ключа, яким ви хочете підписати дані:

* _Файловий носій_ -- це спеціальний файл, який містить ваш особистий ключ. Зазвичай цей файл має назву Key-6 з розширенням _*.dat_ (зустрічаються також розширення _*.pfx_, _*.pk8_, _*.zs2_, _*.jks_).
+
image:user:user-auth/user-auth-idgovua-10.png[]
+
TIP: Автентифікація з цим методом є аналогічною до описаної до у розділі xref:#kep-auth[].

* _Хмарне сховище_ -- якщо ваш особистий ключ зберігається за допомогою стороннього сервісу (зберігання у захищеному хмарному сховищі), то для зчитування ключа необхідно обрати свого надавача зі списку та пройти авторизацію у його системі.
+
image:user:user-auth/user-auth-idgovua-12.png[]

* _Токен_ -- метод автентифікації за допомогою апаратно-програмного пристрою, який працює на базі криптобібліотеки. На Платформі можливим варіантом використання токена
+
[TIP]
====
.Що таке токен?
[%collapsible]
=====
Токен -- це спеціальний апаратно-програмний пристрій, який захищає особисті ключі від копіювання чи зміни зловмисниками. Токен може мати форму USB-пристрою або у формі смарткартка (картки з чипом). Прикладами токенів є пристрої _Алмаз-1К_, _Кристал-1_, `Гряда 301` тощо.

Щоб скористатися токеном:

1. Під'єднайте ваш токен через USB-порт (_якщо у вас токен у формі USB-пристрою_) або скористатися спеціальним зчитувачем інформації (_якщо у вас токен у формі смарткартка_).

2. Оберіть зі списку свого надавача електронних довірчих послуг -- суб'єкта, до якого ви зверталися для отримання електронного підпису.

3. Зі списку токенів оберіть тип пристрою, який ви хочете використати.

4. Вкажіть пароль доступу до особистого ключа у відповідному полі.
=====
====
+
image:user:user-auth/user-auth-idgovua-11.png[]

* _ID-картка_ _(Не використовується)_

. Виконайте усі необхідні кроки, після чого ви зможете увійти до Кабінету.

[#auth-bank-id]
==== Автентифікація з BankID НБУ

Сервіс надається Національним банком України та можливий лише для клієнтів тих банків, які його підтримують.

Після обрання свого банку ви будете переадресовані на його сайт для проходження автентифікації з використанням логіну, пароля, номера картки.

image:user:user-auth/user-auth-idgovua-6.png[]

У разі успішної автентифікації на сайті банку, система Bank ID передасть ваші персональні дані, що дозволить вас ідентифікувати.

image:user:user-auth/user-auth-idgovua-7.png[]

[#auth-dia-signature]
==== Автентифікація з Дія.Підпис

**Дія ID** -- послуга електронної ідентифікації для користувачів, які отримували особистий ключ віддалено за допомогою мобільного застосунку Дія. Дія.Підпис містить дві частини. Одна частина зберігається у вашому смартфоні, а інша — в спеціальному захищеному модулі порталу Дія.

Отримати особистий ключ віддалено за допомогою мобільного застосунку Дія мають можливість громадяни України, які є власниками ID-картки або біометричного закордонного паспорта.

Щоб авторизуватися на сайті за допомогою Дія ID:

. Проскануйте QR-код.

. Зчитайте особистий ключ шляхом сканування обличчя (перевірки за фото) та вводу пароля до особистого ключа.

. У разі успішної автентифікації у мобільному застосунку Дія, система передає ваші персональні дані, що дозволить вас ідентифікувати.
+
image:user:user-auth/user-auth-idgovua-8.png[]
+
image:user:user-auth/user-auth-idgovua-9.png[]

== Підпис даних

=== Підпис даних хмарним ключем через IIT-віджет

NOTE: Опція автентифікації хмарним ключем доступна для користувачів обох типів кабінетів, умовою є наявність хмарного ключа у користувача.

Процес підпису даних за допомогою хмарного ключа на віджеті виконується за тією ж схемою, що й автентифікація через IIT-віджет із використанням хмарного ключа (_див. детальніше xref:#cloud-key[]_).

=== Підпис даних хмарним ключем через віджет ID.GOV.UA

Отримувачі послуг, зокрема фізичні особи та ФОП можуть підписувати дані, перейшовши на сторінку id.gov.ua. Після переходу цим користувачам доступні такі опції:

. Використання _КЕП_
. Використання _хмарного ключа_
. Використання _Дія.Підпис_

==== Використання КЕП для підпису даних

. При переході на задачу підписання даних у бізнес-процесі, користувачам відображається наступний віджет:
+
image:user:user-auth/user-auth-idgovua-13.png[]

. Оберіть опцію _Електронного підпису_. Далі відбувається перехід на сторінку id.gov.ua.
+
image:user:user-auth/user-auth-idgovua-14.png[]

. Оберіть значення _Файловий_, додайте особистий ключ та пароль до нього. Натисніть кнопку `Зчитати`.
+
image:user:user-auth/user-auth-idgovua-15.png[]

. Відбувається зчитування даних з ключа та перехід на сторінку для підпису даних.
+
image:user:user-auth/user-auth-idgovua-16.png[]

. Натисніть `Підписати`, дані успішно підписано.

==== Використання хмарного ключа для підпису даних

. При переході на задачу підписання даних у бізнес-процесі, користувачам відображається наступний віджет.
+
image:user:user-auth/user-auth-idgovua-13.png[]

. Оберіть опцію _Електронного підпису_. Далі відбувається перехід на сторінку id.gov.ua.

. Оберіть значення _Хмарний_, тип сервісу підпису та, залежно від обраного значення, або внесіть ідентифікатор, або проскануйте QR-код. Натисніть кнопку `Зчитати`.
+
image:user:user-auth/user-auth-idgovua-17.png[]
+
NOTE: Обидві дії потребують підтвердження за допомогою мобільного телефона. Після цього відображається сторінка для підпису даних, де потрібно натиснути кнопку `Підписати` і ще раз підтвердити дію за допомогою мобільного телефону.
+
image:user:user-auth/user-auth-idgovua-16.png[]

==== Використання Дія.Підпис для підпису даних

. У випадку, коли адміністратор реєстру вже налаштував у Control Plane у розділі _Віджет підпису документів,_ зокрема у полі _Посилання_, адресу віджета id.gov.ua (наприклад, https://id.gov.ua/sign-widget/v20220527/[]), отримувач послуг -- будь-то фізична особа чи ФОП -- при підписі даних побачить наступний екран:
+
image:user:user-auth/user-auth-idgovua-13.png[]

. Проскануйте QR-код через мобільний додаток Дія. Відбувається підтвердження підпису.
+
image:user:user-auth/user-auth-idgovua-18.png[]

. На наступній сторінці натисніть `Підписати`.
+
image:user:user-auth/user-auth-idgovua-16.png[]

. Тепер повторно підтвердьте підписання даних, ще раз просканувавши QR-код через мобільний додаток _Дія_. Після цього дані будуть успішно підписані.

== Пов'язані сторінки

* xref:registry-develop:registry-admin/cp-auth-setup/cp-auth-setup-overview.adoc[]