:toc-title: ЗМІСТ
:toc: auto
:toclevels: 5
:experimental:
:important-caption:     ВАЖЛИВО
:note-caption:          ПРИМІТКА
:tip-caption:           ПІДКАЗКА
:warning-caption:       ПОПЕРЕДЖЕННЯ
:caution-caption:       УВАГА
:example-caption:           Приклад
:figure-caption:            Зображення
:table-caption:             Таблиця
:appendix-caption:          Додаток
:sectnums:
:sectnumlevels: 5
:sectanchors:
:sectlinks:
:partnums:

= Налаштування власного DNS-імені для Keycloak

== Загальний опис

Адміністратори платформи мають змогу налаштовувати власні DNS-імена для сервісу управління користувачами та ролями Keycloak за допомогою адміністративної панелі Control Plane. Це дозволяє створити зручні URL-адреси для входу користувачів та забезпечує правильну роботу аутентифікації та міжсервісної взаємодії у приватних мережах.

Переваги використання функціональності: ::

* Власні DNS-імена: надає можливість створювати зручні та легко запам'ятовувані URL-адреси для входу користувачів у їхні особисті кабінети.
* Коректна робота в приватних мережах: добре працює у приватних мережах, забезпечуючи правильну перевірку сертифікатів та аутентифікацію за допомогою Keycloak для міжсервісної взаємодії.

Завдяки цьому адміністратори можуть легко та ефективно керувати налаштуваннями Keycloak, що сприяє полегшенню роботи користувачів із системою.

Функціональні сценарії: ::

* Конфігурація DNS-імен компонента Keycloak через адмін-консоль на рівні Платформи

* Вибір DNS-імені для логіна в кабінети користувачів через адмін-консоль на рівні реєстру

* Видалення доданих DNS-імен до Keycloak

Загальні принципи та положення: ::

* Технічний адміністратор Платформи відповідає за конфігурацію наявних Keycloak DNS-імен.

* Адміністратор завантажує SSL-сертифікат у форматі *_.pem_* для домену разом із DNS-іменем.

* Технічний адміністратор реєстру налаштовує DNS-імена для реєстрових кабінетів користувачів.

* Адміністратор реєстру обирає домен для Keycloak зі списку доступних.

* Список доступних доменів у системі формується з DNS-імен платформного Keycloak.

* У налаштуваннях кабінетів можна завантажити окремі SSL-сертифікати у форматі *_.pem_* для кожного користувацького кабінету.

* Адміністратор Платформи забезпечує ротацію сертифікатів Keycloak та кабінетів користувачів.

* Система дозволяє редагувати встановлені раніше SSL-сертифікати та DNS-імена.

* Адмін-консоль перевіряє, чи завантажений SSL-сертифікат відповідає введеному домену, чи не є самопідписаним, та чи строк його дії ще не сплив.

* З міркувань безпеки, доступ до _HashiCorp Vault_ для читання сертифікатів здійснюється ЛИШЕ через окремого сервісного (системного) користувача.

* Якщо реєстр розгортається без порталу (надавача або отримувача послуг), відповідні UI-елементи для налаштування DNS-імен не відображаються.

* Заданий URL для Keycloak та кабінетів обмежений 63 символами та проходить системну валідацію на правильність.

[#configure-dns-platform]
== Конфігурація DNS-імен компонента Keycloak для Платформи

Щоб налаштувати власні DNS-імена, а також завантажити SSL-сертифікати для Keycloak, виконайте наступні дії:

. Увійдіть до адміністративної панелі *Control Plane*.
. Відкрийте розділ Керування Платформою та перейдіть до пункту *Keycloak DNS*.
+
У цьому розділі ви побачите системне значення DNS за замовчуванням, яке вже заповнене й недоступне для редагування.
+
NOTE: Для додаткових DNS виконайте зовнішню конфігурацію записів у реєстратора доменних імен. Для цього скористайтеся інструкцією xref:#external-configuration[], яка також доступна за посиланням на інтерфейсі Control Plane.

+
image:registry-management/custom-dns/keycloak/custom-dns-keycloak-platform-1.png[]

. Натисніть кнопку kbd:[Додати DNS], щоб відкрити вікно налаштувань. Введіть доменне ім'я для Keycloak, відповідно до підказок під полем, і завантажте SSL-сертифікат для Keycloak.
+
NOTE: Конфігурація DNS за замовчуванням вичитується адмін-консоллю зі специфікації Keycloak CR у компоненті *`user-management`*.

. У вікні налаштувань натисніть кнопку kbd:[Підтвердити], щоб зберегти дані та запустити валідаційні перевірки.
+
TIP: Ви можете також натиснути кнопку kbd:[Відмінити], щоб закрити вікно без збереження внесених даних.
+
image:registry-management/custom-dns/keycloak/custom-dns-keycloak-platform-2.png[]
+
Всі додані DNS-імена будуть відображатися списком на сторінці *Keycloak DNS*.

. Ви можете відредагувати будь-яке з доданих DNS-імен, натиснувши на іконку олівця поряд з обраним додатковим DNS. У вікні редагування змініть доменне ім'я та сертифікат.
+
NOTE: Дія кнопок "Відмінити" та "Підтвердити" така сама, як і при додаванні нового DNS, і вони виконують ті ж самі валідації при збереженні даних.

. Також, ви можете видалити додатковий DNS, якщо він не використовується жодним із реєстрів. Якщо він використовується, спочатку змініть домен в відповідному реєстрі на інший. Для видалення потрібно натиснути на іконку корзини, що розташована навпроти обраного доданого DNS, і у вікні, що з'явиться, підтвердити дію.

. Після завершення всіх дій із додатковими DNS, натисніть кнопку kbd:[Підтвердити] для збереження змін. Після виконання валідаційних перевірок, якщо всі дані введені коректно, вони збережуться.

+
В результаті сформується запит на оновлення конфігурації реєстру, який можна переглянути у розділі +++<b style="font-weight: 600"> Керування Платформою > Запити на оновлення </b>+++.

. Підтвердьте внесення змін та дочекайтеся виконання Jenkins-процесу *MASTER-Build-cluster-mgmt*, який і застосує конфігурацію.

[#configure-dns-registry]
== Конфігурація DNS-імен компонента Keycloak для реєстру

Налаштовані у розділі xref:#configure-dns-platform[] DNS-імена можуть використовуватися при створенні або редагуванні реєстру. Для цього:

. Увійдіть до інтерфейсу адмін-панелі *Control Plane*.

. Відкрийте розділ +++<b style="font-weight: 600"> Реєстри </b>+++ та оберіть один із реєстрів зі списку для редагування.

. Натисніть `Редагувати` > `+++<b style="font-weight: 600">Налаштування DNS </b>+++`.

. Знайдіть секцію +++<b style="font-weight: 600"> Сервіс управління користувачами та ролями (Keycloak) </b>+++ та оберіть DNS-ім'я зі списку доступних.

. Натисніть kbd:[Підтвердити], що зберегти зміни. Після виконання валідаційних перевірок, якщо всі дані введені коректно, вони збережуться.

+
В результаті сформується запит на оновлення конфігурації реєстру, який можна переглянути у розділі +++<b style="font-weight: 600"> Реєстри > Запити на оновлення </b>+++.

. Підтвердьте внесення змін та дочекайтеся виконання Jenkins-процесу *MASTER-Build-<registry-name>*, який і застосує конфігурацію.

image:registry-management/custom-dns/keycloak/custom-dns-keycloak-registry.png[]

[#external-configuration]
== Додаткова конфігурація за межами OpenShift-кластера та реєстру

Виконайте зовнішню конфігурацію за межами OpenShift-кластера та реєстру.

. Створіть `CNAME`-запис у свого постачальника DNS.
+
Він має вказувати на _Load Balancer_ прив'язаного до OpenShift роутера (_HAProxy_). Домен роутера OpenShift відрізняється для кожного кластера. Записи `CNAME` завжди повинні вказуватися на інше доменне ім’я, а не на IP-адресу.
+
[TIP]
====
`CNAME` (Запис канонічного імені) -- це тип запису ресурсу в системі доменних імен (DNS), який порівнює одне доменне ім’я (псевдонім) з іншим (канонічне ім’я).
====
+
`CNAME` запис може виглядати так:
+
----
www.example.net. CNAME www.example.com.
----
+
Подивитись на поточні встановлені CNAME записи можна за допомогою сервісу link:https://dns.google[dns.google].
+
[WARNING]
====
`CNAME` не може бути встановлений для *apex*-доменів (example.com), а піддомен повинен бути вказаний (www.example.com).
====

. Напишіть у Telegram-каналі `[EPAM] IIT Digital Signature Library Questions`, щоб додати нову адресу до тестового віджету link:https://eu.iit.com.ua/[eu.iit.com.ua].
+

+
--
Кабінет посадової особи та отримувача послуг стає доступний за налаштованими DNS-іменами після додаткової (ручної) зовнішньої конфігурації адміністратором.

[CAUTION]
Зазвичай оновлення DNS-імен відбувається впродовж однієї години, хоча глобальне оновлення може тривати до 48 годин.
--

== Застосування змін до конфігурації

Коли ви підтверджуєте зміни після налаштувань в адмін-панелі, на рівні Платформи та реєстру відбувається наступне:

Для налаштувань платформи: ::

. SSL-сертифікати, які ви завантажили для власних доменів Keycloak, зберігаються у _Підсистемі управління секретами та шифруванням_, *HashiCorp Vault*.
. У файлі *_deploy-templates/values.yaml_* компонента `*cluster-mgmt*` додаються записи із доменами та шляхами до SSL-сертифікатів, що відповідають прикладу:
+
[source,yaml]
----
keycloak:
  customHosts:
    - host: keycloak.example.com
      certificatePath: registry-kv/....
    - host: keycloak-login.instance.com
      certificatePath: registry-kv/....
----

Для налаштувань реєстру: ::

. SSL-сертифікати, які ви завантажили для кастомних доменів Кабінетів надавача та отримувача послуг, також зберігаються до *HashiCorp Vault*.
. У файлі *_deploy-templates/values.yaml_* відповідного реєстрового репозиторію додаються записи із доменами та шляхами до SSL-сертифікатів, що відповідають прикладу:
+
[source,yaml]
----
portals:
  officer:
    customHost:
       enabled: true
       host: officer.example.com
       certificatePath: registry-kv/....
----

[ssl-certificates-saving-convention]
=== Конвенція зберігання SSL-сертифікатів

Конвенція зберігання SSL-сертифікатів у HashiCorp Vault визначає шляхи для платформних та реєстрових сертифікатів.

Платформні сертифікати зберігаються за шляхом:

----
registry-kv/cluster/domains/<domain-name>

key:caCertificate value:<caValue>
key:certificate value:<certificateValue>
key:key value:<keyValue>
----

Реєстрові сертифікати зберігаються за шляхом:

----
registry-kv/registry/<registry-name>/domains/<portal-name>/<domain-name>

key:caCertificate value:<caValue>
key:certificate value:<certificateValue>
key:key value:<keyValue>
----