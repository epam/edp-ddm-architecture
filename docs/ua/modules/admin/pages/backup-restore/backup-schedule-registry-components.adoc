:toc-title: ЗМІСТ
:toc: auto
:toclevels: 5
:experimental:
:important-caption:     ВАЖЛИВО
:note-caption:          ПРИМІТКА
:tip-caption:           ПІДКАЗКА
:warning-caption:       ПОПЕРЕДЖЕННЯ
:caution-caption:       УВАГА
:example-caption:           Приклад
:figure-caption:            Зображення
:table-caption:             Таблиця
:appendix-caption:          Додаток
:sectnums:
:sectnumlevels: 5
:sectanchors:
:sectlinks:
:partnums:

= Керування розкладом резервного копіювання реєстру

== Загальний опис

Платформа надає можливість [.underline]#керувати розкладом створення резервних копій компонентів реєстру, а також часом зберігання таких копій у сховищі бекапів#.

Резервні копії компонентів створюються за допомогою інструменту *`velero`* та зберігаються у захищеному сховищі бекапів *`minio`*, що знаходиться поза межами кластера Платформи.

[NOTE]
====
Розклад резервного копіювання налаштовується у форматі https://uk.wikipedia.org/wiki/Cron[*unix-cron*] на інтерфейсі адміністративної панелі *Control Plane*.

Період зберігання резервних копій має бути більшим за або дорівнювати одиниці, бути цілим числом та не містити спеціальних символів.

Запуск процесів по `cron` визначається у різних часових зонах для резервного копіювання реєстру та реплікації S3-об'єктів (_детальніше про це описано у розділах нижче_).
====

////
TODO: Need this section?
Перелік компонентів реєстру, для яких налаштовується резервне копіювання за розкладом та час зберігання резервних копій: ::

* [*] [.underline]#Портал управління бізнес-процесами реєстру# -- компонент `*bp-admin-portal*`.
* [*] [.underline]#Кабінет отримувача послуг# -- компонент `*citizen-portal*`.
* [*] [.underline]#Кабінет посадової особи# -- компонент `*officer-portal*`.
* [*] [.underline]#Система перевірки та версіонування коду# -- реєстровий компонент `*gerrit*`.
* [*] [.underline]#Система збірки та розгортання змін на середовищах# -- реєстровий компонент `*jenkins*`.
* [*] [.underline]#Система управління ідентифікацією користувачів реєстру та правами доступу# -- реєстровий компонент *keycloak*.
* [*] [.underline]#Сховище артефактів# -- реєстровий компонент *`nexus`*.
////

Також система виконує автоматичну реплікацію даних, які зберігаються в S3-бакетах. Ви можете налаштувати розклад резервного копіювання таких реплікацій.

Значення розкладу резервного копіювання для компонентів реєстру, а також для реплікацій бакетів зберігаються до конфігурації реєстру у файл *_deploy-templates/values.yaml_* за допомогою пайплайну *MASTER-Build-`<registry-name>`*.

За створення резервних копій реєстру відповідає Jenkins-пайплайн *`Create-registry-backup-<registry-name>`*. Він запускається згідно зі встановленим часом у розкладі, створює бекапи та зберігає їх визначену кількість днів.

[#schedule-setup]
== Налаштування розкладу резервного копіювання

[#registry-components-backup-schedule]
=== Налаштування розкладу створення резервних копій реєстру та періоду їх зберігання

. Увійдіть до консолі *Control Plane* як адміністратор реєстру.
+
image:admin:infrastructure/cluster-mgmt/update-cluster-mgmt-01.png[]

. Перейдіть до розділу +++<b style="font-weight: 600">Реєстри<b>+++ та оберіть необхідний.
+
image:admin:infrastructure/cluster-mgmt/change-key/change-key-01.png[]

. Натисніть кнопку `+++<b style="font-weight: 600">Редагувати<b>+++`, що розташована у правому верхньому куті.
+
NOTE: Налаштування розкладу резервного копіювання та часу зберігання резервних копій доступне також при xref:admin:registry-management/control-plane-create-registry.adoc[створенні реєстру], та не є обовʼязковим.

+
image:admin:infrastructure/cluster-mgmt/change-key/change-key-02.png[]

. Перейдіть до секції +++<b style="font-weight: 600">Резервне копіювання<b>+++. Тут можна встановити розклад створення резервних копій та період зберігання. Активуйте перемикач та налаштуйте розклад створення автоматичних резервних копій.
+
TIP: За замовчуванням налаштування автоматичних резервних копій вимкнено для нових реєстрів.

+
image:admin:backup-restore/backup-schedule-registry-components/backup-schedule-registry-components-01.png[]
+
[NOTE]
====
Розклад резервного копіювання налаштовується у форматі https://uk.wikipedia.org/wiki/Cron[*unix-cron*] та визначається [.underline]#за київським часом#.

За замовчуванням часовий пояс `*Europe/Kiev*` встановлюється у конфігурації _values.yaml_ та на рівні поди з Jenkins як змінна середовища.

Враховується https://24timezones.com/%D0%9A%D0%B8%D1%97%D0%B2/%D1%87%D0%B0%D1%81[зміщення] на +2 години (`UTC+2`) у зимовий та +3 години (`UTC+3`) у літній час.

Скористайтеся ресурсом https://crontab.guru/[] -- простим та зручним редактором для виразів cron, щоб краще зрозуміти логіку налаштувань розкладу.
====
* У полі `Розклад` вкажіть, наприклад, таке значення: `5 10 * * MON-FRI`. Використовуйте пробіл як роздільник.
+
Це означатиме, що резервна копія для середовища реєстру створюватиметься кожного дня, з понеділка по п'ятницю, о 10:05 за київським часом.
+
TIP: Після введення розкладу резервного копіювання, на інтерфейсі з'являється підказка, яка показує час 3-х наступних запусків створення резервних копій.

* У полі `Час зберігання (днів)` вкажіть, наприклад, `5`. Тобто бекап зберігатиметься у сховищі протягом 5 днів.
+
NOTE: Значення може бути лише додатним числом та не меншим за 1 день. Рекомендуємо встановити час збереження більшим за період між створенням копій.
+
image:admin:backup-restore/backup-schedule-registry-components/backup-schedule-registry-components-02.png[]

. Перейдіть до налаштування xref:#replication-schedule-backup[резервного копіювання реплікацій об'єктів S3], або залиште значення за замовчуванням та натисніть `+++<b style="font-weight: 600">Підтвердити<b>+++`.

[#replication-schedule-backup]
=== Резервне копіювання реплікацій об'єктів S3

==== Контекст

*Velero* -- це відкритий інструмент, що надає можливості резервного копіювання, відновлення, міграції та аварійного відновлення компонентів Платформи. Важливо зазначити, що Velero спроможний створювати резервні копії не лише власне даних (наприклад, зі сховищ, сумісних з S3), а й стану середовища OpenShift, включаючи конфігурації розгортань.

S3-бакети, своєю чергою, слугують для зберігання різноманітних даних. У контексті нашої системи, вони використовуються для реплікації даних між S3-сумісними сховищами.

Верхньорівневий опис роботи системи наступний: ::

. Використовуючи компонент velero, Платформа створює резервні копії ресурсів OpenShift (таких як конфігурації, секрети, томи (volumes), ресурси баз даних тощо) згідно з налаштованим графіком. Ці резервні копії зберігаються у сховищі *Minio* протягом визначеного періоду часу (_детальніше див. у розділі xref:#schedule-setup[]_).

. Крім того, реєстр містить дані, які є необхідними для бізнес-процесів, зокрема тимчасові дані, історія виконання процесів тощо). Ці дані зберігаються у вигляді `ObjectBucketClaim` (`obc`) в S3-бакетах. Реплікація цих бакетів відбувається автоматично. Ви можете налаштувати резервне копіювання для таких реплікацій через адміністративну панель Control Plane.

Реплікація полягає в автоматичному копіюванні даних з одного бакета до іншого, що може бути корисним, наприклад, для створення резервних копій даних в інших географічних регіонах, що забезпечує високу доступність та надійність.

Таким чином, платформа надає дворівневий захист: через резервні копії ресурсів OpenShift, які створюються за допомогою Velero і зберігаються в Minio, та через реплікацію S3-бакетів, яка гарантує додаткове зберігання даних.

==== Налаштування бекапів реплікації S3-об'єктів

. Увійдіть до консолі *Control Plane* як адміністратор реєстру.
+
image:admin:infrastructure/cluster-mgmt/update-cluster-mgmt-01.png[]

. Перейдіть до розділу +++<b style="font-weight: 600">Реєстри<b>+++ та оберіть необхідний.
+
image:admin:infrastructure/cluster-mgmt/change-key/change-key-01.png[]

. Натисніть кнопку `+++<b style="font-weight: 600">Редагувати<b>+++`, що розташована у правому верхньому куті.

+
image:admin:infrastructure/cluster-mgmt/change-key/change-key-02.png[]

. Перейдіть до секції +++<b style="font-weight: 600">Резервне копіювання<b>+++ > +++<b style="font-weight: 600">Резервне копіювання реплікацій об'єктів S3<b>+++.
+
image:admin:backup-restore/backup-schedule-registry-components/backup-schedule-registry-components-10.png[]

. Налаштуйте розклад.
+
[NOTE]
====
Розклад резервного копіювання налаштовується у форматі https://uk.wikipedia.org/wiki/Cron[*unix-cron*] та визначається [.underline]#за UTC#.

Часова зона встановлюється у конфігурації _values.yaml_ та на рівні поди з Jenkins як змінна середовища.

Скористайтеся ресурсом https://crontab.guru/[] -- простим та зручним редактором для виразів cron, щоб краще зрозуміти логіку налаштувань розкладу.
====
+
У полі Розклад вкажіть, наприклад, таке значення: `25 12 * * *`. Використовуйте пробіл як роздільник. Це означатиме, що резервна копія реплікації S3-бакета створюватиметься кожного дня о 12:25.
+
Якщо не задати власний розклад, то система використає значення за замовчуванням згідно з UTC: `30 17 * * * *`.
+
[TIP]
====
Після введення розкладу резервного копіювання, на інтерфейсі з'являється підказка, яка показує час 3-х наступних запусків створення резервних копій:
____
Наступний запуск резервного копіювання реплікацій об'єктів S3 (за UTC):

* 09.06.2023 12:25:00
* 10.06.2023 12:25:00
* 11.06.2023 12:25:00
____
====

. Налаштуйте місце зберігання резервних копій реплікацій об'єктів S3.
+
NOTE: Якщо не встановити власних значень для зберігання, використовуються значення за замовчуванням, встановлені системною при розгортанні реєстру.

* Встановіть власні значення для зберігання резервних копій реплікацій об'єктів S3. Для цього натисніть +++<b style="font-weight: 600">Задати власні значення<b>+++ та у новому вікні заповніть відповідні поля:

** +++<b style="font-weight: 600">Ім'я бакета<b>+++ +
Ім'я бакета має бути унікальним серед усіх інших бакетів у вашому середовищі S3 та містити від 3 до 63 символів. Допустимі символи: `"a-z"`, `"0-9"`, `"."`, `"-"`. Наприклад, `my-s3-bucket-123`.

** *Endpoint* +
Це URL, за яким сервіс з'єднується із S3-середовищем. Наприклад, `https://endpoint.com`. Наприклад, для Amazon S3 це може бути https://s3.amazonaws.com для глобального endpoint або https://s3.<Region>.amazonaws.com для конкретного регіону, де `<Region>` це ідентифікатор регіону, наприклад, `us-west-2`.

** +++<b style="font-weight: 600">Логін<b>+++ +
Це облікові дані, які ви отримуєте від постачальника послуги. Наприклад, для Amazon S3, це ваш *AWS Access Key ID*, що виглядає приблизно так: `AKIAIOSFODNN7EXAMPLE`.
** +++<b style="font-weight: 600">Пароль<b>+++ +
Це облікові дані, які ви отримуєте від постачальника послуги. Наприклад, для Amazon S3, це ваш *AWS Secret Access Key*, що може виглядати приблизно так: `wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY`.

* Натисніть `+++<b style="font-weight: 600">Підтвердити<b>+++`, щоб зберегти власні значення для зберігання, або `+++<b style="font-weight: 600">Відмінити<b>+++`, щоб скасувати внесення змін.
+
image:admin:backup-restore/backup-schedule-registry-components/backup-schedule-registry-components-9.png[]

* На сторінці +++<b style="font-weight: 600">Резервне копіювання<b>+++ знову натисніть `+++<b style="font-weight: 600">Підтвердити<b>+++`, щоб зберегти зміни та відправити запит на оновлення конфігурації реєстру.
+
image:admin:backup-restore/backup-schedule-registry-components/backup-schedule-registry-components-11.png[]

=== Застосування конфігурації розкладу

У результаті виконання налаштувань розкладу резервного копіювання, описаних у попередніх підрозділах, формується запит на оновлення зі статусом `Новий` та типом `Редагування реєстру`.

. У розділі +++<b style="font-weight: 600">Реєстри<b>+++ > +++<b style="font-weight: 600">Запити на оновлення<b>+++ знайдіть необхідний запит.
+
image:registry-management/cp-submit-mr/cp-submit-mr-1.png[]

. Відкрийте сформований запит, натиснувши іконку перегляду -- 👁.

. У новому вікні зіставте 2 версії змін, переконайтеся, що внесені вами дані вірні, та натисніть `+++<b style="font-weight: 600">Підтвердити<b>+++`. Ви також можете відразу відхилити зміни до конфігурації, натиснувши `+++<b style="font-weight: 600">Відхилити<b>+++`.
+
NOTE: Запропоновані зміни вносяться до конфігурації файлу *_deploy-templates/values.yaml_* репозиторію реєстру у разі підтвердження.

+
image:admin:backup-restore/backup-schedule-registry-components/backup-schedule-registry-components-12.png[]
+
image:registry-management/cp-submit-mr/cp-submit-mr-3.png[]
+
У результаті запит набуває статусу `Підтверджено`.

. Зачекайте, доки виконається збірка коду. Це може зайняти декілька хвилин.

Після успішного застосування конфігурації, у встановлений час запускається Jenkins-пайплайн *Create-registry-backup-`<registry-name>`*. Він застосовує параметри заданої конфігурації та створює резервні копії у сховищі бекапів (_див. детальніше у розділі xref:#create-check-backups[]_).

[#create-check-backups]
== Створення та перевірка бекапів

У визначену дату та час мають бути створені резервні копії, згідно із розкладом, вказаним у конфігурації (_див. -- xref:#schedule-setup[]_).

Перевірити це можна наступним чином: ::
+
. У відомостях про реєстр відкрийте секцію +++<b style="font-weight: 600">Компоненти реєстру<b>+++ та перейдіть до *Jenkins*.
+
image:admin:backup-restore/backup-schedule-registry-components/backup-schedule-registry-components-1.png[]

. Перейдіть до теки з необхідним реєстром та оберіть пайплайн *`Create-registry-backup-<registry-name>`*. Якщо пайплайн підсвічується зеленим, то збірку можна вважати успішною.
+
image:admin:backup-restore/backup-schedule-registry-components/backup-schedule-registry-components-2.png[]

. Відкрийте деталі збірки.
+
image:admin:backup-restore/backup-schedule-registry-components/backup-schedule-registry-components-3.png[]

. Перейдіть до виводу консолі, *Console Output*, щоб переглянути технічний лог виконання пайплайну.
+
image:admin:backup-restore/backup-schedule-registry-components/backup-schedule-registry-components-4.png[]

. Прокрутіть бігунок униз сторінки та переконайтеся, що резервну копію реєстру створено.
+
.Console Output. Успішне створення резервної копії реєстру
====
----
[INFO] Velero backup - external-1-2023-02-17-17-07-36 done with Completed status
----
Вираз показує, що створено резервну копію для реєстру із певною назвою (_тут_ -- `external-1`), дату та час створення бекапу та статус успішного завершення.
====
+
image:admin:backup-restore/backup-schedule-registry-components/backup-schedule-registry-components-5.png[]

+
IMPORTANT: Після закінчення строку зберігання, система бекапування видаляє застарілі резервні копії.