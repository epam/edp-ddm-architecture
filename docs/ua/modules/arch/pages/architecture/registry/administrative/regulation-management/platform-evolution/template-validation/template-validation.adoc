= Валідація порожніх обов'язкових полів на рівні шаблонів у бізнес-процесі

== Загальний опис
При моделюванні бізнес-процесів використовуються _Шаблони елементів_ для типових BPMN елементів (сервісні задачі, задачі
користувача тощо) з описом відповідного контракту. Для вхідних параметрів такого роду шаблонів налаштовується валідація,
яка відпрацьовує на стороні клієнта у _Веб-інтерфейсі моделювання регламенту_. Проте в рамках реалізації правила валідації
були застосовані не для всіх необхідних параметрів _Шаблонів елементів_ Через це відсутність обов'язкового поля
моделювальник побачить тільки при виконанні бізнес-процесу, а не при його моделюванні. Необхідно застосувати правила
валідації в рамках чинного рішення для всіх _Шаблонів елементів_ та додатково розробити механізм серверної валідації.

== Концепти
* _Шаблони елементів_ - Camunda element templates, які спрощують процес моделювання бізнес-процесів. Детальніше
https://docs.camunda.io/docs/components/modeler/desktop-modeler/element-templates/about-templates/[за посиланням]
* _Пайплайн перевірки регламенту_ - Jenkins Code Review pipeline, який запускається при внесенні змін в версію кандидат, або
безпосередньо в МР в Gerrit
* _Пайплайн публікації регламенту_ - Jenkins Build pipeline, який запускається при внесенні змін в мастер версію регламенту реєстру

== Функціональні сценарії
* Використання _Шаблонів елементів_ при моделюванні бізнес-процесів регламенту реєстру у
_Веб-інтерфейс моделювання регламенту_
* Валідація вхідних параметрів шаблонів задач у _Пайплайні перевірки регламенту_ при моделюванні регламенту
* Валідація вхідних параметрів шаблонів задач у _Пайплайні публікації регламенту_ при моделюванні регламенту
* Валідація вхідних параметрів шаблонів задач у _Веб-інтерфейсі моделювання регламенту_ при моделюванні регламенту
* Валідація вхідних параметрів шаблонів задач у _Пайплайні публікації регламенту_ при розгортанні регламенту
на продакшен оточенні

== Ролі користувачів
* Розробник регламенту
* Адміністратор реєстру

== Загальні принципи та положення

=== Серверна валідація
* Серверна валідація _Шаблонів елементів_ проходить за загальними принципами валідації регламенту реєстру на
_Пайплайні публікації регламенту_ та _Пайплайні перевірки регламенту_
* _Пайплайн перевірки регламенту_ розширюється кроком по валідації регламенту реєстру
* Валідація вхідних параметрів _Шаблонів елементів_ повинна виконуватися за допомогою утиліти
registry-regulations-validator-cli
* При наявності помилок валідації вхідних параметрів _Шаблонів елементів_, _Пайплайн перевірки регламенту_ повинен викидати
помилку з повідомленням, яке є достатнім для розуміння помилки
* Для правил валідації використовується та сама версія _Шаблонів елементів_, що і для _Веб-інтерфейсу моделювання регламенту_
* Версія _Шаблонів елементів_ відповідає версії реєстру. Тобто _Шаблонів елементів_ можуть бути змінені тільки в момент оновлення
версії реєстру
* Для збереження _Шаблонів елементів_ використовується ConfigMap, яка оновлюється при оновленні версії реєстру
* Для опису правил валідації використовується стандарний механізм element templates (constraints)
* В рамках поточного рішення підтримується тільки notEmpty constraint валідація (100% випадків використання в версії
платформи 1.9.5)

=== Валідація у _Веб-інтерфейсі моделювання регламенту_ (поточний стан)
* При розробці шаблону задач можна вказати тип поля вхідного параметра
* Валідація на клієнті підтримується тільки при вказанні типу вхідного параметра
* В Camunda версії 7.x є можливість не вказувати тип вхідного параметра
* На даний момент підтримуються наступні типи вхідних параметрів: String, Text, Boolean, Dropdown and Hidden
* Для переліку шаблонів задач в платформі потрібне використання типу Map, який не підтримується в Camunda версії 7.x/8.x
* Якщо не вказувати тип вхідного параметра, у моделювальника буде можливість самостійно обрати тип Map зі списку
* Типізовані вхідні параметри показуються в секції Custom Properties, в той час, як нетипізовані - в секції
Input Parameters

NOTE: Camunda 8.x не підтримує нетипізовані вхідні параметри.
https://docs.camunda.io/docs/components/modeler/desktop-modeler/element-templates/defining-templates/[Деталі тут]

.Панель моделювання. Типізовані параметри
image::architecture/registry/administrative/regulation-management/platform-evolution/template-validation/panel-properties.png[300,200]

.Панель моделювання. Нетипізовані параметри
image::architecture/registry/administrative/regulation-management/platform-evolution/template-validation/panel-inputs.png[300,200]

.Панель моделювання. Змішані параметри
image::architecture/registry/administrative/regulation-management/platform-evolution/template-validation/panel-inputs-properties.png[300,200]

== Високорівневий дизайн рішення

.Компонентна діаграма
image::architecture/registry/administrative/regulation-management/platform-evolution/template-validation/component.svg[]

.Діаграма розгортання (поточна)
image::architecture/registry/administrative/regulation-management/platform-evolution/template-validation/delivery-current.svg[]

.Діаграма розгортання (цільова)
image::architecture/registry/administrative/regulation-management/platform-evolution/template-validation/delivery-target.svg[]

.Валідація параметрів шаблонів елементів у валідаторі регламенту
[plantuml, template-validation-1, svg]
----
@startuml
start
:CLI received the list of BPMN files to validate;
:CLI read element templates config map;
repeat

  :get next BPMN file to validate;
  group BPMN file validation
  repeat
    :get next BPMN element to validate;
    group BPMN element validation
    :getAttributeValue camunda:modelerTemplate on BPMN element;

    if (camunda:modelerTemplate is empty?) then (no)
      :find element template where id = camunda:modelerTemplate;
      :get child element bpmn:extensionElements;
      :get child element camunda:inputOutput;

      repeat
        :get next tag (camunda:inputParameter or camunda:outputParameter;
        group Parameter validation
        :find element.property where parameter name = binding.name;

        if (template has property) then (no)
          :error;
          kill
        endif

        :get property constraints;
        :validate tag value against constraint;
        endgroup
      repeat while (more input/output parameters?) is (yes)
      -> no;
     endif
     endgroup
  repeat while (more elements to validate) is (yes)
  -> no;
  endgroup
repeat while (more bpmn to validate) is (yes)
-> no;

stop
@enduml
----

== Журнал рішень
* Підхід до валідації:
** Було порівняно 2 підходи до валідації _Шаблонів елементів_ на рівні _Пайплайну публікації регламенту_ та
_Пайплайну перевірки регламенту_:
*** Правила валідації параметрів зберігаються безпосередньо в самому файлі BPMN
*** Правила валідації зберігаються окремо разом зі специфікацією вхідних параметрів у _Шаблонах елементів_
** Основні принципи, за якими був обраний 2 підхід:
*** Централізований підхід до зберігання правил валідації
*** Збереження стандартної BPMN/camunda схеми для bpmn файлів для сумісності
*** Унеможливлювання для моделювальника виключити правила валідації при використанні _Шаблону елемента_
* Валідація на клієнті:
** Був проведений POC за результатами якого було виявлено що кастомізація панелі моделювальника можлива тільки при
форку бібліотеки bpmn-js-properties-panel
** Прийнято рішення не форкати бібліотеку для можливості оновлення до нових версій і залишити валідацію на клієнті
без змін
** Подальше розширення панелі моделювальника для автопідказок можливе без форку бібліотеки
* Підхід до розгортання ConfigMap з переліком _Шаблонів елементів_ переробити і зробити файли з шаблонами частиною
registry-configuration компонента

== Обсяг робіт

=== Попередня декомпозиція
* [DEVOPS] Перенести файли з element templates в репозиторій registry-configuration зі створенням OpenShift ConfigMap
* [DEVOPS] [FE] Перейменувати ConfigMap з element templates на business-process-modeler-element-templates
* [FE] Переробити логіку по зчитуванню значення з ConfigMap (замість js файлу - загальний json)
* [DEVOPS] Додати крок з валідацією регламенту в пайплайн перевірки регламенту
* [DEVOPS] Прибрати post-upgdade скрипт з common-web-app для наповнення ConfigMap з element templates
* [BE] Додати валідацію параметрів шаблонів елементів у валідатор регламенту (в скоупі тільки тип обмеження notEmpty з
можливим подальшим розширенням)
* [BE] Додати типізацію вхідних параметрів в _Шаблонах елементів_ з необхідною валідацією (перехід на змішаний підхід
вхідних параметрів)
* [FE] Додати блокування збереження зміни у _Веб-інтерфейсі моделювання регламенту_ якщо не пройшлв валідація по
_Шаблону елементів_

=== Поза скоупом
* Кастомізація https://github.com/bpmn-io/bpmn-js-properties-panel[панелі моделювальника] яка потребує форку бібліотеки:
** Додавання нового типу вхідного параметру Map
** Блокування збереження зміни у _Веб-інтерфейсі моделювання регламенту_ якщо не пройшлв валідація по
_Шаблону елементів_
** Об'єднання двох секція Inputs (нетипізовані вхідні параметри) та Custom Properties (типізовані) в одну
* Підтримка серверної валідації для типів, які не підтримуються стандартним механізмом element templates
* Підтримка серверної валідації по патерну (regexp), minLength та maxLength

== Обмеження рішення
* Валідація на клієнті залишається неповною через відсутність підтримки типу параметру Map
* Валідація на бекенді проходить асинхронно в пайплайні публікації (нема швидкого фідбеку для користувача)
* Існуючі бізнес-процеси з шаблонами елементів, які не відповідають правилам валідації можуть бути причиною помилки при
розгортанні пайплайну при переході на нову версію