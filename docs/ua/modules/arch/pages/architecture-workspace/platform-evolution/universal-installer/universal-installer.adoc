= Підтримка концепції _регіонів обслуговування_ Платформою Реєстрів

[IMPORTANT]
--
Сторінка технічної документації є баченням майбутньої реалізації, актуальність якого може бути застарілою.
--

== Загальні принципи та положення

* Рішення _Платформи Реєстрів_ надає можливості розгортання екземплярів Платформи для створення реєстрів з урахуванням регіональних вимог
* _Компонент керування станом ресурсів Платформи_ включає набір компонент та скриптів розгортання для всіх регіонів, які підтримуються _Платформою Реєстрів_
* _Платформа Реєстрів_ підтримує два регіони обслуговування:
** _ua_ - розробка реєстрів з урахуванням регіональних вимог та особливостей
** _global_ - розробка реєстрів з генералізованими вимогами
* Цільовий регіон обслуговування вказується адміністратором при встановленні нового екземпляра _Платформи Реєстрів_
* Екземпляр _Платформи Реєстрів_ передбачає обслуговування єдиного регіону, вказаного при її інсталяції та не може бути змінений
* Реєстри наслідують регіон обслуговування екземпляра Платформи при їх створенні через _Веб-інтерфейс управління Платформою та реєстрами_
* Реєстр передбачає обслуговування єдиного регіону, налаштованого на рівні екземпляра Платформи
* У якості підходу для управління поведінкою підсистем Платформи та реєстрів згідно до налаштованого регіону обслуговування прийнято використання _Feature Toggle_ на рівні коду та автоматизації
* Кожен компонент підсистем Платформи та реєстрів параметризується змінною з налаштуванням регіону обслуговування для адаптації поведінки
* _CD_-пайплайн розгортання реєстру на _CI/CD_ підтримує можливість вибору регіону для обслуговування
* Тестування _Платформи Реєстрів_ для регіону обслуговування _global_ виконується в ручному режимі, паралельно основному процесу розробки для _ua_ регіону
* Демонстрація можливостей Платформи та реєстрів, які обслуговують _global_ регіон виконується на базі окремо створеного регламенту, згідно з ключовими сценаріями використання

== Обсяг змін

* _CI/CD_
* _Компонент керування станом ресурсів Платформи_
* _Підсистема управління Платформою та реєстрами_
* _Підсистема розгортання та налаштування Платформи та реєстрів_
* _Підсистема управління користувачами та ролями_
* _Підсистема кабінетів користувачів_
* _Підсистема цифрових підписів_
* _Підсистема моделювання регламенту реєстру_
* _Підсистема розгортання регламенту реєстру_
* _Підсистема симуляції API зовнішніх систем_
* _Регламент демо-реєстру_

=== Підсистеми та компоненти, які потребують адаптації під регіон

|===
|Підсистема|Компонент|Коментар

.2+|_Підсистема розгортання та налаштування Платформи та реєстрів / CICD_
|*edp-library-stages-fork*
|...

|*edp-library-pipelines-fork*
|...

|_Компонент керування станом ресурсів Платформи_
|*control-plane-installer*
|...

.3+|_Підсистема управління Платформою та реєстрами_
|*control-plane-gerrit*
|...

|*control-plane-console*
|...

|*ddm-architecture*
|...

|_Підсистема розгортання та налаштування Платформи та реєстрів_
|*registry-configuration*
|...

.2+|_Підсистема управління користувачами та ролями_
|*user-management*
|...

|*digital-signature-ops*
|...

|_Підсистема цифрових підписів_
|*digital-signature-ops*
|...

.2+|_Підсистема моделювання регламенту реєстру_
|*admin-portal*
|...

|*publish-users-job*
|...

.3+|_Підсистема розгортання регламенту реєстру_
|*registry-regulations-publication-pipeline*
|...

|*registry-regulations-validator-cli*
|...

|*notification-template-publisher*
|...

.5+|_Підсистема симуляції API зовнішніх систем_

|*external-integration-mocks*
|...

|*sign-widget-mock*
|...

|*trembita-edr-registry-mock*
|...

|*trembita-dracs-registry-mock*
|...

|*trembita-idp-mock-server*
|...

|_Підсистема кабінетів користувачів_
|*common-web-app*
|...

|===

== Автентифікація користувачів кабінетів

=== Автентифікація

У разі налаштування екземпляра Платформи на обслуговування _global_ регіону, для автентифікації користувачів має використовуватись _Browser Authentication_.

image::architecture-workspace/platform-evolution/universal-installer/authentication.png[]

=== Самореєстрація

image::architecture-workspace/platform-evolution/universal-installer/self-registration.png[]

У разі, якщо для реєстру, який обслуговує _global_ регіон, налаштовано Самореєстрацію, має використовуватись стандартний механізм реєстрації Keycloak.

Додатково мають бути налаштовані Attribute Mappers на рівні клієнтів для пропагації в токен службових атрибутів з тестовими значеннями (тип _Hardcoded Claim_):

* _citizen-portal_:
** drfo
** fullName

* _officer-portal_:
** drfo
** edrpou
** fullName

== Накладання підпису та валідація

=== Кваліфікований електронний підпис

...

=== Цифрова печатка

...

== Розгортання екземпляра Платформи

При розгортанні нового екземпляра Платформи Реєстрів, інсталятор підтримує можливість задати регіон для обслуговування за допомогою змінної оточення _platformRegion_. За відсутності приймається значення за замовчуванням _ua_.

[source, bash]
----
$ sudo docker run --rm \
    --name control-plane-installer-<VERSION> \
    --...
    --env platformRegion=<ua|global> \
    --entrypoint "/bin/sh" control-plane-installer:<VERSION> \
    -c "./install.sh -i"
----

== Структура операційної конфігурації

В рамках реалізації вимог, необхідно розширити шаблони конфігурацій Платформи та реєстрів додатковим налаштуванням `global.region`.

[NOTE]
Для підтримки зворотної сумісності версій, у разі відсутності налаштування `global.region`, застосовується значення за замовчуванням `ua`.

=== Конфігурація Платформи

Налаштування `global.region` встановлюється при розгортанні нового екземпляра Платформи у значення, яке було передано у вигляді змінної оточення `platformRegion` інсталятору Платформи.

.control-plane-gerrit:cluster-mgmt.git/deploy-templates/values.yaml
[source, yaml]
----
global:
  region: ua # [ua, global]
----

=== Конфігурація реєстру

Налаштування `global.region` встановлюється при створенні нового реєстру на Платформі у значення, яке відповідає поточному налаштуванню `global.region` на рівні конфігурації Платформи.

.control-plane-gerrit:registry-tenant-template.git/deploy-templates/values.yaml
[source, yaml]
----
global:
  region: ua # [ua, global]
----
