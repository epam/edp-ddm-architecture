= Використання платформного Nexus замість реєстрового при створенні реєстру

В цьому перехідному дизайні розглядається надання опційної можливості використання для потреб реєстру центрального сховища артефактів Платформи.

[IMPORTANT]
--
Сторінка технічної документації є баченням майбутньої реалізації, актуальність якого може бути застарілою.
--

== Актори та ролі користувачів
* Технічний адміністратор Платформи
* Технічний адміністратор реєстру
* Моделювальник регламенту реєстру

== Загальний опис
З точки зору роботи підсистем розгортання та моделювання регламенту реєстру, необхідно мати сховище для зберігання згенерованих
артефактів реєстрових компонентів (registry-rest-api, registry-kafka-api, registry-soap-api, registry-model), а саме їх
Docker образи та JAR (Java Archive) файли.

Задля економії ресурсів реєстру (CPU, RAM) пропонується надати можливість адміністратору Платформи при створенні реєстру
обирати потрібне сховище.

== Функціональні сценарії
* Створення нового реєстру
* Розгортання регламенту реєстру

== Поточна реалізація
В поточній реалізації Платформи, для виконання цієї вимоги під кожний реєстр розгортається своє власне сховище артефактів (SonarType Nexus).

.Фрагмент діаграми взаємодії між компонентами підсистем
image::architecture-workspace/platform-evolution/optional-registry-nexus/as-is-nexus.drawio.svg[]

[TIP]
--
Докладніше про поточну реалізацію описано у відповідних підсистемах:

* xref:arch:architecture/platform/administrative/config-management/overview.adoc[]
* xref:arch:architecture/registry/administrative/regulation-publication/overview.adoc[]
--

.Місця зберігання артефактів в реєстровому Nexus
|===
|Тип|Назва репозиторію|Шлях|Приклад

|Docker Image
|docker-registry
|`/v2/<registry-name>/<component-name>`
|/v2/registry-1/registry-rest-api-master-0-0-1

|JAR
|edp-maven-releases
|`/ua/gov/mdtu/ddm/dataplatform/template/<component-name>`
|/ua/gov/mdtu/ddm/dataplatform/template/rest-api

|===

== Загальні принципи та положення
* При створенні реєстру, на адмін-консолі доступний вибір типу сховища артефактів (центральне або виділене реєстрове сховище)
* Налаштування типу сховища артефактів недоступне для редагування після створення.
* При обраному "центральному" сховищі, відбувається налаштування відповідних компонентів в реєстрі для роботи з ним.
* При обраному "виділеному" реєстровому сховищі відбувається розгортання компонентів `nexus-operator` що і розгортає реєстровий nexus.
* Реєстр має свій окремий maven репозиторій в Платформному сховищі Nexus.
* Реєстр не має свій окремий docker репозиторій в Платформному сховищі Nexus, а використовує вже існуючий.

== Цільовий дизайн
Після розробки та впровадження цього перехідного дизайну, адміністратор Платформи буде мати можливість обрати в якості сховище артефактів:

* Центральне сховище артефактів Платформи
* Виділене реєстрове сховище артефактів

image::architecture-workspace/platform-evolution/optional-registry-nexus/to-be-nexus.drawio.svg[]

== UI

На сторінці створення реєстру, відображається нова таба "Сховище артефактів" з dropdown елементом і з варіантами вибору:

* Платформне сховище
* Виділене реєстрове сховище

Після створення реєстру поле деактивується і для редагування недоступне.

.Орієнтовний mockup
image::architecture-workspace/platform-evolution/optional-registry-nexus/mockup.png[]

В `values.yaml` реєстру записується значення:

[source,yaml]
----
global:
  registry:
    artifactsStorage: "platform" # platform | registry
----

Спираючись на ці значення відбувається налаштування відповідних компонентів в реєстрі для роботи з ним, а саме:

* Виділене реєстрове сховище — виконується розгортання реєстрового компоненту `nexus-operator`, що за собою тягне всі налаштування які і виконуються наразі.
* Платформне сховище — реєстр налаштовується на роботу з центральним сховищем артефактів Платформи.

== Інтеграція реєстра для роботи з центральним сховищем артефактів

Для налаштування роботи реєстру з центральним сховищем артефактів Платформи, необхідно виконати наступні кроки:

. Створити maven репозиторій реєстру в центральному nexus.
  * [mdtu-ddm/infrastructure/control-plane-nexus.git]/deploy-templates/nexus-operator/templates/cm/configuration/nexus_default_users.yaml
  * [mdtu-ddm/infrastructure/control-plane-nexus.git]/deploy-templates/nexus-operator/templates/cm/configuration/nexus_repos_to_create.yaml
. Створити реєстрового користувача для взаємодії з центральним nexus.
. Проініціалізувати `registry-regulation-publication-pipelines` для роботи з центральним nexus.
. Параметризувати `service-generation-utility` для роботи з центральним nexus.

.Місця зберігання артефактів в платформному Nexus
|===
|Тип|Назва репозиторію|Шлях|Приклад

|Docker Image
|docker-registry
|`/v2/registries/<registry-name>/<component-name>`
|/v2/registries/registry-1/registry-rest-api-master-0-0-1

|JAR
|<registry-name>-maven-releases
|`/ua/gov/mdtu/ddm/dataplatform/template/<component-name>`
|/ua/gov/mdtu/ddm/dataplatform/template/rest-api

|===

== Компоненти системи та їх призначення в рамках дизайну рішення

У даному розділі наведено перелік компонент системи, які задіяні або потребують змін в рамках реалізації дизайну.

|===
|Підсистема|Компонент|Модуль|Опис змін

|Підсистема розгортання регламенту реєстру
|*registry-regulations-publications-pipelines*
|https://github.com/epam/edp-ddm-registry-regulations-publication-pipeline[github:/epam/edp-ddm-registry-regulations-publication-pipeline]
|Адаптування пайплайнів cleanup та delete registry

|
|
|
|

|===

== Високорівневий план розробки
=== Технічні експертизи
* _DevOps_

=== Попередній план розробки
