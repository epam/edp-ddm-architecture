= Управління доступом користувачів до _Кабінету надавача послуг_ з використанням _КЕП Фізичної Особи_

[IMPORTANT]
--
Сторінка технічної документації є баченням майбутньої реалізації, актуальність якого може бути застарілою.
--

== Загальний опис

На рівні реєстру, необхідно забезпечити можливість технічному адміністратору налаштовувати доступ користувачів до кабінету надавачів послуг з використанням _КЕП ФО_, в якому, відповідно, відсутній ЄДРПОУ організації. Це пов'язано зі складністю отримання _КЕП ФОП_ або представника юридичної особи з огляду на необхідність фізичної присутності.

== Актори та ролі користувачів

* Надавач послуг (_ФО_)
* Технічний адміністратор реєстру

== Функціональні сценарії

* Управління доступом користувачів з використанням _КЕП ФО_ до _Кабінету надавача послуг_ через _Веб-інтерфейс управління Платформою та реєстрами_
* Автентифікація надавачів послуг з _КЕП ФО_ через _ІІТ_-віджет та _id.gov.ua_
* Накладання підпису надавачами послуг з використанням _КЕП ФО_

== Загальні принципи та положення

* За замовчуванням, користувачі не мають доступ до Кабінету надавачів послуг з _КЕП ФО_
* Надання дозволу ФО на доступ до кабінету надавачів послуг має враховувати потенційні ризики та включати відповідні зміни на рівні регламенту реєстру для їх мітігації
* Використання _КЕП ФО_ / _ФОП_ / _представника юридичної особи_ вважаються ідентифікуючими ознаками окремих користувачів, дані яких є ізольованими між собою
* Облікові записи користувача, які було створено з використанням _КЕП ФО_ / _ФОП_ / _представника юридичної особи_ не об'єднуються
* Для автентифікації надавача послуг використовується _КЕП ФО_ у вигляді файлового, апаратного та хмарного ключів

== Компоненти системи та їх призначення в рамках дизайну рішення

У даному розділі наведено перелік компонент системи, які задіяні або потребують змін в рамках реалізації функціональних вимог.

|===
|Підсистема|Компонент|Модуль|Опис змін

.2+|Підсистема управління Платформою та Реєстрами
|*control-plane-console*
|-
|Розширення інтерфейсу управління додатковою секцією

|*registry-configuration*
|-
|Розширення конфігурації додатковим налаштуванням

|Підсистема розгортання та налаштування Платформи та Реєстрів
|*control-plane-jenkins*
|_edp-library-stages-fork_
|Застосування змін конфігурації до ресурсів реєстру

.2+|Підсистема управління користувачами та ролями
.2+|*keycloak-ds-officer-authenticator*
|_keycloak-ds-officer-authenticator-core_
.2+|Реалізація автентифікації та самореєстрації надавачів послуг з використанням _КЕП ФО_
|_keycloak-id-gov-ua-officer-core_

|Підсистема цифрових підписів
|*digital-signature-ops*
|-
|Підтримка підписів надавачів послуг, накладених з використанням _КЕП ФО_

|===

== Ключові сценарії

=== Автентифікація надавача послуг з _КЕП ФО_

Необхідно розширити компонент *keycloak-ds-officer-authenticator* логікою автентифікації та самореєстрації для надавачів послуг з _КЕП ФО_:

* _com.epam.digital.data.platform.keycloak.ds.officer.authenticator.DsoAuthenticator_
* _com.epam.digital.data.platform.keycloak.ds.officer.authenticator.RegistryFederationAuthenticator_
* _com.epam.digital.data.platform.keycloak.idgovua.officer.authenticator.IdGovUaOfficerAuthenticator_

.Блок-схема процесу автентифікації
image::arch:architecture-workspace/platform-evolution/individual-officer-access/individual-officer-auth.svg[individual-officer-auth, 500]

=== Валідація підпису надавача послуг з _КЕП ФО_

Необхідно розширити компонент *digital-signature-ops* логікою валідації цифрового підпису, накладеного надавачами послуг з _КЕП ФО_:

* _com.epam.digital.data.platform.dso.config.GenericConfig#getOfficerValidator_
* _com.epam.digital.data.platform.dso.config.IsolationConfig#getOfficerValidator_

.Блок-схема процесу валідації цифрового підпису
image::arch:architecture-workspace/platform-evolution/individual-officer-access/individual-officer-signature-validation.svg[individual-officer-signature-validation, 500]

== Управління конфігурацією реєстру

=== Конфігурація реєстру

В рамках реалізації функціональних вимог, необхідно розширити конфігурацію реєстру додатковим налаштуванням `portals.officer.individualAccessEnabled`.

[NOTE]
Для підтримки зворотної сумісності версій, у разі відсутності налаштування _portals.officer.individualAccessEnabled_ застосовувати значення за замовчуванням _false_.

.control-plane-gerrit:<registry>.git/deployment-templates/values.yaml
[source, yaml]
----
portals:
  officer:
    individualAccessEnabled: true # default: false
----

=== Інтерфейси адміністратора

В рамках реалізації функціональних вимог, необхідно розширити екран управління налаштуваннями автентифікації надавачів послуг реєстру додатковою секцією зі збереженням значення на рівні конфігурації реєстру в `portals.officer.individualAccessEnabled`.

.Управління доступом користувачів з КЕП Фізичної Особи
image::arch:architecture-workspace/platform-evolution/individual-officer-access/control-plane-officer-individual-access-control.png[control-plane-officer-individual-access-control, 500]

== Міграція існуючих реєстрів при оновленні

Не потребує окремих процедур міграції, у разі відсутності налаштування на рівні конфігурації реєстру зберігається поведінка за замовчуванням - відсутність доступу користувачам з _КЕП ФО_ до кабінету отримувача послуг реєстру, доки технічний адміністратор явним чином не внесе зміни через _Веб-інтерфейс управління Платформою та реєстрами_.

== Високорівневий план розробки

=== Технічні експертизи

* BE (_Java_, _Go_)
* DevOps

=== План розробки

* Розширення шаблону конфігурації реєстру додатковим налаштуванням
* Розширення _Веб-інтерфейсу управління Платформою та реєстрами_ секцією управління налаштуванням
* Розширення механізму застосування змін конфігурації реєстру до відповідних _KeycloakAuthFlow_-ресурсів
* Розширення механізму застосування змін конфігурації реєстру до конфігурації компоненти *digital-signature-ops*
* Розширення автентифікації та самореєстрації підтримкою надавачів послуг з _КЕП ФО_ у разі відповідного налаштування на рівні конфігурації реєстру
* Розширення механізму валідації підпису підтримкою надавачів послуг з _КЕП ФО_ у разі відповідного налаштування на рівні конфігурації реєстру
* Розробка референтних прикладів:
** Самореєстрація надавачів послуг _ФО_ з підтвердженням відповідальною посадовою особою
** Внесення даних в реєстр з накладанням цифрового підпису з використанням _КЕП ФО_