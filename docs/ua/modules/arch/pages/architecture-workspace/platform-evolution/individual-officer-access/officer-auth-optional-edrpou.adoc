= Управління доступом користувачів до _Кабінету надавача послуг_ з використанням КЕП Фізичної Особи

== Загальний опис

На рівні реєстру, необхідно забезпечити можливість технічному адміністратору налаштовувати доступ користувачів до кабінету надавачів послуг з використанням КЕП ФО, в якому, відповідно, відсутній ЄДРПОУ організації. Це пов'язано зі складністю отримання КЕП ФОП або представника юридичної особи з огляду на необхідність фізичної присутності.

== Актори та ролі користувачів

* Надавач послуг (ФО)
* Технічний адміністратор реєстру

== Функціональні сценарії

* Управління доступом користувачів з використанням КЕП ФО до _Кабінету надавача послуг_ через _Веб-інтерфейс управління Платформою та реєстрами_
* Автентифікація надавачів послуг з КЕП ФО через _ІІТ_-віджет та _id.gov.ua_
* Накладання підпису надавачами послуг з використанням КЕП ФО

== Загальні принципи та положення

* За замовчуванням, користувачі не мають доступ до Кабінету надавачів послуг з КЕП ФО
* Надання дозволу ФО на доступ до кабінету надавачів послуг має враховувати потенційні ризики та включати відповідні зміни на рівні регламенту реєстру для їх мітігації
* Використання КЕП ФО / ФОП / представника юридичної особи вважаються ідентифікуючими ознаками окремих користувачів, дані яких є ізольованими між собою
* Облікові записи користувача, які було створено з використанням КЕП ФО / ФОП / представника юридичної особи не об'єднуються
* Для автентифікації надавача послуг використовується КЕП ФО у вигляді файлового ключа

== Компоненти системи та їх призначення в рамках дизайну рішення

У даному розділі наведено перелік компонент системи, які задіяні або потребують змін в рамках реалізації функціональних вимог.

|===
|Підсистема|Компонент|Модуль|Опис змін

.2+|Підсистема управління Платформою та Реєстрами
|*control-plane-console*
|-
|Розширення інтерфейсу управління додатковою секцією

|*registry-configuration*
|-
|Розширення конфігурації додатковим налаштуванням

|Підсистема розгортання та налаштування Платформи та Реєстрів
|*control-plane-jenkins*
|_edp-library-stages-fork_
|Застосування змін конфігурації до ресурсів реєстру

.2+|Підсистема управління користувачами та ролями
.2+|*keycloak-ds-officer-authenticator*
|_keycloak-ds-officer-authenticator-core_
.2+|Реалізація автентифікації та самореєстрації надавачів послуг з використанням КЕП ФО
|_keycloak-id-gov-ua-officer-core_

|Підсистема цифрових підписів
|*digital-signature-ops*
|-
|Підтримка підписів надавачів послуг, накладених з використанням КЕП ФО

|===

== Ключові сценарії

=== Автентифікація надавача послуг з КЕП ФО

.Блок-схема процесу автентифікації
image::arch:architecture-workspace/platform-evolution/individual-officer-access/individual-officer-auth.svg[individual-officer-auth, 500]

=== Валідація підпису надавача послуг з КЕП ФО

.Блок-схема процесу валідації цифрового підпису
image::arch:architecture-workspace/platform-evolution/individual-officer-access/individual-officer-signature-validation.svg[individual-officer-signature-validation, 500]

== Управління конфігурацією реєстру

=== Конфігурація реєстру

В рамках реалізації функціональних вимог, необхідно розширити конфігурацію реєстру додатковим налаштуванням `keycloak.authFlows.officerAuthFlow.individualAccessEnabled`.

[NOTE]
Для підтримки зворотної сумісності версій, у разі відсутності налаштування _keycloak.authFlows.officerAuthFlow.individualAccessEnabled_ застосовувати значення за замовчуванням _false_.

.control-plane-gerrit:<registry>.git/deployment-templates/values.yaml
[source, yaml]
----
keycloak:
  authFlows:
    officerAuthFlow:
      individualAccessEnabled: false # default: false
----

=== Інтерфейси адміністратора

В рамках реалізації функціональних вимог, необхідно розширити екран управління налаштуваннями автентифікації надавачів послуг реєстру додатковою секцією зі збереженням значення на рівні конфігурації реєстру в `keycloak.authFlows.officerAuthFlow.individualAccessEnabled`.

.Управління доступом користувачів з КЕП Фізичної Особи
image::arch:architecture-workspace/platform-evolution/individual-officer-access/control-plane-edrpou-config.png[control-plane-edrpou-config, 500]

== Міграція існуючих реєстрів при оновленні

Не потребує окремих процедур міграції, у разі відсутності налаштування на рівні конфігурації реєстру зберігається поведінка за замовчуванням - відсутність доступу користувачам з КЕП ФО до кабінету отримувача послуг реєстру, доки технічний адміністратор явним чином не внесе зміни через _Веб-інтерфейс управління Платформою та реєстрами_.

== Високорівневий план розробки

=== Технічні експертизи

* BE (_Java_, _Go_)
* DevOps

=== План розробки

* Розширення шаблону конфігурації реєстру додатковим налаштуванням
* Розширення інтерфейсу адмін-консолі секцією управління налаштуванням
* Розширення механізму застосування змін конфігурації реєстру до відповідних _KeycloakAuthFlow_-ресурсів
* Розширення механізму застосування змін конфігурації реєстру до конфігурації компоненти *digital-signature-ops*
* Розширення автентифікації та самореєстрації підтримкою надавачів послуг з КЕП ФО у разі відповідного налаштування на рівні конфігурації реєстру
* Розширення механізму валідації підпису підтримкою надавачів послуг з КЕП ФО у разі відповідного налаштування на рівні конфігурації реєстру
* Розробка референтних прикладів