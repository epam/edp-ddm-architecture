= Налаштування доступу до публічних даних реєстру
include::platform:ROOT:partial$templates/document-attributes/default-set-ua.adoc[]

include::platform:ROOT:partial$admonitions/language-ua.adoc[]

== Загальний опис

Сторонні системи та користувачі мають можливість отримувати публічну інформацію з реєстру в актуальному стані, обробляти та візуалізувати її без автентифікації, використовуючи публічні точки доступу API.

Цей документ складається з двох основних частин: створення та публікація точок доступу на рівні регламенту реєстру та налаштування доступу на рівні конфігурації реєстру.

== Сценарії використання

Платформа надає наступну функціональність для роботи із публічними даними у реєстрі: ::

* [*] Публікація пошукових запитів
* [*] Конфігурація ресурсів публічного API
* [*] Створення точок інтеграції для публічного API технічним адміністратором реєстру
* [*] Отримання документації та використання публічного API
* [*] Моніторинг стану та використання публічних пошукових критеріїв
* [*] Зміна рейт-лімітів для наявних точок інтеграції

== План дій з налаштування та використання

Скористайтеся наступним планом дій для налаштування та використання публічних API у реєстрі:

Налаштування на рівні регламенту: ::
+
[%interactive]
* [ ] xref:#regulations-modeling[]
* [ ] xref:#regulations-api-publish[]
* [ ] xref:#view-endpoints-openapi[]

Налаштування на рівні конфігурації реєстру: ::
+
[%interactive]
* [ ] xref:#control-plane-public-access[Налаштування доступу до публічних даних та встановлення рейт-лімітів]
* [ ] (_Додатково_) xref:#grafana-monitoring[]
* [ ] (_Додатково_) xref:#public-user-account[]

[#regulations-modeling]
== Моделювання регламенту

. Відкрийте +++<b style="font-weight: 700">Адміністративний портал<b>+++ та створіть версію-кандидат.
+
TIP: Детальніше про це читайте на сторінці xref:registry-admin/admin-portal/version-control/create-new-change-request.adoc[].

. Перейдіть у +++<b style="font-weight: 700">Таблиці > Файл опису структури<b>+++ та додайте новий changeset із критерієм пошуку (Search Condition).
+
[TIP]
====
* Детальніше про файл опису структури читайте на сторінці xref:registry-admin/admin-portal/registry-modeling/tables/xml-editor.adoc[].

* Детальніше про критерії пошуку (Search Conditions) читайте на сторінці xref:data-modeling/data/physical-model/liquibase-ddm-ext.adoc[].
====

+
image:registry-develop:registry-admin/external-integration/api-publish/public-api/expose-public-api-1.png[]

. Визначте, який саме пошуковий критерій ви хочете зробити публічним. Для цього додайте новий changeset із тегом `exposeSearchCondition` та атрибутом `publicAccess`.
+
[source,xml]
----
<exposeSearchCondition publicAccess="true" name="vpo_person_type_contains_name_public_test"/>
----
+
TIP: Більш детально про `exposeSearchCondition` -- див. xref:data-modeling/data/physical-model/liquibase-ddm-ext.adoc#exposeSearchCondition[Тег налаштування доступу до API реєстру].

+
[NOTE]
====
Рекомендуємо налаштувати посторінкову пагінацію (тип `page`) для управління відображенням повернутих з `exposeSearchCondition` даних (`count`). Також налаштуйте `limit` до кількості даних реєстру, які повертаються у відповіді.

Дізнайтеся більше про `limit` та `pagination` у наступних розділах документації:

* xref:data-modeling/data/physical-model/liquibase-ddm-ext.adoc#limit-attribute-values[Атрибут limit]
* xref:data-modeling/data/physical-model/liquibase-ddm-ext.adoc#pagination-attribute-values[Атрибут pagination]
====

. Перейдіть до наступного розділу для публікації моделі даних у регламенті.

[#regulations-api-publish]
== Публікація API у регламенті

Опублікуйте модель даних, застосувавши зміни до майстер-версії регламенту.
API-точка доступу до даних буде згенерована на базі кожного визначеного пошукового критерію.

TIP: Детальніше про публікацію змін до регламенту читайте у розділі xref:registry-admin/admin-portal/version-control/overview-new-change-request.adoc#push-changes-master[Застосування змін до майстер-версії].

[#view-endpoints-openapi]
== Перегляд опублікованих API у Swagger

Після успішного проходження всіх етапів публікації, можна переглянути внесені пошукові запити, які доступні для публічного доступу, в OpenAPI-специфікації. Для цього:

. Перейдіть до вебінтерфейсу управління кластером OpenShift.
. Оберіть проєкт із вашим реєстром, відкрийте Networking > Routes та перейдіть за посиланням до сервісу *`platform-gateway-kong-proxy`*.
+
[NOTE]
====
Обов'язково додайте в кінець URL-адреси `/openapi`, інакше ви потрапите до sandbox-середовища із pet-точками доступу. Ваш URL у браузері має виглядати так:

----
https://example.com/api/public/data-factory/openapi
----
====

. Відкрийте openapi та знайдіть опубліковані публічні точки доступу.
. Скопіюйте ім'я ендпоінту до буфера обміну та перейдіть до наступного кроку налаштувань.
+
image:registry-develop:registry-admin/external-integration/api-publish/public-api/expose-public-api-2.png[]


[NOTE]
====

Для зменшення навантаження на сервіс Kong API Gateway, для посилань до API-документації, для GET-запитів встановлюється TTL-based кешування. Відповідь кешується за допомогою плагіну `proxy-cache`.

Налаштувати значення кешу можна на рівні конфігурації плагіну через Gerrit. Значення за замовчуванням -- 15 хв.

Кеш зберігається в пам'яті API Gateway.
====

[#control-plane-public-access]
== Налаштування доступу до публічних даних

=== Налаштування доступу до публічних даних та встановлення рейт-лімітів

Відкрийте доступ до публічних даних та налаштуйте рейт-ліміти.

. Увійдіть до адміністративної панелі *Control Plane*.
. На вкладці +++<b style="font-weight: 700">Інформація про реєстр<b>+++ знайдіть секцію +++<b style="font-weight: 700">Публічний доступ<b>+++.
. Натисніть кнопку `+++<b style="font-weight: 700">Надати доступ<b>+++`.
. У новому вікні заповніть поля:

* +++<b style="font-weight: 700">Службова назва запита<b>+++: введіть службову назву запита. Наприклад, `city-lab`.

* +++<b style="font-weight: 700">Точка інтеграції<b>+++:
вкажіть точку інтеграції, налаштовану розробником регламенту на етапі xref:#regulations-modeling[] та опубліковану в сервісі API реєстру. Наприклад, `/search-laboratories-by-city`.

* Встановіть рейт-ліміти на доступ -- кількість запитів від користувачів/систем за одиницю часу. Наприклад, за годину, місяць тощо.

. Натисніть кнопку `+++<b style="font-weight: 700">Надати<b>+++`.
+
image:registry-develop:registry-admin/external-integration/api-publish/public-api/expose-public-api-3.png[]

. Перейдіть до секції +++<b style="font-weight: 700">Запити на оновлення<b>+++, відкрийте та підтвердьте новий запит. Запропоновані зміни будуть застосовані до налаштувань реєстру у файлі *_deploy-templates/values.yaml_*.
+
image:registry-develop:registry-admin/external-integration/api-publish/public-api/expose-public-api-5.png[]
+
TIP: Див. детальніше про підтвердження змін на сторінці xref:admin:registry-management/control-plane-submit-mr.adoc[].
+
Після налаштування, конфігурація реєстру матиме такий вигляд:
+
[source,yaml]
----
publicApi:
  - name: vpo-person-type-test
    url: /vpo-person-type-contains-name-public-test
    limits:
        second: 5
        hour: 100
    enabled: true
  - ...
----
+
Після виконання пайплайну розгортання, публічний доступ до даних через вказаний API-ендпоінт буде відкритий.

=== Перевірка роботи публічного доступу

. Відкрийте браузер у режимі _Інкогніто_ й вставте скопійоване у розділі xref:#view-endpoints-openapi[] посилання на доданий пошуковий запит.
+
image:registry-develop:registry-admin/external-integration/api-publish/public-api/expose-public-api-6.png[]

. Неавтентифікований користувач/система отримає дані у форматі JSON.
+
image:registry-develop:registry-admin/external-integration/api-publish/public-api/expose-public-api-6-1.png[]
+
[CAUTION]
====
При досягненні ліміту, формується відповідь від API Gateway з кодом 429 та тілом
----
{ "message": "API rate limit exceeded" }
----
====

=== Керування доступом

. Редагуйте точки інтеграції та рейт-ліміти: ::

.. Натисніть на іконку _редагування_ &#128393; біля відповідного запита.
.. Внесіть необхідні зміни та підтвердьте їх.
+
image:registry-develop:registry-admin/external-integration/api-publish/public-api/expose-public-api-7.png[]

. Заблокуйте доступ натисканням іконки _блокування_ &#128274;. Технічно це означатиме призупинення доступу до певного API-ендпоінту.
+
TIP: Доступ можна відновити, натиснувши на _розблокування_ (_повторний клік на заблокований елемент_ &#128274;).
+
image:registry-develop:registry-admin/external-integration/api-publish/public-api/expose-public-api-7-1.png[]

. Анулюйте доступ повністю натисканням іконки _видалення_ 🚫.
+
NOTE: Після кожної дії перевірте та підтвердьте застосування змін у секції +++<b style="font-weight: 700">Запити на оновлення<b>+++.

CAUTION: Якщо видалити наявні точки інтеграції або тимчасово вимкнути їх, користувач отримає повідомлення про помилку HTTP 404 при спробі доступу.

[NOTE]
====
Зміна іконок статусу навпроти публічного API у секції _Публічний доступ_ означає, що створений запит на оновлення застосовано до `master`-гілки, а внесені зміни потрапили до файлу конфігурації реєстру -- _deploy-templates/values.yml_.
Щоб перевірити успішність застосування змін і коректність налаштованого доступу до публічних ендпоінтів, технічний адміністратор реєстру повинен перевірити статус пайплайну `master`-гілки.
====

[#grafana-monitoring]
== Моніторинг показників у Grafana

Платформа має Grafana-дашборд, призначений для моніторингу показників виконання і кількості запитів до публічних точок інтеграції від неавтентифікованих користувачів і сторонніх систем.

image:registry-develop:registry-admin/external-integration/api-publish/public-api/expose-public-api-4.png[]

Технічний адміністратор реєстру може користуватися даними з дашборду для відстеження динаміки й стану показників. Ці дані можуть допомогти у визначенні потреби в оптимізації налаштувань, таких як коригування лімітів на запити.

TIP: Детальну інформацію щодо моніторингу ви можете переглянути на сторінці xref:registry-admin/grafana-monitoring/public-api-kong-metrics.adoc[].

[#public-user-account]
== Створення сервісного облікового запису для виконання публічних запитів

Попри те, що формально точки інтеграції є публічними, для підтримання однорідності аудиту та логування в середині Платформи, такі запити будуть здійснюватись від імені службового користувача із Keycloak-реалму `external-system`. Система автоматично створить службового користувача `public-user` для авторизації на рівні `platform-gateway`.

_Переконайтеся_, що такий системний користувач створений у відповідному реалмі сервісу Keycloak. Для цього:

. Відкрийте сервіс автентифікації та авторизації Keycloak
. Знайдіть реалм `-external-system` для вашого реєстру.
. Відкрийте меню *Clients* > `public-user`.