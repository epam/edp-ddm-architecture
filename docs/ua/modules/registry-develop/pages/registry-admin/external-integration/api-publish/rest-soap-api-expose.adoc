:toc-title: ЗМІСТ
:toc: auto
:toclevels: 5
:experimental:
:important-caption:     ВАЖЛИВО
:note-caption:          ПРИМІТКА
:tip-caption:           ПІДКАЗКА
:warning-caption:       ПОПЕРЕДЖЕННЯ
:caution-caption:       УВАГА
:example-caption:           Приклад
:figure-caption:            Зображення
:table-caption:             Таблиця
:appendix-caption:          Додаток
:sectnums:
:sectnumlevels: 5
:sectanchors:
:sectlinks:
:partnums:

= Налаштування регламенту для надання доступу до даних через SOAP та REST API

Якщо ваш реєстр є власником даних, і ви хочете виставляти інтеграційні API-точки, отримувати запити та віддавати дані іншим реєстрам або системам, виконайте наступні налаштування регламенту:

. xref:#authorization-settings[Виконайте авторизаційні налаштування -- надайте доступ для виклику бізнес-процесу].
. xref:#target-registry-bp-modeling[Змоделюйте бізнес-процес, що викликатиметься іншим реєстром].
. xref:#create-data-model[Створіть модель даних (надайте доступ на читання даних реєстру через API-представлення)]

[NOTE]
====
Для REST-взаємодії необхідно також надати доступ до реєстру в адміністративній панелі *Control Plane*. Детальніше про це -- див. на сторінці xref:admin:registry-management/control-plane-registry-grant-access.adoc[].
====

[#authorization-settings]
== Налаштування авторизації для доступу до бізнес-процесів реєстру

Адміністратор реєстру має виконати налаштування авторизації на рівні регламенту.

[NOTE]
====
Виконайте налаштування у 2-х конфігураційних файлах: ::

* *_bp-auth/external-system.yml_* -- відповідає за доступ до бізнес-процесів;
* *_bp-trembita/external-system.yml_* -- відповідає за обмін даними (передачу параметрів) для запуску бізнес-процесу.
====

. Налаштуйте доступ до бізнес-процесів у цільовому реєстрі, який надаватиме свій API для обміну даними.
+
Для цього перейдіть до файлу *_bp-auth/external-system.yml_* у регламенті та визначте конфігурацію:
+
.Конфігураційний файл для надання доступу до бізнес-процесів у цільовому реєстрі
====
[source,yaml]
----
authorization:
  realm: 'external-system'
  process_definitions:
    - process_definition_id: 'my-process-id'
      process_name: 'Назва вашого бізнес-процесу'
      process_description: 'Опис вашого бізнес-процесу'
      roles:
        - 'trembita-invoker'
----
====
+
У цьому прикладі ми вказуємо, що доступ необхідно надати до бізнес-процесу `my-process-id` для ролі `*trembita-invoker*` з Keycloak-реалму `*-external-system*`. Параметри `process_name` та `process_description` є опціональними, і не впливають на процес авторизації.
+
IMPORTANT: Клієнт `*trembita-invoker*` з однойменною роллю створюється автоматично оператором Keycloak в реалмі `*-external-system*` при розгортанні реєстру. Облікові дані цього клієнта необхідно використовувати для всіх зовнішніх систем, яким потрібен доступ до реєстру на Платформі.

. Налаштуйте файл *_bp-trembita/external-system.yml_* у регламенті:

* Налаштуйте змінні старту бізнес-процесу. Для цього вкажіть, які параметри очікуватиме бізнес-процес у блоці *`start_vars`*.
+
IMPORTANT: Без визначення *`start_vars`* бізнес-процес не запрацює.

* Налаштуйте змінні повернення. Для цього вкажіть у блоці *`return_vars`*, які параметри повертатиме бізнес-процес.
+
.Налаштування API-контракту для бізнес-процесу
====
[source,yaml]
----
trembita:
  process_definitions:
    - process_definition_id: 'my-process-id'
      start_vars:
        - eduname
      return_vars:
        - id
        - name
----
====
+
У цьому прикладі ми вказуємо, що для запуску бізнес-процесу `*my-process-id*` у цільовому реєстрі, необхідно передати стартові змінні. Без них ви не зможете ініціювати бізнес-процес. Тут ми передаємо параметр `eduname` -- умовне ім'я учня.
+
TIP: Приклад, як прийняти змінні у цільовому процесі, див. у розділі нижче: xref:#target-registry-bp-modeling[].

* Також налаштуйте змінні повернення. Тут ми налаштовуємо, що бізнес-процес повертатиме параметри `id` та `name`. Вони будуть записані до змінної результату в *Output Parameters* цієї ж сервісної задачі з делегатом.

[#create-data-model]
== Налаштування моделі даних

Створіть модель даних реєстру. Додайте нові критерії пошуку, що надаватимуть доступ на читання даних БД через API-представлення реєстру.

[TIP]
Детальніше про налаштування моделі даних ви можете переглянути на сторінці xref:registry-develop:data-modeling/data/physical-model/rest-api-view-access-to-registry.adoc[].

[#target-registry-bp-modeling]
== Моделювання бізнес-процесу для виклику у цільовому реєстрі

Змоделюйте бізнес-процес, до якого звертатимуться інші реєстри для отримання даних. Це може бути будь-який процес, передбачений бізнес-логікою вашого реєстру.

[NOTE]
====
Для того, щоб запустити бізнес-процес у вашому реєстрі, вам необхідно прийняти надіслані стартові змінні, які очікуються. Це можна зробити за допомогою скрипт-задачі, як показано на прикладі.

.Приймання стартових змінних процесу у цільовому реєстрі
image::registry-admin/external-integration/rest-api-no-trembita/accept-map-params-bp.png[]
====

[TIP]
====
Приклад _.bpmn_-моделі процесу, а також користувацькі _.json_-форми до нього ви можете знайти у регламенті демо-реєстру *_consent-data_* за посиланням:
https://admin-tools-consent-data.apps.envone.dev.registry.eua.gov.ua/gerrit.

Процес буде доступний за назвою *_BPMN-create-school-auto-sign.bpmn_*. Назви форм ви можете знайти всередині відповідних користувацьких задач бізнес-процесу у полі *`Form key`*.
====