:toc-title: ЗМІСТ
:toc: auto
:toclevels: 5
:experimental:
:important-caption:     ВАЖЛИВО
:note-caption:          ПРИМІТКА
:tip-caption:           ПІДКАЗКА
:warning-caption:       ПОПЕРЕДЖЕННЯ
:caution-caption:       УВАГА
:example-caption:           Приклад
:figure-caption:            Зображення
:table-caption:             Таблиця
:appendix-caption:          Додаток
:sectnums:
:sectnumlevels: 5
:sectanchors:
:sectlinks:
:partnums:

////
Use the following syntax to apply asciidoctor/tabs:

[tabs]
====
Tab A:: Contents of tab A.

Tab B::
+
Contents of tab B.

Tab C::
+
--
Contents of tab C.

Contains more than one block.
--
====
////

= Робота із геоданими у реєстрі

CAUTION: Документ у процесі розробки.

[#general-description]
== Загальний опис

Адміністратори реєстрів та розробники регламенту мають змогу налаштовувати роботу із геопросторовими данимиfootnote:1[[.underline]#Геопросторові дані# -- це дані, які мають географічне положення та можуть бути пов'язані з конкретними географічними об'єктами, такими як міста, річки, ліси, будівлі тощо.] у рамках бізнес-процесів завдяки геомодулю ГІСfootnote:2[[.underline]#ГІС (Геоінформаційна система)# -- це програмне забезпечення, яке дозволяє збирати, зберігати, аналізувати, візуалізувати та навіть прогнозувати різні геопросторові дані.], який був імплементований у систему.

У центрі рішення лежить компонент https://geoserver.org/[Geoserver] -- сервер із відкритим кодом, який дозволяє отримувати дані з БД у вигляді *`https://uk.wikipedia.org/wiki/GeoJSON[GeoJSON]`*.

[NOTE]
====
[%collapsible]
.Основні типи -- GeoJSON, Feature, Layer
=====
* *`GeoJSON`* -- формат даних, який може бути інтерпретований LeafletJS і відображений на карті.
* *`Feature`* -- це об'єкт, який містить геометрію (інформацію про географічне положення об'єкта) та атрибути (додаткову інформацію про об'єкт) певного географічного об'єкта.
* *`Layer`* (шар) -- растровий або векторний набір даних, представлений набором географічних об'єктів, які можуть бути відображені на карті. Шар може містити інформацію про географічні об'єкти, такі як точки, лінії, полігони тощо, а також про їхні атрибути та метадані.
=====
====

Для відображення геопросторових даних на UI-формах Кабінетів, використовується бібліотека `https://leafletjs.com/[LeafletJs]`, яка інтегрує всі аспекти геомодуля та дозволяє відображати мапи на HTML-сторінках.

[#scenarios]
=== Сценарії використання геомодуля

Платформа надає наступну функціональність для роботи із геопросторовими даними у реєстрі: ::

* [*] Відображення мап, супутникових знімків які підтримуються сторонніми системами, у порталі посадових осіб або отримувачів послуг, із можливістю їх перемикання між собою та зміни масштабу.

* [*] Відображення об'єктів реєстру, які мають прив'язку до місцевості на мапі -- шари (layers).

* [*] Включення декількох шарів на мапі.

* [*] Пошук об'єктів реєстру на мапі за атрибутами.

* [*] Можливість вибору координати точки, внесення ліній або полігонів шляхом нанесення їх на карту в рамках бізнес-процесу.

* [*] Геокодування -- пошук координати на мапі за публічною адресою або назвою об'єкта.

* [*] Зворотне геокодування -- пошук адреси або назви об'єкта за координатами.

=== План дій з використання геомодуля у реєстрі

Скористайтеся наступним планом дій для налаштування та використання геомодуля у реєстрі:

Основні налаштування: ::
+
[%interactive]
* [ ] xref:#geoserver-deployment[]
* [ ] xref:#create-data-model[]
* [ ] xref:#bp-modeling[]
* [ ] xref:#form-modeling[]

Робота з даними: ::
+
[%interactive]
* [ ] xref:#officer-citizen-portals[]
* [ ] xref:#geoserver[]
* [ ] xref:#db-tables[]

Додаткова інформація: ::
+
[%interactive]
* [ ] xref:#openapi[]

[#geoserver-deployment]
== Розгортання геомодуля

Найперше -- розгорніть реєстр із геомодулем.

_Геомодуль_ є складовою частиною окремого шаблону реєстру та _автоматично розгортається разом з реєстром_ із відповідного шаблону. При розгортанні реєстру з такого шаблону, додатково встановлюються GeoServer та Nominatimfootnote:[*Nominatim* -- це геокодер, який може перетворювати адреси або назви місць на їхні відповідні географічні координати та зворотно -- географічні координати на адреси або назви місць.].

NOTE: Конфігурація GeoServer та публікація шарів відбувається під час розгортання регламенту.

Розгорнути реєстр із конфігурацією геомодуля можна в адміністративній панелі *Control Plane*. Для цього виконайте наступні кроки:

. Увійдіть до *Control Plane* та відкрийте розділ [.underline]#Реєстри#.
. У процесі налаштування, на кроці `Шаблон реєстру`, оберіть шаблон із геомодулем. Використовуйте конфігурацію `*-recommended*`:
+
`templates/registry-tenant-template-geo-server-recommended`
+
image:registry-admin/geoserver/geoserver-1.png[]
+
Після виконання та підтвердження усіх змін, запуститься Jenkins-процес `MASTER-Build-<назва-реєстру>`, який розгорне реєстр із геосервером.
+
TIP: Детальніше про розгортання реєстру -- див. на сторінці xref:admin:registry-management/control-plane-create-registry.adoc[].

== Моделювання регламенту для використання геопросторових даних у бізнес-процесах

[#create-data-model]
=== Створення моделі даних реєстру

Після розгортання реєстру, ви зможете створити дата-модель та використовувати геопросторові дані у регламенті.

Найперше необхідно створити модель даних. Для використання геопросторових даних у реєстрі імплементовано спеціальний атрибут *`type="geometry"`*, який розширює можливості стандартної бібліотеки Liquibase.

Такий параметр можна використовувати на рівні колонок як при побудові таблиць, так і критеріїв пошуку (таблиць-представлень).

[TIP]
====
* Детальніше про моделювання таблиць див. xref:data-modeling/data/physical-model/liquibase-ddm-ext.adoc#createTable[Теги створення таблиць].
* Детальніше про моделювання таблиць див. xref:data-modeling/data/physical-model/liquibase-ddm-ext.adoc#create-search-conditions[Керування критеріями пошуку (Search Conditions)]
====

.Моделювання таблиці із типом geometry
====
[source,xml]
----
<changeSet id="table geometry type" author="registry owner">
    <createTable tableName="entity_with_geo_type" ext:historyFlag="true" remarks="Сутність з геотипом">
        <column name="entity_id" type="UUID" defaultValueComputed="uuid_generate_v4()">
            <constraints nullable="false" primaryKey="true" primaryKeyName="pk_entity_id"/>
        </column>
        <column name="name" type="TEXT">
            <constraints nullable="false"/>
        </column>
        <column name="address" type="TEXT">
            <constraints nullable="false"/>
        </column>
        <column name="entity_location" type="geometry">
            <constraints nullable="false"/>
        </column>
    </createTable>
</changeSet>
----
====

.Моделювання таблиці-представлення (Search Condition) із типом geometry
====
[source,xml]
----
<changeSet author="registry owner" id="create SC get_entity_with_geo_type_not_equals">
    <ext:createSearchCondition name="get_entity_with_geo_type_not_equals">
        <ext:table name="entity_with_geo_type">
            <ext:column name="entity_id"/>
            <ext:column name="name" searchType="notEqual"/>
            <ext:column name="address"/>
            <ext:column name="entity_location"/>
        </ext:table>
    </ext:createSearchCondition>
</changeSet>
----
====

Після застосування змін до майстер-гілки регламенту реєстру, запускається Jenkins-процес *`MASTER-Build-registry-regulations`*, який публікує структури, які містять тип "геометрія" (`geometry`), як шари до `GeoServer`-а.

[NOTE]
====
В результаті GeoServer міститиме опубліковані сутності `entity_with_geo_type` та `get_entity_with_geo_type_not_equals_v`, до яких можна звертатися для відображення геоданих на UI-формах бізнес-процесу.

Детальніше -- див. у розділі xref:#geoserver[].
====

[#bp-modeling]
=== Моделювання бізнес-процесів

Після розгортання моделі даних реєстру та створення шарів даних (Layers) відповідно до дата-моделі, ви зможете записувати до, або зчитувати з БД об'єкти, які містять координати певних точок, ліній, або полігонів тощо.

// TODO: HERE

[#form-modeling]
=== Моделювання UI-форм до бізнес-процесів

Візуалізувати геодані на UI-формах Кабінетів користувача можна завдяки компоненту FormIO «Мапа» (*Map*). Цей компонент надає повну функціональність по роботі із геопросторовими даними у реєстрі (_див. детальніше розділ xref:#scenarios[]_).

[#officer-citizen-portals]
=== Робота з геоданими у Кабінетах користувачів

[#geoserver]
== Робота з GeoServer

*GeoServer* -- сервіс, який дозволяє отримувати дані з БД у вигляді GeoJSON для їх подальшої обробки та відображення на мапі у бізнес-процесах.

Усі структури даних регламенту, які містять тип "геометрія" (`geometry`), публікуються як шари (Layers) до геосервера.


Конфігурація публікується на етапі розгортання регламенту, на кроці `publish-geoserver-configuration` основного Jenkins-процесу *`MASTER-Build-registry-regulations`*.

TIP: Для керування налаштуваннями геосервера передбачений вебінтерфейс, який можна знайти за посиланням у середовищі вашого реєстру:
https://geo-server-<назва-реєстру>.apps.envone.dev.registry.eua.gov.ua/geoserver.

[#layer-preview]
[layer-preview]
==== Перегляд шарів у геосервері

TBD

//TODO: HERE

[#db-tables]
== Робота з таблицями у базі даних реєстру

//TODO: HERE

TBD

[#openapi]
== Робота з API

Кожен об'єкт із координатами (точка) та шар (Layer) можна отримати напряму з API реєстру, у сервісі *`registry-rest-api`*.

[TIP]
====
Усі згенеровані API-ендпоінти відповідного реєстру представлені в openapi-специфікації та доступні за посиланням:
https://registry-rest-api-<назва-реєстру>.apps.envone.dev.registry.eua.gov.ua/openapi.

Обов'язково додавайте *`/openapi`* в кінець посилання, інакше ви потрапите до тестового середовища (пісочниці) Swagger.
====
