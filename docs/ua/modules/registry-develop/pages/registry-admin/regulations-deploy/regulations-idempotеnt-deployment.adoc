= Ідемпотентне розгортання регламенту реєстру
include::platform:ROOT:partial$templates/document-attributes/default-set-ua.adoc[]

== Введення

Ця документація описує процес ідемпотентного розгортання регламенту реєстру, який розв'язує проблему неконсистентності стану регламенту через ігнорування неуспішних кроків у попередніх запусках пайплайну. Мета цього процесу - забезпечити, що всі зміни в регламенті застосовуються надійно та послідовно.

== Проблематика

У попередніх версіях пайплайну розгортання, певні кроки активувались тільки при внесенні змін у відповідні директорії регламенту. Якщо крок був неуспішним, але у поточному коміті змін не було, цей крок ігнорувався і вважався успішним. Це створювало проблеми з виявленням і виправленням помилок.

== Ідемпотентний підхід

=== Реалізація та збереження чексум

На Платформі впроваджено ідемпотентний підхід, що включає:

* *Порівняння станів регламенту*: поточний стан регламенту порівнюється зі станом на момент останнього успішного виконання кроку.
* *Генерування та зберігання чексум*: чексуми директорій та файлів регламенту генеруються з використанням алгоритму шифрування `SHA256` та зберігаються як секрети.

{empty}

Перегляд збережених чексум: ::

Адміністратор реєстру може переглянути ці секрети через Вебінтерфейс управління кластером OpenShift:

. Відкрийте консоль
include::platform:ROOT:partial$templates/links/platform/administrative/openshift.adoc[]
.
. Перейдіть до розділу *Workloads* > *Secrets*.
. Знайдіть секрет *`registry-regulations-state`*. У розділі *Data* ви зможете переглянути чексуми відповідних компонентів розгортання регламенту.
+
image:registry-develop:registry-admin/regulations-deploy/idempotant-deployment/idempotant-deployment-1.png[]

=== Практичне застосування

. Внесіть зміни до версії-кандидата регламенту, наприклад, створіть новий бізнес-процес (_див. детальніше -- xref:registry-develop:registry-admin/admin-portal/registry-modeling/process-models/create-process.adoc[]_).
. Перевірте та застосуйте зміни до мастер-версії (_див. детальніше -- xref:registry-admin/admin-portal/version-control/candidate/overview-new-change-request.adoc[]_).

Jenkins і MASTER-Build-пайплайн: ::

. Перейдіть до сервісу *Jenkins* за посиланням у Кабінеті адміністратора регламентів.
+
image:registry-develop:registry-admin/regulations-deploy/idempotant-deployment/idempotant-deployment-3.png[]

. У пайплайні *MASTER-Build-registry-regulations* кожен крок перевіряє чексуми файлів директорій.
+
image:registry-develop:registry-admin/regulations-deploy/idempotant-deployment/idempotant-deployment-2.png[]
+
[NOTE]
.Крок розгортання повторно запускається, якщо:
====
. У секреті відсутній крок з таким ім'ям.
. Чексума для хоча б однієї з директорій відрізняється від чексуми в секреті.
. Відсутня інформація про чексуму файлу у секреті.
====

Залежні директорії: ::

Перевірка чексум для залежних директорій, які використовуються у декількох кроках, відбувається окремо для кожного кроку.

=== Примусове розгортання

Розробники регламенту мають можливість активувати примусове розгортання всіх кроків у пайплайні завдяки параметру *`FULL_DEPLOY`*:

TIP: Запуск пайплайну публікації регламенту -- *`MASTER-Build-registry-regulations`* -- з активованою опцією *`FULL_DEPLOY`* дозволяє правильно і повністю розгорнути регламент.

image:registry-admin/regulations-deploy/cleanup-job/cleanup-job-4.png[]

== Відстеження змін та збереження даних після розгортання

У нашому прикладі створено бізнес-процес, а тому зміни стосуються директорії _bpmn_. Відповідно коли в директорію _bpmn_ регламенту реєстру вносяться зміни, автоматично запускається крок `upload-business-process-changes`. Ви можете побачити відповідні записи у логах виконання пайнлайну.

.Перевірка успішного розгортання змін до bpmn
image::registry-develop:registry-admin/regulations-deploy/idempotant-deployment/idempotant-deployment-4.png[]

Інші кроки у пайплайні маркуються як неактивні, якщо відповідні зміни в директоріях не виявлені. Це також відображається у логах пайплайну.

.Кроки, де зміни до файлів не виявлено
image::registry-develop:registry-admin/regulations-deploy/idempotant-deployment/idempotant-deployment-5.png[]

Після кроку розгортання: ::
+
* Запускається утиліта, що зберігає назву кроку, перелік директорій та чексуми у форматі JSON до секрету.
+
.Приклад. Збереження чексуми до секрету для схеми бізнес-процесу у bpmn
[source,json]
----
{
  "bpmn/a-new-bp-test.bpmn": "d206ee947a1f92946401a908f713398066b46f4c85e88c2bff9c27540a15461c"
}
----

* Після успішного збереження, статус кроку розгортання позначається як успішно пройдений.

Завдяки цьому підходу, розробник може бути впевненим у правильному застосуванні всіх змін до регламенту реєстру, мінімізуючи ризики неконсистентності.


