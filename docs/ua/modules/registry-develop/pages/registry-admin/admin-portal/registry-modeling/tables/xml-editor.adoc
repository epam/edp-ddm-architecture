:toc-title: ЗМІСТ
:toc: auto
:toclevels: 5
:experimental:
:important-caption:     ВАЖЛИВО
:note-caption:          ПРИМІТКА
:tip-caption:           ПІДКАЗКА
:warning-caption:       ПОПЕРЕДЖЕННЯ
:caution-caption:       УВАГА
:example-caption:           Приклад
:figure-caption:            Зображення
:table-caption:             Таблиця
:appendix-caption:          Додаток
:sectnums:
:sectnumlevels: 5
:sectanchors:
:sectlinks:
:partnums:

= Моделювання структури таблиць БД реєстру в XML-редакторі коду

== Загальні положення

Адміністративний портал пропонує вбудований XML-редактор, який спеціалізується на роботі зі структурою таблиць у файлі *_data-model/createTables.xml_* і спрощує роботу з моделлю даних у регламенті реєстру. Всього існують два підходи до створення та редагування таблиць:

* Робота безпосередньо у файлах регламенту Gerrit. У цьому випадку може бути декілька різних файлів для роботи з різними таблицями.
+
TIP: Детальніше про роботу з таблицями у моделі даних див. -- xref:data-modeling/data/physical-model/liquibase-ddm-ext.adoc#table-management[Керування таблицями].

* Робота через XML-редактор в адміністративному порталі. Зміни, внесені тут, після їх застосування до майстер гілки репозиторію *_registry-regulations_*, потрапляють лише до одного файлу -- *_data-model/createTables.xml_*.
+
[NOTE]
====
У такому випадку необхідно дотримуватися таких рекомендацій:

* Усі операції, пов'язані зі створенням або зміною структури таблиць бази даних, слід зберігати у файлі _data-model/createTables.xml_. Це допоможе забезпечити правильну організацію структури даних та зручність роботи з ними.

* Файл *_data-model/createTables.xml_* має бути явно включений до переліку файлів для розгортання у конфігурації *_data-model/main-liquibase.xml_*. Це гарантує належне врахування змін у таблицях бази даних під час розгортання системи.

Дотримуючись цих рекомендацій, ви зможете забезпечити ефективну роботу зі структурою таблиць та забезпечити коректність розгортання бази даних у вашому реєстрі.

====

Ви самі обираєте, який підхід використовувати для створення та редагування таблиць. Якщо ви обираєте роботу з адміністративного порталу через вбудований XML-редактор, то для полегшення роботи зі структурою таблиць у файлі _createTables.xml_ було імплементовано рішення https://microsoft.github.io/monaco-editor/[Monaco Editor], візуалізоване темою *Visual Studio Dark*. Це дозволяє швидко та зручно вносити зміни через єдиний інтерфейс і зменшує кількість помилок, забезпечуючи більш продуктивний процес роботи з моделлю даних.

Однією з переваг цього редактора є _синтаксичний аналіз коду_ -- можливість отримувати сповіщення про синтаксичні помилки, якщо такі виникли. Крім того, редактор надає підказки та дозволяє використовувати функцію автозаповнення, що спрощує процес додавання нової таблиці до моделі даних.

== Сценарії використання

* Зручне редагування структури даних у моделі регламенту реєстру за допомогою простого вікна редагування.
* Автоматичне збереження внесених змін до версії-кандидата регламенту, що дозволяє ефективно вести процес редагування.
* Відображення повідомлень про помилки у вікні редагування структури таблиць моделі даних регламенту реєстру, що допомагає швидко виявляти та виправляти помилки.
* Надання автопідказок та автодоповнень при редагуванні *`liquibase changelog xml`*, що спрощує процес редагування та дозволяє уникнути помилок.
* Перевірка liquibase-конфігурації згідно з *liquibase* та *DDM xsd*, що допомагає налаштувати конфігурацію коректно та уникнути проблем.

== Функціональні можливості

=== Загальний процес використання

Використовуйте візуальний редактор коду при створенні та редагуванні таблиць моделі даних реєстру за допомогою XML-тегів.

[CAUTION]
====
Редагування складових регламенту реєстру можливе лише в рамках версій-кандидатів на внесення змін. Для майстер-версії доступна лише опція перегляду.

Детальніше про особливості роботи з версіями регламенту дивіться на сторінці
xref:registry-admin/admin-portal/version-control/version-control-overview.adoc[].
====

. У [.underline]#Кабінеті адміністратора регламентів# відкрийте розділ [.underline]#Таблиці#.
+
TIP: Портал адміністратора ви можете знайти за посиланням: +
https://admin-tools-<назва-реєстру>.apps.envone.dev.registry.eua.gov.ua/.
+
image:registry-develop:registry-admin/admin-portal/tables-data-structures/xml-editor/xml-editor-1.png[]

. В рамках версії-кандидата відкрийте вкладку [.underline]#Файл опису структури# та розгорніть візуальний редактор у повноекранному режимі, натиснувши `Розгорнути`.

. Внесіть відповідні зміни до моделі даних та натисніть kbd:[Зберегти зміни].
+
TIP: Детальніше про роботу з моделлю даних реєстру ви можете дізнатися на сторінці xref:data-modeling/data/physical-model/overview.adoc[].
+
image:registry-develop:registry-admin/admin-portal/tables-data-structures/xml-editor/xml-editor-2.png[]
+
Ви отримаєте відповідне повідомлення-підказку про те, що зміни збережено.
+
image:registry-develop:registry-admin/admin-portal/tables-data-structures/xml-editor/xml-editor-3.png[]
+
Скасуйте зміни, натиснувши kbd:[Відмінити зміни]. При натисканні на цю кнопку, ви отримаєте наступне попереджувальне повідомлення із варіантами продовження:
+
====
`Ви впевнені, що хочете скасувати зміни?`
====
+
image:registry-develop:registry-admin/admin-portal/tables-data-structures/xml-editor/xml-editor-5.png[]

+
[WARNING]
====
Якщо ви змінили файл, але не зберегли зміни, і хочете вийти із вікна редагування, то отримаєте наступне повідомлення:

=====
`Файл опису структури було змінено. Якщо покинути сторінку зараз, то незбережені зміни будуть скасовані.`
=====

image:registry-develop:registry-admin/admin-portal/tables-data-structures/xml-editor/xml-editor-4.png[]

====

+
NOTE: Кнопка kbd:[Зберегти зміни] заблокована, якщо файл опису структури містить помилки, знайдені під час аналізу коду та liquibase-конфігурації згідно з liquibase та DDM xsd (_детальніше -- див. у розділі xref:#xsd-liquibase-validation[]_).

. Перейдіть до розділу [.underline]#Огляд версії# та перевірте, що зміни у файлі додалися до переліку змін вашої версії-кандидата з відповідним статусом.
+
NOTE: Якщо у файлі *_data-model/createTables.xml_* було внесено зміни через адміністративний портал або безпосередньо через додавання патчсет-у в Gerrit у відповідний MR до версії-кандидата, то на сторінці [.underline]#Огляд версії# в розділі [.underline]#Внесені зміни# відображатиметься секція [.underline]#Структура таблиць БД#.
+
image:registry-develop:registry-admin/admin-portal/tables-data-structures/xml-editor/xml-editor-9.png[]

. Застосуйте зміни до майстер-версії регламенту.
+
TIP: Детальніше дивіться на сторінці xref:registry-admin/admin-portal/version-control/overview-new-change-request.adoc[].

[WARNING]
====
.Виникнення помилок під час обробки файлу з описом структури моделі даних
[%collapsible]
=====

* При відкритті вкладки [.underline]#Файл опису структури# в адміністративному порталі, у разі відсутності файлу _data-model/createTables.xml_ у репозиторії з регламентом, може виникнути 404 помилка.
+
image:registry-admin/admin-portal/tables-data-structures/xml-editor/xml-editor-7.png[]

* У випадку проблем із обробкою файлу _data-model/createTables.xml_, може виникнути 500 помилка.
+
image:registry-admin/admin-portal/tables-data-structures/xml-editor/xml-editor-8.png[]

=====
====


[#xsd-liquibase-validation]
=== Синтаксичний аналіз коду, підказки та автодоповнення

Вбудований синтаксичний аналізатор коду в редакторі Monaco пропонує переваги, які є специфічними для роботи з XML-розміткою:

//TODO: Add screenshot
. [.underline]#Підсвічування синтаксису XML#: Редактор Monaco підсвічує відповідні елементи XML-файлу, такі як теги, атрибути та текстовий контент. Це полегшує читання та редагування XML-файлів.
+
//TODO: Add screenshot
. [.underline]#Автодоповнення XML-тегів#: Редактор Monaco надає автодоповнення закривальних тегів, базуючись на відкритих тегах, а також автодоповнення для тегів `<changeSet>` та їхнього вмісту. Крім того, він пропонує автодоповнення для типових і нетипових (розширених) тегів та атрибутів Liquibase, що сприяє правильній структурі XML-файлів та знижує ризик виникнення помилок.
+
TIP: Детальніше про доступні теги для побудови моделі даних див. на сторінках xref:data-modeling/data/physical-model/liquibase-standard-change-types.adoc[] та xref:data-modeling/data/physical-model/liquibase-ddm-ext.adoc[] відповідно.

. [.underline]#Валідація XML#: Синтаксичний аналізатор перевіряє коректність XML-структури в реальному часі, виявляючи неправильні або відсутні теги та атрибути, що дозволяє швидко виправити помилки.
+
image:registry-develop:registry-admin/admin-portal/tables-data-structures/xml-editor/xml-editor-6.png[]

[NOTE]
====
Функції синтаксичного аналізатора коду ґрунтуються на правилах, встановлених у XSD для редагування XML Liquibase документів. Відповідні XSD зберігаються у сховищі артефактів Nexus Платформи.

Для використання автопідказок, автодоповнення та аналізу коду згідно з `Liquibase XSD` та `DDM Liquibase Extension` під час редагування файлу структури моделі даних, замініть `http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.5.xsd` та `https://nexus-public-mdtu-ddm-edp-cicd.apps.cicd2.mdtu-ddm.projects.epam.com/repository/extensions/com/epam/digital/data/platform/liquibase-ext-schema/latest/liquibase-ext-schema-latest.xsd` на актуальні схеми, розміщені у Nexus.

Зверніться до адміністратора платформи для отримання посилань на схеми.
====

== Інтеграція структури таблиць БД з різних файлів регламенту для відображення в адміністративному порталі

Цей розділ допоможе вам інтегрувати структуру таблиць бази даних (БД) із різних файлів регламенту для відображення у Кабінеті адміністратора регламентів. Мета полягає у тому, щоб зібрати всі структури таблиць БД в одному файлі -- *_createTables.xml_*.

. Аналіз файлів регламенту.
+
Перегляньте файли теки *_data-model_*, такі як _createTables.xml_, _tablesCommon.xml_, _tablesKatottg.xml_ тощо, які містять набори змін (changeSets) із таблицями та їх атрибутами.

. Перенесення структур таблиць до файлу _createTables.xml_.

* Знайдіть усі changeSets, які стосуються структури таблиць БД, у різних файлах регламенту.

* Перенесіть ці changeSets до файлу _createTables.xml_ у хронологічному порядку.

. Визначення дати створення changeSet.
+
Щоб знайти дату створення changeSet, скористайтеся функцією *`Annotate with Git Blame`* в Intellij IDEA (або іншому середовищі розробки):

* Натисніть правою кнопкою миші на лівому стовпці з номерами рядків у файлі.

* Оберіть опцію *`Annotate with Git Blame`*.

+
image:registry-admin/admin-portal/tables-data-structures/xml-editor/xml-editor-10.png[]

* Після цього лівий стовпчик розшириться, і поряд з номером рядка будуть відображені _дата останнього оновлення_ та _автор_ цього рядка.

+
+
image:registry-admin/admin-portal/tables-data-structures/xml-editor/xml-editor-11.png[]

. Перевірка результатів у Кабінеті адміністратора регламентів.
+
Після завершення попередніх кроків, відкрийте адміністративний портал та перейдіть до розділу [.underline]#Таблиці# > [.underline]#Файл опису структури#. Тепер ви повинні побачити всю структуру таблиць БД, зібрану з різних файлів регламенту та відображену в одному файлі _createTables.xml_.

NOTE: Зверніть увагу, що інтеграція структури таблиць БД в одному файлі -- це лише рекомендація для поліпшення відображення структури даних у Кабінеті адміністратора. Ви завжди можете продовжити розробку структури даних безпосередньо в адміністративному порталі, враховуючи ваші власні вимоги та обмеження.