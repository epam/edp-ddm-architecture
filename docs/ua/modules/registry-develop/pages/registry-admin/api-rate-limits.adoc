= API Рейт-ліміти: обмеження кількості запитів за одиницю часу
:toc-title: ЗМІСТ
:toc: auto
:toclevels: 5
:experimental:
:important-caption:     ВАЖЛИВО
:note-caption:          ПРИМІТКА
:tip-caption:           ПІДКАЗКА
:warning-caption:       ПОПЕРЕДЖЕННЯ
:caution-caption:       УВАГА
:example-caption:           Приклад
:figure-caption:            Зображення
:table-caption:             Таблиця
:appendix-caption:          Додаток
:sectnums:
:sectnumlevels: 5
:sectanchors:
:sectlinks:
:partnums:

== Загальний опис
____
Рейт-лімітування (_англ. -- Rate limiting_) -- це стратегія для обмеження мережевого трафіку.
____

_API рейт-ліміти_ (_англ. -- API Rate Limits_) -- обмеження кількості HTTP-запитів до сервісу чи маршруту за заданий період секунд, хвилин, годин, днів, місяців або років.

Механізм рейт-лімітів реалізований на базі
https://docs.konghq.com/hub/kong-inc/rate-limiting/[Rate-Limiting]-плагіну для Kong API Gateway. Якщо сервіс/маршрут не має рівня аутентифікації, ліміт буде встановлено для IP-адреси клієнта. В іншому випадку для лімітів можна використовувати значення власного заголовка запита, що містить інформацію про користувача: наприклад, ідентифікатор
користувача, його роль чи ідентифікатор організації, яку він представляє. Такий заголовок можна додати засобами Kong OIDC-плагіну.

[CAUTION]
====
Важливо, щоб плагін _rate-limiting виконувався після OIDC-плагіну_!

Тобто пріоритет OIDC-плагіну має бути вищим за значення пріоритету для плагіну rate-limiting, який за https://github.com/Kong/kong/blob/master/kong/plugins/rate-limiting/handler.lua#L49[замовчуванням становить 910]. Цей механізм більш детально описаний нижче.
====

[IMPORTANT]
====
Всі рейт-ліміти обчислюються виключно в межах одного екземпляру Kong API Gateway. Якщо кількість екземплярів Kong більше одного, то загальна кількість запитів від користувача може бути більшою в _n_ разів за значення, встановлене в налаштуваннях для лімітів, де _n_ -- це кількість
розгорнутих екземплярів Kong API Gateway.

Kong API Gateway розгортається на рівні сервісів реєстру.
====

.Верхньорівнева діаграма функціонування рейт-лімітів у Kong
====
image:registry-admin/api-rate-limits/Kong-Rate-Limits.drawio.png[]
====

== Принцип роботи рейт-лімітів для неавтентифікованих користувачів

Для неавтентифікованих користувачів можливо встановити ліміт лише за IP-адресою (`config.limit_by: ip`).

////
Такий ліміт працюватиме виключно для публічних API, які не потребують автентифікації, адже в разі наявності
автентифікації, OIDC-плагін, який виконується першим, повертатиме
користувачу помилку `HTTP 403 Forbidden` до надходження запита до Rate-limiting-плагіну.
////

.Схема роботи рейт-лімітів для неавтентифікованих користувачів
====
[plantuml]
----
include::partial$registry-admin/api-rate-limiting-unauthenticated-user.puml[]
----

. Користувач надсилає запит до платформи, який надходить до Kong API Gateway.
. Запит обробляється Kong Rate-Limiting плагіном, який, базуючись на правилах для конкретного сервісу/маршруту, визначає, чи досягнуто ліміт запитів для IP-адреси користувача.
. Якщо ліміт запитів від користувача не досягнуто, запит
перенаправляється на відповідний сервіс платформи для подальшого
опрацювання.
. Користувач отримує відповідь від сервісу.
. Якщо ліміт запитів досягнуто, плагін Rate-Limiting повертає відповідь з помилкою `HTTP 429`.
====

== Принцип роботи рейт-лімітів для автентифікованих користувачів

Якщо сервіс/маршрут має рівень автентифікації, то ліміт
можна встановити не лише для IP-адреси клієнта, а й для
конкретного автентифікованого користувача чи їх групи.

В такому разі для обчислення ліміту можна використовувати значення власного заголовка `"token-claim"` запита, що містить інформацію про користувача: наприклад, ідентифікатор користувача, роль, або ідентифікатор організації, яку він представляє.
Такий заголовок можна додати засобами Kong OIDC-плагіну.

.Принцип роботи рейт-лімітів для автентифікованих користувачів
====
[plantuml]
----
include::partial$registry-admin/api-rate-limiting-authenticated-user.puml[]
----

. Користувач надсилає запит до платформи, який надходить до Kong API Gateway.
. Першим запит обробляє Kong OIDC-плагін, який перевіряє сесію
користувача. +
Якщо користувач успішно пройшов автентифікацію (існує активна сесія), то OIDC-плагін додає до запита заголовки із JWT-токенами
користувача та заголовок `"token-claim"`, що містить значення атрибута (claim) з токена доступу автентифікованого користувача. Надалі значення цього заголовка використовується плагіном rate-limiting для обчислення лімітів для автентифікованого користувача чи групи таких користувачів.
. Обробка запита передається до наступного плагіну -- Rate-Limiting.
. Плагін Rate-Limiting, базуючись на правилах для конкретного сервісу/маршруту, визначає, чи досягнуто ліміт запитів для користувача. +
Ліміт може бути встановлений як за IP-адресою, так і на основі значення заголовка `"token-claim"`.
. Якщо ліміт запитів від користувача не досягнуто, запит
перенаправляється на відповідний сервіс платформи для подальшого опрацювання.
. Користувач отримує відповідь від сервісу.
. Якщо ліміт запитів досягнуто, плагін Rate-Limiting повертає відповідь з помилкою `HTTP 429`.
====

[header-setup-unauth-user]
[#header-setup-unauth-user]
=== Налаштування власного заголовка для автентифікованого користувача

Для обчислення лімітів для автентифікованих користувачів можна використовувати значення заголовка `"token-claim"` запита, що містить інформацію про користувача. Встановити значення для цього заголовка можна в налаштуваннях OIDC-плагіну для Kong. Цей заголовок може містити значення кореневого атрибута (`claim`) з JWT-токена доступу користувача.

.Приклад налаштування OIDC-плагіну KONG для додавання заголовка "token-claim"
====

.OIDC Config
[source,yaml]
-----------------
config:
  token_claim_header_value: "sub"
-----------------

В такому випадку, після обробки запита OIDC-плагіном, до запита буде додано заголовок `"token-claim"`, значення для якого буде взято з атрибута `"sub"` (claim) токена доступу користувача.

Тобто ми отримаємо заголовок `"token-claim"`, що містить ідентифікатор користувача. Надалі цей
заголовок можна використати в плагіні rate-limiting для обчислення ліміту за ідентифікатором користувача.

.Rate-Limiting Config
[source,yaml]
-----------------
config:
  limit_by: header
  header_name: "token-claim"
-----------------

====

Для складніших варіантів обчислення ліміту можна додати власний
атрибут до JWT-токена, що містить значення яке обчислюється. Зробити це можливо засобами https://www.keycloak.org/docs/latest/server_admin/#_protocol-mappers[Keycloak protocol mappers].

[#rate-limits-configuration]
== Налаштування рейт-лімітів адміністратором

=== Механізм налаштування рейт-лімітів

Механізм рейт-лімітів реалізований на базі
https://docs.konghq.com/hub/kong-inc/rate-limiting/[Rate-Limiting]-плагіну для Kong API Gateway.

Плагін Kong Rate-limiting є частиною Kong API Gateway та розгортається автоматично, разом з ним.

Механізм налаштування рейт-лімітів адміністратором є наступним: ::

. Адміністратор створює або редагує конфігураційний файл у форматі _.yaml (.yml)_
з налаштуваннями для розширень Kong API Gateway -- OIDC та Rate-Limiting.
. Адміністратор зберігає зміни в Gerrit-репозиторії у відповідному каталозі.
. Запускається процес Jenkins, який перевіряє наявність змін в репозиторії, та застосовує змінену конфігурацію для всіх запущених екземплярів Kong API Gateway в межах реєстру.
+
.Схема налаштування рейт-лімітів адміністратором
====
image:registry-admin/api-rate-limits/Rate-limit-configuration.drawio.png[]
====

[CAUTION]
====
Щоб налаштувати ліміти для автентифікованих
користувачів чи їх груп, що об`єднані за певним атрибутом, необхідно спершу додати до запита заголовки з потрібними атрибутами. Базуючись на значеннях цих атрибутів, Rate-Limiting плагін зможе рахувати ліміти для
кожного автентифікованого користувача чи групи індивідуально. Додати до запита заголовки з атрибутами користувача можна за допомогою OIDC-плагіну, який дозволяє додати власний заголовок `"token-claim"` зі значенням з JWT-токена (_детальніше -- у розділі xref:#header-setup-unauth-user[]_).
====

=== Процес налаштування лімітів за допомогою values.yaml

Налаштування рейт-лімітів відбувається у конфігураційному файлі _values.yaml_, у шаблоні розгортання відповідного реєстру. Метадані розгортання реєстрів із шаблону зберігаються у компоненті `control-plane-gerrit` -- центральному репозиторії Gerrit.

[TIP]
====
Для прикладу розглянемо шаблон реєстру `registry-tenant-template-registry-dev-minimal`, що містить відповідну мінімальну конфігурацію ресурсів для реєстру, що розгортатиметься (_див. сторінку xref:admin:registry-management/control-plane-create-registry.adoc[]_).
====

[NOTE]
====
* За замовчуванням рейт-ліміти вимкнені.
* Увімкнути їх може адміністратор безпеки з належними правами доступу.
====

. У локальному середовищі адміністратора відкрийте репозиторій центрального Gerrit -- `control-plane-gerrit`.

. Відкрийте конфігураційний файл відповідного шаблону розгортання реєстру.
+
Шлях до файлу може бути, наприклад, такий:
+
____
resources/repositories/templates/registry-tenant-template-<registry-template-name>.git/deploy-templates/values.yaml
____
+
TIP: Для прикладу ми використовуємо шаблон _registry-tenant-template-registry-dev-minimal.git_ -- шаблон розгортання реєстру із відповідним набором ресурсів (_тут -- мінімальна (minimal) конфігурація_).
+
image:registry-admin/api-rate-limits/api-rate-limits-1.png[]

. Всередині файлу _values.yml_ знайдіть секцію параметрів, яка відповідає за налаштування плагінів Kong -- `kongPluginsConfig`.

. Увімкніть плагін встановлення рейт-лімітів. Для цього встановіть значення параметра `rateLimitingPluginEnable: true`.
+
NOTE: Функціональність рейт-лімітів здатна обмежити кількість запитів за одиницю часу _від вебпорталів_ (Кабінети посадової особи, отримувача послуг та адміністрування регламентів) _до API внутрішніх сервісів_ реєстру.

. За замовчуванням налаштування Kong Rate Limiting плагіну виглядають наступним чином:
+
.Налаштування values.yml для плагіну Kong Rate Limiting
====
[source,yaml]
----
kongPluginsConfig:
  rateLimitingPluginEnable: false
  pluginsRateLimitByHeaderRequestsPerSecond: 10
  pluginsRateLimitByHeaderRequestsPerHour: 10000
  pluginsRateLimitByHeaderPolicy: "local"
  pluginsRateLimitByHeaderFaultTolerant: "true"
  pluginsRateLimitByHeaderHideClientHeaders: "false"
  pluginsRateLimitByHeaderHeaderName: "token-claim"
  pluginsRateLimitByIpRequestsPerSecond: 10
  pluginsRateLimitByIpRequestsPerHour: 10000
  pluginsRateLimitByIpPolicy: "local"
  pluginsRateLimitByIpFaultTolerant: "true"
  pluginsRateLimitByIpHideClientHeaders: "false"
----

Поточна конфігурація показує налаштування рейт-лімітів за секунду та годину за:

* заголовком (`ByHeader`) -- лише для авторизованих користувачів -- параметри `pluginsRateLimitByHeaderRequestsPerSecond` та `pluginsRateLimitByHeaderRequestsPerHour` відповідно;
* IP-адресою (`ByIp`) -- для будь-яких користувачів -- параметри `pluginsRateLimitByIpRequestsPerSecond` та `pluginsRateLimitByIpRequestsPerHour` відповідно.

IMPORTANT: Для коректної роботи плагіну, значення лімітів для параметрів `LimitByHeader` та `LimitByIP` мають бути однаковими.

====
+
NOTE: Повний список налаштувань та можливостей Kong Rate Limiting плагіну з описом параметрів доступний за https://docs.konghq.com/hub/kong-inc/rate-limiting/[посиланням].

. Після усіх налаштувань, виконайте commit до відповідного репозиторію. Після проходження збірки, нові ліміти набудуть чинності.

//TODO: Додати в опис примітку про дефолтні ліміти для ендпоінтів: 1.8.2+

== Відображення помилок на формах Кабінетів при перевищенні кількості запитів до сервісів

Перевищення кількості дозволених запитів від кабінетів адміністратора регламенту реєстру (`admin-portal`), посадової особи (`officer-portal`) та отримувача послуг (`citizen-portal`) до сервісів (бекенд-API) призводить до виникнення помилок, які відображаються на інтерфейсах користувачів.

Якщо при спробі доступу до сторінок кабінетів перевищено ліміт дозволеної кількості запитів до сервісів, то робота зі сторінкою блокується і відбувається перехід на сторінку з описом помилки `HTTP 429`.

Обмеження кількості запитів та час відновлення роботи зі сторінкою порталу встановлює адміністратор безпеки у xref:#rate-limits-configuration[налаштуваннях плагіну] Rate Limiting.

.Приклади відображення помилок у кабінетах користувачів при перевищенні встановлених лімітів
====

.Помилка при перевищенні лімітів запитів до сервера за встановлену одиницю часу у кабінеті адміністратора регламентів:
image:registry-admin/api-rate-limits/api-rate-limits-2.png[]

.Перевищення лімітів запитів до сервера за встановлену одиницю часу у кабінеті посадової особи:
image:registry-admin/api-rate-limits/api-rate-limits-4.png[]

.Перевищення лімітів запитів до сервера за встановлену одиницю часу у кабінеті отримувача послуг:
image:registry-admin/api-rate-limits/api-rate-limits-3.png[]
====

////
----
//TODO: Уточнити: Заголовок RateLimit-Reset, cхоже, підтримується лише в enterprise версії плагіну (Advanced).
Значення "хх секунд" в тексті помилки визначається значенням отриманою з HTTP заголовка відповіді сервера "RateLimit-Reset".
Сторінка з описом помилки відображається для користувача при виконанні запитів з усіх сторінок Admin/Citizen/Officer Portal.
Користувач має змогу оновити сторінку після того, як буде вичерпано встановлений проміжок часу блокування порталу і повернутись на активну сторінку за допомогою:
а) засобів навігації браузера;
б) клавіатури;
в) кнопки "Оновити сторінку" на інтерфейсі сторінки з описом помилки.
Користувач має змогу оновити сторінку з описом помилки до закінчення встановленого проміжку часу блокування порталу(RateLimit Reset)після чого сторінка з описом помилки відображається з оновленим значенням RateLimit-Reset до розблокування.
Користувач має змогу оновити сторінку з описом помилки до закінчення встановленого проміжку часу блокування порталу(RateLimit Reset), однак для продовження роботи час становлений в RateLimit Reset має бути завершеним.
При спробі користувача перейти на будь-яку іншу сторінку порталу за допомогою засобів навігації браузера, система повертає користувача на сторінку з описом помилки.
Перелік критичних запитів та способи відображення нотифікації про помилки пп. 31 Переліку сценаріїв помилок та способів їх обробки.
////