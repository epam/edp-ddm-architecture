= Дебаг під час моделювання регламенту реєстру
include::platform:ROOT:partial$templates/document-attributes/default-set-ua.adoc[]

Дебаг — це процес виявлення, аналізу та виправлення помилок або дефектів, що можуть статися під час розробки регламенту. Під час дебагу розробник здійснює систематичний аналіз коду за допомогою різних інструментів, щоб знайти причину помилок.

== Загальний опис

Під час розробки регламенту розробник може зіштовхнутися з виникненням помилок на різних етапах, тому важливо вміти відстежувати джерела та причини виникнення помилок, виконувати відлагодження їх та виправляти.

TIP: Детальніше про типові помилки, з якими зіштовхується розробник, і методами їх виправлення можна ознайомитися на сторінці xref:registry-admin/typical-errors.adoc[].

Залежно від етапу розробки, застосовуються різні техніки дебагу в різних застосунках:

* Відстеження помилок при розробці *data-model*.
* Відстеження помилок під час збірки регламенту у застосунку *Jenkins*.
* Дебаг *groovy*-скриптів з виводом у консоль або в середовищі розробки — *IntelliJ IDEA*.
* Відстеження помилок при розробці бізнес-процесу у застосунку *Camunda*.
* Додаткові можливості дебагу.

== Відстеження помилок при розробці *data-model*

NOTE: Розробник має керуватися загальними https://docs.google.com/document/d/1mxwGDe6VTJZ7qkbJbNYGLMPU5oWsdET1GWJ5KUv-5rg/edit?usp=sharing[вимогами щодо створення моделі даних].

IMPORTANT: При створенні *changeSet* розробник має брати до уваги наявні обмеження на використання ідентифікаторів чи імен таблиць та полів. Детальніше про ключові слова див. за посиланням: https://www.postgresql.org/docs/current/sql-keywords-appendix.html[]

=== IntelliJ IDEA

Для створення фізичної моделі даних під час розробки регламенту реєстру використовується *Liquibase* — система управління версіями баз даних, що описується за допомогою строго типізованих XML-шаблонів.

*IntelliJ IDEA* є потужним середовищем розробки з широкими функціональними можливостями для написання та дебагу коду. Якщо у вашому коді не вистачає закриваючого тегу, *IntelliJ IDEA* автоматично підкреслить місця помилок:

image:registry-admin/debug/debug-registry-regulations-1.png[image,width=1505,height=280]

Для уникнення помилок під час створення *changeSet* рекомендується використовувати актуальні теги та атрибути згідно з документацією:

* xref:data-modeling/data/physical-model/liquibase-standard-change-types.adoc[]
* xref:arch:architecture/libraries/liquibase-ddm-ext/overview.adoc[]
* xref:data-modeling/data/physical-model/liquibase-ddm-ext.adoc[]

Основна перевірка на правильність створення *changeSet* відбувається на етапі виконання пайплайну *MASTER-Code-review-registry-regulations*. Після внесення змін до моделі даних рекомендується дочекатися автоматичної перевірки коду.

На малюнку під цифрою 1 вказано статус процесу виконання (білд розпочато), на якому зараз знаходиться зміна. Під цифрою 2 вказана назва pipeline, який зараз виконується.

image:registry-admin/debug/debug-registry-regulations-2.png[image,width=1091,height=802]

Якщо збірка завершиться успішно, статус зміниться на `SUCCESS`.

image:registry-admin/debug/debug-registry-regulations-3.png[image,width=803,height=151]

NOTE: У разі виникнення помилок необхідно провести дебаг, описаний у розділі нижче: xref:#jenkins-debug[].

Середовище розробки IntelliJ IDEA також відстежує дублювання унікальних ідентифікаторів і підкреслює місця помилок. Щоб побачити причину помилки, можна навести курсор на підкреслене червоним місце і з’явиться опис помилки. Також справа з'являється знак оклику у червоному кружечку і поруч кількість помилок, яка є у файлі. При натисканні на знак оклик знизу з’являється консоль з описом помилки:

image:registry-admin/debug/debug-registry-regulations-4.png[image,width=1999,height=1252]

Завдяки вбудованому аналізатору кода *IntelliJ IDEA* відслідковує синтаксичні помилки і підкреслює їх зеленим, детальніше подивитися у консолі помилки можна натиснувши на зелену галочку, поряд з якою вказано загальну кількість синтаксичних помилок:

image:registry-admin/debug/debug-registry-regulations-5.png[image,width=1935,height=1286]

=== pgAdmin

Платформа *pgAdmin* надає можливість переглядати SQL-код і створювати SQL-запити до бази даних.

TIP: Детальніше про підключення до pgAdmin можна дізнатися на сторінці xref:registry-develop:registry-admin/db-connection/db-connection-pgadmin.adoc[].

Для перегляду створених таблиць:

. Виберіть таблицю, далі натисканням правої клавіші миші виберіть menu:Scripts[`SELECT Script`]. В результаті автоматично згенерується скрипт, який при запуску виведе на екран усі згенеровані поля таблиці.
. Натисніть кнопку *`Execute`*:
+
image:registry-admin/debug/debug-registry-regulations-6.png[image,width=2048,height=1284]

За допомогою *pgAdmin* можна відстежувати коректність запису даних до бази даних. Якщо у скрипті присутня помилка, її буде відображено внизу з детальним описом:

* Яка саме помилка
* Місце, де сталася помилка

image:registry-admin/debug/debug-registry-regulations-7.png[image,width=1734,height=1030]

[#jenkins-debug]
== Відстеження помилок під час збірки регламенту у сервісі *Jenkins*

xref:registry-admin/regulations-deploy/registry-admin-deploy-regulation.adoc[Збірка регламенту реєстру] проходить в декілька етапів на різних пайплайнах, і на кожному з них можливе виникнення помилок.

У разі виникнення помилки під час збірки регламенту, етап, на якому сталася помилка, буде підсвічено червоним кольором. Для отримання більш детального опису помилки та визначення способу її усунення необхідно виконати наступні кроки:

. Ліворуч знизу екрану, в історії збірок, оберіть відповідний номер збірки, де сталася помилка -- поруч із номером збірки буде червоне коло, що вказує на помилку.
+
image:registry-admin/debug/debug-registry-regulations-8.png[image,width=1238,height=967]

. У новому вікні ліворуч відкрийте *Console Output*.
+
image:registry-admin/debug/debug-registry-regulations-9.png[image,width=1257,height=729]

. Перегляньте детальний опис помилки у нижній частині сторінки:

** де сталася помилка;
** яка саме помилка;
** у якому рядку сталася помилка (якщо це помилка синтаксична або виникла в процесі розгортання сутностей із `.xml`-файлів).
+
image:registry-admin/debug/debug-registry-regulations-10.png[image,width=1482,height=627]
+
Вище можна побачити приклад помилки, який стався на етапі валідації коду:

* 1 -- показує назву папки і файлу, де сталася помилка: тека `data-model`, файл `createSearchConditions.xml`;

* 2 -- показує назву `SearchCondition`, де сталася помилка: `sc_staff_status`;
* 3 -- показує, яка сама помилка: в таблиці не існує поля `id`.

При виникненні помилок на різних етапах збірки, в логах додатково можуть з'явитись посилання на детальний опис помилки, яку необхідно опрацювати.

Наприклад, в логах основної збірки з'являється посилання на помилку, що виникла на етапі роботи пайплайну *MASTER-Build-registry-regulations-data-model*. Ви можете скористатися посиланням, щоб побачити причину виникнення помилки:

image:registry-admin/debug/debug-registry-regulations-11.png[image,width=1482,height=707]

Щоб виправити помилку, виконайте наступні дії:

. Скасуйте останній коміт.
. Усуньте причину помилки.
. Повторно виконайте внесення змін (`git add`, `git commit`, `git push`).

NOTE: Найпоширеніші помилки й способи їх усунення описані на сторінці xref:registry-admin/typical-errors.adoc[].

== Дебаг Groovy-скриптів

У процесі розробки бізнес-процесу розробник може додавати скриптові задачі до процесу, написані мовою Groovy, а також використовувати у скриптах xref:bp-modeling/bp/juel-functions/juel-functions-overview.adoc[JUEL-функції]. Можливою проблемою для розробника може стати опрацювання результату, отриманого на попередньому етапі. Оскільки результат опрацювання є специфічного типу, який підтримує Camunda (наприклад, клас Camunda `SpinListImpl`), цей результат необхідно опрацювати або привести до іншого Java-типу, або дістати конкретне значення.

=== Вивід даних Groovy-скрипта у консоль

Одним із методів дебагу на цьому етапі є вивід отриманих даних у консоль.

Для прикладу розглянемо опрацювання результату виконання сервісної задачі xref:bp-modeling/bp/element-templates/service-task-templates/entity-management/search-entities-in-data-factory.adoc[].

image:registry-admin/debug/debug-registry-regulations-12.png[image,width=869,height=1103]

У скриптовій задачі за допомогою функції `println` виведіть у консоль наступні параметри:

. Кількість елементів, які отримали після виконання сервісної задачі Search for entities in data factory.
. Назва класу змінної `response` — результат виконання сервісної задачі.
. Назва класу елементів у змінній `response`.
. Значення першого елементу змінної `response` (зберігається у форматі ключ-значення).
. Назва класу першого елементу змінної `response`.
. Збереження значення з ключем "userName" у першому елементі змінної `response`.
. Назва класу змінної `users`.
. Кількість елементів, збережених у змінній `users`.
. Значення першого елементу у змінній `users`.
. Назва класу першого елементу у змінній `users`.

image:registry-admin/debug/debug-registry-regulations-13.png[image,width=1710,height=829]

NOTE: Мова програмування Groovy розроблена для платформи Java, отже вона також підтримує всі команди й синтаксис мови Java, тому можна використовувати команди зі стандартної бібліотеки Java.

Для перегляду виведених даних у консоль, оберіть поду bpms (детальніше про поди див. розділ xref:#openshift-pods[] нижче) і перейдіть на вкладку *Logs*, щоб мати можливість переглянути у консолі всі значення, які були прописані в скриптовій задачі:

image:registry-admin/debug/debug-registry-regulations-14.png[image,width=1659,height=425]

=== Робота з Groovy-скриптами у середовищі розробки

Іншим способом дебагу є створення Groovy-скриптів у середовищі розробки, наприклад, в IntelliJ IDEA. Такий метод дебагу дозволяє швидко вносити велику кількість виправлень до коду й одразу отримувати результати роботи з кодом.

NOTE: Важливо правильно налаштувати середовище розробки, вказавши всі необхідні залежності й їх версії, які є актуальними для платформи. Ви можете переглянути актуальний для платформи https://drive.google.com/file/d/1Jlbl2VwAqxtGKR3LT_P1XlbOmckJ-aj-/view?usp=drive_link[POM-файл] із необхідними залежностями й перенести всі налаштування у свій проєкт.

Для налаштування середовища розробки IntelliJ IDEA виконайте наступні кроки:

. Створіть новий проєкт *Groovy* із фреймворком *Maven*.
+
image:registry-admin/debug/debug-registry-regulations-15.png[image,width=976,height=899]

. Налаштуйте `properties` та `dependencies` у POM файлі проєкту відповідно до файлу-прикладу. Усі версії мають бути такими ж, як і у файлі-прикладі.
+
image:registry-admin/debug/debug-registry-regulations-16.png[image,width=892,height=1085]

. У папці створіть новий *Groovy Script*, введіть ім'я файлу й натисніть *Enter*.
+
image:registry-admin/debug/debug-registry-regulations-17.png[image,width=1020,height=691]

. Перенесіть скрипт у створений файл, який необхідно протестувати, внесіть усі необхідні дані. Як зразок використайте приклад конвертації даних із JSON у map ключів-значень.
+
image:registry-admin/debug/debug-registry-regulations-18.png[image,width=1031,height=736]

. Запустіть файл, результати виконання скрипта будуть виведені у консоль.
+
image:registry-admin/debug/debug-registry-regulations-19.png[image,width=1431,height=1036]

Тестування скрипта в середовищі розробки дає можливість швидко перевірити необхідний скрипт, виявити помилки та виправити їх.

== Відстеження помилок при розробці бізнес-процесу у Camunda

NOTE: При створенні бізнес-процесів дотримуйтеся https://docs.google.com/document/d/1mxwGDe6VTJZ7qkbJbNYGLMPU5oWsdET1GWJ5KUv-5rg/edit?usp=drive_link[вимог до розробки] й для уникнення помилок сумісності вашої бізнес-моделі з платформними вимогами й налаштуваннями, рекомендується xref:bp-modeling/bp/modeling-options.adoc[початково створювати бізнес-процес у Кабінеті адміністратора].

=== Налаштування плагіна BPMN Linter для Camunda Modeler

Для валідації створення й налаштування бізнес-процесу у десктопному застосунку *Camunda Modeler* увімкніть плагін xref:registry-develop:bp-modeling/bp/element-templates/element-templates-install.adoc#_встановлення_плагіну_bpmn_linter[BPMN Linter]. Цей плагін перевіряє правильність налаштування діаграми бізнес-процесу і підсвічує помилки, якщо вони є:

image:registry-admin/debug/debug-registry-regulations-20.png[image,width=2048,height=907]

При наведенні на кожен із червоних хрестиків, що з’явились на елементах бізнес-процесу, можна отримати інформацію про помилку:

image:registry-admin/debug/debug-registry-regulations-21.png[image,width=2048,height=907]

Основні помилки, які підсвічує плагін *BPMN Linter*:

* Відсутність початкової або кінцевої події.
* Відсутність налаштувань на гілках, коли можливий сценарій розгортання декількох варіантів продовження процесу.
* Відсутність з'єднання між елементами.
* Відсутність назви елемента.

=== Дебаг бізнес-процесу у Кабінеті адміністратора регламентів

Існують обмеження на використання деяких зарезервованих слів під час створення назв бізнес-процесів. Наприклад, не можна використовувати слова `get`, `set`, `user` у будь-якій комбінації для бізнес-назви та службової назви процесу. Такі обмеження легше відстежувати саме під час створення бізнес-процесу: створіть у Кабінеті адміністратора регламенту новий бізнес-процес, додайте в конструкторі елементи *Pool/Participant*, *start event* та *end event*, налаштуйте кожен із них і збережіть бізнес-процес:

image:registry-admin/debug/debug-registry-regulations-22.png[image,width=1374,height=508]

Виділені поля є обов’язковими для заповнення. Адже саме ці два поля автоматично додаються як службова назва і бізнес-назва процесу в Кабінеті адміністратора при створенні бізнес-процесу:

image:registry-admin/debug/debug-registry-regulations-23.png[image,width=1374,height=508]

=== Camunda Cockpit

*Camunda Cockpit* -- це інструмент для моніторингу та адміністрування процесів, що створюються у застосунку Camunda. Ця платформа застосовується для автоматизації бізнес-процесів і надає можливість швидко відстежувати роботу бізнес-процесів.

Основні функції *Camunda Cockpit*:

* Можливість переглядати статус виконання бізнес-процесів у реальному часі і відстежувати, які етапи процесу вже виконані, де є затримки або проблеми.
* Можливість швидко знаходити та xref:registry-develop:registry-admin/registry-admin-bp-management-cockpit.adoc#_робота_з_помилковими_інцидентами[усувати помилки], які виникають під час виконання різних процесів.
* Можливість переглядати деталі виконаних завдань, включаючи історію процесу, та аналізувати їх продуктивність.
* Можливість контролювати процеси, зупиняти і завершувати завдання на різних етапах бізнес-процесу.

Для початку необхідно xref:registry-develop:registry-admin/registry-admin-bp-management-cockpit.adoc#_права_доступу_до_сервісу[налаштувати доступ до *Camunda Cockpit*], після чого розробнику будуть доступні всі можливості *Camunda Cockpit* для xref:registry-develop:registry-admin/registry-admin-bp-management-cockpit.adoc#_управління_бізнес_процесами_у_camunda_cockpit[адміністрування бізнес-процесів].

За замовчуванням у Camunda налаштовано 3 спроби для виконання процесу з інтервалом у 5 хвилин. Якщо у процесі є помилка або процес виконується занадто довго, система може інтерпретувати це як невдачу і запускати його знову.

[#extra-debug-options]
== Додаткові можливості дебагу

[#chrome-dev-tools]
=== Chrome DevTools

*Chrome DevTools* (інструменти розробника) надає можливість відстежувати помилки у ході виконання бізнес-процесу.

image:registry-admin/debug/debug-registry-regulations-24.png[image,width=2048,height=1017]

TIP: Детальніше про помилки на етапі розробки бізнес-процесу див. на сторінці xref:registry-admin/typical-errors.adoc[].

Найпершим кроком для виявлення місця, де сталася помилка, є відстеження запитів і відповідей, якими обмінюються браузер та сервер. Для запуску DevTools на будь-якому місці у відкритому вікні натисніть правою клавішею миші та виберіть *“Подивитися код”*. У консолі, що відкрилась, перейдіть на вкладку *Network* -> *Fetch/XHR* та оберіть подію, на якій сталась помилка (поруч з назвою буде червоний кружечок із хрестиком):

image:registry-admin/debug/debug-registry-regulations-25.png[image,width=2048,height=1017]

У вкладці *Headers* буде відображено список усіх завантажених сторінкою ресурсів, а також діагностична інформація щодо кожного з них. Для більш детального опису помилки перейдіть на вкладку *Response*:

image:registry-admin/debug/debug-registry-regulations-26.png[image,width=2048,height=1017]

На цій вкладці відображається:

* `traceId` -- унікальний ідентифікатор запиту у системі трейсингу, який дозволяє в деталях простежити історію виконання запиту.
* Опис помилки.
* Назва елемента, де сталася помилка.

[#openshift-pods]
=== OpenShift Pods

Платформа *OpenShift* надає можливість відстежувати всі процеси, що запускаються в конкретному поді (Pod).

Основні поди, які необхідні для відстежування помилок (`xxx` у назві -- це змінний код, який залежить від збірки регламенту):

* `admin-portal-xxx` -- под відповідає за роботу Кабінету адміністратора регламенту,
* `citizen-portal-xxx` -- под відповідає за роботу Порталу отримувача послуг,
* `officer-portal-xxx` -- под відповідає за роботу Кабінету посадової особи,
* `gerrit-xxx` -- под відповідає за роботу Gerrit,
* `jenkins-xxx` -- под відповідає за роботу Jenkins,
* `bpms-xxx` -- под відповідає за роботу Camunda Engine.

Для відстежування процесу у поді на *OpenShift* виконайте наступні кроки:

. В інтерфейсі *OpenShift* виберіть ваш реєстр і відкрийте розділ *Pods*.
+
image:registry-admin/debug/debug-registry-regulations-27.png[image,width=1163,height=895]

. У пошуку введіть назву пода, наприклад, `bpms`, і натисніть на нього.
+
image:registry-admin/debug/debug-registry-regulations-28.png[image,width=1671,height=539]

. Перейдіть на вкладку *Logs* і натисніть *Resume stream* (_за потреби_), щоб завантажити останні логи.
+
image:registry-admin/debug/debug-registry-regulations-29.png[image,width=2048,height=1397]

У нижній частині сторінки буде показана помилка:

* Над першою червоною лінією відображається загальний текст повідомлення: неможливо виконати дію елемента `'Activity_1jyq8oh'` (в Camunda є можливість знайти елемент за його назвою).
* Над другою червоною лінією відображається вже сама помилка: не існує властивості (у цьому випадку -- змінної) `hello`.

image:registry-admin/debug/debug-registry-regulations-30.png[image,width=2048,height=1397]

=== Kibana

*Kibana* — це інструмент візуального інтерфейсу, який дозволяє візуалізувати та створювати інформаційну панель над даними журналу подій платформи. Для можливості дебагу у Kibana необхідно створити *Index Pattern* та налаштувати фільтри.

TIP: Детальніше про налаштування Kibana можна ознайомитись на сторінці: xref:registry-develop:registry-admin-study/study-tasks/task-8-event-logging-kibana.adoc[].

У результаті налаштування *Index Pattern* та фільтрів за помилкою буде відображатися загальний опис помилок. Додатково можна налаштувати вивід лише повідомлення опису помилки, для цього з правого боку виберіть фільтр `structured.exception.message`:

image:registry-admin/debug/debug-registry-regulations-31.png[image,width=2048,height=964]

Тепер у стовпці `structured.exception.message` буде відображатися детальний опис помилки:

[arabic]
. Назва елементу, в якому сталася помилка.
. Яка саме помилка: не існує властивості (_тут — змінної_) `hello`.

Також знайти потрібну помилку можна xref:registry-develop:registry-admin/openshift-logging/kibana.adoc#_фільтрування_даних[за допомогою `traceId`].

* Скопіюйте значення `xref:#chrome-dev-tools[traceId]` із Chrome DevTools та вставте його у пошуковий рядок. Для детального перегляду помилки рекомендується вибрати фільтр `structured.exception.message`.
* Для відображення деталей помилки натисніть на прапорець, помічений цифрою 1, і прокрутіть сторінку трохи вниз:

image:registry-admin/debug/debug-registry-regulations-32.png[image,width=1893,height=1160]

.Пояснення до зображення

* Значення `traceId`.
* Детальний опис помилки.
* `java stacktrace` помилки.


