= Завдання 3. Моделювання бізнес-процесу з інтеграцією
include::platform:ROOT:partial$templates/document-attributes/default-set-ua.adoc[]

include::platform:ROOT:partial$admonitions/language-ua.adoc[]

== Мета завдання

Мета цього завдання: ::

* [*] Навчити моделювати бізнес-процес, що має інтеграцію з фабрикою даних.
* [*] Навчити моделювати гілки у бізнес-процесі.
* [*] Навчити моделювати форми та налаштовувати компоненти *Select* для отримання даних із дата-фабрики.

== Передумови

include::partial$snippets/study/prerequisites-bp-forms-ua.adoc[]

. xref:registry-develop:bp-modeling/bp/bp-modeling-instruction.adoc[Більш детально ознайомтеся із компонентами бізнес-процесу].

== Процес виконання завдання

[#bp-modeling]
=== Моделювання бізнес-процесу

[NOTE]
====
Під час моделювання бізнес-процесу необхідно створити та зберегти відповідну BPMN-діаграму.
Для цього ви можете використовувати вбудовані можливості Платформи, зокрема Вебінтерфейс моделювання регламенту (Адмін Портал), або сторонні інструменти, наприклад Camunda Modeler.

Цей курс зосереджений на детальному підході до розробки регламенту, що дає змогу глибше зрозуміти принципи побудови бізнес-процесів і розширити свою експертизу.
Деякі приклади демонструються в Адмін Порталі.
Обидва підходи базуються на стандарті BPMN 2.0, тому основні принципи моделювання залишаються однаковими незалежно від вибраного інструменту.

Адмін Портал може бути зручнішим вибором, оскільки він містить вбудовані засоби моделювання процесів і форм, актуальний набір інтеграційних розширень для бізнес-процесів (делегатів), а також редактори для написання та редагування коду безпосередньо в середовищі моделювання.

Щоб ознайомитися з прикладом, перегляньте файл `link:{attachmentsdir}/study-project/task-3/bp-schema/feature-add-lab.bpmn[feature-add-lab.bpmn]`, який містить готову схему бізнес-процесу.
====

==== Етапи моделювання бізнес-процесу

В рамках цього завдання розробник має змоделювати бізнес-процес, що складається з наступних етапів:

. xref:#create-pool-bp[]
. xref:#start-event[]
. xref:#service-task-search-subject-data[]
. xref:#xor-subject-found[]
. xref:#alt-branch-validation-error[]
. xref:#script-save-subject-id[]
. xref:#script-data-preparing-subject-code[]
. xref:#create-task-add-lab-data[]
. xref:#search-laboratory-data[]
. xref:#xor-lab-data-found[]
. xref:#alt-branch-val-error-back-to-previous-xor[]
. xref:#main-branch-continue-bp[]
. xref:#create-user-task-lab-data-signing[]

. xref:#create-script-task-prepare-data-record-transient-var[]
. xref:#sign-data-by-system-key[]
. xref:#save-data-to-data-factory[]
. xref:#define-business-process-status[]
. xref:#create-end-task[]

IMPORTANT: Якщо ви використовуєте сторонній додаток, після завершення всіх етапів не забудьте зберегти змодельовану схему бізнес-процесу у відповідну папку з регламентом реєстру. Докладніше див. xref:#save-bp-schema[Збереження змодельованої схеми бізнес-процесу].

[#create-pool-bp]
==== Створення пулу для бізнес-процесу

*_Змоделюйте пул для бізнес-процесу_*. Виконайте такі кроки:

NOTE: Діаграму бізнес-процесу потрібно моделювати в рамках елемента *Pool/Participant*.

. В інтерфейсі моделювання бізнес-процесів знайдіть елемент *Pool/Participant* на панелі інструментів ліворуч і перетягніть його до панелі моделювання.

. Заповніть такі поля відповідними значеннями:
.. У полі *Participant name* введіть `Створення лабораторії`.
.. У полі *Process ID* введіть `feature-add-lab`. Це значення також буде використане під час налаштування прав доступу у цьому завданні та відповідатиме параметру `process_definition_id`.
.. У полі *Process name* вкажіть `Створення лабораторії`.

.Загальний вигляд пулу для змодельованого процесу створення лабораторії
image::registry-develop:study-project/task-3/task-3-1-1-bp-ua.png[]

.Приклад змодельованого та збереженого процесу в Адмін Порталі
image::registry-develop:study-project/task-3/task-3-1-bp-ua.png[]

[#start-event]
==== Створення початкової події

*_Додайте початкову подію (Start Event)_*, яка визначатиме початок бізнес-процесу. У нашому випадку вона є *_початковою формою_*, що дозволяє користувачам вводити необхідні початкові дані перед їх передачею в систему для подальшої обробки.

Налаштуйте подію наступним чином:

General ::

. У полі *Name* введіть назву події. Наприклад, `Початок`.
. У полі *ID* вкажіть ідентифікатор події, наприклад, `start_event`. Ви можете залишити значення за замовчуванням або задати власне.

Forms ::

. У полі *Type* виберіть `Embedded or External Task Forms`.
. У полі *Form key* вкажіть ключ форми: `feature-search-subject`.
+
TIP: Ця UI-форма створюється окремо в процесі моделювання форм і надана як приклад у файлі `feature-search-subject.json`.

Start initiator ::
У полі *Initiator* введіть `initiator`, щоб встановити користувача, який ініціював бізнес-процес.

image:registry-develop:study-project/task-3/task-3-2-bp-ua.png[]

[#service-task-search-subject-data]
==== Налаштування сервісного завдання для отримання даних про суб'єкт

*_Змоделюйте сервісне завдання (Service Task)_*, яке перевірятиме, чи існують лабораторії з однаковим кодом ЄДРПОУ/РНОКПП або назвою перед додаванням нового запису в систему.

Налаштуйте завдання наступним чином:

General ::
У полі *Name* введіть назву завдання. Наприклад, `Отримання суб'єкта з дата-фабрики`.

Template ::
Використовуйте інтеграційне розширення (делегат) xref:bp-modeling/bp/element-templates/service-task-templates/entity-management/search-entities-in-data-factory.adoc[] для налаштування запита.

+
image:registry-develop:study-project/task-3/task-3-2-1-bp-ua.png[]

Inputs ::
Передайте вхідні параметри запита у вигляді *Map* (ключ-значення), де ключами є назви полів форми -- `subjectCode` та `subjectType`. Значення ключів можна передати як *_вирази в один рядок_* за допомогою JUEL-функції `xref:bp-modeling/bp/juel-functions/forms/submission.adoc[submission()]`.

* `subjectCode`:
+
[source,groovy]
----
${submission('start_event').formData.prop('subjectType').value().equals('ENTREPRENEUR') ? submission('start_event').formData.prop('rnokppCode').value()  : submission('start_event').formData.prop('edrpou').value()}
----
+
[TIP]
====
*_Розбір виразу (prettified)_*:

[source,groovy]
----
${submission('start_event').formData.prop('subjectType').value().equals('ENTREPRENEUR')
   ? submission('start_event').formData.prop('rnokppCode').value()
   : submission('start_event').formData.prop('edrpou').value()}
----

* `submission('start_event').formData.prop('subjectType').value().equals('ENTREPRENEUR')`
** Отримує значення `subjectType` зі стартової події `start_event`.
** Перевіряє, чи дорівнює це значення `"ENTREPRENEUR"`.

* Якщо умова `true` (тип суб'єкта — `ENTREPRENEUR`):
** Викликає `submission('start_event').formData.prop('rnokppCode').value()` (повертає `rnokppCode`).

* Якщо умова `false` (інший тип суб'єкта):
** Викликає `submission('start_event').formData.prop('edrpou').value()` (повертає `edrpou`).
====

* `subjectType`:
+
[source,groovy]
----
${submission('start_event').formData.prop('subjectType').value()}
----
+
Отримує значення `subjectType` зі стартової події `start_event`.

+
image:registry-develop:study-project/task-3/task-3-2-2-bp-ua.png[]

{empty}

Custom properties ::

* У полі *Resource* введіть ендпоінт `subject-equal-subject-type-equal-subject-code`. Це відповідник критерію пошуку, який було налаштовано в xref:registry-develop:study-project/study-tasks/task-1-registry-db-modeling.adoc#search-subject-by-type-code[навчальному завданні 1].

* У полі *X-Access-Token* вкажіть токен ініціатора процесу, використовуючи JUEL-функцію `xref:bp-modeling/bp/juel-functions/users/initiator.adoc[initiator()]`:
+
[source,groovy]
----
${initiator().accessToken}
----

* У полі *Result variable* збережіть результат виконання запита до змінної `subjectResponse`.

+
image:registry-develop:study-project/task-3/task-3-2-3-bp-ua.png[]

[#xor-subject-found]
==== XOR-шлюз "Суб'єкт знайдено?" та моделювання умов розвитку процесу

*_Додайте XOR-шлюз "Суб'єкт знайдено?"_*, який буде використовуватися для розгалуження процесу на дві гілки залежно від результату пошуку суб'єкта в дата-фабриці.
Це рішення приймається на основі умов, що задаються в потоці переходу (*Sequence Flow*) кожної з гілок.

TIP: XOR-шлюз дозволяє автоматично розділити потік виконання бізнес-процесу, відправляючи його або на подальшу обробку, або на завершення у разі помилки. Коректне налаштування умов на вихідних потоках гарантує правильну логіку роботи бізнес-процесу.

[modeling-conditions]
===== Моделювання умов на XOR-шлюзі

Щоб правильно змоделювати логіку процесу, виконайте такі кроки:

. *Додайте XOR-шлюз* до схеми бізнес-процесу після завдання "Отримання суб'єкта з дата-фабрики".
+
image:registry-develop:study-project/task-3/task-3-3-bp-ua.png[]

. *Створіть дві вихідні гілки* від XOR-шлюзу:
* ⎇ Основна гілка (суб'єкт знайдено).
* ⎇ Альтернативна гілка (суб'єкт не знайдено).

. *Задайте умови для кожної гілки* у відповідних потоках переходу (*Sequence Flow*):

* *Умова "ні"* (суб'єкт не знайдено) -> процес переходить до формування помилки:
+
[source,groovy]
----
${subjectResponse.value.responseBody.elements().isEmpty()}
----
+
image:registry-develop:study-project/task-3/task-3-3-1-bp-ua.png[]


* **Умова "так"** (суб'єкт знайдено) -> процес продовжується:
+
[source,groovy]
----
${!subjectResponse.value.responseBody.elements().isEmpty()}
----
+
image:registry-develop:study-project/task-3/task-3-3-2-bp-ua.png[]

Кожна з цих умов використовується в полі *Condition Expression* відповідного потоку переходу (*Sequence Flow*).

[#alt-branch-validation-error]
==== Альтернативна гілка: формування валідаційної помилки та завершення процесу

Якщо суб'єкт не знайдено, процес має завершитися помилкою. Для цього:

. Додайте елемент "Формування валідаційної помилки" після XOR-шлюзу.
. Використовуйте інтеграційне розширення (делегат) xref:bp-modeling/bp/element-templates/service-task-templates/error-handling/throw-validation-error.adoc[Throw validation error] для моделювання помилки.
. Налаштуйте параметри помилки у полі *Validation Errors*:
+
[source,json]
----
{"field": "", "value": "", "message": "Суб'єкт не знайдено"}
----

+
image:registry-develop:study-project/task-3/task-3-3-01-bp-ua.png[]

. Після формування помилки приєднайте подію завершення процесу (*End Event*).
+
image:registry-develop:study-project/task-3/task-3-3-02-bp-ua.png[]

Такий підхід гарантує, що у разі відсутності суб'єкта бізнес-процес коректно завершиться із зазначенням помилки.

==== Основна гілка: продовження процесу та подальша обробка знайденого суб'єкта

Якщо суб'єкт знайдено, бізнес-процес продовжується наступними етапами:

. Моделювання наступного XOR-шлюзу для додаткової логіки на подальших етапах процесу.
. Збереження ідентифікатора суб'єкта для подальшої роботи.
. Підготовка даних документа для показу
. Додавання інформації про лабораторію.
. Подальші етапи процесу.

image:registry-develop:study-project/task-3/task-3-3-03-bp-ua.png[]

Розглянемо кожен елемент процесу у відповідних підрозділах нижче.

[#script-save-subject-id]
==== Скрипт збереження ID суб'єкта

*_Додайте скриптове завдання (Script Task)_*. Це завдання виконує збереження ідентифікатора суб'єкта, отриманого після перевірки його наявності в дата-фабриці.
Скриптове завдання дозволяє автоматично обробляти дані без взаємодії з користувачем.

image:registry-develop:study-project/task-3/task-3-4-bp-ua.png[]

Налаштуйте завдання так:

General ::

* У полі *Name* введіть назву завдання: `Збереження id суб'єкта`.
* У полі *ID* вкажіть унікальний ідентифікатор завдання або залиште значення за замовчуванням.

Script ::

* У полі *Result variable* введіть `subjectId`, щоб зберегти ідентифікатор суб'єкта для подальшого використання в процесі.
* Натисніть *Open script editor* та додайте скрипт для обробки отриманого ідентифікатора.
+
.Приклад скрипту
[source,groovy]
----
execution.setVariable("subjectId", subjectResponse.value.responseBody.elements().get(0).id);
----

** Цей скрипт отримує перший елемент з масиву `elements()` та зберігає його ID у змінній `subjectId`. Це забезпечує доступ до отриманого ідентифікатора в наступних завданнях бізнес-процесу.

** Отримане значення `subjectId` використовується на подальших кроках процесу:

[#script-data-preparing-subject-code]
==== Скрипт формування даних з кодом отриманого суб'єкта для передзаповнення наступної користувацької форми

*_Додайте скриптове завдання (Script Task)_*. Це завдання використовується для підготовки даних суб'єкта, отриманого з дата-фабрики, та формування об'єкта `payload`, який передається для подальшої обробки.

image:registry-develop:study-project/task-3/task-3-5-bp-ua.png[]

Налаштуйте завдання наступним чином:

General ::

* У полі *Name* введіть назву завдання: `Підготовка даних документа для показу`.
* У полі *ID* вкажіть унікальний ідентифікатор завдання або залиште значення за замовчуванням.

Script ::
Відкрийте *Script Editor* та додайте наступний скрипт:
+
.Приклад скрипту
[source,groovy]
----
def cephData = [:]

cephData['edrpou'] = subjectResponse.responseBody.elements().get(0).prop('subjectCode').value()

execution.removeVariable('payload')
set_transient_variable('payload', S(cephData, 'application/json'))
----
+
Опис логіки скрипту:

. **Створюється змінна `cephData`**, яка буде містити необхідні дані про суб'єкта.
. **Записується код ЄДРПОУ** у поле `edrpou` шляхом отримання значення `subjectCode` з першого елемента відповіді `subjectResponse`.
. **Видаляється стара змінна `payload`**, щоб очистити попередні значення.
. **Формується новий `payload`** у форматі JSON та передається у змінну `payload` як тимчасова змінна (*transient variable*), яка буде використана в наступних етапах бізнес-процесу.

[#create-task-add-lab-data]
==== Створення користувацької задачі для внесення даних про лабораторію

*_Додайте завдання користувача (User Task)_*, яке буде використовуватися для внесення даних про лабораторію через форму, яка надається користувачу у процесі виконання бізнес-процесу.
Завдання дозволяє отримати від користувача необхідні дані перед наступними етапами обробки.

Налаштуйте завдання наступним чином:

General ::
* У полі *Name* введіть `Додати інформацію про лабораторію`.
* У полі *ID* зазначте `addLabFormActivity`. Це унікальний ідентифікатор завдання, який використовується у всьому процесі для посилання на цю задачу.

Template ::
Використовуйте інтеграційне розширення (делегат) xref:bp-modeling/bp/element-templates/user-task-templates/user-form.adoc[].

Custom properties ::
* У полі *Form key* введіть `feature-add-new-lab`. Це службова назва форми, де користувач має вносити дані. Вона має точно збігатися з ідентифікатором відповідної форми у системі.
* У полі *Assignee* вкажіть `${initiator}`, щоб автоматично призначити завдання ініціатору процесу. Це означає, що користувач, який запустив процес, отримає форму для заповнення.
* У полі *Form data pre-population* передайте `${payload}`, щоб автоматично передзаповнити форму даними, підготовленими на попередньому етапі. Ця змінна містить JSON-об'єкт з попередньо отриманими даними, які підставляються у відповідні поля форми.

image:registry-develop:study-project/task-3/task-3-6-bp-ua.png[]

[#search-laboratory-data]
==== Створення сервісної задачі для пошуку даних про лабораторію

*_Додайте сервісне завдання (Service Task)_*, яке буде використовуватися для пошуку записів про лабораторію у дата-фабриці.
Завдання виконує запит до реєстру та повертає результат у змінну процесу.

Налаштуйте завдання наступним чином:

General ::
* У полі *Name* введіть `Пошук даних про лабораторію (transient var)`.
* У полі *ID* зазначте `searchForLabByNameAndEdrpouActivity`. Це унікальний ідентифікатор, що використовується для звернення до цього завдання в процесі.

Template ::
Використовуйте інтеграційне розширення (делегат) xref:bp-modeling/bp/element-templates/service-task-templates/entity-management/search-entities-in-data-factory.adoc[].

image:registry-develop:study-project/task-3/task-3-7-bp-ua.png[]

Inputs ::
Передайте вхідні параметри запиту у вигляді *Map* (ключ-значення). Значення ключів можна передати за допомогою JUEL-функцій.

* У полі menu:Search variables[Assignment type] виберіть `Map`.
* Додайте такі *Map entries* як параметри пошуку:
+
[options="header"]
|===
| Key     | Value
| `name`  | `${submission('addLabFormActivity').formData.prop('name').value()}`
| `edrpou`| `${submission('addLabFormActivity').formData.prop('edrpou').value()}`
|===

+
image:registry-develop:study-project/task-3/task-3-7-1-bp-ua.png[]

Custom properties ::
* У полі *Resource* введіть ендпоінт `laboratory-equal-edrpou-name-count`. Це відповідник критерію пошуку лабораторії за назвою та кодом ЄДРПОУ.
* У полі *X-Access-Token* вкажіть токен виконавця останнього завдання користувача -- `${completer('addLabFormActivity').accessToken}`.
+
[NOTE]
====
Використання правильного токена доступу ::

У бізнес-процесах можуть використовуватися два типи токенів доступу:

. *Токен ініціатора процесу* (`${initiator().accessToken}`) -- використовується, якщо доступні дані користувача, який запустив бізнес-процес.
. *Токен виконавця останньої користувацької задачі* (`${completer('taskDefinitionId').accessToken}`) -- використовується, коли важливо враховувати роль або дії користувача, що виконав останню задачу в межах процесу.

*JWT-токен має термін дії 300 секунд*.
Якщо бізнес-процес триває довше, слід використовувати токен виконавця задачі, щоб уникнути проблем з авторизацією.

Детальніше про використання JUEL-функцій можна переглянути на сторінках:

* xref:registry-develop:bp-modeling/bp/juel-functions/users/initiator.adoc[]
* xref:registry-develop:bp-modeling/bp/juel-functions/users/completer.adoc[]
====

+
image:registry-develop:study-project/task-3/task-3-7-2-bp-ua.png[]

[#xor-lab-data-found]
==== XOR-шлюз "Дані присутні?" та моделювання умов розвитку процесу

*_Додайте XOR-шлюз "Дані присутні?"_*, який потрібен для розгалуження процесу на дві гілки залежно від результату перевірки наявності лабораторії в дата-фабриці.
Це рішення приймається на основі умов, що задаються в потоці переходу (*Sequence Flow*) кожної з гілок.

[modeling-conditions]
===== Моделювання умов на XOR-шлюзі

Щоб правильно змоделювати логіку процесу, виконайте такі кроки:

. *Додайте XOR-шлюз* до схеми бізнес-процесу після завдання "Пошук даних про лабораторію (transient var)".
+
image:registry-develop:study-project/task-3/task-3-8-bp-ua.png[]

. *Створіть дві вихідні гілки* від XOR-шлюзу:
* ⎇ Основна гілка (дані лабораторії не знайдено).
* ⎇ Альтернативна гілка (дані лабораторії вже присутні).

. *Задайте умови для кожної гілки* у відповідних потоках переходу (*Sequence Flow*):

* *Умова "так"* (дані лабораторії вже присутні) -> процес переходить до формування валідаційної помилки:
+
[source,groovy]
----
${!response.value.responseBody.elements().isEmpty()}
----
+
image:registry-develop:study-project/task-3/task-3-8-1-bp-ua.png[]

* *Умова "ні"* (дані лабораторії не знайдено) -> процес продовжується:
+
[source,groovy]
----
${response.value.responseBody.elements().isEmpty()}
----
+
image:registry-develop:study-project/task-3/task-3-8-2-bp-ua.png[]

Кожна з цих умов використовується в полі *Condition Expression* відповідного потоку переходу (*Sequence Flow*).

[#alt-branch-val-error-back-to-previous-xor]
==== Альтернативна гілка: формування валідаційної помилки та повернення на попередній XOR-шлюз

Якщо дані про лабораторію вже присутні, процес має завершитися помилкою. Для цього:

. Додайте елемент "Формування валідаційної помилки" після XOR-шлюзу.
. Використовуйте інтеграційне розширення (делегат) xref:bp-modeling/bp/element-templates/service-task-templates/error-handling/throw-validation-error.adoc[Throw validation error] для моделювання помилки.
. Налаштуйте параметри помилки у полі *Validation Errors*.
+
[NOTE]
====
Делегат *Throw validation error* дозволяє виводити декілька повідомлень одночасно.

У разі формування валідаційної помилки користувач побачить два спливних повідомлення (pop-up) приблизно наступного вигляду:

* *name:* <введене значення name на формі> _"Дані про цю лабораторію вже присутні"._

* *edrpou:* <введене значення edrpou на формі> _"Дані про цю лабораторію вже присутні"._
====
+
.Приклад валідаційної помилки для поля "name"
[source,json]
----
{"field": "name", "value": "${submission('addLabFormActivity').formData.prop('name').stringValue().replaceAll(\"\", \\\"\\\")}", "message": "Дані про цю лабораторію вже присутні"}
----
+
.Приклад валідаційної помилки для поля "edrpou"
[source,json]
----
{"field": "edrpou", "value": "${submission('addLabFormActivity').formData.prop('edrpou').value()}", "message": "Дані про цю лабораторію вже присутні"}
----
+
image:registry-develop:study-project/task-3/task-3-9-bp-ua.png[]

. Після формування помилки приєднайте гілку, яка приводитиме альтернативний потік на попередній XOR-шлюз.
+
image:registry-develop:study-project/task-3/task-3-9-1-bp-ua.png[]

Такий підхід гарантує, що у разі наявності лабораторії бізнес-процес піде альтернативним потоком із зазначенням помилки.

[#main-branch-continue-bp]
==== Основна гілка: продовження процесу та подальша обробка даних

Якщо лабораторії немає у дата-фабриці, бізнес-процес продовжується наступними етапами:

. Моделювання наступного XOR-шлюзу для додаткової логіки на подальших етапах процесу.
. Підписання даних про лабораторію.
. Збереження даних до БД та завершення процесу.

image:registry-develop:study-project/task-3/task-3-10-bp-ua.png[]

Розглянемо кожен елемент процесу у відповідних підрозділах нижче.

[#create-user-task-lab-data-signing]
==== Створення завдання користувача для підпису даних

*_Додайте завдання користувача (User Task)_* для накладання *КЕП (кваліфікованого електронного підпису)* на внесені дані про лабораторію перед їх передачею в систему.
Цю дію виконує посадова особа або надавач послуг, тому необхідно використовувати делегат xref:bp-modeling/bp/element-templates/user-task-templates/officer-sign-task.adoc[] при налаштуванні завдання.

[TIP]
Якщо дані мають бути підписані отримувачем послуг (громадянином), потрібно використовувати делегат xref:bp-modeling/bp/element-templates/user-task-templates/citizen-sign-task.adoc[].

Налаштуйте завдання наступним чином:

General ::

* У полі *Name* введіть `Підписати дані про лабораторію`.
* У полі *ID* зазначте `signLabFormActivity`. Це унікальний ідентифікатор завдання, який використовується для звернення до нього в межах бізнес-процесу.

Template ::
Використовуйте делегат xref:bp-modeling/bp/element-templates/user-task-templates/officer-sign-task.adoc[], який дозволяє посадовій особі підписувати дані через кваліфікований електронний підпис.

Custom properties ::

* У полі *Form key* введіть `feature-sign-added-lab`. Це службова назва форми, у якій користувач підписує внесені дані. Вона має точно збігатися з ідентифікатором відповідної форми у системі.
* У полі *Assignee* вкажіть `${initiator}`, щоб автоматично призначити завдання ініціатору процесу. Це означає, що користувач, який запустив процес, отримає форму для накладання КЕП.
* У полі *Form data pre-population* передайте `${submission('addLabFormActivity').formData}`, щоб автоматично передзаповнити форму даними, які були внесені на попередньому етапі.

image:registry-develop:study-project/task-3/task-3-11-bp-ua.png[]

[#create-script-task-prepare-data-record-transient-var]
==== Скрипт для підготовки даних перед записом (transient var)

*_Додайте скриптове завдання (Script Task)_*, яке використовується для *перетворення та підготовки підписаних даних перед їх записом у систему*.
Скрипт виконує *очищення, нормалізацію та форматування даних*, необхідних для коректного збереження у фабриці даних.

image:registry-develop:study-project/task-3/task-3-12-bp-ua.png[]

Налаштуйте завдання наступним чином:

General ::

* У полі *Name* введіть `Підготовка даних для запису (transient var)`.
* У полі *ID* зазначте `convertSignFormDataToDataFactoryFormatActivity`.
Це унікальний ідентифікатор завдання, який використовується для звернення до нього в межах бізнес-процесу.

Script ::
Відкрийте *Script Editor* та додайте наступний скрипт:
+
.Приклад скрипту
[source,groovy]
----
def signedFormData = submission('signLabFormActivity').formData

signedFormData.prop('oblast', signedFormData.prop('oblast').prop('code').value())

signedFormData.prop('koatuuId', signedFormData.prop('koatuu').prop('koatuuId').value())
signedFormData.deleteProp('koatuu')
signedFormData.prop('ownershipId', signedFormData.prop('ownership').prop('ownershipId').value())
signedFormData.deleteProp('ownership')
signedFormData.prop('kopfgId', signedFormData.prop('kopfg').prop('kopfgId').value())
signedFormData.deleteProp('kopfg')

signedFormData.prop('subjectId', subjectId)

execution.removeVariable('dataPayload')
set_transient_variable('dataPayload', signedFormData)
----
+
Опис логіки скрипту:

. *Отримання підписаних даних*: дані, внесені та підписані посадовою особою у завданні `signLabFormActivity`, зберігаються у змінній `signedFormData`.

. *Нормалізація значень*:
* Перетворюється значення `oblast`, замінюючи його на `code`.
* Окремо виділяються значення `koatuuId`, `ownershipId` та `kopfgId` із вкладених структур, а самі вкладені властивості (`koatuu`, `ownership`, `kopfg`) видаляються для спрощення структури.

. *Додавання `subjectId`*: додається ідентифікатор суб'єкта (`subjectId`), який використовується для прив'язки даних до відповідного суб'єкта.

. *Передача результату*:
* Видаляється стара змінна `dataPayload`, щоб очистити попередні значення.
* Оновлений об'єкт `signedFormData` передається у *тимчасову змінну (transient variable)* `dataPayload` для подальшого використання у бізнес-процесі.

[#sign-data-by-system-key]
==== Моделювання сервісного завдання для підпису даних системним ключем

*_Створіть сервісну задачу (Service Task)_* для *накладання системного підпису на підготовлені дані* перед їх передачею на збереження.
Для підпису використовується делегат xref:bp-modeling/bp/element-templates/service-task-templates/system-signature-by-dso-service.adoc[System signature by DSO service], який забезпечує підписання даних із використанням внутрішнього ключа системи.

Налаштуйте завдання наступним чином:

General ::

* У полі *Name* введіть `Підписати дані системним ключем`.
* У полі *ID* залиште значення за замовчуванням або вкажіть унікальний ідентифікатор завдання.

Template ::
Використовуйте інтеграційне розширення (делегат) xref:bp-modeling/bp/element-templates/service-task-templates/system-signature-by-dso-service.adoc[System signature by DSO service].

Custom properties ::

* У полі *Payload* передайте дані, що підлягають підписанню -- `${dataPayload}`.
Це змінна, яка містить підготовлені та нормалізовані дані, отримані після попередніх етапів процесу.

* У полі *X-Access-Token source* передайте токен доступу виконавця останньої користувацької задачі:
+
[source,groovy]
----
${completer('signLabFormActivity').accessToken}
----
+
TIP: Тут використовується функція `xref:bp-modeling/bp/juel-functions/users/completer.adoc[completer()]`, що отримує токен користувача, який виконав задачу `signLabFormActivity`.
+
[NOTE]
====
Використання правильного токена доступу ::

У бізнес-процесах можуть використовуватися два типи токенів доступу:

. *Токен ініціатора процесу* (`${initiator().accessToken}`) -- використовується, якщо доступні дані користувача, який запустив бізнес-процес.
. *Токен виконавця останньої користувацької задачі* (`${completer('taskDefinitionId').accessToken}`) -- використовується, коли важливо враховувати роль або дії користувача, що виконав останню задачу в межах процесу.

*JWT-токен має термін дії 300 секунд*.
Якщо бізнес-процес триває довше, слід використовувати токен виконавця задачі, щоб уникнути проблем з авторизацією.

Детальніше про використання JUEL-функцій можна переглянути на сторінках:

* xref:registry-develop:bp-modeling/bp/juel-functions/users/initiator.adoc[]
* xref:registry-develop:bp-modeling/bp/juel-functions/users/completer.adoc[]
====

* У полі *Result variable* зазначте змінну для збереження отриманого підпису -- `system_signature_ceph_key`. Це змінна, в яку записується результат підписання даних системним ключем.

image:registry-develop:study-project/task-3/task-3-13-bp-ua.png[]

Цей підхід гарантує, що дані підписуються системним ключем без необхідності додаткових дій з боку користувача, забезпечуючи автоматизацію процесу.

[#save-data-to-data-factory]
==== Збереження даних у фабрику даних

*_Змоделюйте сервісне завдання (Service Task)_*, яке використовується для *збереження оброблених і підписаних даних в операційній БД реєстру.

image:registry-develop:study-project/task-3/task-3-14-bp-ua.png[]

Налаштуйте завдання наступним чином:

General ::
* У полі *Name* введіть `Зберегти дані в Дата фабрику`.
* У полі *ID* зазначте `sendLabToDataFactoryActivity` або залиште значення за замовчуванням.

Template ::
Використовуйте інтеграційне розширення (делегат) xref:bp-modeling/bp/element-templates/service-task-templates/entity-management/create-entity.adoc[].

Custom properties ::

* У полі *Resource* введіть значення `laboratory`. Це вказує, що дані будуть збережені у відповідному ресурсі (таблиці) у фабриці даних.
+
NOTE: У полі *Resource* необхідно використовувати назви ресурсів/ендпоінтів у *kebab-case* (через дефіс `-`), наприклад, `laboratory-test`, а не `laboratory_test` (як у БД).

* У полі *Payload* передайте дані для збереження -- `${dataPayload}`. Це змінна, що містить підготовлені та підписані дані, які необхідно передати в базу даних.

* У полі *X-Access-Token* передайте токен користувача, який підписував дані:
+
[source,groovy]
----
${completer('signLabFormActivity').accessToken}
----
+
[NOTE]
====
Використання правильного токена доступу ::

У бізнес-процесах можуть використовуватися два типи токенів доступу:

. *Токен ініціатора процесу* (`${initiator().accessToken}`) -- використовується, якщо доступні дані користувача, який запустив бізнес-процес.
. *Токен виконавця останньої користувацької задачі* (`${completer('taskDefinitionId').accessToken}`) -- використовується, коли важливо враховувати роль або дії користувача, що виконав останню задачу в межах процесу.

*JWT-токен має термін дії 300 секунд*.
Якщо бізнес-процес триває довше, слід використовувати токен виконавця задачі, щоб уникнути проблем з авторизацією.

Детальніше про використання JUEL-функцій можна переглянути на сторінках:

* xref:registry-develop:bp-modeling/bp/juel-functions/users/initiator.adoc[]
* xref:registry-develop:bp-modeling/bp/juel-functions/users/completer.adoc[]
====
+
Це забезпечує правильну авторизацію для операції збереження.

* У полі *X-Digital-Signature source* вкажіть цифровий підпис, накладений користувачем:
+
[source,groovy]
----
${sign_submission('signLabFormActivity').signatureDocumentId}
----
+
TIP: Використовуйте JUEL-функцію `xref:bp-modeling/bp/juel-functions/forms/sign-submission.adoc[sign_submission()]` для передачі підписаних даних з форми.

* У полі *X-Digital-Signature-Derived source* зазначте системний підпис, накладений автоматично -- `${system_signature_ceph_key}`. Це підпис, накладений на попередньому етапі завданням `System signature by DSO service`.

* У полі *Result variable* вкажіть змінну, до якої записується відповідь від сервера -- `response`. Вона міститиме результат виконання операції збереження.

===== Логіка роботи

. Дані (`dataPayload`) передаються до фабрики даних у ресурс `laboratory`.

. Використовується токен виконавця `signLabFormActivity`, щоб підтвердити права на операцію збереження.

. Передаються **користувацький підпис** (`X-Digital-Signature source`) та **системний підпис** (`X-Digital-Signature-Derived source`).

. Фабрика даних приймає запит та створює новий запис у базі даних.

. У змінну `response` записується результат виконання операції (успіх/помилка).

NOTE: Це завдання є фінальним етапом у процесі створення запису про лабораторію та гарантує, що всі дані успішно передаються та зберігаються в операційній базі даних реєстру.

[#define-business-process-status]
==== Встановлення статусу завершення бізнес-процесу

*_Створіть сервісне завдання (Service Task)_*, що дозволить *визначати підсумковий статус бізнес-процесу*.
Завдання відображає, чи успішно завершився процес, та задає відповідний статус для подальшого моніторингу.

image:registry-develop:study-project/task-3/task-3-15-bp-ua.png[]

Налаштуйте завдання наступним чином:

General ::

* У полі *Name* введіть `Результат виконання "Лабораторія створена"`.
* У полі *ID* зазначте `defineBusinessProcessStatusActivity` або залиште значення за замовчуванням.

Template ::
Використовуйте інтеграційне розширення (делегат) xref:bp-modeling/bp/element-templates/service-task-templates/define-bp-status/define-bp-status.adoc[].

Custom properties ::
У полі *Status* введіть текст. Наприклад, `Лабораторія створена`. Це буде відображено у полі `Статус виконаного бізнес-процесу` на порталах надавачів та отримувачів послуг.
+
[NOTE]
====
Поля *Name* та *Status* мають інформативне значення.
Результат виконання процесу із зазначеним статусом буде показано у Кабінеті користувача або надавача послуг, повідомляючи як завершилось виконання певного бізнес-процесу.

.Приклад статусу із нотифікацією про виконання певного завдання процесу. Відображення статусу завершення процесу виконується за аналогічним принципом
image::user:notifications/notifications-success-01.png[]
====

NOTE: Це завдання є фінальним кроком у бізнес-процесі, що підтверджує успішне створення лабораторії.

[#create-end-task]
==== Створення події завершення бізнес-процесу

*_Створіть подію, яка завершуватиме бізнес-процес (End Event)_*. Для цього виконайте наступні кроки:

. Приєднайте та налаштуйте подію завершення бізнес-процесу.

. На панелі налаштувань праворуч для параметра *Name* вкажіть значення `Лабораторія створена`.

image:registry-develop:study-project/task-3/task-3-16-bp-ua.png[]

NOTE: У результаті маємо змодельований бізнес-процес з інтеграцією Фабрики даних.

[#save-bp-schema]
==== Збереження змодельованої схеми бізнес-процесу

===== Якщо моделюєте у Вебінтерфейсі адміністратора регламенту

Після завершення моделювання збережіть зміни, натиснувши кнопку у правому верхньому куті вебінтерфейсу.

* Якщо ви працюєте безпосередньо у `master`-версії регламенту, зміни буде застосовано автоматично після збереження.
* Якщо ви працюєте у версії-кандидаті, застосуйте зміни до `master`-версії вручну: xref:registry-develop:registry-admin/admin-portal/version-control/candidate/overview-new-change-request.adoc#push-changes-master[Детальніше про застосування змін].

===== Якщо моделюєте у сторонньому BPMN-додатку або Camunda Modeler

Після завершення моделювання збережіть схему бізнес-процесу з назвою `feature-add-lab.bpmn` у регламентну папку `bpmn` у Gerrit-репозиторії.

Щоб зберегти файл у Camunda Modeler:

. Відкрийте меню menu:File[Save File As..].
. Введіть назву `feature-add-lab.bpmn`, вкажіть шлях до папки `bpmn` і натисніть *Save*.

[#forms-modeling]
=== Моделювання форм

[NOTE]
====
На етапі моделювання форм необхідно створити та прив'язати JSON-форми до попередньо змодельованих задач в рамках бізнес-процесу.

Форми прив'язуються до бізнес-процесів за службовою назвою.

Використовуйте готові JSON-файли зі змодельованими формами для наочного прикладу:

* `link:{attachmentsdir}/study-project/task-3/bp-forms/feature-search-subject.json[feature-search-subject.json]`
* `link:{attachmentsdir}/study-project/task-3/bp-forms/feature-add-new-lab.json[feature-add-new-lab.json]`
* `link:{attachmentsdir}/study-project/task-3/bp-forms/feature-sign-added-lab.json[feature-sign-added-lab.json]`
====

[#start-form]
==== Налаштування стартової форми бізнес-процесу

. Увійдіть до застосунку *Кабінет адміністратора регламентів*.
+
image::registry-develop:bp-modeling/forms/admin-portal-form-modeling-step-1.png[]

. Створіть нову кандидат-версію *Завдання 3*.
+
image:registry-develop:study-project/task-3/task-3-011.png[]
+
image:registry-develop:study-project/task-3/task-3-012.png[]

. Перейдіть до розділу *UI-форми*. Щоб створити нову форму для бізнес-процесу, натисніть кнопку *Створити нову форму*.
+
image:registry-develop:study-project/task-3/task-3-013.png[]

. На вкладці *Загальна* вкажіть бізнес- і службову назву форми:

* Бізнес-назва форми: `Пошук суб'єкта в реєстрі`.
* Службова назва форми: `feature-search-subject`. Службова назва має збігатися зі значенням поля *Form key* у початковій події (початковій формі) бізнес-процесу.

+
image:registry-develop:study-project/task-3/task-3-1-form-ua.png[]

===== Опис форми: Конструктор

Відкрийте вкладку *Конструктор* та виконайте налаштування трьох основних компонентів UI-форми:

. *Тип суб'єкта* -- перемикач (Radio Component), який визначає, чи є суб'єкт *ФОП* (Фізична особа-підприємець) або *Юридичною особою*.
. *Код РНОКПП* -- текстове поле для введення коду фізичної особи-підприємця.
. *Код ЄДРПОУ* -- текстове поле для введення коду юридичної особи.

У результаті моделювання форма повинна виглядати так:

image:registry-develop:study-project/task-3/task-3-2-form-ua.png[]

===== Налаштування компонента "Тип суб'єкта" (Radio Component)

Компонент xref:bp-modeling/forms/components/radio.adoc[Radio] використовується для вибору між двома типами суб'єкта:

* [*] *Фізична особа-підприємець* (значення: `ENTREPRENEUR`)
* [*] *Юридична особа* (значення: `LEGAL`)

Перетягніть компонент *Radio* з бокового меню ліворуч на панель моделювання та виконайте наступні налаштування на відповідних вкладках:

[tabs]
====
Display ::

На цій вкладці вкажіть основні параметри:

* *Label (Мітка):* `Тип суб'єкта`
* *Label Position (Розташування мітки):* `Top`
* *Options Label Position (Розташування міток опцій):* `Right`
* *Inline Layout (Розташування в рядок):* ✅ Увімкнено

+
image:registry-develop:study-project/task-3/task-3-3-form-ua.png[]

Data ::

На цій вкладці налаштуйте значення, які передаються у бізнес-процес:

* *Default Value (Значення за замовчуванням):* Немає (користувач обирає самостійно)
* *Values (Опції):*
** `Фізична особа-підприємець` → `ENTREPRENEUR`
** `Юридична особа` → `LEGAL`
* *Clear Value When Hidden (Очищувати значення, якщо приховано):* ✅ Увімкнено

+
image:registry-develop:study-project/task-3/task-3-4-form-ua.png[]

Validation ::

На цій вкладці задайте обов'язковість заповнення:

* *Required (Обов'язкове поле):* ✅ Увімкнено
* *Custom Error Message (Повідомлення про помилку):* `Поле "Тип суб'єкта" є обов'язковим.`

+
image:registry-develop:study-project/task-3/task-3-5-form-ua.png[]

API ::
Ім'я поля в структурі даних, яка буде відправлена при відправленні даних форми.
Також це ім'я поля в структурі даних яким передзаповнюється форма.
Поточне значення цього поля можна перевірити в структурі даних, яка відображається на вкладці *Запит* в інтерфейсі розробки форм.

* *Property Name:* `subjectType`

+
image:registry-develop:study-project/task-3/task-3-6-form-ua.png[]

====

[NOTE,caption="Результат"]
На цьому етапі *Radio* компонент "Тип суб'єкта" повністю налаштований. Далі необхідно налаштувати текстові поля "Код РНОКПП" та "Код ЄДРПОУ".

===== Налаштування текстового поля "Код РНОКПП" (Textfield Component)

Компонент xref:bp-modeling/forms/components/text-field.adoc[Text Field] використовується для введення текстових даних в один рядок.

[tabs]
====
Display ::

На цій вкладці вкажіть основні параметри:

* *Label (Мітка):* `Код РНОКПП`
* *Label Position (Розташування мітки):* `Top`
* *Placeholder (Текст підказки у полі):* `Placeholder`
* *Description (Опис поля):* Порожнє
* *Tooltip (Підказка):* Порожнє

+
image:registry-develop:study-project/task-3/task-3-7-form-ua.png[]

Validation ::

На цій вкладці задайте правила валідації:

* *Required (Обов'язкове поле):* ✅ Увімкнено
* *Maximum Length (Максимальна довжина):* `10`

+
image:registry-develop:study-project/task-3/task-3-8-form-ua.png[]

API ::

Ім'я поля в структурі даних, яка буде відправлена при надсиланні форми.
Також це ім'я поля в структурі даних, яким передзаповнюється форма.

* *Property Name (Ім'я API-параметра у системі):* `rnokppCode`

+
image:registry-develop:study-project/task-3/task-3-9-form-ua.png[]

Logic ::

На цій вкладці використовується menu:Advanced Logic[JavaScript] для динамічного відображення поля залежно від вибору користувача.
+
Логіка відображення поля наступна:
+
[source,javascript]
----
show = (data.subjectType === 'INDIVIDUAL' || data.subjectType === 'ENTREPRENEUR');
----

* Якщо `subjectType` дорівнює `'INDIVIDUAL'` або `'ENTREPRENEUR'`, то поле `Код РНОКПП` відображається.
* В іншому випадку воно приховується.

+
image:registry-develop:study-project/task-3/task-3-10-form-ua.png[]

Table ::

Ця вкладка використовується для налаштування відображення поля у таблиці.

* *Table View:* ✅ Увімкнено (значення буде відображатися у списку поданих форм).

+
image:registry-develop:study-project/task-3/task-3-11-form-ua.png[]
====

[NOTE,caption="Результат"]
На цьому етапі текстове поле *Код РНОКПП* повністю налаштоване. Далі необхідно налаштувати поле "Код ЄДРПОУ".

===== Налаштування тестового поля "Код ЄДРПОУ" (Textfield Component)

Налаштування текстового поля "Код ЄДРПОУ" майже ідентичні з налаштуваннями текстового поля "Код РНОКПП", але мають деякі відмінності.

[tabs]
====
Display ::

На цій вкладці вкажіть основні параметри:

* *Label (Мітка):* `Код ЄДРПОУ`
* *Label Position (Розташування мітки):* `Top`
* *Placeholder (Текст підказки у полі):* `Placeholder`
* *Description (Опис поля):* Порожнє
* *Tooltip (Підказка):* Порожнє

Validation ::

На цій вкладці задайте правила валідації:

* *Required (Обов'язкове поле):* ✅ Увімкнено
* *Maximum Length (Максимальна довжина):* `8`

+
image:registry-develop:study-project/task-3/task-3-12-form-ua.png[]

API ::

Ім'я поля в структурі даних, яка буде відправлена при надсиланні форми.
Також це ім'я поля в структурі даних, яким передзаповнюється форма.

* *Property Name*: `edrpou`

+
image:registry-develop:study-project/task-3/task-3-13-form-ua.png[]

Logic ::

На цій вкладці використовується menu:Advanced Logic[JavaScript] для динамічного відображення поля залежно від вибору користувача.
+
Логіка відображення поля наступна:
+
[source,javascript]
----
show = (data.subjectType === 'LEGAL');
----

* Якщо `subjectType` дорівнює `'LEGAL'`, то поле `Код ЄДРПОУ` відображається.
* В іншому випадку воно приховується.

+
image:registry-develop:study-project/task-3/task-3-14-form-ua.png[]

====

[NOTE,caption="Результат"]
На цьому етапі текстове поле *Код ЄДРПОУ* повністю налаштоване. Далі необхідно перейти до перегляду форми.

===== Перегляд форми

Перейдіть на вкладку *Перегляд*, щоб ознайомитися з інтерфейсом UI-форми, яку побачать користувачі у їхніх кабінетах під час виконання бізнес-процесу.

image:registry-develop:study-project/task-3/task-3-15-form-ua.png[]

На цьому етапі можна протестувати базову взаємодію з формою: заповнити поля введення, перевірити налаштовані параметри та оцінити загальний вигляд інтерфейсу.

===== Вкладка "Запит"

Перейдіть на вкладку *Запит*, щоб переглянути сформований JSON-об'єкт, який буде передано у *Фабрику даних* після заповнення форми.

image:registry-develop:study-project/task-3/task-3-16-form-ua.png[]

Ця вкладка відображає дані, що були введені або обрані на вкладці *Перегляд*. Наприклад:

- Якщо ви обрали значення у випадному списку або натиснули *radio button* на вкладці *Перегляд*, відповідне значення відобразиться у JSON-структурі.
- Якщо ви ввели текстові дані у поля вводу, вони також відобразяться тут.

Таким чином, вкладка *Запит* дає змогу перевірити, які саме параметри будуть передані у *Фабрику даних* під час виконання бізнес-процесу. Це корисно для тестування та візуальної валідації перед відправленням запиту.

[#form-insert-data]
==== Створення форми для внесення даних про лабораторію

У вебінтерфейсі розробника регламенту створіть нову форму та виконайте наступні кроки:

. На вкладці *Загальна*:

* У полі `Бізнес-назва форми` вкажіть назву, що відповідає назві змодельованої xref:#create-task-add-lab-data[користувацької задачі] -- `Додати інформацію про лабораторію`.
* Заповніть поле `Службова назва форми` значенням `feature-add-new-lab` (має відповідати значенню поля `Form key` тієї ж xref:#create-task-add-lab-data[користувацької задачі]).

+
image:study-project/task-3/task-3-27-forms-name.png[]

. Перейдіть до вкладки *Конструктор*.

. З панелі компонентів ліворуч перетягніть компонент *Text Field* до панелі моделювання та виконайте подальші налаштування:

+
image:study-project/task-3/task-3-27-forms-drag-text-field.png[]

* У новому вікні перейдіть на вкладку *Display*, заповніть поле `Label` значенням `Назва лабораторії`:

+
image:registry-develop:study-project/task-3/task-3-27-forms.png[]

* Перейдіть на вкладку *Validation* та встановіть прапорець для параметра  `Required` -- `true`:

+
image:registry-develop:study-project/task-3/task-3-28-forms.png[]

* Перейдіть на вкладку *API* та заповніть поле `Property Name` значенням `name`.
+
[IMPORTANT]
====
Значення поля `Property Name` повинно бути унікальним.
====
* Натисніть кнопку `Save` для збереження змін:

+
image:registry-develop:study-project/task-3/task-3-29-forms.png[]

+
[IMPORTANT]
====
Аналогічно змоделюйте текстові поля (*Text Field*) для `Код ЄДРПОУ або РНОКПП`, `Адреса`, `Телефон`, `Керівник`.

//Поле `Код ЄДРПОУ або РНОКПП` повинен бути обов'язковим та мати `Property name` = `edrpou`.
====

. З панелі компонентів зліва перетягніть компонент *Checkbox* до панелі моделювання та виконайте подальші налаштування:
+
image:study-project/task-3/task-3-30-forms-drag-checkbox.png[]

* Перейдіть на вкладку *Display* та заповніть поле `Label` значенням `Наявність акредитації`:
+
image:registry-develop:study-project/task-3/task-3-30-forms.png[]

* Перейдіть на вкладку *API* та заповніть поле `Property Name` значенням `accreditationFlag`.
* Натисніть кнопку `Save` для збереження змін:
+
image:registry-develop:study-project/task-3/task-3-31-forms.png[]

. З панелі компонентів зліва перетягніть компонент *File* до панелі моделювання та виконайте подальші налаштування:

+
image:study-project/task-3/task-3-32-forms-drag-file.png[]

* Перейдіть на вкладку *Display* та заповніть поле `Label` значенням `Документи про приміщення`:
+
image:registry-develop:study-project/task-3/task-3-32-forms.png[]

* Перейдіть на вкладку *File* та заповніть наступні поля:

** у полі `Storage` вкажіть `Url`;
** у полі `Url` вкажіть `/documents`;
+
image:registry-develop:study-project/task-3/task-3-33-forms.png[]

** у полі вкажіть `File Pattern` вкажіть `application/pdf,image/jpeg,image/png`;
** у полі `File Minimum size` вкажіть `0KB`;
** у полі `File Maximum size` вкажіть `50MB`.
+
image:registry-develop:study-project/task-3/task-3-34-forms.png[]

* Перейдіть на вкладку *Data* та залишіть поле `Multiple Values` порожнім, тобто зі значенням `False`:
+
image:registry-develop:study-project/task-3/task-3-35-forms.png[]

* Перейдіть на вкладку *API* та заповніть поле `Property Name` значенням `premisesFile`.
* Натисніть кнопку `Save` для збереження змін:
+
image:registry-develop:study-project/task-3/task-3-36-forms.png[]

. Виконайте налаштування для отримання інформації з довідника "Область". З панелі компонентів зліва перетягніть компонент *Select* до панелі моделювання.
+
image:study-project/task-3/task-3-37-forms-drag-select.png[]

* Перейдіть на вкладку *Display* та заповніть поле `Label` значенням `Область`:

+
image:registry-develop:study-project/task-3/task-3-41-forms.png[]

* Перейдіть на вкладку *Data* та заповніть наступні поля:

** у полі `Data Source Type` вкажіть значення `URL`;
** у полі `Data Source URL` вкажіть `/officer/api/data-factory/koatuu-obl-contains-name`,

+
[TIP]
====
де:

* `/officer` -- вказує, що запит до довідника буде виконано із Кабінету посадової особи;
* `/api/data-factory/` -- вказує шлях до фабрики даних;
* `koatuu-obl-contains-name` -- назва критерію пошуку (search condition) для отримання даних із довідника областей, що був змодельований та доданий до репозиторію.
====

** у полі `Value Property` введіть значення `code`;
+
image:registry-develop:study-project/task-3/task-3-42-forms.png[]

** у полі `Item Template` вкажіть `<span>{{ item.name }}</span>`,
+
[TIP]
====
де `name` -- назва параметра, що повертає критерій пошуку (search condition) та відображатиметься на формі.
====
+
image:registry-develop:study-project/task-3/task-3-43-forms.png[]

* Перейдіть на вкладку *Validation* та встановіть прапорець для параметра `Required` -- `True`.

* Перейдіть на вкладку *API* та заповніть поле `Property Name` значенням `oblast`.
+
image:registry-develop:study-project/task-3/task-3-44-forms.png[]

* Натисніть кнопку `Save` для збереження змін.

. Налаштуйте залежний компонент *Select*. З панелі компонентів зліва перетягніть компонент *Select* до панелі моделювання та виконайте подальші налаштування для отримання інформації з довідника:

+
image:study-project/task-3/task-3-37-forms-drag-select.png[]

* Перейдіть на вкладку *Display* та заповніть поле `Label` значенням `Назва населеного пункту`.
+
image:registry-develop:study-project/task-3/task-3-45-forms.png[]

* Перейдіть на вкладку *Data* та заповніть наступні поля:

** у полі `Data Source Type` введіть `URL`;
** у полі `Data Source URL` введіть `/officer/api/data-factory/koatuu-np-starts-with-name-by-obl`,
+
[TIP]
====
де:

* `/officer` -- вказує, що запит до довідника буде виконано із Кабінету посадової особи;
* `/api/data-factory/` -- вказує шлях до фабрики даних;
* `koatuu-np-starts-with-name-by-obl` -- назва критерію пошуку (search condition) для отримання даних із довідника населених пунктів, що був змодельований та доданий до репозиторію.
====

** у полі `Value Property` вкажіть `koatuuId`;
+
image:registry-develop:study-project/task-3/task-3-46-forms.png[]

** у полі `Filter Query` вкажіть `level1={{data.oblast.code}}`,
+
[TIP]
====
де:

* `level1` -- вхідний параметр для ендпоінту `koatuu-np-starts-with-name-by-obl`;
* `{{data.oblast.code}}`-- шлях для отримання даних `data.Property name.Value Property` із попереднього компонента *Select*.
====

** у полі `Item Template` вкажіть `<span>{{ item.name }}</span>`,
+
[TIP]
====
де `name` -- назва параметра, що повертає search condition та буде відображений на формі.
====

** у полі `Refresh options On` введіть значення `Область`  (поточне значення буде видалено, коли значення в полі `Область` зміниться);
** встановіть прапорець для параметра `Clear Value On Refresh Options` -- `True`:
+
image:registry-develop:study-project/task-3/task-3-47-forms.png[]

* Перейдіть на вкладку *Validation* та встановіть прапорець для параметра  `Required` -- `True`.

* Перейдіть на вкладку *API* та заповніть поле `Property Name` значенням `koatuu`.

* Натисніть кнопку `Save`, щоб зберегти зміни.

. Виконайте налаштування для отримання даних із довідника форм власності. Для цього з панелі компонентів ліворуч перетягніть компонент *Select* до панелі моделювання та виконайте подальші налаштування для отримання інформації з довідника.
+
image:study-project/task-3/task-3-37-forms-drag-select.png[]

* Перейдіть на вкладку *Display* та заповніть поле `Label` значенням `Форма власності`.
+
image:registry-develop:study-project/task-3/task-3-37-forms.png[]

* Перейдіть на вкладку *Data* та заповніть наступні поля:

** у полі `Data Source Type` вкажіть значення `URL`;
** у полі `Data Source URL` вкажіть `/officer/api/data-factory/ownership-contains-name`,
+
[TIP]
====
де:

* `/officer` -- вказує, що запит до довідника буде виконано із Кабінету посадової особи;
* `/api/data-factory/` -- вказує шлях до фабрики даних;
* `ownership-contains-name` -- назва критерію пошуку (search condition) для отримання даних із довідника форм власності, що був змодельований та доданий до репозиторію.
====

** у полі `Value Property` вкажіть `ownershipId`;
+
image:registry-develop:study-project/task-3/task-3-38-forms.png[]

** у полі `Item Template` вкажіть `<span>{{ item.name }}</span>`,
+
[TIP]
====
де `name` -- назва параметра, що повертає критерій пошуку (search condition) та відображатиметься на формі.
====
+
image:registry-develop:study-project/task-3/task-3-39-forms.png[]

* На вкладці *Validation* встановіть прапорець для параметра `Required` -- `true`;

* На вкладці *API* заповніть поле `Property Name` значенням `ownership`.
+
image:registry-develop:study-project/task-3/task-3-40-forms.png[]

* Натисніть кнопку `Save` для збереження змін.

. Збережіть форму, натиснувши кнопку `Створити форму` у правому верхньому куті:

+
image:registry-develop:study-project/task-3/task-3-48-forms.png[]

[#form-data-signing]
==== Створення форми для підписання даних КЕП

Після завершення xref:#form-insert-data[попереднього етапу] зі створенням форми для внесення даних, _створіть ще одну форму для підпису даних_.

Для цього скопіюйте xref:#form-insert-data[попередньо змодельовану форму], натиснувши **іконку копіювання** -- це дозволить створити форму із готового шаблону.

image:registry-develop:study-project/task-3/task-3-49-forms.png[]

_Налаштуйте параметри форми_:

. Введіть назву відповідної xref:#create-user-task-lab-data-signing[користувацької задачі] `Підписати дані про лабораторію` в полі `Бізнес-назва форми`;
. Заповніть поле `Службова назва форми` значенням `feature-sign-added-lab` (відповідає значенню поля `Form key` тієї ж xref:#create-user-task-lab-data-signing[користувацької задачі]);

. В усіх компонентах:

* На вкладці *Display* встановіть прапорець для параметра *Disabled*.
* Натисніть кнопку `Save` для збереження змін.
+
image:registry-develop:study-project/task-3/task-3-50-forms.png[]

. Збережіть форму, натиснувши кнопку *Створити форму* у правому верхньому куті.

[#save-ui-forms]
==== Збереження змодельованих UI-форм

===== Якщо працюєте з регламентом в Адмін Порталі та Gerrit-репозиторії

Після завершення налаштування UI-форми збережіть її у локальному *Gerrit-репозиторії*, виконавши наступні дії:

. Перейдіть до *Кабінету адміністратора регламентів*.
. Відкрийте розділ *UI-форми*.
. Завантажте необхідні форми, натиснувши *іконку завантаження*.
. Помістіть отримані файли до регламентної папки `forms` у локальному Gerrit-репозиторії.

===== Якщо працюєте безпосередньо у вебінтерфейсі

Збережіть зміни, натиснувши кнопку *Створити форму* або *Зберегти зміни* у вкладці моделювання форми.

* Якщо ви працюєте у `master`-версії регламенту, зміни буде застосовано автоматично після збереження.
* Якщо ви працюєте у версії-кандидаті, застосуйте зміни до `master`-версії вручну: xref:registry-develop:registry-admin/admin-portal/version-control/candidate/overview-new-change-request.adoc#push-changes-master[Детальніше про застосування змін].

[#bp-access]
=== Моделювання доступу до бізнес-процесу

[NOTE]
====

На цьому етапі необхідно надати доступ до бізнес-процесу в *Кабінеті користувача/надавача послуг* для стандартної ролі `officer`  .

Параметри доступу налаштовуються у конфігураційному файлі, що має назву `link:{attachmentsdir}/study-project/task-3/bp-access/officer.yml[officer.yml]` із директорії `bp-auth`.
====

Відредагуйте файл `bp-auth/officer.yml` додавши наступні параметри:

.Приклад. Налаштування доступу до бізнес-процесу в Кабінеті посадової особи
[source,yaml]
----
authorization:
  realm: 'officer'
  process_definitions:
    - process_definition_id: 'add-lab-test'
      process_name: 'Створення лабораторії'
      process_description: 'Регламент для створення лабораторій'
      roles:
        - officer
    - process_definition_id: 'feature-add-lab'
      process_name: 'Створення лабораторії'
      process_description: 'Регламент для створення лабораторій'
      roles:
        - officer
----

[save-officer-yml]
==== Збереження файлу з налаштуваннями доступу

Збережіть файл `officer.yml` до регламентної папки `bp-auth` проєкту в локальному Gerrit-репозиторії.

== Завантаження файлів регламенту до віддаленого репозиторію Gerrit

Для успішного розгортання бізнес-процесу, форм, а також застосування правильних налаштувань доступу до бізнес-процесу у цільовому середовищі, адміністратор регламенту має завантажити збережені локально файли регламенту реєстру до віддаленого сховища коду Gerrit.

Для цього виконайте кроки з інструкції xref:registry-develop:registry-admin/regulations-deploy/registry-admin-deploy-regulation.adoc[].

На основі наданого контексту, розгляньте процедуру перевірки виконання завдання розробки регламенту у наступному розділі.

== Процедура перевірки виконання завдання

Ця процедура забезпечить систематичний підхід до перевірки виконання завдань розробки та інтеграції бізнес-процесів, а також допоможе забезпечити високу якість кінцевого продукту.

. Отримання тестових КЕП-ключів для автентифікації та підпису даних.
+
Зверніться до технічного адміністратора Платформи для отримання тестових ключів для надавачів послуг. Ці ключі забезпечать доступ до розроблених бізнес-процесів у тестовому середовищі.

. Налаштування користувача.
+
Використайте користувача з правами, що відповідають ролі надавача послуг, та забезпечте, що атрибути користувача відповідають тим, що вказано в тестових ключах: *ПІБ* -- `fullName`, *ЄДРПОУ* -- `edrpou` та *РНОКПП* -- `drfo`).

. Перевірка в Кабінеті надавача послуг (користувача).

- *Вхід у систему:* увійдіть в Кабінет надавача послуг за допомогою профілю користувача з відповідними правами та тестовими ключами.
- *Моделювання бізнес-процесів:* перевірте, чи правильно модельовані бізнес-процеси, включаючи інтеграцію з фабрикою даних та реалізацію гілок у бізнес-процесах.
- *Форми та компоненти Select:* переконайтеся, що форми налаштовані коректно та компоненти Select працюють належним чином для отримання даних з фабрики даних.

. Зворотний зв'язок:
+
Повідомте про будь-які помічені недоліки або відхилення від очікуваних результатів.


