:toc-title: ЗМІСТ
:toc: auto
:toclevels: 5
:experimental:
:important-caption:     ВАЖЛИВО
:note-caption:          ПРИМІТКА
:tip-caption:           ПІДКАЗКА
:warning-caption:       ПОПЕРЕДЖЕННЯ
:caution-caption:       УВАГА
:example-caption:           Приклад
:figure-caption:            Зображення
:table-caption:             Таблиця
:appendix-caption:          Додаток
:sectnums:
:sectnumlevels: 5
:sectanchors:
:sectlinks:
:partnums:

= Завантаження цифрових документів за зовнішнім посиланням

== Загальний опис

Платформа дозволяє завантажувати цифрові документи за віддаленою адресою у зовнішній системі та зберігати їх до реєстру для подальшого використання у бізнес-процесах. Це може бути необхідно, наприклад, для перегляду актів, зображень, або інших цифрових документів тощо.

NOTE: Наразі система дозволяє отримувати цифрові документи за зовнішнім посиланням із типом автентифікації `*NO_AUTH*`, коли запит виконується до публічних API (_детальніше -- див. розділ xref:#ext-system-integration-config[]_).

Для отримання цифрових файлів за віддаленою адресою розроблена JUEL-функція `*save_digital_document_from_url()*`, яку можна використовувати для спрощення моделювання процесів у скриптах (_детальніше -- див. розділ xref:#bp-modeling[]_).

За обробку цифрових документів на Платформі відповідає Сервіс цифрових документів (*`digital-document-service`*).

.Отримання цифрового контенту за віддаленою адресою та подальша обробка всередині реєстру
image::arch:architecture/registry/operational/bpms/remote-file-transfer.svg[remote-file-transfer,700]

[#ext-system-integration-config]
== Налаштування інтеграції із зовнішньою системою

Для того, щоб запит на отримання зовнішніх ресурсів міг вийти за межі кластера Платформи, необхідно на рівні реєстру створити *`Service Entry`* -- точку виходу трафіку за межі системи.

[NOTE]
Service Entry створюється автоматично, після того, як адміністратор реєстру налаштує інтеграцію в адміністративній панелі Control Plane. Після застосування змін до конфігурації реєстру та проходження Jenkins-пайплайн `*MASTER-Build-<registry-name>*`, підключення до зовнішньої системи буде налаштовано.

TIP: За деталями налаштувань у консолі Control Plane зверніться до сторінки xref:registry-develop:registry-admin/external-integration/cp-integrate-ext-system.adoc[].

. Увійдіть до консолі *Control Plane* як адміністратор реєстру.
. Перейдіть до розділу [.underline]#Реєстри# та відкрийте необхідний.
. Знайдіть секцію [.underline]#Налаштування взаємодії з іншими системами# та натисніть kbd:[+ ДОДАТИ ЗОВНІШНЮ СИСТЕМУ].
. У новому вікні налаштуйте інтеграцію із зовнішньою системою для подальшої взаємодії згідно з регламентом реєстру.
+
NOTE: Налаштуйте взаємодію через метод автентифікації *`NO_AUTH`*. Інші методи автентифікації для цього сценарію недоступні.

+
image:registry-admin/external-integration/cp-integrate-ext-system/cp-ext-sys-3.png[]

[#bp-modeling]
== Використання у бізнес-процесі

=== Загальні відомості та обмеження

Після налаштування взаємодії із зовнішньою системою у Control Plane, ви можете моделювати сценарії отримання цифрових документів за віддаленою адресою та їх подальшого використання у бізнес-процесах.

Для отримання цифрових файлів за віддаленою адресою використовуйте JUEL-функцію `*save_digital_document_from_url ()*`. Її можна використовувати при розробці Groovy-скриптів у бізнес-процесах.

Функція може приймати 2 вхідні параметри: ::

* URL цифрового документа
* Назва файлу
+
NOTE: Можливо отримати лише один документ за один запит до зовнішнього джерела.
+
Обидва параметри є рядком (`String`), тому моделювальник може передати функції фактично будь-який аргумент:
+
.Шаблон функції
====
----
save_digital_document_from_url(String remoteFileUrl, String targetFileName)
----
====

[TIP]
====
Алгоритм роботи функції наступний:

. Функція `*save_digital_document_from_url ()*` виконує запит до відкритого ресурсу за вказаним посиланням та отримує цифровий документ (наприклад, зображення у форматі `.jpeg`).
. Далі передає файл _Сервісу цифрових документів_ (`digital-document-service`).
. Сервіс зберігає файл у зашифрованому вигляді до _Об'єктного сховища проміжних даних БП_ (`lowcode-file-storage`) та у відповідь отримує метадані -- *`id`* та *`checksum`*
документа, які передаються до бізнес-процесу.

Надалі `id` та `checksum` можна використати у бізнес-процесі для збереження та подальшого отримання документа з об'єктного сховища даних CEPH.

Повний перелік параметрів, які можна використати у бізнес-процесі, дивіться у таблиці нижче.

.Структура тіла відповіді
|===
|Json Path|Тип|Опис

|`*$.id*`
|UUID
|Унікальний ідентифікатор цифрового документа, сформований з використанням генератора псевдовипадкових чисел.

|`*$.name*`
|Текстовий
|Оригінальна назва файлу

|`*$.type*`
|Текстовий
|Тип контенту файлу (_application/pdf, image/png, image/jpeg_, etc.)

|`*$.checksum*`
|Текстовий
|Автоматично згенерований геш, що накладається на контент файлу з використанням алгоритму `SHA256`.

|`*$.size*`
|Числовий
|Розмір файлу

|===

.Приклад відповіді
[source, json]
----
{
  "id": "{UUID}",
  "name": "{fileName}",
  "type": "{contentType}",
  "checksum": "{sha256}",
  "size": 0
}
----

====

[IMPORTANT]
====
Максимальний розмір файлу::

Максимальний розмір файлу (`max-remote-file-size`), який може обробити Сервіс цифрових документів, дорівнює 100 MB. У разі, якщо `digitalDocuments.maxFileSize` не вказано явним чином, приймається значення у `100` MB як системне обмеження.

Формати файлів, що підтримуються::

При використанні функції *`save_digital_document_from_url()`*, система автоматично проводить процедуру валідації файлів, що завантажуються через UI-форми Кабінетів користувачами. Валідація полягає в перевірці файлів на відповідність певним обмеженням, зокрема щодо допустимих типів файлів:

* _"application/pdf": "pdf"_
* _"image/png": "png"_
* _"image/jpeg": "jpg", "jpeg"_
* _"text/csv": csv_
* _"application/octet-stream": "asics"_
* _"application/pkcs7-signature": "p7s"_
====

[TIP]
====
Скористайтеся готовою схемою бізнес-процесу для безпосереднього поглиблення у деталі:

* [*] link:{attachmentsdir}/bp-modeling/save-digital-doc-remote-url/external-system-file-saving.bpmn[external-system-file-saving.bpmn]

Скопіюйте вміст _.bpmn_-файлу та вставте на вкладці [.underline]#Код# у розділі [.underline]#Моделі процесів# [.underline]#Кабінету адміністратора регламентів#.
====

=== Моделювання бізнес-процесу

==== Скрипт для отримання цифрового документа за зовнішнім посиланням

. Створіть скрипт-задачу (*Script Task*).
. У полі `Name` введіть назву задачі. Наприклад, `Отримання файлу з іншої системи`.
. У полі `*Script*` відкрийте [.underline]#Редактор скриптів# та напишіть Groovy-скрипт для обробки даних.
+
image:registry-develop:bp-modeling/bp/save-digital-doc-remote-url/dig-doc-remote-url-1.png[]

. Використовуйте функцію `*save_digital_document_from_url ()*`, щоб отримати цифровий документ зі сторонньої системи.

* Передайте як вхідні параметри функції посилання та назву файлу. Це можна зробити, наприклад, визначивши параметри `url` та `fileName` як змінні, присвоївши їм відповідні значення, та використавши у функції.
+
image:registry-develop:bp-modeling/bp/save-digital-doc-remote-url/dig-doc-remote-url-2.png[]

* Або можна відразу сформувати об'єкт та призначити йому як значення функцію з відповідними вхідними параметрами.
+
image:registry-develop:bp-modeling/bp/save-digital-doc-remote-url/dig-doc-remote-url-3.png[]
+
[NOTE]
====
Після обробки отриманих даних на стороні Сервісу цифрових документів, до бізнес-процесу повертаються метадані документа, збереженого у тимчасовому сховищі проміжних даних -- `id` та `checksum`.

Після того, як цифровий документ збережено до тимчасового сховища, розробник має визначити логіку подальшого збереження документа до постійного сховища CEPH у рамках цього ж процесу, адже після завершення БП файл буде видалено із тимчасового сховища.
====

+
Результат виконання скрипту зберігаємо до змінної `documentMetadata`, яку надалі використовуємо в іншому скрипті для формування об'єкта, що зберігатиме метадані отриманого документа до постійного сховища CEPH. +
image:registry-develop:bp-modeling/bp/save-digital-doc-remote-url/dig-doc-remote-url-4.png[]

==== Користувацька задача для виводу файлу з БД на UI-форму

Після збереження об'єкта із метаданими цифрового документа до основної БД, знаходимо запис за його ID та передаємо об'єкт як змінну на UI-форму Кабінету користувача.

. Створіть користувацьку задачу (*User Task*).
. Введіть назву задачі. Наприклад, `Переглянути файл з БД на формі`.
. Застосуйте [.underline]#шаблон делегата# зі списку доступних -- *User form*.
. У полі `Form key` введіть службову назву форми, до якої необхідно передати дані. Наприклад, `file-saved-from-ext-system-view`.
. У полі `Assignee` вкажіть токен ініціатора процесу -- `${initiator}`.
. У полі `Form data pre-population` вкажіть дані об'єкта із цифровим документом (у нашому прикладі -- це зображення), який виведеться на форму. Наприклад, `${response.value.responseBody}`.
+
image:registry-develop:bp-modeling/bp/save-digital-doc-remote-url/dig-doc-remote-url-5.png[]

[#form-modeling]
=== Моделювання UI-форм

Отриманий цифровий документ за зовнішнім посиланням можна відобразити на UI-формі бізнес-процесу та завантажити на локальну машину для подальшого використання.

[TIP]
====
Скористайтеся готовою формою для безпосереднього ознайомлення із деталями:

* [*] link:{attachmentsdir}/bp-modeling/save-digital-doc-remote-url/file-saved-from-ext-system-view.json[_file-saved-from-ext-system-view.json_]

Скопіюйте вміст _.json_-файлу та вставте на вкладці [.underline]#Код# у розділі [.underline]#UI-форми# Кабінету адміністратора регламентів.
====

. Створіть UI-форму для бізнес-процесу.
. У [.underline]#Конструкторі# налаштуйте компонент *`Text Field`* для виводу назви файлу.

. Далі налаштуйте компонент `*File*` для отримання даних (цифрового документа) зі сховища CEPH.
+
image:registry-develop:bp-modeling/bp/save-digital-doc-remote-url/dig-doc-remote-url-6.png[]
+
Перейдіть на вкладку *`API`* та у полі `Property Name` вкажіть ключ для пошуку запису в об'єктному сховищі. Наприклад, `image`.
+
[NOTE]
====
Параметр не є жорстко закодованим. Ви можете використовувати будь-які ключі, передбачені логікою вашого бізнес-процесу.
====
+
image:registry-develop:bp-modeling/bp/save-digital-doc-remote-url/dig-doc-remote-url-7.png[]
+
Результат, що повертається на UI-форму, може виглядати так:
+
.Цифровий документ, отриманий із CEPH по ключу `image`
====
image:registry-develop:bp-modeling/bp/save-digital-doc-remote-url/dig-doc-remote-url-8.png[]
====

[#officer-portal-usage]
=== Використання у Кабінеті посадової особи

Розглянемо приклад, як виглядатиме користувацька UI-форма із виведеним цифровим документом, отриманим з об'єктного сховища.

. Увійдіть до Кабінету посадової особи.
. Запустіть змодельований бізнес-процес.
+
image:registry-develop:bp-modeling/bp/save-digital-doc-remote-url/dig-doc-remote-url-9.png[]

. Завантажте отриманий файл на локальну машину для подальшого використання.
+
image:registry-develop:bp-modeling/bp/save-digital-doc-remote-url/dig-doc-remote-url-10.png[]

== Пов'язані сторінки

* xref:admin:registry-management/control-plane-digital-documents.adoc[]
* xref:bp-modeling/forms/components/file/component-file-multiple-values.adoc[]

== Додаткові відеоматеріали

video::WT8rHKH8S4I[youtube, width=680, height=380]