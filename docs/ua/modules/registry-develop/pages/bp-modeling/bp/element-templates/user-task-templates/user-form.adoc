= Налаштування форми користувача: _User form_
include::platform:ROOT:partial$templates/document-attributes/default-set-ua.adoc[]

Цей документ пояснює, як налаштувати взаємодію з UI-формою користувача на рівні моделі бізнес-процесу.

== Загальна інформація

Інтеграційне розширення *User form* дозволяє налаштовувати форми користувачів у рамках бізнес-процесів, додаючи різні властивості до завдання користувача (User Task).

.Короткі відомості про делегат
|===
|Назва |Пояснення

|Бізнес-назва інтеграційного розширення
|*User form*

|Службова назва інтеграційного розширення
|`${formUserTaskTemplate}`

|Назва файлу в бібліотеці розширень
|_userTaskTemplate.json_
|===

== Перед початком

include::partial$admonitions/install-element-templates.adoc[]

== Налаштування

Делегат *User form* призначений для використання у завданнях користувача (User Task) бізнес-процесу. Він дозволяє налаштувати форми користувача з різними параметрами.

NOTE: Розширення використовується для визначення задачі, що _НЕ_ потребує валідації КЕП-підписом надавача або отримувача послуг.

=== Налаштування завдання користувача

. Створіть завдання типу *User Task* у вашому бізнес-процесі.
. Назвіть завдання, наприклад, `Форма користувача`.
. Застосуйте шаблон делегата, обравши *User form* зі списку в налаштуваннях завдання.

+
image:bp-modeling/bp/element-temp/user-task/user-form/user-form-1.png[]

=== Налаштування делегата

Form key ::
У полі *Form key* вкажіть службову назву UI-форми. Це поле обов'язкове і має бути заповненим. Воно чітко пов'язує UI-форму і користувацьку задачу бізнес-процесу.

Assignee ::
У полі *Assignee* вкажіть виконавця завдання. Зробити це можна кількома способами:

* Наприклад, ви можете *призначити задачу ініціатору бізнес-процесу*, вказавши `${initiator}`.
+
IMPORTANT: Для використання `${initiator}` у задачах користувача (як звичайних, так і таких, що потребують валідації підписом КЕП), у стартовій події бізнес-процесу необхідно визначити ініціатора процесу зі значенням `initiator`.

* Також ви можете *призначити виконавця попереднього завдання користувача*. Для цього ви можете використати JUEL-функцію `completer()`, передавши ID попередньої задачі та використавши метод `userName`. Наприклад:
+
[source,groovy]
----
${completer('previous user task ID').userName}
----
+
** `completer()` — назва JUEL-функції.
** `'previous user task ID'` — ID попередньої задачі користувача.
** `userName` — метод, який передає ідентифікатор користувача з Keycloak.

* *Вкажіть значення ідентифікатора користувача напряму (константа)*, щоб призначити задачу одному чітко визначеному користувачу. Наприклад, `userID`.
+
NOTE: Ідентифікатором користувача є параметр *preferred_user_name*, встановлений у Keycloak.

+
CAUTION: Якщо визначено *Assignee*, то поля *Candidate users* та *Candidate roles* потрібно залишати порожніми (_див. нижче_). Якщо *Assignee* не вказано, то потрібно обов'язково вказати або список користувачів, або список ролей, яким буде доступна до виконання поточна задача. Інакше задача не буде відображатися у доступних до виконання в рамках вашого бізнес-процесу.

Candidate users ::
У полі *Candidate users* вкажіть *список користувачів*, які можуть виконувати завдання. Ви можете вказати список користувачів через кому, для яких задача буде доступною до виконання. У рамках бізнес-процесу кожен користувач зможе призначити цю задачу собі та виконати, навіть якщо він не має доступу до всього бізнес-процесу. Вказати список користувачів можна двома шляхами:

* *(_Рекомендовано_). Передайте список користувачів як рядок через змінну*.
+
Для цього попередньо використайте делегат xref:bp-modeling/bp/element-templates/service-task-templates/users/search-registry-users-by-attributes.adoc[], за допомогою якого ви зможете отримати список користувачів у вигляді комплексного об'єкта. Не всі поля із цього об'єкта потрібні для визначення *Candidate users*. Тому результат, який повернеться в делегат, потрібно спочатку зберегти, наприклад, у змінну `usersResponse`, потім перетворити скриптом список в рядок із username, визначених через кому. Потім результат виконання скрипту потрібно записати в нову змінну як рядок, наприклад, `usersList`, і передати її в полі *Candidate users*. Наприклад, `${usersList}`.

* *(_Альтернативно_). Передайте список користувачів як константу*, тобто вкажіть username одного або більше користувачів з Keycloak через кому. Наприклад:
+
[source,text]
----
username1,username2,username3
----

Candidate roles ::
У полі *Candidate roles* вкажіть ролі, для яких доступне виконання завдання. Введіть *список ролей*, через кому, для яких задача буде доступною до виконання. У рамках бізнес-процесу кожен користувач, хто має визначену роль, зможе цю задачу призначити собі та виконати, навіть якщо у нього немає доступу до самого бізнес-процесу. Вказати список ролей можна двома шляхами:

* *Передайте список ролей як рядок через змінну*. Для цього використовуйте один із доступних делегатів:

** xref:bp-modeling/bp/element-templates/service-task-templates/user-roles/get-keycloak-roles-by-realm.adoc[] +
** xref:bp-modeling/bp/element-templates/service-task-templates/user-roles/get-keycloak-roles-from-user.adoc[]
+
За допомогою одного з цих делегатів ви зможете отримати список усіх ролей певного користувача або список усіх ролей з певного Keycloak-реалму. Список повертається у наступному форматі:
+
.Приклад відповіді зі списком ролей у форматі JSON
[source,json]
----
[
  "user",
  "admin",
  "hierarchy-registry-manager",
  "personnel-officer-admin",
  "reviewer"
]
----
+
Не всі ролі зі списку можуть бути потрібними для визначення *Candidate roles*. Тому результат, який повернеться в делегаті, потрібно спочатку зберегти, наприклад, у змінну `roles`, потім скриптом отримати список лише тих ролей, які потрібні для виконання завдання. Потім результат виконання скрипту потрібно записати в нову змінну як рядок, наприклад, `availableRoles`, і передати її в полі *Candidate roles*. Наприклад, `${availableRoles}`.

* *Передайте список ролей як константу*, тобто вкажіть одну або більше ролей з Keycloak через кому. Наприклад:
+
[source,text]
----
user,admin,manager
----
+
TIP: Наприклад, бізнес-процес з умовною назвою *bp1* зможе ініціювати лише користувач з роллю `officer-bp1`, але задачу у цьому процесі, яка доступна ролям `user,admin,manager`, зможуть виконати лише користувачі, які мають одну з вказаних ролей в Keycloak, бо така роль визначена у переліку *Candidate roles*.

Form data pre-population ::

. Поле *Form data pre-population* забезпечує автоматичне заповнення форми даними, які були введені на одній з попередніх користувацьких задач. Вказати значення для цього поля можна двома способами:

* *Передайте дані як змінну*. Для цього потрібно спочатку взяти дані на одній з попередніх форм за допомогою скрипту. Результат виконання скрипту можна записати як об'єкт, наприклад, у змінну `formData`. Потім ви можете передати сформований об'єкт як змінну `${formData}` у поле *Form data pre-population*.

* *Передайте дані за допомогою функції `submission()`*. Це можна зробити за допомогою виразу:
+
[source,groovy]
----
${submission('Previous user task ID').formData}
----
+
** `submission()` — назва JUEL-функції.
** `'Previous user task ID'` — ID будь-якої попередньої задачі користувача, змодельованої у бізнес-процесі, і яка містить подібний набір полів — ідентична або майже ідентична.
** `formData` — метод, який дозволяє отримати дані на UI-формі у бізнес-процес й передати їх на іншу форму.
+
Це забезпечує зв'язок між діями виконавця попередньої задачі та цією задачею.

Form variables ::
 *Form variables* (*змінні форми*) у бізнес-процесах та UI-формах використовуються для зберігання та передачі даних між різними етапами процесу та інтерфейсом користувача. Вони забезпечують взаємодію між користувачем і бізнес-логікою, а також між різними частинами бізнес-процесу. Найбільш прикладним випадком використання form variables є заповнення UI-форми даними, які вже є у системі, що полегшує роботу користувача. Наприклад, якщо користувач заповнює форму розподілення певних задач бізнес-процесу для певних ролей зі списку доступних у системі, form variables можуть використовуватись для автоматичного заповнення відповідних полів із випадного списку ролей.
+
Налаштування змінних форми відбувається безпосередньо на UI-формі паралельно з моделюванням бізнес-процесу. Це може виглядати, наприклад, так:
+
. Відкрийте налаштування форми, перейдіть на вкладку *Data* та налаштуйте наступні параметри:
.. У полі *Data source type* введіть `Custom`.
.. У полі *Custom Values* вкажіть `values = formVariables.officerUsers`.
+
image:study-project/task-5/task-5-forms-8.png[]

. У полі *Form variables* бізнес-процесу вкажіть змінну `officerUsers`, яка буде передана на форму.
+
TIP: Більш детально про змінні форм ви можете дізнатися у розділі xref:registry-develop:study-project/study-tasks/task-5-bp-modeling-multiple-participants.adoc#form-variables[Моделювання форм за допомогою formVariables].

== Приклад

Ось приклад, який показує, як відповідний делегат використовується у бізнес-процесі:

.Приклад. Налаштування делегата User form
image::best-practices/bp-officer-simultaneous-tasks/bp-officer-simultaneous-tasks-6.png[]

[TIP]
====
[%collapsible]
.Де можна знайти приклад бізнес-процесу?
=====
include::partial$snippets/demo-reg-reference-examples-ua.adoc[]

*User form* -- делегат, який використовується майже в усіх бізнес-процесах, адже потребує виконання дій зі сторони людини в рамках завдань користувача. Тому приклади використання можна знайти практично в усіх бізнес-процесах у вашому демо-регламенті.

Ви можете використати один із багатьох прикладів процесів за пошуком по ключовим словам -- *_reference-parallel-tasks-officers-diff-rls_*.

У Кабінеті користувача бізнес-процес буде доступний у розділі *Доступні послуги*.
=====
====

== Пов'язані сторінки

* xref:best-practices/bp-officers-simultaneous-tasks.adoc[]
* xref:bp-modeling/bp/element-templates/user-task-templates/officer-sign-task.adoc[]
* xref:bp-modeling/bp/element-templates/user-task-templates/citizen-sign-task.adoc[]








