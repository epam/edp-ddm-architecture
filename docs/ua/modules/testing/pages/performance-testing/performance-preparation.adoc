= Поточний стан тестування навантаження системи
include::platform:ROOT:partial$templates/document-attributes/default-set-ua.adoc[]

include::platform:ROOT:partial$admonitions/language-ua.adoc[]

== Опис поточного тестування навантаження

=== Поточні сценарії

Як регламент для тестування навантаження на даний використовується certified-laboratories-registry-regulation.

Поточні тести покривають наступні сценарії:

[options="header"]
|===

| Сценарій | Сервіси які задієються

| Створення простої сутності
| registry-rest-api, registry-kafka-api, bpms, digital-signature-ops, user-task-management, form-schema-provider, form-submission-validation

| Оновлення простої сутності
| registry-rest-api, registry-kafka-api, bpms, digital-signature-ops, user-task-management, form-schema-provider, form-submission-validation

| Читання простої сутності
| registry-rest-api, bpms, digital-signature-ops, user-task-management, form-schema-provider, form-submission-validation

| Критерій з пошуком за типом starts-with
| registry-rest-api

| Критерій з пошуком за типом contains
| registry-rest-api

| Критерій з пошуком за типом equals
| registry-rest-api

| Отримання історії виконання БП
| process-history-service, bpms

| Авторизація
| Keyckoak

| Логаут
| Keycloak


|===

=== Технологічний стек

[options="header"]
|===

| Назва утиліти | Опис

| Apache JMeter
| Утиліта для написання сценаріїв тестів навантаження та їх запуску

| Carrier
| UI агрегатор репортів з перформанс тестів


|===

=== Конвенція написання степів

Для більш зручного написання степів і подальшого їх аналізу виведена наступна конвенція

[options="header"]
|===
| Логічна група | Патерн URL | Патерн кроку |  Приклад назви кроку

| Критерії пошуку
| ${external-rest-api-route}/api/gateway/data-factory/${sc-name}
| ${ext-system\|public-api\|trembita\|portal}-sc-${get\|post}-${sc-name}
| ext-system-sc-get-koatuu-obl-equals-name

| Критерії пошуку
| ${public-rest-api-route}/api/public/data-factory/${sc-name}
| ${ext-system\|public-api\|trembita\|portal}-sc-${get\|post}-${sc-name}
| public-api-sc-get-koatuu-obl-equals-name

| Критерії пошуку
| ${registry-soap-api-route}/ws
| ${ext-system\|public-api\|trembita\|portal}-sc-${get\|post}-${sc-name}
| trembita-sc-get-koatuu-obl-equals-name

| Критерії пошуку
| ${registry-rest-api-route}/${sc-name}
| ${ext-system\|public-api\|trembita\|portal}-sc-${get\|post}-${sc-name}
| portal-sc-get-koatuu-obl-equals-name

| Процес
| ${external-rest-api-route}/business-process/api/${start\|start-form}
| ${ext-system\|trembita\|portal}-bp-${bpKey}-${start\|start-form}
| ext-system-bp-get-lab-start

| Процес
| ${bp-webservice-gateway-route}/ws
| ${ext-system\|trembita\|portal}-bp-${bpKey}-${start\|start-form}
| trembita-bp-get-lab-start

| Процес
| ${user-process-management-route}/${start\|start-form}
| ${ext-system\|trembita\|portal}-bp-${bpKey}-${start\|start-form}
| portal-bp-get-lab-start-form

| Процеси
| ${user-process-management-route}/process-definitions
| portal-${method}-${action}
| portal-get-process-definitions

| Процеси
| ${user-process-management-route}/process-definitions/count
| portal-${method}-${action}
| portal-get-process-definitions-count


| Процеси
| ${user-process-management-route}/history/process-instances
| portal-${method}-${action}
| portal-get-history-process-instances

| Процеси
| ${user-process-management-route}/history/process-instances/count
| portal-${method}-${action}
| portal-get-history-process-instances-count

| Процеси
| ${user-process-management-route}/runtime/process-instances
| portal-${method}-${action}
| portal-get-runtime-process-instances

| Процеси
| ${user-process-management-route}/runtime/process-instances/count
| portal-${method}-${action}
| portal-get-runtime-process-instances-count

| Задача
| ${user-task-management-route}/${process-instance-id}/${task-name}/complete
| portal-${bpName}-${taskName}-${complete\|get-task\|sign-form}
| portal-create-lab-fill-laboratory-data-complete

| Задача
| ${user-task-management-route}/${process-instance-id}/${task-name}/task
| portal-${bpName}-${taskName}-${complete\|get-task\|sign-form}
| portal-create-lab-fill-laboratory-data-get-task

| Задача
| ${user-task-management-route}/${process-instance-id}/${task-name}/sign-form
| portal-${bpName}-${taskName}-${complete\|get-task\|sign-form}
| portal-create-lab-fill-laboratory-data-sign-form

| Задачі
| ${user-task-management-route}/task
| portal-${method}-${tasks\|tasks-count}
| portal-get-tasks

| Задачі
| ${user-task-management-route}/task/count
| portal-${method}-${tasks\|tasks-count}
| portal-get-tasks-count

| Задачі
| ${user-task-management-route}/history/task
| portal-${method}-${tasks\|tasks-count}
| portal-get-history-tasks

| Задачі
| ${user-task-management-route}/history/task/count
| portal-${method}-${tasks\|tasks-count}
| portal-get-history-tasks-count

| Форма
| ${form-schema-provider}/${form-name}/form-by-key
| portal-${method}-${action}
| portal-get-form-by-key

|===

== Підготовка оточення проведення тестування навантаження

=== Підготовка реєстру

==== Налаштування файлу запуску

Для виконання прекондішнів по підготовці до запуску тестів навантаження необхідно підготувати файл, дана конфігурація виконає наступні кроки:

** Створення реєстру за заданою назвою
** Розгортання обраного регламенту
** Додавання доступу для зовнішніх систем
** Налаштування EDR
** Налаштування піблічного доступу до заданого ендпоінту

.Файл підготовки оточення __registry.json__
(xref:arch:attachment$/architecture/performance-testing/registry.json[Завантажити])
[%collapsible, json]
====
----
include::arch:attachment$/architecture/performance-testing/registry.json[json]
----
====

Необхідно налаштувати параметри до котрих додані коментарі

[options="header"]
|===
| Назва секції | Опис
| name
| Назва реєстру. Необхідно вказати назву бажаного реєстру

| isGeoServer
| Присутність геосерверу. True - присутній, False - не присутній


| accessToExternalSystems
| Назва доступу до зовнішньої системи


| publicApiSettings
| Необхідно вказати назву публічного доступу, ендпоіну, ліміту на годину


| template
| Тип реєстру. Productuion - оточення продакшн типу, Development - оточення для розробки


| repository
| Назва регламенту. Доступні регламенти:

* certified-laboratories-registry-regulation
* consent-data

| branch
| Гілка регламенту для разгортання

| regulationDeployOnly
| Тип запуску тестів попереднього розгортання. True - запуск лише розгортання регламенту, False - повний флоу
|===

==== Запуск прекондішн тестів
Для виконнання прекондішн тестів необхідно перейти до Jenkins -> Clusters -> <cluster name> -> <cluster name>-run-installer-validation-tests

* Запуск пайплайну з параметрами

image::arch:attachment$/architecture/performance-testing/run-pipeline.png[align="center", 500, 500]

* Обрати виключно параметр RUN_REGISTRY_TESTS

image::arch:attachment$/architecture/performance-testing/test-params.png[align="center", 500, 500]

* Вказати tag з Gerrit до відповідного очікуваного регламенту

image::arch:attachment$/architecture/performance-testing/set-build.png[align="center", 500, 500]

* Передати підготовлений файл як input param до пайплайну на кроку control-plane-tests

image::arch:attachment$/architecture/performance-testing/file-uplpad.png[align="center", 500, 500]

==== Підготовка оточення до проведення тестування навантаження

Для подальшого налаштування реєстру необхідно виконати наступні дії:

* Створення конфіг мапи в опеншифті для тестових користувачів

Конфіг мапа створюється у namespace реєстру який був створений за назвою sign-widget-mock-users

.Файл контенту секрету __sign-widget-mock-users__
(xref:arch:attachment$/architecture/performance-testing/sign-widget-mock-users.yml[Завантажити])
[%collapsible, json]
====
----
include::arch:attachment$/architecture/performance-testing/sign-widget-mock-users.yml[yml]
----
====

* Додати у Control Plane Gerrit, в репозиторії реєстру, файл values.yml наступну змінну

*caIsolation: true*

* Встановити аутентифікацію через браузер у опеншифті

** Необхідно перейти до Пошуку та занайти сутність Keycloak Realms для  реєстру та обрати officer-portal

image::arch:attachment$/architecture/performance-testing/keycloak-realm-path.png[align="center", 500, 500]

** Встановити для browser-flow у ресурсі browser

image::arch:attachment$/architecture/performance-testing/keycloak-flow.png[align="center", 500, 500]

== Запуск тестування навантаження

Для запуску тестування навантаження необхідно виконати наступні кроки:

* Перейти до Carrier та обрати вкладику Baackend, натиснути кнопку ран навпроти officer-processes

image::arch:attachment$/architecture/performance-testing/carrier-perf-start.png[align="center", 500, 500]

* У параметрах задати неймспейс рееєстру та натиснути кнопку start

image::arch:attachment$/architecture/performance-testing/carrier-perf-params.png[align="center", 500, 500]
