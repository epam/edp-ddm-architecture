= Підтвердження каналу зв`язку з користувачем

== Загальний контекст

Для забезпечення вимог відправлення повідомлень користувачам про стан виконання замовлених послуг, на базі платформи реалізована підтримка концепції каналів зв'язку з можливістю їх налаштування на рівні профілю користувача (внесення адреси, активація / деактивація каналу зв'язку).

TIP: З детальною інформацією щодо управління налаштуваннями можна ознайомитись у розділі xref:architecture/registry/operational/user-settings/user-channel-settings.adoc[Управління каналами зв'язку користувача].

Внесення змін до адреси каналу зв'язку та його активація потребують проходження процедури підтвердження через використання автоматично згенерованого _OTP_-коду (_One-Time-Password_), який відправляється користувачу за вказаним каналом та використовується для перевірки внесених даних.

Даний механізм застосовується для підтвердження наступних каналів зв'язку:

- _email_ - Відправлення поштових повідомлень
- _diia_ - Відправлення _push_-котифікацій у мобільний застосунок _Дія_

== Технічний дизайн рішення

image:architecture/registry/operational/user-settings/contact-verification.png[]

=== Компоненти системи та їх призначення

У даному розділі наведено перелік компонент системи, які задіяні або потребують змін/створення в рамках реалізації функціональних вимог згідно дизайну рішення.

|===
|Компонент|Службова назва|Призначення

|_Кабінет громадянина_
|*citizen-portal*
|Внесення змін до адреси та активація каналу зв'язку.

Ініціювання процедури верифікації каналу зв'язку з відправленням OTP-коду для підтвердження

|_Сервіс повідомлень користувачів_
|*notification-service*
|Відправлення службових повідомлення з _OTP_-кодом користувачу за вказаним каналом зв'язку

|_Сервіс управління налаштуваннями користувачів_
|*user-settings-service*
|Генерація, збереження та відправлення _OTP_-коду через _Сервіс повідомлень користувачів_.

Верифікація співпадіння попередньо згенерованого та наданого користувачем OTP-кодів.

Застосування змін до налаштуваню каналів зв'язку користувача
|_Розподілене in-memory сховище даних_
|*redis*
|Тимчасове зберігання згенерованих _OTP_-кодів з _TTL_
|===

=== Налаштування політик міжсервісної взаємодії

В рамках реалізації вимог, необхідно додати відповідні мережеві політики _NetworkPolicy_, які дозволяють взаємодію для наступних компонентів:

- *user-settings-service* -> *redis*
- *user-settings-service* -> *kafka*

=== Взаємодія компонентів системи

На даній діаграмі послідовності схематично зображено алгоритм підтвердження каналу зв'язку при його зміні / активації.

[plantuml, channel-confirmation-flow, svg]
----
include::partial$architecture/registry/operational/user-settings/channel-confirmation-flow.puml[]
----

. Користувач в налаштуваннях профілю вводить контактні дані (імейл, номер телефону, або інші контакти).
. Портал особи проводить валідацію введених даних на відповідність встановленому формату та в разі успішного проходження здійснює виклик Сервісу Налаштувань для збереження контактних даних.
. Сервісом налаштувань ініціює процес верифікації нового каналу звʼязку. Для цього генерується криптографічно безпечний 6-ти значний псевдовипадковий код підтвердження та зберігається в тимчасове сховище Redis. Ключем запису виступає композиція ідентифікатора користувача та ідентифікатора каналу звʼязку.  При цьому для запису встановлюється час життя (TTL) рівний n секунд де n задається в xref:architecture/registry/operational/user-settings/user-contact-confirmation.adoc#_загальні_налаштування_сервісу[загальних налаштуваннях].
. Після збереження подія з код підтвердження та ідентифікатором каналу звязку публікується в Kafka topic (4.а.) звідки потрапляє до Сервісу Відправки Повідомлень (4.b.).
. Сервіс Відправки Повідомлень формує повідомлення з кодом згідно шаблону та направляє його до відповідного Шлюзу Відправки Повідомлень в залежності від обраного каналу звєязку.
. Шлюз відправки повідомлень надсилає повідомлення з кодом користувачу.
. Користувач, отримавши код підтвердження, вводить його на сторінці налаштувань профіля.
. Портал особи проводить валідацію введених даних на відповідність встановленому формату (6-ти значне число) та в разі успішного проходження здійснює виклик Сервісу Налаштувань для підтвердження контактних даних.
. Сервіс Налаштувань Користувача, отримавши код підтвердження, вичитує з Тимчасового Сховища Даних збережений на кроці №3 код підтвердження згідно ключа та видаляє його в сховищі.
. Отримавши раніше збережений ключ сервіс звіряє його з отриманим від користувача.
.. В разі співпадіння контактні дані зберігаються в профілі користувача як перевірені.
.. В разі неспівпадіння кодів, користувачу відображається помилка та пропонується повторно внести OTP-код у разі, якщо він не був інвалідований системою або повторно його згенерувати.

=== Зберігання згенерованих OTP-кодів

Для збереження автоматично згенерованих _OTP_-кодів використовується розподілене _in-memory_ сховище _Redis_, дані в якому зберігаються у вигляді _Hash_-структури з сегрегацією об'єктів на рівні _Keyspaces_-префіксів (_<keyspace>:<key>_) та з встановленим TTL для записів згідно xref:architecture/registry/operational/user-settings/user-contact-confirmation.adoc#_загальні_налаштування_сервісу[загальних налаштувань].

Для об'єктів _OTP_-кодів використовується префікс:

- *channel-verification-codes*

.Приклад паттерну генерації ключа для запису:
[source]
----
channel-verification-codes:{userId}/{channel}
----

.Структура даних об'єктів у "_channel-verification-codes_" keyspace
[source, json]
----
{
  "address": "...",
  "verificationCode": "..."
}
----

=== Відправлення повідомлень зі згенерованими OTP-кодами

Для відправлення повідомлення з OTP-кодом через _Сервіс повідомлень користувачів_ необхідно опублікувати запит у відповідний _Kafka_-топік "_user-notifications_" та явно вказати необхідність ігнорування стану активності для каналу зв'язку за допомогою службового поля "*ignoreChannelPreferences*".

.Канонічний вигляд структури повідомлення
[source,json]
----
{
 "context": {
  "system": "Low-code Platform",
  "application": "user-settings-service"
 },
 "notification": {
  "templateName": "channel-confirmation",
  "ignoreChannelPreferences": true
 },
 "recipients": [
   {
      "id": "{userId}",
      "channels": [
        {
          "channel": "email",
          "email": "{email}"
        }
      ],
      "parameters": [
        {
            "key": "verificationCode",
            "value": "{verificationCode}"
        }
      ]
   }
 ]
}
----

TIP: З детальною інформацією щодо інтеграції з _Сервісом повідомлень користувачів_ можна ознайомитись у розділі xref:architecture/registry/operational/notifications/notifications-integration.adoc#_інтеграція_механізмів_відправлення_повідомлень_для_службового_використання_сервісами_реєстру[Інтеграція механізмів відправлення повідомлень для службового використання сервісами реєстру].

== Налаштування системних шаблонів формування повідомлень з OTP-кодом

[CAUTION]
Необхідно підтвердити / сформувати контент шаблонів для відправлення повідомлень.

В рамках реалізації рішення, необхідно розширити базовий репозиторій регламенту _empty-regulation-template_, який використовується для створення нових реєстрів, додатковими шаблонами повідомлень під служовою назвою *channel-confirmation*.

.Структура репозиторію регламенту з системними шаблонами
[plantuml, channel-confirmation-template-structure, svg]
----
include::partial$architecture/registry/operational/user-settings/channel-confirmation-template-structure.puml[]
----

=== Шаблон поштового повідомлення зі згенерованим _OTP_-кодом

.Приклад файлу мета-даних _notification.yml_
[source, yaml]
----
title: "Підтвердження електронної пошти"
----

.Приклад шаблону _notification.ftlh_:
[source, html]
----
<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="center">
        Код підтвердження: ${verificationCode}
    </div>
</body>
</html>
----

=== Шаблон push-повідомлення у мобільний додаток Дія зі згенерованим _OTP_-кодом

.Приклад файлу мета-даних _notification.yml_
[source, yaml]
----
title: "Підтвердження каналу зв'язку реєстру"
attributes:
  actionType: "message"
  templateType: "attention"
  shortText : "Підтвердження каналу зв'язку реєстру"
----

.Приклад шаблону _notification.diia_:
[source, text]
----
Код підтвердження: ${verificationCode}
----

== Розширення API _Сервісу управління налаштуваннями_

TIP: З детальною інформацією щодо дизайну сервісу можна ознайомитись у розділі xref:architecture/registry/operational/user-settings/user-channel-settings.adoc[Управління каналами зв'язку користувача].

[WARNING]
Отримання доступу до API можливе лише в рамках виконання запиту автентифікованого користувача в системі

=== Верифікація вказаного каналу зв'язку через генерацію OTP

[NOTE]
Данний API-роут є публічним та має бути опублікованим для зовнішнього доступу через окремий _Kong Route_ для _Кабінету Громадянина_.

_POST /api/settings/me/channels/{channel}/verify_

|===
|Параметр|Тип|Частина запиту|Опис

|*X-Access-Token*
|JWT
|HTTP заголовок
|Токен доступу користувача

|*channel*
|Текстовий
|Параметр запиту
|Назва каналу [email, diia]
|===

.Приклад тіла запиту
[source, json]
----
{
    "address": "<email>"
}
----

.Приклад відповіді
[source, json]
----
{
    "verificationCodeExpirationSec": "60"
}
----

.Коди помилок
|===
|Код|Опис

a|[green]#202#
|Accepted з поверненням інформації про період дії OTP-коду
a|[red]#400#
|Некоректно сформований запит
a|[yellow]#401#
|Помилка автентифікації (відсутній токен доступу)
a|[red]#500#
|Серверна помилка обробки запиту
|===

=== Активація вказаного каналу зв'язку з підтвердженням через OTP

[NOTE]
Данний API-роут є публічним та має бути опублікованим для зовнішнього доступу через окремий _Kong Route_ для _Кабінету Громадянина_.

[IMPORTANT]
Наразі кількість спроб на внесення OTP-коду для активації каналу не обмежено на час дії OTP-коду. В майбутньому розглянути необхідність можливості налаштуванням кількості спроб на рівні регламенту реєстру.

_POST /api/settings/me/channels/{channel}/activate_

|===
|Параметр|Тип|Частина запиту|Опис

|*X-Access-Token*
|JWT
|HTTP заголовок
|Токен доступу користувача

|*channel*
|Текстовий
|Параметр запиту
|Назва каналу [email, diia]
|===

.Приклад тіла запиту
[source, json]
----
{
    "address": "<email>",
    "verificationCode": "<otp-code>"
}
----

.Коди помилок
|===
|Код|Опис

a|[green]#200#
|OK - OTP верифікацію пройдено успішно
a|[red]#400#
|Некоректно сформований запит
a|[yellow]#401#
|Помилка автентифікації (відсутній токен доступу)
a|[yellow]#403#
|Наданий OTP-код не відповідає адресі для активації
a|[red]#500#
|Серверна помилка обробки запиту
|===

== Загальні налаштування сервісу

Сервіс надає можливість налаштування xref:https://redis.io/commands/expire/[TTL] для записів зі згенерованими OTP-кодами, які зберігаються у сховищі _Redis_.

.Канонічний приклад налаштувань
[source, yaml]
----
verification.otp.time-to-live: 60
----

== Оновлення версії існуючих реєстрів

Для існуючих реєстрів, у процесі оновлення версії необхідно створити системні шаблони повідомлень, які використовуються для відправки OTP-кодів згідно правил, описаних у розділі xref:architecture/registry/operational/user-settings/user-contact-confirmation.adoc#_налаштування_системних_шаблонів_формування_повідомлень_з_otp_кодом[Налаштування системних шаблонів повідомлень для формування повідомлень з OTP-кодом].

