= Декларативний підхід до налаштування емуляторів зовнішніх систем для спрощення тестування зовнішніх інтеграцій реєстру

== Загальний опис

Існує проблема, що поточне рішення для мокування виконується за допомогою SoapUI та сервіси моку інтеграційних точок поставляється разом з платформою. Це призводить до того що не можливо швидко додати новий мок інтеграційної точки або змінити вже існуючий без надання апдейту платформи.

Для вирішення цієї проблеми необхідно замістити поточний підхід для створення моків на реалізацію нової унифікованої стратегії яка дає можливість конфігурувати власні моки для інтеграційниї точок в режимі реального часу без постачання нової версії платформи.

== Актори та ролі користувачів

* Розробник реєстрів
* Розробник платформи

== Глосарій

- WM - WireMock
- WMS - WireMock Studio
- Mocks - заглушки точки інтеграції
- Control Plane Console - консоль адміністратора платформи

== Поточна робота мокування інтеграційних точок

image::architecture-workspace/platform-evolution/mocking/current-mocking-solution.drawio.svg[]

На даній діаграмі можна побачити, що для оновлення/додавання моку треба:

* Розробник платформи створює мок у SOAP UI
* Розробник платформи додає зміну у інсталлер
* Розробник реєстру може використовувати загальний мок після оновлення платформи

Також варто зазначити, що мок знаходиться на рівні платформи, а не реєстру, тобто він загальній на усі реєстри які є на кластері.

Недоліки поточного рішення:

* Моки постачаються разом з платформою що унеможливлює зміни розробником регламенту
* Немає можливості швидко інтегруватися з новою зовнішньою системою адміністратору реєстру без допомоги розробника платформи
* Немає можливості персонизувати мок інтеграційної точки для реєстру


== Технічний дизайн рішення

=== Інтеграційні сценарії
|===
|Назва системи|Рівень|Протокол|Вид інтеграції

|*diia*
|Реєстр
|REST
|Зовнішня інтеграція

|*trembita*
|Реєстр
|SOAP
|Зовнішня інтеграція


|*<Інші зовнішні системи>*
|Реєстр
|REST/SOAP
|Зовнішня інтеграція

|===

На даній діаграмі зображено залучені для реалізації вимог сервіси та взаємодію між ними. Додатково зображено важливі особливості, які необхідно брати до уваги в рамках реалізації.

image::architecture-workspace/platform-evolution/mocking/rework-mock-solution.drawio.svg[align="center"]

Для мокування інтеграційних точок пропонується використовувати WM та WMS. За даним підходом можливо мокуватия як REST так і SOAP API.

.Налаштування інтеграції реєстру з моком зовнішної точки інтеграції
[plantuml,enable-mocking-flow, svg]
----
include::partial$architecture-workspace/platform-evolution/mocking/enable-mocking-for-registry.puml[enable-mocking-flow, align="center"]
----

.Додавання власного моку для використання у реєстрі
[plantuml,import-user-mocking-flow, svg]
----
include::partial$architecture-workspace/platform-evolution/mocking/import-user-mock.puml[import-user-mocking-flow, align="center"]
----

=== Порядок дій для розгортання власного моку інтеграційної точки

* Адміністратор платформи додає зовнішню інтеграцію для dev реєстру з <<trembita-link, Трембіта>> або <<external-system, іншою зовнішньою системою>>

* У герріті Control Plane Console оновився файл конфігурації для інтеграції з зовнішньою системою

.control-plane-gerrit:<registry>.git/deployment-templates/values.yaml
[source,yaml]
----
trembita:
#SOAP external systems integration
  registries:
    edr-registry:
      #Link on registry wiremock
      url: "http://registry-wiremock/"
      ...
    dracs-registry:
      #Link on registry wiremock
      url: "http://registry-wiremock/"
      ...
    idp-exchange-service-registry:
      #Link on registry wiremock
      url: "http://registry-wiremock/"
      ...
external-systems:
#REST external systems integration
  diia:
    #Link on registry wiremock
    url: "http://registry-wiremock/"
    ...
  http-bin:
    #Link on registry wiremock
    url: "http://registry-wiremock/"
    ...
  secured-service:
    #Link on registry wiremock
    url: "http://registry-wiremock/"
    ...
----
[IMPORTANT]
Посилання змінюється лише для обраної системи на реєстровий WM

* Додавання до реєстрового герріту, в проект registry-regulations власного мапінгу в папці mock-integration

Для збереження мапінгів у реєстровому репозиторії необхідно слідувати структурі

[plantuml, format=svg, align="center"]
----
skinparam Legend {
	BackgroundColor transparent
	BorderColor transparent
}
legend
registry-regulatuins
|_ mock-integration
  |_ ${external_system_name}.json
  |_ ${external_system_name}-${request_name}-response.json
  |_ ....
end legend
----

=== Приклад файлів мапінгів та обробки респонсу
WM підтримує як SOAP так і REST запити тому нижче наведено приклад обробки обох типів запитів

** Файл з мапінгами для EDR моку __edr.json__ (xref:attachment$architecture-workspace/platform-evolution/mocking/edr.json[Завантажити])

.Показати файл
[%collapsible, json]
====
[source, json]
----
    {
        "mappings": [
            {
                "request": {
                    "urlPath": "/mockEdr",
                    "method": "POST"
                },
                "response": {
                    "status": 200,
                    "bodyFilePath": "mock-integration/edr-response.xml",
                    "headers": {
                        "Content-Type": "text/xml"
                    },
                    "transformers": [
                        "response-template",
                        "body-transformer"
                    ]
                }
            }
        ]
    }
----
====


** Файл відповіді __mock-integration/edr-response.xml__ (xref:attachment$architecture-workspace/platform-evolution/mocking/edr-response.xml[Завантажити])


.Показати файл
[%collapsible, xml]
====
[source, xml]
----
<soap11env:Envelope
	xmlns:soap11env="http://schemas.xmlsoap.org/soap/envelope/"
	xmlns:tns="http://nais.gov.ua/api/sevdeir/EDR"
	xmlns:xroad="http://x-road.eu/xsd/xroad.xsd"
	xmlns:id="http://x-road.eu/xsd/identifiers">
	<soap11env:Header>
		<tns:AuthorizationToken>token</tns:AuthorizationToken>
		<xroad:userId>MDTUDDM</xroad:userId>
		<xroad:client id:objectType="SUBSYSTEM">
			<id:xRoadInstance>SEVDEIR-TEST</id:xRoadInstance>
			<id:memberClass>GOV</id:memberClass>
			<id:memberCode>43395033</id:memberCode>
			<id:subsystemCode>IDGOV_TEST_01</id:subsystemCode>
		</xroad:client>
		<xroad:service id:objectType="SERVICE">
			<id:xRoadInstance>SEVDEIR-TEST</id:xRoadInstance>
			<id:memberClass>GOV</id:memberClass>
			<id:memberCode>00015622</id:memberCode>
			<id:subsystemCode>2_MJU_EDR_prod</id:subsystemCode>
			<id:serviceCode>SearchSubjects</id:serviceCode>
		</xroad:service>
		<xroad:protocolVersion>4.0</xroad:protocolVersion>
		<xroad:id>MDTUDDM</xroad:id>
		<xroad:requestHash algorithmId="http://www.w3.org/2001/04/xmldsig-more#gost34311">YzS4MYmFiW8tkoncbQL624RllowfcK8B8FGNTWZ5QFE=</xroad:requestHash>
	</soap11env:Header>
	<soap11env:Body>
		<tns:SearchSubjectsResponse>
			<tns:SubjectList>
                        <!--Темплейтинг мапінгу-->
                        {{#each (soapXPath request.body '/SearchSubjects/code/text()') as |thing|}}
                        {{#if (contains thing '101')}}
                                <tns:state>1</tns:state>
                                <tns:state_text>зареєстровано</tns:state_text>
                                <tns:name>Сидоренко Василь Леонідович</tns:name>
                                <tns:url>http://zqedr-api.nais.gov.ua/1.0/subjects/3</tns:url>
                                <tns:code>{{thing}}</tns:code>
                                <tns:id>3</tns:id>
                        {{else if (contains thing '123213123')}}
                                <tns:state>1</tns:state>
                                <tns:state_text>зареєстровано</tns:state_text>
                                <tns:name>Петренко Петро Петрович</tns:name>
                                <tns:url>http://zqedr-api.nais.gov.ua/1.0/subjects/3</tns:url>
                                <tns:code>{{thing}}</tns:code>
                                <tns:id>3</tns:id>
                        {{/if}}
                        {{/each}}
				<tns:SubjectInfo>
				</tns:SubjectInfo>
			</tns:SubjectList>
		</tns:SearchSubjectsResponse>
	</soap11env:Body>
</soap11env:Envelope>
----
====


** Файл мапінгу __diia.json__ (xref:attachment$architecture-workspace/platform-evolution/mocking/diia.json[Завантажити])

.Показати файл
[%collapsible, json]
====
[source, json]
----
    {
        "mappings": [
            {
                "request": {
                    "urlPath": "/api/partner-token/post-info",
                    "method": "POST",
                    "headers": {
                            "Accept": {
                                "contains": ".*"
                                }
                            },
                    "bodyPatterns": [{
                           "matchesJsonPath": "$.info"
                    }]
                },
                "response": {
                    "status": 200,
                    "bodyFilePath": "mock-integration/dia-post_info-response.json",
                    "headers": {
                        "Content-Type": "text/xml"
                    },
                    "transformers": [
                        "response-template",
                        "body-transformer"
                    ]
                }
            }
        ]
    }
----
====

** Файл відповіді __mock-integration/dia-post_info-response.json__ (xref:attachment$architecture-workspace/platform-evolution/mocking/dia-post_info-response.json[Завантажити])

.Показати файл
[%collapsible, json]
====
[source, json]
----
{
  "info": "string"
}
----
====

[IMPORTANT]
Користувач після додавання моку зможе піти за адресою http:registry-wiremock/mockEdr щоб отримати замокану відповідь

[TIP]
https://wiremock.org/docs/stubbing/[Посилання на документацію за якою треба створювати власні мапінги]

* Під час виконання пайплайну registry-regulations-management при наявності мапінгів виконується запит
[source, bash]
----
curl -v -d @mapping.json http://registry-wiremock:8080/__admin/mappings/import
----
[IMPORTANT]
Мапінги можуть зберігатись у декількох файлах, тому треба імпортувати за допомогою API усі файли з мапінгами

== Приклад створення власного моку WMS

Мапінг для імпорту можна створити у WMS, для цього треба:

* Перейти до WMS та натиснути Mock API кнопку

image::architecture-workspace/platform-evolution/mocking/mock-api.png[align="center", 500, 500]

* Обрати пустий шаблон та заповнити назву

image::architecture-workspace/platform-evolution/mocking/create-new-mock.png[align="center", 500, 500]

* Перейти до вкладки Stubs

image::architecture-workspace/platform-evolution/mocking/stubs.png[align="center", 500, 500]

* Натиснути кнопку New

image::architecture-workspace/platform-evolution/mocking/new-stub.png[align="center", 500, 500]

* Заповнити налаштування мапінгу та зберегти його

image::architecture-workspace/platform-evolution/mocking/save-stub.png[align="center", 500, 500]

* Експортувати файл для завантаження його у реєстровий герріт

image::architecture-workspace/platform-evolution/mocking/export-mock.png[align="center", 500, 500]

== Управління конфігурацїєю мокування

.[#trembita-link]#Налаштування взаємодії реєстру через Тримбіту для dev реєстру#
image::architecture-workspace/platform-evolution/mocking/mock_trembita.png[registry-integrations-management, 200, align="center"]

.Налаштування взаємодії з моком інтеграційних точок Трембіта для dev реєстру
image::architecture-workspace/platform-evolution/mocking/enable_mock_trembita.png[registry-integrations-management, 200, align="center"]

.[#external-system]#Налаштування взаємодії реєстру з зовнішньою системою#
image::architecture-workspace/platform-evolution/mocking/mock_rest_system.png[registry-integrations-management, 200, align="center"]

.Налаштування взаємодії реєстру з моком інтеграційних точок зовнішніх систем
image::architecture-workspace/platform-evolution/mocking/enable_mock_rest_system.png[registry-integrations-management, 200, align="center"]


== Високорівневий план розробки

=== Технічні експертизи

* _DevOps_
* _Dev_

=== План розробки

* Деплой WM та WMS під час розгортання тільки dev реєстрів
* Оновлення Control Plane Console під нову функціональність
* Додавання стейджу у registry-regulations пайплайну для імпорту мапінгів
* Створення конг роуту на WMS
* Розробка інструкцій користувачів