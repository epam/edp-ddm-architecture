= Оновлення OpenShift до 4.12

[NOTE]
--
Сторінка технічної документації у процесі розробки...
--

Ця сторінка документації описує процес підготовки до оновлення та сам процесс оновлення кластерів продакшн та
розробницьких до версії OKD 4.12. Основна https://access.redhat.com/articles/6955381[стаття] від RedHat

== План оновлення
NOTE: Для кожного кластер є нижче окремий розділ зі special steps if any

1. Виконати та внести всі зміни в компоненти платформи вказані в таблиці 1.
Зміни повинні бути backward compatible з 4.11 версією.
2. Перевірити на чистому кластері 4.12 збірку інсталлера платформи після внесених змін.
3. Встановити версію в пайплайні розгортання кластерів в `4.12.0-0.okd-2023-03-05-022504`
4. Оновити Stage RPZM Gigacloud.
5. Оновити кластер Envone та реєстри.
6. Оновити кластер CICD2
7. Оновити Reestr1
8. Production RPZM Gigacloud
9. Підготувати інструкції по оновленню для інших Міністерств

[IMPORTANT]
====
Оновлення до останньої версії 4.11 не рекомендується через наявність https://github.com/okd-project/okd/issues/1505[дефекту] у роботі з Ceph, який критично впливає на
роботу Платформи та сповільнює роботу підсистеми розподіленого зберігання файлів. Вирішений тільки з версії
`4.12.0-0.okd-2023-03-05-022504`
====

== Обовʼязкові зміни для компонентів реєстрів та Платформи перед початком оновлення до 4.12

.Обовʼязкові зміни в компонентах
|===
|#|API|Компонент\Репозиторій|Ресурс|Суть змін

|1
|`machine.openshift.io/v1beta1`
|control-plane-gerrit, storage, logging
|registry-machine-set
|1. Оновити AMI воркерів до Fedora 37 (ami-094fe1584439e91dd)

2. Оновити версію API awsproviderconfig.openshift.io/v1beta1 -> machine.openshift.io/v1beta1

|2
|`operators.coreos.com/v1alpha1`
|storage
|values.yaml
|Додати версію ocs-operator для 4.12

|3
|`noobaa.io/v1alpha1`
|storage, control-plane-gerrit
|Noobaa BucketClass/BackingStore
|Видалити весь компонент noobaa

|4
|`install.istio.io/v1alpha1`
|service-mesh
|Istio Operator
|Оновити istio до версії 1.17.2.

|5
|`autoscaling/v2beta2`
`policy/v1beta1`
|keycloak
|hpa, pod security policy
|1. Оновити `autoscaling/v2beta2` до `autoscaling/v2`

https://kubernetes.io/docs/tasks/configure-pod-container/migrate-from-psp/[2. Мігрувати на pod security admission]

|6
|`batch/v1beta1`
|backup-management
|CronJob
|Migrate from `batch/v1beta1` to `batch/v1`

|7
|-
|Усюди, де використовується в docker images
|-
|Оновити `oc` та `kubectl` до відповідної okd 4.12 / 1.25 kubernetes

|8
|`operator.openshift.io/v1`
|service-mesh / ip-restrictions
|Service, IngressController
|Мігрувати з `service.beta.kubernetes.io/load-balancer-source-ranges` анотації на специфікацію CR IngressController. Приклад:

`endpointPublishingStrategy:
loadBalancer:
allowedSourceRanges:

- 174.128.55.224/29

- 174.128.60.0/24`

Також перенести всю конфігурацію по обмеженню доступу з `service-mesh` репозиторію до `ip-restrictions`
|===

== Проблеми з версією 4.11 на 4.12

|===
|Проблема|Чи наявна в 4.12

|https://github.com/okd-project/okd/issues/1310[Kubelet CPU]
|

|https://jiraeu.epam.com/browse/MDTUDDM-20159[OLM Оператор]
|

|https://jiraeu.epam.com/browse/MDTUDDM-20817[Noobaa]
|

|https://jiraeu.epam.com/browse/MDTUDDM-20021[Kong]
|

|https://jiraeu.epam.com/browse/MDTUDDM-19943[Gigacloud network performance issues]
|

|===


== Спеціальні кроки для оновлення кластерів
[IMPORTANT]
====
Перед оновленням обовʼязково зробити бекап etcd та бекап Платформи з реєстрами
====
