== Генерація витягів з кабінету користувача

Для забезпечення вимог надання інформаційних послуг на базі платформи, реалізована підтримка двох підходів до моделювання бізнес-процесів в залежності від способу відображення даних через кабінет користувача:

- Бізнес-процес, результатом якого є відображення даних через UI-форму кабінету
- Бізнес-процес, результатом якого є зформований витяг, доступний для завантаження з кабінету та офлайн перегляду

Данний технічний дизайн зфокусований на вимогах підтримки інформаційних послуг, результатом яких є генерація витягу з реєстру на рівні Low-code платформи.

[NOTE]
TODO: Додати посилання на технічний дизайн підсистеми звітності.

=== Базові принципи
- Витяги можуть бути згенеровані тільки в рамках надання інформаційних послуг через бізнес-процеси
- Доступ до інформаційної послуги генерації витягу контролюється на рівні БП та на рівні доступу до даних, які необхідно завантажити для формування витягу
- Витяг має бути представлений окремим шаблоном на рівні регламенту реєстру та однозначно   ідентифікується _типом витягу_
- В рамках одного бізнес-процесу може бути згенерований тільки один витяг з урахуванням прав доступу користувача, який ініціював БП до даних
- Запит на формування витягу до "Підсистеми звітності" має бути підписаним ключем користувача або системним ключем
- Згенеровані витяги можуть бути завантажені лише користувачем, який замовив інформаційну послугу
- Згенеровані витяги мають бути доступні для завантаження у визначений проміжок часу у початковому вигляді згідно прав доступу до даних на момент генерації
- На згенеровані витяги може бути накладено системний цифровий підпис в залежності від типу інформаційної послуги та даних, на базі яких формується витяг
- Необхідність накладання системного цифрового підпису на витяг визначається адміністратором регламенту на рівні моделювання бізнес-процесу
- Процес генерації витягу не має блокувати роботу користувача з кабінетом
- Користувач кабінету має можливість отримати інформацію про статус генерації витягу на сторінці "Послуги у виконанні" та завантажити документ витягу зі сторінки "Замовлені послуги" у разі його готовності
- Підготовка даних для формування запиту на генерацію витягу моделюється на рівні БП за допомогою допоміжних Search Conditions функціональності платформи.
- Рекомендовано мінімізувати об'єм даних, який завантажується на рівні БП для формування запиту на генерацію витягу

=== Низькорівневий дизайн взаємодії

На даній діаграмі зображено задіяні для реалізації вимог сервіси платформи, взаємодію між ними у розрізі напрямків та типів потоків даних. Додатково зображено важливі особливості, які необхідно прийняти до уваги в рамках реалізації та моделювання.

image::lowcode/excerpt-generation.svg[]

=== Замовлення інформаційної послуги формування витягу
Інформаційна послуга формування витягу має бути змодельована у вигляді окремого бізнес-процесу з використанням наступних інструментів та можливостей моделювання:

- <<Логічна модель бізнес-процесу формування витягу, Синхронний або асинхронний підхід до генерації витягу в рамках бізнес-процесу>>
- <<Логічна модель бізнес-процесу формування витягу, Використання Call Activity елементу BPMN нотації для енкапсуляції логіки взаємодії з "API генерації витягів">>
- <<Конфігурація типового розширення генерації витягів, Типове розширення для формування запиту на генерацію витягу>>
- <<Конфігурація типового розширення для отримання інформації про статус генерації витягів, Типове розширення для отримання інформації про статус генерації витягу>>
- <<Конфігурація типового розширення отримання токена доступу системного користувача, Типове розширення отримання токена доступу системного користувача>>
- Системні змінні екземпляру бізнес-процесу, які використовуються для відображення результату формування витягу та встановлення асоціації між екземпляром бізнес-процесу та згенерованим документом

[plantuml]
----
include::partial$lowcode/excerpt-generation.puml[]
----

=== Логічна модель бізнес-процесу формування витягу

На даній діаграмі зображено логічну модель бізнес-процесу формування запиту на генерацію витягу. Підтримується два підходи до організації UX з боку користувача:

- _Синхронний підхід до моделювання бізнес-процесу генерації витягів_ (*sync*), при якому користувач після ініціювання через кабінет має дочекатися завершення процесу генерації після чого система автоматично перенаправять його на сторінку "Замовлені послуги", на якій є можливість завантажити витяг, згенерований в рамках початкового бізнес-процесу. Цей підхід пришвидшує користувачу доступ до завантаження, але, в той же час, може бути використаний для витягів, час генерації яких не погіршує UX у розрізі часу очікування

- _Асинхронний підхід до моделювання бізнес-процесу генерації витягів_ (*beforeAsync*), при якому користувач після ініціювання запиту на формування витягу перенаправляється на сторінку "Послуг у виконанні", де він може відслідковувати стан генерації витягу або продовжувати роботу з кабінетом. У цьому разі, користувачу потрібно буде самостійно перейти на сторінку "Замовлені послуги" по завершенню бізнес-процесу генерації витягу

image::lowcode/excerpt-generation-bpmn.png[]

=== Задіяні системні змінні бізнес-процесу
З ціллю підтримки асоціації між ініційованим єкземпляром бізнес-процесу та згенерованим документом витягу, використовуються змінні процесу, які зберігаються в історичну таблицю операційного сховища бізнес-процесів.
|===
|Назва системної змінної|Опис

|SYS_VAR_PROCESS_EXCERPT_ID
|Змінна використовується для збереження ідентифікатору витягу, у разі, якщо витяг є результатом надання послуги / виконання бізнес-процесу

|SYS_VAR_PROCESS_COMPLETION_RESULT
|Опис результату виконання, який вказується адміністратором регламенту при моделюванні бізнес-процесу

|===

=== Отримання згенерованих витягів через кабінет
Результатом бізнес-процесу надання інформаційної послуги є згенерований документ, який збережено у розподіленому об'єктному сховищу Ceph. Додатково, ідентифікатор документу витягу буде збережено у вигляді змінної екземпляру бізнес-процесу _SYS_VAR_PROCESS_EXCERPT_ID_. Наявність цієї змінної і є ознакою інформаційної послуги, результатом якої є витяг на відміну від інших. Для замовлених послуг з цією ознакою стає доступна окрема опція "Завантажити витяг" у кабінеті користувача, яка дозволяє завантажити цілоьвий документ через "API отримання витягів".

[NOTE]
За надання доступу до завантаження згенерованих документів за унікальним ідентифікатором та контроль доступу відповідає окремий бекенд-сервіс "API отримання витягів".

[NOTE]
TODO: Додати посилання на опис контракту API "Підсистеми звітності"

[plantuml]
----
include::partial$lowcode/excerpt-retrieval.puml[]
----

=== Авторизація доступу користувачів до згенерованих витягів
Доступ до згенерованого витягу повинен мати лише користувач, який ініціював замовлення інформаційної послуги формування витягу через бізнес-процес згідно правам доступу, налаштованим на рівні регламенту.

=== Конфігурація типового розширення генерації витягів
З ціллю надання можливостей моделювання інформаційних послуг, результатом яких є згенерований документ витягу, використовується окреме типове розширення _Java Delegate_ у каталозі моделювання, за допомогою якого можно визначити всі необхідні параметри запиту на генерацію.

Додатково, до виклику автоматично додаються системні змінні контексту виклику у якості заголовків:

- _X-Source-System_
- _X-Source-Application_
- _X-Source-Business-Process_
- _X-Source-Business-Activity_

[NOTE]
Параметри, які є частиною payload запиту, потрібні бути підписані, а підпис, у свою чергу, має бути переданий у вигляді заголовку.

[NOTE]
TODO: Додати посилання на опис контракту API "Підсистеми звітності"

|===
|Конфігураційний параметр|Вхідний/Вихідний|Службова назва|Тип|Опис

|Токен доступу
|in
|X-Access-Token [header]
|string
|Токен користувача, під яким виконується запит на генерацію витягу

|Тип звіту
|in
|excerptType [payload]
|string
|Тип витягу, який необхідно згенерувати в рамках бізнес-процесу

|Накладання системного підпису
|in
|requiresSystemSignature [payload]
|boolean
|Необхідність накладання системного підпису для заданого типу звіту

|Вхідні дані для генерації
|in
|excerptInputData [payload]
|map
|Набір данних, які необхідно передати у якості параметрів для генерації витягу

|Ідентифікатор витягу
|out
|excerptIdentifier
|string
|Унікальний ідентифікатор витягу, за яким можно отримати доступ на завантаження згенерованого документу
|===

=== Конфігурація типового розширення для отримання інформації про статус генерації витягів
З ціллю надання можливостей моніторингу статусу виконання запиту на генерацію витягу, використовується окреме типове розширення _Java Delegate_ у каталозі моделювання, за допомогою якого можно визначити всі необхідні параметри запиту та отримати актуальний статус формування документу.

Додатково, до виклику автоматично додаються системні змінні контексту виклику у якості заголовків:

- _X-Source-System_
- _X-Source-Application_
- _X-Source-Business-Process_
- _X-Source-Business-Activity_

[NOTE]
TODO: Додати посилання на опис контракту API "Підсистеми звітності"

|===
|Конфігураційний параметр|Вхідний/Вихідний|Службова назва|Тип|Опис

|Токен доступу
|in
|X-Access-Token [header]
|string
|Токен користувача, під яким виконується запит на генерацію витягу

|Ідентифікатор витягу
|in
|excerptIdentifier
|string
|Унікальний ідентифікатор документу витягу, за яким можно отримати інформацію про статус генерації

|Статус генерації витягу
|out
|excerptGenerationStatus
|string
|Статус генерації документу витягу (IN_PROGRESS, COMPLETED, FAILED)
|===

=== Конфігурація типового розширення отримання токена доступу системного користувача
У ряді випадків існує необхідність взаємодії бізнес-процесу з внутрішніми сервісами платформи на рівні service-2-service, а контекст виклику не обов'язково потребує токен доступу користувача, який ініціював бізнес-процес або є виконавцем задач. У цьому разі платформа надає типове розширення для отримання токена доступу від імені системного користувача (сервіс-акаунта) з Keycloak, який дозволяє виконувати внутрішні системні запити / проходити авторизацію.

|===
|Конфігураційний параметр|Вхідний/Вихідний|Службова назва|Тип|Опис

|Токен доступу
|out
|systemUserAccessToken
|string
|Токен системного користувача (сервіс-акаунта, створеного для _bpms_ сервісу)
|===