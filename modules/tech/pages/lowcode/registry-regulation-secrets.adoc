= Управління налаштуваннями та секретами зовнішніх інтеграцій

== Контекст

=== Інформаційний обмін з зовнішніми системами

Перелік зовнішніх систем, з якими реалізована взаємодія в рамках бізнес-сценаріїв:

- Публічні сервіси "_Дія_" (з детальною інформацією можна ознайомитись у розділі xref:lowcode/notifications/diia-notifications-api.adoc[])

Перелік реєстрів, з якими реалізовано інформаційний обмін (з детальною інформацією можна ознайомитись у розділі xref:registry-develop:registry-admin/external-integration/api-call/trembita/overview.adoc[]):

- Єдиний державний реєстр (ЄДР)
- Державний реєстр актів цивільного стану (ДРАЦС)
- Єдина інформаційна база даних внутрішньо переміщених осіб (ЄІБДВПО)

=== Інтеграційни сценарії

|===
|Назва компоненту|Рівень|Зовнішня система/Реєстр|Конфігурація|Спосіб інтеграції|Сценарій

|*dso-citizen-authenticator*
|Платформа
|ЄДР
|Конфігурація інтеграцій та секретів в регламенті реєстру
|Вбудований
|Аутентифікація представників бізнесу у _Кабінеті Громадянина_ (перевірка наявності активованого запису в реєстрі)

|*notification-service*
|Реєстр
|Дія
|Конфігурація інтеграції та секрету через інтерфейс _control-plane_
|Вбудований
|Відправлення інформаційних push-повідомлень громадянам

.3+|*bpms*
.3+|Реєстр
|ЄДР

ДРАЦС

ЄІБДВПО
|Конфігурація інтеграцій та секретів в регламенті реєстру
|Типові інтеграційні _SOAP_-конектори
|Інформаційний обмін з реєстрами через Трембіту в рамках виконання бізнес-процесів

|Дія
|Конфігурація інтеграцій в регламенті та _ручне_ створення секрету
|Універсальний інтеграційний _REST_-конектор
|Інформаційний обмін в рамках виконання бізнес-процесів

|<Зовнішня система>
|Конфігурація інтеграцій в регламенті та _ручне_ створення секретів
|Універсальний інтеграційний _REST_-конектор
|Інформаційний обмін через в рамках виконання бізнес-процесів
|===

== Поточний технічний дизайн

=== Контейнерна діаграма

image::lowcode/registry-ext-systems-secrets-baseline.svg[registry-ext-systems-secrets-baseline,700]

=== Налаштування аутентифікатора громадян

В рамках аутентифікації громадян, система отримує дані користувача з ЄДР. Конфігурація інтеграції та секрет зберігаються на рівні регламенту та застосовуються _Пайплайном публікації регламенту_ для налаштування _dso-citizen-authenticator_ реєстру:

image::lowcode/dso-citizen-authenticator.png[dso-citizen-authenticator, 300]

=== Налаштування зовнішніх інтеграцій на рівні регламенту

Наразі інтеграції з реєстрами через Трембіту реалізовані за допомогою типових інтеграційних _SOAP_-конекторів.

TIP: Детальніше можна ознайомитись у розділі xref:registry-develop:bp-modeling/external-integration/api-call/connectors-external-registry.adoc[]

Для _REST_-інтеграцій з зовнішніми системами реалізовано _Універсальний REST-конектор_, який підтримує наступні способи авторизації:

- _BASIC_ (username + password)
- _PARTNER_TOKEN_ (partner_token + Bearer token)

TIP: Детальніше можна ознайомитись у розділі xref:registry-develop:bp-modeling/bp/rest-connector.adoc[]

.bp-trembita/configuration.yml
[source, yaml]
----
trembita-exchange-gateway:
  registries:
    edr-registry:
      user-id: 'DDM'
      protocol-version: '4.0'
      trembita-url: 'trembita.url/mockEDRService'
      authorization-token: 'token'
      client:
        x-road-instance: 'SEVDEIR-TEST'
        member-class: 'GOV'
        member-code: '43395033'
        subsystem-code: 'IDGOV_TEST_01'
      service:
        x-road-instance: 'SEVDEIR-TEST'
        member-class: 'GOV'
        member-code: '00015622'
        subsystem-code: '2_MJU_EDR_prod'
external-systems:
  diia:
    url: http://api2.diia.gov.ua
    methods:
      get-damaged-property:
        path: /api/v1/public-service/damaged-property/filtered
        method: GET
    auth:
      type: PARTNER_TOKEN
      secret-name: diia-partner-token
      partner-token-auth-url: https://api2t.diia.gov.ua/api/v1/auth/partner
      token-json-path: $.token
  httpbin:
    url: http://httpbin.org/
    methods:
      get:
        path: /get
        method: GET
    auth:
      type: BASIC
      secret-name: httpbin-basic-authentication
----

=== Недоліки поточної реалізації

* Визначення налаштувань інтеграцій, які залежать від оточення, на рівні регламенту, що унеможливлює промоцію регламенту між екземплярами реєстру (адреси та секрети зовнішніх систем, тощо.)
* Визначення секретів для доступу до зовнішніх систем на рівні регламенту
* Необхідність виконання ротації секретів адміністратором регламенту
* Необхідність ручного створення _OpenShift_-секретів зовнішніх систем адміністратором реєстру
* Необхідність ручного налаштування мережевих політик (створення _Istio Service Entry_ для зовнішніх систем)
* Дублювання налаштувань клієнта _Трембіти_ для реєстру на рівні регламенту

== Цільовий технічний дизайн

[NOTE]
Цільове рішення у процесі формування

=== Загальні принципи

- Регламент реєстру не має містити налаштувань, які залежать від "оточення" / екземпляра реєстру
- Регламент реєстру не має містити конфіденційних даних ні в якій формі
- Налаштування параметрів зовнішніх інтеграцій не мають дублюватись та використовуються централізовано
- Додання зовнішніх систем для інтеграції з реєстром не потребує ручних дій налаштування мережевих політик
- Секрети з параметрами доступу до зовнішніх систем зберігаються в захищеному сховищу сервісу управління секретами _HashiCorp Vault_
- Адміністратор реєстру та Адміністратор безпеки визначають правомірність взаємодії реєстру з зовнішніми системами
- Адміністратор реєстру налаштовує інтеграції з зовнішніми системами (протокол інтеграції, адреса, протокол аутентифікації, секрети, тощо.) на рівні екземпляра реєстру
- Адміністратор реєстру відповідає за ротацію секретів з параметрами доступу до зовнішніх систем
- Адміністратор регламенту виконує мінімальний об'єм попередньої конфігурації на рівні регламенту для використання зовнішніх інтеграцій в бізнес-процесах
- Між-реєстрова інтеграція через Трембіту реалізується у вигляді каталогу типових розширень-конекторів до реєстрів та не потребує додаткової конфігурації на рівні регламенту
- Інтеграція з 3rd-party системами потребує додаткової конфігурації на рівні регламенту у вигляді переліку операцій та їх типів, які використовує реєстр через типове розширення БП _Універсальний REST-конектор_

=== Контейнерна діаграма

image::lowcode/registry-ext-systems-secrets.svg[registry-ext-systems-secrets,700]

=== Налаштування зовнішніх інтеграцій реєстру через _Центр управління платформою_

.control-plane-gerrit:<registry>.git/deployment-templates/values.yaml
[source,yaml]
----
trembita:
  consumer:
    user-id: "DDM"
    protocol-version: "4.0"
    client:
      x-road-instance: "SEVDEIR-TEST"
      member-class: "GOV"
      member-code: "43395033"
      subsystem-code: "IDGOV_TEST_01"
# External registries used through Trembita / business processes specific integration connectors - can be updated & can't be removed by "control-plane" administrator
  registries:
    - name: "edr-registry"
      url: "https://trembita.mdtu-ddm.projects.epam.com"
      protocol: "SOAP"
      service:
        x-road-instance: "SEVDEIR-TEST"
        member-class: "GOV"
        member-code: "00015622"
        subsystem-code: "2_MJU_EDR_prod"
        auth:
          secret: "vault:secret/<registry>/registry/<trembita-registry-name>"
      auth:
        type: "AUTH_TOKEN"
    - name: "dracs-registry"
      url: "https://trembita.mdtu-ddm.projects.epam.com"
      protocol: "SOAP"
      service:
        x-road-instance: "SEVDEIR-TEST"
        member-class: "GOV"
        member-code: "00015622"
        subsystem-code: "2_MJU_EDR_prod"
    idp-exchange-service-registry:
      url: "https://trembita.mdtu-ddm.projects.epam.com"
      protocol: "SOAP"
      service:
        x-road-instance: "SEVDEIR-TEST"
        member-class: "GOV"
        member-code: "00015622"
        subsystem-code: "2_MJU_EDR_prod"
external-systems:
# External system used both by registry services and business processes - can be updated & can't be removed by "control-plane" administrator
  - name: "diia"
    url: "https://api2t.diia.gov.ua"
    protocol: "REST"
    auth:
      type: "AUTH_TOKEN+BEARER"
      auth-uri: "/api/v1/auth/partner"
      access-token-json-path: "$.token"
      secret: "vault:secret/<registry>/external-system/<ext-system-name>"
# Example external systems added for particular registry and explicitly "used" on regulation level - can be added/updated/removed if necessary by "control-plane" administrator
  - name: "http-bin"
    url: "http://httpbin.org/"
    protocol: "REST"
    auth:
      type: "BASIC"
      secret: "vault:secret/<registry>/external-system/<ext-system-name>"
  - name: "secured-service"
    url: "http://secured-service.org/"
    protocol: "REST"
    auth:
      type: "BEARER"
      secret: "vault:secret/<registry>/external-system/<ext-system-name>"
----

[NOTE]
--
Для кожного запису налаштувань інтеграції з зовнішніми системами, має бути автоматично створений ресурс _Istio Service Entry_ для надання дозволу взаємодії згідно дизайну.
--

=== Налаштування зовнішніх інтеграцій на рівні регламенту

.bp-trembita/configuration.yml
[source, yaml]
----
# reusing external system names configured on registry level
external-systems:
  - name: "diia"
    operations:
      - name: "get-damaged-property"
        resource-path: "/api/v1/public-service/damaged-property/filtered"
        method: "GET"
      - name: "create-distribution"
        resource-path: "/api/v1/notification/distribution/push"
        method: "POST"
  - name: "http-bin"
    operations:
      - name: "get-operation"
        resource-path: "/get"
        method: "GET"
----

=== Створення ресурсів при публікації змін регламенту

.ConfigMap: "external-systems-endpoint-configuration"
[source,yaml]
----
kind: ConfigMap
apiVersion: v1
metadata:
  name: external-systems-endpoint-configuration
  namespace: <registry-namespace>
data:
  external-systems:
    - name: "diia"
      operations:
        get-damaged-property:
          resource-path: "/api/v1/public-service/damaged-property/filtered"
          method: "GET"
        create-distribution:
          resource-path: "/api/v1/notification/distribution/push"
          method: "POST"
    - name: "http-bin"
      operations:
        get-operation:
          resource-path: "/get"
          method: "GET"
----

=== Створення ресурсів при застосуванні змін до налаштувань реєстру

.ConfigMap: "registry-trembita-client"
[source,yaml]
----
kind: ConfigMap
apiVersion: v1
metadata:
  name: registry-trembita-client
  namespace: <registry-namespace>
data:
  trembita:
    consumer:
      user-id: "DDM"
      protocol-version: "4.0"
      client:
        x-road-instance: "SEVDEIR-TEST"
        member-class: "GOV"
        member-code: "43395033"
        subsystem-code: "IDGOV_TEST_01"
----

.ConfigMap: "trembita-registries-configuration"
[source,yaml]
----
kind: ConfigMap
apiVersion: v1
metadata:
  name: trembita-registries-configuration
  namespace: <registry-namespace>
data:
  trembita:
    registries:
      - name: "edr-registry"
        url: "https://trembita.mdtu-ddm.projects.epam.com"
        protocol: "SOAP"
        service:
          x-road-instance: "SEVDEIR-TEST"
          member-class: "GOV"
          member-code: "00015622"
          subsystem-code: "2_MJU_EDR_prod"
        auth:
          type: "AUTH_TOKEN"
      - name: "dracs-registry"
        url: "https://trembita.mdtu-ddm.projects.epam.com"
        protocol: "SOAP"
        service:
          x-road-instance: "SEVDEIR-TEST"
          member-class: "GOV"
          member-code: "00015622"
          subsystem-code: "2_MJU_EDR_prod"
      - name: "idp-exchange-service-registry"
        url: "https://trembita.mdtu-ddm.projects.epam.com"
        protocol: "SOAP"
        service:
          x-road-instance: "SEVDEIR-TEST"
          member-class: "GOV"
          member-code: "00015622"
          subsystem-code: "2_MJU_EDR_prod"
----

.Secret: "trembita-registries-secrets"
[source,yaml]
----
kind: Secret
apiVersion: v1
metadata:
  name: trembita-registries-secrets
  namespace: <registry-namespace>
data:
  trembita.registries.edr-registry.auth.secret.token: "<token>"
----

.ConfigMap: "external-systems-configuration"
[source,yaml]
----
kind: ConfigMap
apiVersion: v1
metadata:
  name: external-systems-configuration
  namespace: <registry-namespace>
data:
  external-systems:
    - name: "http-bin"
      url: "http://httpbin.org/"
      protocol: "REST"
      auth:
        type: "BASIC"
    - name: "secured-service"
      url: "http://secured-service.org/"
      protocol: "REST"
      auth:
        type: "BEARER"
----

.Secret: "external-systems-secrets"
[source,yaml]
----
kind: Secret
apiVersion: v1
metadata:
  name: external-systems-secrets
  namespace: <registry-namespace>
data:
  external-systems.<external-system-name-1>.auth.secret.username: "<username>"
  external-systems.<external-system-name-1>.auth.secret.password: "<password>"
  external-systems.<external-system-name-2>.auth.secret.token: "<token>"
----

.ConfigMap: "diia-configuration"
[source,yaml]
----
kind: ConfigMap
apiVersion: v1
metadata:
  name: diia-configuration
  namespace: <registry-namespace>
data:
  external-systems:
    diia:
      url: "https://api2t.diia.gov.ua"
      protocol: "REST"
      auth:
        type: "AUTH_TOKEN+BEARER"
        auth-uri: "/api/v1/auth/partner"
        access-token-json-path: "$.token"
----

.Secret: "diia-secret"
[source,yaml]
----
kind: Secret
apiVersion: v1
metadata:
  name: diia-secret
  namespace: <registry-namespace>
data:
  external-systems.diia.auth.secret.token: "<token>"
----

=== Типи підтримуваних протоколів аутентифікації та зберігання секретів у _HashiCorp Vault_

==== Інтеграції з іншими реєстрами через Трембіту:

- _NO_AUTH_
- _AUTH_TOKEN_

."AUTH_TOKEN" Vault Secret: "secret/<registry>/registry><trembita-registry-name>"
[source, json]
----
{
  "token": "<authorization-token>"
}
----

==== Інтеграції з іншими системами:

- _NO_AUTH_
- _AUTH_TOKEN_
- _AUTH_TOKEN+BEARER_
- _BASIC_
- _BEARER_

."BASIC" Vault Secret: secret/<registry/>external-system/<ext-system-name>
[source, json]
----
{
  "username": "<username>",
  "password": "<password>"
}
----

."BEARER" | "AUTH_TOKEN" | "AUTH_TOKEN+BEARER" Vault Secret: secret/<registry>/external-system/<ext-system-name>
[source, json]
----
{
  "token": "<authorization-token>"
}
----

=== Інтерфейси управління зовнішніми інтеграціями реєстру

.Налаштування реєстру у якості клієнта Трембіти
image::lowcode/registry-integrations/control-plane-trembita-client-configuration.png[control-plane-trembita-client-configuration, 300]

.Управління зовнішніми інтеграціями реєстру
image::lowcode/registry-integrations/registry-integrations-management.png[registry-integrations-management, 500]

.Налаштування взаємодії з реєстром через Трембіту
image::lowcode/registry-integrations/trembita-registry-integration-configuration.png[trembita-registry-integration-configuration, 300]

.Налаштування взаємодії з зовнішньою системою
image::lowcode/registry-integrations/external-system-integration-configuration.png[external-system-integration-configuration, 300]