= Управління налаштуваннями та секретами зовнішніх інтеграцій

[NOTE]
Розділ у процесі формування...

== Поточний дизайн

image::lowcode/registry-ext-systems-secrets-baseline.svg[registry-ext-systems-secrets-baseline,700]

=== Недоліки поточної реалізації

* Визначення налаштувань, які залежать від оточення, що унеможливлює промоцію регламенту між екземплярами реєстру (адреси та секрети зовнішніх систем, тощо.)
* Визначення секретів для доступу до зовнішніх систем на рівні регламенту
* Необхідність виконання ротації секретів адміністратором регламенту
* Необхідність ручного створення секретів зовнішніх систем адміністратором реєстру
* Дублювання налаштувань клієнта _Трембіти_ для реєстру на рівні регламенту
* Дублювання конфігурації та секретів до зовнішніх систем, які використовуються в регламенті та реєстровими сервісами:
** _Дія_ - відправлення _push_-нотифікацій користувачам
** _ЄДР_ - аутентифікація користувачів

=== Налаштування аутентифікатора громадян

В рамках аутентифікації громадян, система отримує дані користувача з ЄДР. Конфігурація інтеграції та секрет зберігаються на рівні окремого репозиторію _registry-configuration.git_ та застосовуються _Пайплайном публікації регламенту_ для налаштування _dso-citizen-authenticator_ реєстру:

image::lowcode/dso-citizen-authenticator.png[dso-citizen-authenticator, 300]

=== Налаштування зовнішніх інтеграцій на рівні регламенту

.bp-trembita/configuration.yml
[source, yaml]
----
trembita-exchange-gateway:
  registries:
    edr-registry:
      user-id: 'DDM'
      protocol-version: '4.0'
      trembita-url: 'trembita.url/mockEDRService'
      authorization-token: 'token'
      client:
        x-road-instance: 'SEVDEIR-TEST'
        member-class: 'GOV'
        member-code: '43395033'
        subsystem-code: 'IDGOV_TEST_01'
      service:
        x-road-instance: 'SEVDEIR-TEST'
        member-class: 'GOV'
        member-code: '00015622'
        subsystem-code: '2_MJU_EDR_prod'
external-systems:
  diia:
    url: http://api2.diia.gov.ua
    methods:
      get-damaged-property:
        path: /api/v1/public-service/damaged-property/filtered
        method: GET
    auth:
      type: PARTNER_TOKEN
      secret-name: diia-partner-token
      partner-token-auth-url: https://api2t.diia.gov.ua/api/v1/auth/partner
      token-json-path: $.token
  httpbin:
    url: http://httpbin.org/
    methods:
      get:
        path: /get
        method: GET
    auth:
      type: BASIC
      secret-name: httpbin-basic-authentication
----

== Цільовий дизайн

image::lowcode/registry-ext-systems-secrets.svg[registry-ext-systems-secrets,700]

=== Загальні принципи

- Регламент реєстру не має містити налаштувань, які залежать від "оточення" / екземпляра реєстру
- Регламент реєстру не має містити конфіденційних даних ні в якій формі
- Адміністратор реєстру визначає правомірність та рівень безпеки взаємодії реєстру з зовнішніми системами
- Адміністратор регламенту виконує мінімальний об'єм попередньої конфігурації для використання зовнішніх інтеграцій в бізнес-процесах
- Адміністратор реєстру налаштовує інтеграції з зовнішніми системами (протокол інтеграції, адреса, протокол аутентифікації, секрети, тощо.) на рівні екземпляра реєстру
- Налаштування параметрів зовнішніх інтеграцій не мають дублюватись в реєстрі та використовуються централізовано
- Для кожної 3rd-party системи, яку визначив Адміністратор реєсру, автоматично налаштовуються необхідні мережеві політики
- Секрети з параметрами доступу до зовнішніх систем зберігаються в захищеному сховищу сервісу _HashiCorp Vault_
- Ротація секретів з параметрами доступу до зовнішніх систем контролюється адміністратором реєстру
- Реєстрові сервіси, через які реалізована інтеграція з зовнішніми системами, використовують конфігурацію рівня реєстру та напряму взаємодіють с сервісом _HashiCorp Vault_ для отримання секретів
- Міжреєстрова інтеграція через Трембіту реалізується у вигляді каталогу типових розширень-конекторів до реєстрів та не потребує додаткової конфігурації на рівні регламенту
- Інтеграція з 3rd-party системами потребує додаткової конфігурації на рівні регламенту у вигляді переліку операцій та їх типів, які використовує реєстр через типове розширення БП _Універсальний REST-конектор_

=== Питання

- Спосіб збереження конфігурації зовнішніх систем реєстру (gitops?)

=== Налаштування зовнішніх інтеграцій на рівні регламенту

.bp-trembita/configuration.yml
[source, yaml]
----
# reusing external system keys configured on registry level
external-systems:
  diia:
    operations:
      get-damaged-property:
        resource-path: "/api/v1/public-service/damaged-property/filtered"
        method: "GET"
      create-distribution:
        resource-path: "/api/v1/notification/distribution/push"
        method: "POST"
  http-bin:
    service-name: "HttpBin"
    operations:
      get-operation:
        resource-path: "/get"
        method: "GET"
----

=== Налаштування реєстра у якості клієнта Трембіти через _Центр управління платформою_

.ConfigMap: registry-trembita-client
[source,json]
----
{
  "trembita-consumer": {
    "user-id": "DDM",
    "protocol-version": "4.0",
    "client": {
      "x-road-instance": "SEVDEIR-TEST",
      "member-class": "GOV",
      "member-code": "43395033",
      "subsystem-code": "IDGOV_TEST_01"
    }
  }
}
----

=== Налаштування інтеграцій з зовнішніми системами реєстру через _Центр управління платформою_

==== Інтеграція через Трембіту

Для налаштування нової інтеграції через Трембіту, необхідно додати запис вигляду:

[source,json]
----
{
  "external-systems": {
    "<registry-name>": {
      "url": "<trembita-url>",
      "protocol": "SOAP/Trembita",
      "trembita": {
        "service": {
          "x-road-instance": "",
          "member-class": "",
          "member-code": "",
          "subsystem-code": ""
        }
      },
      "auth": {
        "type": "NO_AUTH|AUTH_TOKEN"
      }
    }
  }
}
----

Автоматично буде створено секрет у _HashiCorp Vault_ в залежності від обраного протоколу аутентифікації:

."AUTH_TOKEN" Vault Secret: secret/external-system/<ext-system-key>
[source, json]
----
{
  "token": ""
}
----

==== Інтеграція з 3rd-party сервісом

Для налаштування нової REST-інтеграції, необхідно додати запис вигляду:

[source,json]
----
{
  "external-systems": {
    "<external-system-key>": {
      "url": "<external-system-url>",
      "protocol": "REST",
      "auth": {
        "type": "NO_AUTH|AUTH_TOKEN|AUTH_TOKEN+BEARER|BASIC|BEARER",
        "auth-uri": "/api/v1/auth/partner", // AUTH_TOKEN+BEARER only
        "access-token-json-path": "$.token" // AUTH_TOKEN+BEARER only
      }
    }
  }
}
----

Автоматично буде створено _Istio Service Entry_ та секрет у HashiCorp Vault в залежності від обраного протоколу аутентифікації :

."BASIC" Vault Secret: secret/external-system/<ext-system-key>
[source, json]
----
{
  "username": "",
  "password": ""
}
----

."BEARER" | "AUTH_TOKEN" | "AUTH_TOKEN+BEARER" Vault Secret: secret/external-system/<ext-system-key>
[source, json]
----
{
  "token": ""
}
----

=== Повний приклад налаштувань зовнішніх інтеграцій реєстру

// for all external systems we are creating ServiceEntries automatically
.Приклад ConfigMap "registry-external-systems"
[source,json]
----
{
  "external-systems": {
    "edr-registry": {
      "url": "https://trembita.mdtu-ddm.projects.epam.com",
      "protocol": "SOAP/Trembita",
      "trembita": {
        "service": {
          "x-road-instance": "SEVDEIR-TEST",
          "member-class": "GOV",
          "member-code": "00015622",
          "subsystem-code": "2_MJU_EDR_prod"
        }
      },
      "auth": {
        "type": "AUTH_TOKEN",
        "secret (stored in Vault: 'secret/external-system/edr-registry')": {
          "token": "<authorization-token>"
        }
      }
    },
    "dracs-registry": {
      "url": "https://trembita.mdtu-ddm.projects.epam.com",
      "protocol": "SOAP/Trembita",
      "trembita": {
        "service": {
          "x-road-instance": "SEVDEIR-TEST",
          "member-class": "GOV",
          "member-code": "22956058",
          "subsystem-code": "TEST_DRAC"
        }
      }
    },
    "diia": {
      "url": "https://api2t.diia.gov.ua",
      "protocol": "REST",
      "auth": {
        "type": "AUTH_TOKEN+BEARER",
        "secret (stored in Vault: 'secret/external-system/diia')": {
          "token": "<authorization-token>"
        },
        "auth-uri": "/api/v1/auth/partner",
        "access-token-json-path": "$.token"
      }
    },
    "http-bin": {
      "url": "http://httpbin.org/",
      "protocol": "REST",
      "auth": {
        "type": "BASIC",
        "secret (stored in Vault: 'secret/external-system/http-bin')": {
          "username": "<username>",
          "password": "<password>"
        }
      }
    },
    "secured-service": {
      "url": "http://secured-service.org/",
      "protocol": "REST",
      "auth": {
        "type": "BEARER",
        "secret (stored in Vault: 'secret/external-system/secured-service')": {
          "token": "<authorization-token>"
        }
      }
    }
  }
}
----