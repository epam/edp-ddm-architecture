= Підтвердження каналу зв`язку з користувачем

== Загальний контекст

Для того щоб отримувати повідомлення на вказаний користувачем у профілі контакт, користувачу необхідно підтвердити, що цей контакт йому належить. Механізм підтвердження є універсальним та однаковим для всіх каналів зв`язку.

image:lowcode/contact-verification.png[]

. Користувач в налаштуваннях профілю вводить контактні дані (імейл, номер телефону, або інші контакти).
. Портал особи проводить валідацію введених даних на відповідність встановленому формату та в разі успішного проходження здійснює виклик Сервісу Налаштувань для збереження контактних даних.
. Сервісом налаштувань ініціює процес верифікації нового каналу звʼязку. Для цього генерується криптографічно безпечний 6-ти значний псевдовипадковий код підтвердження та зберігається в тимчасове сховище Redis. Ключем запису виступає композиція ідентифікатора користувача та ідентифікатора каналу звʼязку.  При цьому для запису встановлюється час життя (TTL) рівний n секунд де n задається в налаштуваннях. 3.1-3.2.
. Після збереження подія з код підтвердження та ідентифікатором каналу звязку публікується в Kafka topic (4.а.) звідки потрапляє до Сервісу Відправки Повідомлень (4.b.).
. Сервіс Відправки Повідомлень формує повідомлення з кодом згідно шаблону та направляє його до відповідного Шлюзу Відправки Повідомлень в залежності від обраного каналу звєязку.
. Шлюз відправки повідомлень надсилає повідомлення з кодом користувачу.
. Користувач, отримавши код підтвердження, вводить його на сторінці налаштувань профіля.
. Портал особи проводить валідацію введених даних на відповідність встановленому формату (6-ти значне число) та в разі успішного проходження здійснює виклик Сервісу Налаштувань для підтвердження контактних даних.
. Сервіс Налаштувань Користувача, отримавши код підтвердження, вичитує з Тимчасового Сховища Даних збережений на кроці №3 код підтвердження згідно ключа та видаляє його в сховищі.
. Отримавши раніше збережений ключ сервіс звіряє його з отриманим від користувача.
.. В разі співпадіння контактні дані зберігаються в профілі користувача як перевірені.
.. В разі неспівпадіння кодів, користувачу відображається помилка та пропонується повторно згенерувати код та повторити кроки 2-9.

== Розширення API _Сервісу управління налаштуваннями_

TIP: З детальною інформацією щодо дизайну сервісу можна ознайомитись у розділі xref:datafactory/settings.adoc[Сервіс управління налаштуваннями користувача].

[WARNING]
Отримання доступу до API можливе лише в рамках виконання запиту автентифікованого користувача в системі

=== Верифікація вказаного каналу зв'язку через генерацію OTP

[NOTE]
Данний API-роут є публічним та має бути опублікованим для зовнішнього доступу через окремий _Kong Route_ для _Кабінету Громадянина_.

_POST /settings/me/channels/{channel}/verify_

|===
|Параметр|Тип|Частина запиту|Опис

|*X-Access-Token*
|JWT
|HTTP заголовок
|Токен доступу користувача

|*channel*
|Текстовий
|Параметр запиту
|Назва каналу [inbox, email, diia]
|===

.Приклад тіла запиту
[source, json]
----
{
    "address": "<email>"
}
----

.Приклад відповіді
[source, json]
----
{
    "verificationCodeExpirationSec": "60"
}
----

.Коди помилок
|===
|Код|Опис

a|[green]#202#
|Accepted з поверненням результату даних зміненого шаблону
a|[red]#400#
|Некоректно сформований запит
a|[yellow]#401#
|Помилка автентифікації (відсутній токен доступу)
a|[red]#500#
|Серверна помилка обробки запиту
|===

=== Активація вказаного каналу зв'язку з підтвердженням через OTP

[NOTE]
Данний API-роут є публічним та має бути опублікованим для зовнішнього доступу через окремий _Kong Route_ для _Кабінету Громадянина_.

_POST /settings/me/channels/{channel}/activate_

|===
|Параметр|Тип|Частина запиту|Опис

|*X-Access-Token*
|JWT
|HTTP заголовок
|Токен доступу користувача

|*channel*
|Текстовий
|Параметр запиту
|Назва каналу [inbox, email, diia]
|===

.Приклад тіла запиту
[source, json]
----
{
    "address": "<email>",
    "verificationCode": "<otp-code>"
}
----

.Коди помилок
|===
|Код|Опис

a|[green]#200#
|OK - OTP верифікацію пройдено успішно
a|[red]#400#
|Некоректно сформований запит
a|[yellow]#401#
|Помилка автентифікації (відсутній токен доступу)
a|[yellow]#403#
|Наданий OTP-код не відповідає адресі для активації
a|[red]#500#
|Серверна помилка обробки запиту
|===