= Аналіз технологій шаблонізації HTML-документів на відповідність ключовим вимогам

== Функціональні сценарії

- Створення HTML-шаблонів для генерації _PDF_-витягів з реєстру
- Створення HTML-шаблонів для генерації поштових повідомлень

== Розглянуті рішення

- https://freemarker.apache.org/[Freemarker]
- https://www.thymeleaf.org/[Thymeleaf]

== Шаблонізація

=== Технології шаблонізації

В рамках аналізу розглядаються підходи з використанням наступних технологій шаблонізації:

- https://freemarker.apache.org/[Freemarker] - технологія шаблонізації, яка дозволяє на базі статичного шаблону (_ftl_ / _ftlh_) зі спеціальними директивами та вхідних даних згенерувати вихідний HTML-документ
- https://www.thymeleaf.org/[Thymeleaf] - технологія шаблонізації, яка дозволяє на базі статичного HTML-шаблону зі спеціальними атрибутами та вхідних даних згенерувати вихідний HTML-документ

=== Опис шаблонів

Файл шаблону описує статичну структуру документу з використанням спеціальних конструкцій для заповнення динамічними даними. Результатом роботи процесора шаблонізації є фінальний HTML-документ заповнений даними.

==== Приклад Freemarker-шаблону

[source, html]
----
<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="center">
        <img src="images/ua.png" class="trinity" alt="UA" />
    </div>
    <#if user == "Joe">
        <p class="header text14">
            ...
        </p>
    </#if>
    <table>
        <tbody>
            <#list animals as animal>
                <tr>
                    <td>${animal.name}</td>
                    <td>${animal.price} Euros</td>
                </tr>
            </#list>
        </tbody>
    </table>
</body>
</html>
----

==== Приклад Thymeleaf-шаблону

[source, html]
----
<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="center">
        <img src="images/ua.png" class="trinity" alt="UA" />
    </div>
    <p class="header text14" th:if="${user} == 'Joe'">
        ...
    </p>
    <table>
        <tbody>
            <tr th:each="animal: ${animals}">
                <td th:text="${animal.name}"></td>
                <td th:text="${animal.price} + ' Euros'"></td>
            </tr>
        </tbody>
    </table>
</body>
</html>
----

=== Підходи до моделювання шаблонів з використанням WYSIWYG та шаблонізатора

- Кастомізація _WYSIWYG_-редактора для коректної підтримки _Freemarker_-шаблонів з директивами
- Формування власного підходу на базі атрибутів до серіалізації/десеріалізації _Freemarker_-шаблонів з директивами у _HTML_-сумісний вигляд для використання у _WYSIWYG_-редакторі
- Використання HTML-сумісної технології шаблонізації на базі спеціальних атрибутів _Thymeleaf_ та її натуральне використання у _WYSIWYG_-редакторі

== Аналіз шаблонізаторів для використання із контентом, згенерованим через WYSIWYG-редактор

До розгляду було представлено два варіанти шаблонізаторів - https://freemarker.apache.org/[Freemarker] та https://www.thymeleaf.org/[Thymeleaf]. Обидва з них реалізовані на Java, втім обидва з них розглядались в першу чергу на предмет відповідності можливостям підтримки форматування контенту на стороні WYSIWYG-редакторів.

https://freemarker.apache.org/[Freemarker] пропонує використання кастомних елементів для шаблонізації, подібних HTML-тегам. За потреби замість синтаксису, подібного HTML-тегам, можна використовувати вставки, де символи `<` та `>` замінені на квадратні дужки (`[` та `]` відповідно). Втім, такий підхід створює суттєві проблеми при виведенні згенерованого контенту у режимі перегляду в браузері. Згенерований HTML-контент обробляється браузером та перетворюється у DOM-дерево зі своїми правилами; HTML-подібні вставки та вставки із квадратними дужками банально не відповідають правилам браузера, через що він, фактично, псує структуру контенту при перегляді. Водночас деякі з WYSIWYG-редакторів спираються саме на цей механізм обробки DOM-дерева браузером для перевірки коректності контенту, через що виникають складнощі не тільки із переглядом контенту, але і з його збереженням (наприклад, у TinyMCE та Quill).

У якості альтернативи було розглянуто використання підходу, за якого директиви шаблонізації будуть зберегатись не у вигляді додаткових елементів у рамках HTML-документу, а у якості додаткових атрибутів наявних елементів HTML-документу. В теорії, сучасні браузери розглядають будь-які можливі атрибути як валідні для будь-якого елементу, що позбавляє нас ризику "псування" контенту під час відображення та/або збереження контенту.

В результаті у якості рішення, яке відповідало би цим вимогам, було обрано https://www.thymeleaf.org/[Thymeleaf]. Він використовує атрибути на кшталт `th:if`, `th:value`, `th:each` у якості директив. Такі атрибути значно легше зробити підтримуваними в тому числі WYSIWYG-редакторами.

=== Рішення за результатами аналізу

Рекомендовано використання https://www.thymeleaf.org/[Thymeleaf] у якості шаблонізатора для HTML-документів з урахуванням сумісності з WYSIWYG-редактором.
