= Управління стратегіями нечіткого порівняння імені користувача при автентифікації

== Загальний опис

Існує проблема, що атрибут _fullName_ в КЕП що містить ПІП особи є нестандартизованим і заповнюється працівниками АЦСК. Це призводить до того що при перевипуску КЕП або використанні КЕП виданого іншим АЦСК значення можуть не збігатися. Зокрема інший КЕП може містити кілька пробілів замість одного, містити або не містити спеціальні символи такі як апостроф або дефіс. Такі зміни в атрибуті _fullName_ призводять до того, що користувач не може зайти в кабінет з новим ключем оскільки значення _fullName_ атрибута з КЕП не збігається зі значенням що збережене в БД KeyCloak. В свою чергу в KeyCloak зберігається значення атрибута _fullName_ з КЕП користувача який він використовував при першому логіні в реєєстр (атореєстрації).

Для вирішення цієї проблеми необхідно імплементувати нову додаткову до існуючої стратегію нечіткого порівняння стрічок що не враховує спецсимволи.

== Актори та ролі користувачів

* Отримувачі послуг
* Посадові особи
* Розробник регламенту

== Загальні принципи та положення

* При автентифікації мають враховуватись нечіткі співпадіння імен користувачів
* Вибір стратегії порівняння імен користувачів доступний на рівні регламенту реєстру
* Стратегії порівняння імен користувачів для отримувачів послуг та посадових осіб реєстру можуть відрізнятись

== Функціональні сценарії

* Налаштування правил порівняння імен користувачів розробником регламенту
* Валідація змін до правил порівняння імен користувачів при публікації регламенту
* Застосування правил порівняння повного імені користувача отриманого з _КЕП_ або від зовнішнього _IdP_ зі значенням збереженим в _KeyCloak IAM_

== Дизайн управління налаштуваннями

image::architecture-workspace/platform-evolution/registry-authenticator-configuration.svg[registry-authenticator-settings,700]

=== Стратегії автентифікації користувачів

Автентифікація користувача в компоненті "dso-*-authenticator" відбувається згідно логіки:
Автентифікатор в якості вхідних даних отримує наступні атрибути користувача:

- _drfo_: ідентифікаційний номер або серія і номер паспорта особи
- _fullName_: ПІП особи
- _edrpou_: код організації до якої належить особа

В процесі автентифікації відбувається пошук користувача в БД за атрибутом _drfo_. Якщо користувача з відповідним атрибутом знайдено, то відбувається порівняння атрибутів _fullName_ та _edrpou_ (в разі наявності).

Якщо порівняння _drfo_ та _edrpou_ відбувається чітким співпадінням (equals) то для fullName необхідно реалізувати підтримку наступних стратегій:

-  "_strictIgnoreCase_": перед порівнянням стрічки приводяться до нижнього регістру та видаляються всі символи пробілу. (*поточна реалізація*)
-  "_alphanumericIgnoreCase_": перед порівнянням стрічки приводяться до нижнього регістру та видаляються всі символи окрім латинських та кириличних літер та цифр. Також довжина стрічки після нормалізації не може бути менше 50% від оригінальної. (*потребує імплементації*)

Стратегія для порівняння атрибуту _fullName_ задається розробником регламенту в налаштуваннях регламенту реєстру для кожного порталу окремо.

=== Компоненти системи та їх призначення в рамках дизайну рішення

У даному розділі наведено перелік компонент системи, які задіяні або потребують змін/створення в рамках реалізації функціональних вимог згідно з технічним дизайном рішення.

|===
|Компонент|Службова назва|Призначення / Суть змін

|_Регламент реєстру_
|*registry-regulation*
|Розширення регламенту налаштуванням _fullnameAuthStrategy_

|_Пайплайн публікації регламенту_
|*registry-jenkins*
a|Застосування змін згідно файлів конфігурації та ресурсів

|_Автентифікатор громадян_
|*keycloak-ds-citizen-authenticator*
|Налаштування стратегії порівняння повного імені особи при автентифікації

|_Автентифікатор посадових осіб_
|*keycloak-ds-officer-authenticator*
|Налаштування стратегії порівняння повного імені посадової особи при автентифікації

|_CLI-утиліта валідації цілісності регламенту_
|*registry-regulations-validator-cli*
|Валідація налаштувань реєстру

|===

== Моделювання регламенту реєстру

=== Структура регламенту налаштувань реєстру

[TIP]
В рамках задачі по розширенню налаштувань, необхідно також розширити відповідну конфігурацію реєстру за замовчуванням у шаблоні репозиторію регламенту _empty_regulation_template_.

.Структура регламенту реєстру
[plantuml, registry-settings-regulation-structure, svg]
----
@startsalt
{
{T
+ <&folder> registry-regulation
++ <&folder> bpmn
++ <&folder> dmn
++ ...
++ <&folder> <b>settings</b>
+++ <&file> <b>settings.yml</b>
}
}
@endsalt
----

.Приклад конфігурації реєстру _settings/settings.yml_
[source, yaml]
----
settings:
  general:
    auth:
      citizen:
        fullnameAuthStrategy: "strictIgnoreCase"
      officer:
        fullnameAuthStrategy: "alphanumericIgnoreCase"
----

=== Валідація регламенту налаштувань реєстру

В рамках реалізації рішення, необхідно розширити CLI-утиліту _registry-regulations-validator-cli_ валідації регламенту додатковим правилом:

значення полів _settings.general.auth.officer.fullnameAuthStrategy_ та _settings.general.auth.citizen.fullnameAuthStrategy_ присутні та відповідають допустимим значенням: ["strictIgnoreCase", "alphanumericIgnoreCase"]

=== Публікація змін до регламенту налаштувань реєстру

Необхідно розширити:

- Логіку _dso-citizen-authenticator_ та _dso-officer-authenticator_ таким чином, щоб стратегія порівняння повного імені користувача бралася з конфігурації регламенту _registry-gerrit/<registry-regulation>.git/settings/settings.yml_.

.Налаштування dso-citizen-authenticator
image::lowcode/dso-citizen-authenticator-with-fullname-comparison-strategy.png[dso-citizen-authenticator, 300]

.Налаштування dso-officer-authenticator
image::lowcode/dso-officer-authenticator-with-fullname-comparison-strategy.png[dso-officer-authenticator, 300]

== Міграція налаштувань при оновленні реєстру

При оновленні існуючих реєстрів, необхідно встановити значення "_settings.general.auth.fullnameAuthStrategy_" для реєстру рівним _strictIgnoreCase_ щоб залишити незмінною поточну логіку.

== Високорівневий план розробки

=== Технічні експертизи

* BE
* DevOps

=== План розробки

* Розробка стратегії нечіткого порівняння імені користувача
* Розширення конфігурації citizen та officer автентифікаторів можливістю задавати бажану стратегію для кожного кабінету на рівні регламенту.
* Розробка інструкцій для розробника регламенту та референтних прикладів