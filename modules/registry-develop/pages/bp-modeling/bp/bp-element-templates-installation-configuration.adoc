= Типові розширення до бізнес-процесів
:toc:
:toclevels: 5
:toc-title: ЗМІСТ
:sectnums:
:sectnumlevels: 5
:sectanchors:

[#business-process-modeler-extensions-installation]
== Встановлення каталогу типових розширень до бізнес-процесів

Для спрощення моделювання бізнес-процесів розроблені типові розширення-конектори -- **Element Templates**.

[#preconditions]
=== Передумови

==== Встановлення застосунку Сamunda Modeler

* Завантажте архів із застосунком **Camunda Modeler** за https://camunda.com/download/modeler/[посиланням]:
** оберіть продукт **Open Source Modeler** та завантажте відповідну версію, сумісну із вашою операційною системою (наприклад, `Windows 64bit`);
** після завантаження архіву з додатком, розпакуйте його на локальній машині.

==== Встановлення плагіну BPMN Linter

* Встановіть плагін **BPMN Linter** для розширення функціональності Camunda -- зверніться до відповідної інструкції за https://github.com/camunda/camunda-modeler-linter-plugin[посиланням]:
** після завантаження плагіну, помістіть папку із його вмістом до `\camunda-modeler-4.8.1-win-x64\resources\plugins`.

=== Встановлення каталогу типових розширень для Windows OS

Виконайте настанови, подані нижче, для інсталювання каталогу Element Templates:

* перейдіть до захищеного сховища артефактів **Nexus** за посиланням: `https://nexus-{CP-NAMESPACE}.{DNS-WILDCARD}/[]`;

TIP: `{CP-NAMESPACE}` _та `{DNS-WILDCARD}` є змінними, де `{CP-NAMESPACE}` -- назва namespace (простору імен) у Nexus, а `{DNS-WILDCARD}` -- значення DNS wildcardfootnote:[В системі DNS можна задавати запис за замовчуванням для неоголошених піддоменів. Такий запис називається **wildcard**.]._

* знайдіть папку `business-process-modeler-extensions`;
* буде показано каталог папок типу `version.build` (наприклад, `0.0.1-SNAPSHOT.12`);
* оберіть папку з останньою версією;
* оберіть `.zip`-файл у папці, що була відкрита (останньою версією zip може бути, наприклад, файл `business-process-modeler-extensions-1.2.0-RC.1.zip`);
* на вкладці `Summary` натисніть правою кнопкою миші на посилання `Path`. Таким чином розпочнеться завантаження `.zip`-архіву;
* розпакуйте із заміною завантажений `.zip`-файл у підпапці `resources` вашої локальної директорії, де зберігається додаток. Приклад шляху може бути наступним: `C:\Users\Downloads\camunda-modeler-4.8.1-win-x64\resources`,

TIP: _де `camunda-modeler-4.8.1-win-x64` -- локальна директорія, в якій зберігається додаток, а `resources` -- папка, що має містити розширення (element-templates) та плагіни (plugins)_.

Зверніться до https://github.com/camunda/camunda-modeler/tree/master/docs/search-paths#user-data-directory[офіційного джерела] для отримання деталей.

* Підсумкова структура директорії `resources` має виглядати наступним чином:

image:registry-develop:bp-modeling/bp/element-temp/bp-element-temp-02.png[]

* Підсумкова структура директорії `element-templates` має виглядати наступним чином:

image:registry-develop:bp-modeling/bp/element-temp/bp-element-temp-03.png[]

* Підсумкова структура директорії `plugins` має виглядати наступним чином:

image:registry-develop:bp-modeling/bp/element-temp/bp-element-temp-04.png[]

* Перезапустіть додаток Camunda Modeler. Розширення мають бути доступні для використання в каталозі при моделюванні бізнес-процесу:

** створіть задачу (**Create Task**);
** натисніть на іконку налаштувань (**Change Type**);
** зазначте тип задачі (**Service Task** або **User Task**);
** натисніть кнопку `Open Catalog`;
** в результаті відкриється каталог розширень **Element Templates**.

image:registry-develop:bp-modeling/bp/element-temp/bp-element-temp-01.png[]

=== Встановлення каталогу типових розширень для Mac OS

Виконайте настанови, подані нижче, для інсталювання каталогу Element Templates:

* Відкрийте термінал.
* Перейдіть до локальної директорії розміщення ресурсів Camunda Modeler за допомогою команди:

[source, bash]
----
cd ~/Library/Application\ Support/camunda-modeler/resources
----

* Створіть нову директорію під розширення категорії `element templates` у випадку, якщо її там немає, за допомогою команди:

[source, bash]
----
mkdir element-templates
----

* Скопіюйте всі JSON-файли розширень з директорії `business-process-modeler-extensions` до директорії, що була створена, за допомогою команди:

[source,bash]
----
cp business-process-modeler-extensions/*.json ~/Library/Application\ Support/camunda-modeler/resources/element-templates
----

* Підсумкова структура директорії виглядатиме наступним чином:

----
~/Library/Application\ Support/camunda-modeler/resources/element-templates/
----

image:registry-develop:bp-modeling/bp/element-temp/bp-element-temp-05.jpg[]

* Перезапустіть додаток Camunda Modeler. Розширення мають бути доступні для використання в каталозі при моделюванні бізнес-процесу:

** створіть задачу (**Create Task**);
** натисніть на іконку налаштувань (**Change Type**);
** зазначте тип задачі (**Service Task** або **User Task**);
** натисніть кнопку `Open Catalog`;
** в результаті відкриється каталог розширень **Element Templates**.

image:registry-develop:bp-modeling/bp/element-temp/bp-element-temp-01.png[]

[#business-process-modeler-extensions-configuration]
== Налаштування типових розширень до бізнес-процесів

Цей розділ описує налаштування типових розширень для бізнес-процесів -- **Element Templates**.

Типи задач для застосування розширень ::

Типові розширення **Element Templates** можуть бути застосовані до різних типів задач, наприклад:

* xref:#element-temp-user-task[користувацьких задач] (*User Task*);
* xref:#element-temp-service-task[сервісних задач] (*Service Task*);
* xref:#element-temp-call-activity[задач для виклику зовнішніх процесів] (*Call Activity*);
* задач скриптування (*Script Task*);
* тощо.

+
CAUTION: _Налаштування типових розширень-конекторів відбувається у застосунку **Camunda Modeler**. Перед початком роботи переконайтеся, що виконано всі передумови, описані у попередньому розділі xref:business-process-modeler-extensions-installation[Встановлення каталогу типових розширень до бізнес-процесів]._

[#element-temp-user-task]
=== Типові розширення для користувацьких задач

==== Задача, що потребує валідації підписом особи-отримувача послуг реєстру (Citizen Sign Task)

Розширення використовується для визначення задачі, що потребує валідації підписом особи-отримувача послуг реєстру (може бути доступна тільки ініціаторові бізнес-процесу).

NOTE: _Перш за все, переконайтеся, що папка `/element-templates` містить файл `citizenSignTaskTemplate.json`._

* Відкрийте **User Task**, натисніть кнопку `Open Catalog` та оберіть шаблон (Template) зі списку.
* У полі `Form key` введіть службову назву форми.
* У полі `Assignee` введіть значення `${initiator}`, (для того, щоб призначити задачу одразу користувачеві, що ініціював бізнес-процес) або значення ідентифікатора користувача (для того, щоб призначити задачу одному чітко визначеному користувачу).
* У полі `Candidate users` введіть **список користувачів** (написаних через кому), для котрих задача буде доступною для виконання. В рамках бізнес-процесу кожен користувач зможе цю задачу призначити собі та виконати.
* У полі `Candidate roles` введіть **список ролей** (написаних через кому), для яких задача доступна для виконання. В рамках бізнес-процесу кожен користувач, що має хоча б одну з цих ролей зможе цю задачу призначити собі та виконати (навіть якщо у нього немає доступу до самого бізнес-процесу.

TIP: _Наприклад, бізнес-процес із умовною назвою **bp1** зможе ініціювати лише користувач з роллю `officer-bp1`, хоча задачу в цьому бізнес-процесі, яка доступна ролі `officer-task` зможе виконати користувач, лише маючи одну регламенту роль `officer-task`)._

* Проставте необхідні прапорці у наступних полях, вказавши валідаційний пакет підпису:

** `CITIZEN` -- для регламентної ролі `Фізична особа`;
** `ENTERPRENEUR` -- для регламентної ролі `Фізична особа-підприємець (ФОП)`;
** `LEGAL` -- для регламентної ролі `Юридична особа`.

image:registry-develop:bp-modeling/bp/element-temp/bp-element-temp-1.png[]

==== Задача, що потребує валідації підписом посадової особи (Officer Sign Task)

Розширення використовується для визначення задачі, що потребує валідації підписом посадової особи.

NOTE: _Перш за все, переконайтеся, що папка `/element-templates` містить файл `officerSignTaskTemplate.json`._

* Відкрийте **User Task**, натисніть кнопку `Open Catalog` та оберіть шаблон (Template) зі списку.
* У полі `Form key` введіть службову назву форми.
* У полі `Assignee` введіть значення `${initiator}`, (для того, щоб призначити задачу одразу користувачеві, що ініціював бізнес-процес) або значення ідентифікатора користувача (для того, щоб призначити задачу одному чітко визначеному користувачу).

* У полі `Candidate users` введіть **список користувачів** (написаних через кому), для котрих задача буде доступною для виконання. В рамках бізнес-процесу кожен користувач зможе цю задачу призначити собі та виконати.
* У полі `Candidate roles` введіть **список ролей** (написаних через кому), для яких задача доступна для виконання. В рамках бізнес-процесу кожен користувач, що має хоча б одну з цих ролей зможе цю задачу призначити собі та виконати (навіть якщо у нього немає доступу до самого бізнес-процесу.

TIP: _Наприклад, бізнес-процес із умовною назвою **bp1** зможе ініціювати лише користувач з роллю `officer-bp1`, хоча задачу в цьому бізнес-процесі, яка доступна ролі `officer-task` зможе виконати користувач, лише маючи одну регламенту роль `officer-task`)._

image:registry-develop:bp-modeling/bp/element-temp/bp-element-temp-2.png[]

==== Користувацька форма (User form)

Розширення використовується для визначення звичайної задачі, що не потребує валідації підписом посадової особи.

NOTE: _Перш за все, переконайтеся, що папка `/element-templates` містить файл `userTaskTemplate.json`._

* Відкрийте **User Task**, натисніть кнопку `Open Catalog` та оберіть шаблон (Template) зі списку.
* У полі `Form key` введіть службову назву форми.
* У полі `Assignee` введіть значення `${initiator}`, (для того, щоб призначити задачу одразу користувачеві, що ініціював бізнес-процес) або значення ідентифікатора користувача (для того, щоб призначити задачу одному чітко визначеному користувачу).

* У полі `Candidate users` введіть **список користувачів** (написаних через кому), для котрих задача буде доступною для виконання. В рамках бізнес-процесу кожен користувач зможе цю задачу призначити собі та виконати.
* У полі `Candidate roles` введіть **список ролей** (написаних через кому), для яких задача доступна для виконання. В рамках бізнес-процесу кожен користувач, що має хоча б одну з цих ролей зможе цю задачу призначити собі та виконати (навіть якщо у нього немає доступу до самого бізнес-процесу.

TIP: _Наприклад, бізнес-процес із умовною назвою **bp1** зможе ініціювати лише користувач з роллю `officer-bp1`, хоча задачу в цьому бізнес-процесі, яка доступна ролі `officer-task` зможе виконати користувач, лише маючи одну регламенту роль `officer-task`)._

image:registry-develop:bp-modeling/bp/element-temp/bp-element-temp-3.png[]

[#element-temp-service-task]
=== Типові розширення для сервісних задач

==== Додавання ролі користувачу Keycloak (Add role to Keycloak user)

Розширення використовується для призначення ролі користувача Keycloak.

NOTE: _Перш за все, переконайтеся, що папка `/element-templates` містить файл `addRoleToKeycloakUser.json`._

* Відкрийте **Service Task**, натисніть кнопку `Open Catalog` та оберіть шаблон (Template) зі списку.
* У полі `User name` вкажіть ідентифікатор користувача у Keycloak.
* У полі `Role` вкажіть роль користувача.

image:registry-develop:bp-modeling/bp/element-temp/bp-element-temp-4.png[]

==== Групове створення сутностей у фабриці даних (Batch creation of entities in data factory)

NOTE: _Перш за все, переконайтеся, що папка `/element-templates` містить файл `dataFactoryConnectorBatchCreateDelegate.json`._

* Відкрийте **Service Task**, натисніть кнопку `Open Catalog` та оберіть шаблон (Template) зі списку.
* У полі `Name` вкажіть назву задачі.
* У полі `Resource` вкажіть ресурс.
* У полі `Payload` введіть дані для створення.
* У полі `X-Access-Token source` зазначте токен доступу до системи користувача, під яким виконується операція.
* У полі `X-Digital-Signature source` вкажіть джерело цифрового підпису.
* У полі `X-Digital-Signature-Derived source` вкажіть джерело системного цифрового підпису.
* У полі `Result variable` вкажіть будь-яке ім'я для вихідного параметра (за замовчуванням -- `response`).

image:registry-develop:bp-modeling/bp/element-temp/bp-element-temp-5.png[]

==== Групове читання сутностей у фабриці даних (Batch Read entities from data factory)

NOTE: _Перш за все, переконайтеся, що папка `/element-templates` містить файл `dataFactoryConnectorBatchReadDelegate.json`._

* Відкрийте **Service Task**, натисніть кнопку `Open Catalog` та оберіть шаблон (Template) зі списку.
* У полі `Name` вкажіть назву задачі.
* У полі `Resource` вкажіть ресурс.
* У полі `Resource ids` вкажіть ідентифікатор ресурсу.
* У полі `X-Access-Token source` зазначте токен доступу до системи користувача, під яким виконується операція.
* У полі `Result variable` вкажіть будь-яке ім'я для вихідного параметра (за замовчуванням -- `response`).

image:registry-develop:bp-modeling/bp/element-temp/bp-element-temp-6.png[]

==== Створення сутності у фабриці даних (Create entity in data factory)

NOTE: _Перш за все, переконайтеся, що папка `/element-templates` містить файл `dataFactoryConnectorCreateDelegate.json`._

* Відкрийте **Service Task**, натисніть кнопку `Open Catalog` та оберіть шаблон (Template) зі списку.
* У полі `Name` вкажіть назву задачі.
* У полі `Resource` вкажіть ресурс.
* У полі `Payload` введіть дані для створення.
* У полі `X-Access-Token source` зазначте токен доступу до системи користувача, під яким виконується операція.
* У полі `X-Digital-Signature source` вкажіть джерело цифрового підпису.
* У полі `X-Digital-Signature-Derived source` вкажіть джерело системного цифрового підпису.
* У полі `Result variable` вкажіть будь-яке ім'я для вихідного параметра (за замовчуванням -- `response`).

image:registry-develop:bp-modeling/bp/element-temp/bp-element-temp-7.png[]

[#create-nested-entities]
==== Створення декількох сутностей в рамках однієї транзакції (Create nested entities in data factory)

Розширення *Create nested entities in data factory* -- делегат для створення декількох сутностей в рамках однієї транзакції, що налаштовується за допомогою розробленого однойменного шаблону *Create nested entities in data factory* (_dataFactoryConnectorNestedCreateDelegate.json_).

NOTE: Перед налаштуванням шаблону в Сamunda Modeler переконайтеся, що папка `/element-templates` містить файл _dataFactoryConnectorNestedCreateDelegate.json_.

. Змоделюйте сервісну задачу (*Service Task*).

+
image:bp-modeling/bp/element-temp/nested-entities/nested-entities-1.png[]

. Натисніть `Open Catalog` та оберіть шаблон *Create nested entities in data factory* зі списку.

+
image:bp-modeling/bp/element-temp/nested-entities/nested-entities-2.png[]
image:bp-modeling/bp/element-temp/nested-entities/nested-entities-3.png[]

. Сконфігуруйте обраний шаблон:

* У полі `Name` вкажіть назву задачі. Наприклад, `Зберегти дані до Фабрики даних`.
* У полі `Resource` вкажіть ресурс, тобто назву ендпоінту, до якого необхідно звернутися. Наприклад, `person-profile`.
+
NOTE: На рівні API, ендпоінт виглядає наступним чином: `/nested/<resource name>`, де `<resource name>` -- назва ресурсу. Тобто у полі `Resource` необхідно вказати значення, яке визначається після останньої косої риски (`/`).

* У полі `Payload` введіть тіло запита -- JSON-об`єкт із вкладеною структурою декількох сутностей, яку необхідно зберегти до Фабрики даних. Наприклад, `${payload}`.
+
NOTE: Майте на увазі, що необхідно попередньо побудувати цей JSON-об`єкт, тобто `payload`, в рамках задачі скриптування.

* У полі `X-Access-Token` вкажіть токен доступу.
+
[TIP]
====
Токен доступу береться з АБО ініціатора (наприклад, `$initiator().accessToken}`), АБО виконавця задачі (наприклад, `${completer('taskDefinitionId').accessToken}`).
====

+
image:bp-modeling/bp/element-temp/nested-entities/nested-entities-4.png[]

* У полі `X-Digital-Signature source` вкажіть джерело цифрового підпису.
* У полі `X-Digital-Signature-Derived source` вкажіть джерело системного цифрового підпису.
* У полі `Result variable` вкажіть назву змінної процесу, до якої необхідно записати результат (за замовчуванням -- `response`).

+
image:bp-modeling/bp/element-temp/nested-entities/nested-entities-5.png[]

TIP: Особливості використання та налаштування делегата *Create nested entities in data factory* у бізнес-процесі дивіться за xref:registry-develop:bp-modeling/bp/modeling-facilitation/bp-nested-entities-in-data-factory.adoc[посиланням].

==== Створення або оновлення користувацьких налаштувань (Create or update user settings)

NOTE: _Перш за все, переконайтеся, що папка `/element-templates` містить файл `userSettingsConnectorUpdateDelegate.json`._

* Відкрийте **Service Task**, натисніть кнопку `Open Catalog` та оберіть шаблон (Template) зі списку.
* У полі `Name` вкажіть назву задачі.
* У полі `X-Access-Token source` зазначте токен доступу до системи користувача, під яким виконується операція.
* У полі `Result variable` вкажіть будь-яке ім'я для вихідного параметра (за замовчуванням -- `response`).

image:registry-develop:bp-modeling/bp/element-temp/bp-element-temp-8.png[]

==== Визначення статусу бізнес-процесу (Define business process status)

NOTE: _Перш за все, переконайтеся, що папка `/element-templates` містить файл `defineBusinessProcessStatusDelegate.json`._

* Відкрийте **Service Task**, натисніть кнопку `Open Catalog` та оберіть шаблон (Template) зі списку.
* У полі `Name` вкажіть назву задачі.
* У полі `Status` вкажіть статус, що відображатиметься після завершення процесу.

image:registry-develop:bp-modeling/bp/element-temp/bp-element-temp-9.png[]

==== Видалення сутності з фабрики даних (Delete entity from data factory)

NOTE: _Перш за все, переконайтеся, що папка `/element-templates` містить файл `dataFactoryConnectorDeleteDelegate.json`._

* Відкрийте **Service Task**, натисніть кнопку `Open Catalog` та оберіть шаблон (Template) зі списку.
* У полі `Name` вкажіть назву задачі.
* У полі `Resource` вкажіть ресурс.
* У полі `Payload` введіть дані для створення.
* У полі `X-Access-Token source` зазначте токен доступу до системи користувача, під яким виконується операція.
* У полі `X-Digital-Signature source` вкажіть джерело цифрового підпису.
* У полі `X-Digital-Signature-Derived source` вкажіть джерело системного цифрового підпису.
* У полі `Result variable` вкажіть будь-яке ім'я для вихідного параметра (за замовчуванням -- `response`).

image:registry-develop:bp-modeling/bp/element-temp/bp-element-temp-10.png[]

[[header,Delegate]]
==== Розширення для делегатаfootnote:[**Делегат (англ. Delegate)** -- клас, який дозволяє зберігати в собі посилання на метод із певною сигнатурою (порядком і типами значень, що приймаються та повертається) довільного класу. Екземпляри делегатів містять посилання на конкретні методи конкретних класів.] цифрового підпису DSO (Digital signature by DSO service)

NOTE: _Перш за все, переконайтеся, що папка `/element-templates` містить файл `digitalSignatureConnectorDelegate.json`._

* Відкрийте **Service Task** -> у вікні справа натисніть кнопку `Open Catalog` та оберіть відповідний шаблон (Template) зі списку.
* У полі `Payload` введіть дані для підпису.
* У полі `X-Access-Token source` введіть токен доступу до системи користувача, під яким виконується операція.
* У полі `Result variable` вкажіть будь-яке ім'я для вихідного параметра (за замовчуванням -- `response`).

image:registry-develop:bp-modeling/bp/element-temp/bp-element-temp-11.png[]

==== Отримання ролі з Keycloak (Get roles from Keycloak)

NOTE: _Перш за все, переконайтеся, що папка `/element-templates` містить файл `getRolesFromKeycloak.json`._

* Відкрийте **Service Task** -> у вікні справа натисніть кнопку `Open Catalog` та оберіть відповідний шаблон (Template) зі списку.
* У полі `Name` вкажіть назву задачі.
* У полі `Result variable` вкажіть будь-яке ім'я для вихідного параметра (наприклад, `rolesOutput`).

image:registry-develop:bp-modeling/bp/element-temp/bp-element-temp-12.png[]

==== Отримання детальної інформації за суб'єктом з ЄДР (Get subject detail EDR Registry)

NOTE: _Перш за все, переконайтеся, що папка `/element-templates` містить файл `subjectDetailEdrRegistryConnectorDelegate.json`._

* Відкрийте **Service Task** -> у вікні справа натисніть кнопку `Open Catalog` та оберіть відповідний шаблон (Template) зі списку.
* У полі `Name` вкажіть назву задачі.
* У полі `Authorization token` вкажіть токен для доступу до СЕВ ДЕІР «Трембіта».
* Поле `Id` визначає змінну, де зберігається код для пошуку в у зовнішньому реєстрі (ЄДР).
* У полі `Result variable` вкажіть будь-яке ім'я для вихідного параметра (за замовчуванням -- `response`).

image:registry-develop:bp-modeling/bp/element-temp/bp-element-temp-13.png[]

==== Завантаження контенту до Ceph (Put content to Ceph)

NOTE: _Перш за все, переконайтеся, що папка `/element-templates` містить файл `putContentToCeph.json`._

* Відкрийте **Service Task** -> у вікні справа натисніть кнопку `Open Catalog` та оберіть відповідний шаблон (Template) зі списку.
* У полі `Name` вкажіть назву задачі.
* У полі `Ceph key` вкажіть СEPH-ключ документа.
* У полі `Content` введіть дані для збереження.

image:registry-develop:bp-modeling/bp/element-temp/bp-element-temp-14.png[]

==== Завантаження даних для передзаповнення користувацької задачі в Ceph (Put user task form data prepopulation to Ceph)

NOTE: _Перш за все, переконайтеся, що папка `/element-templates` містить файл `putFormDataToCeph.json`._

* Відкрийте **Service Task** -> у вікні справа натисніть кнопку `Open Catalog` та оберіть відповідний шаблон (Template) зі списку.
* У полі `Name` вкажіть назву задачі.
* У полі  `Task definition key` вкажіть ідентификатор задачі, яку слід передзаповнити.
* У полі `Form data prepopulation` введіть дані форми, що відображатимуться.

image:registry-develop:bp-modeling/bp/element-temp/bp-element-temp-15.png[]

==== Читання контенту із Ceph (Read content from Ceph)

NOTE: _Перш за все, переконайтеся, що папка `/element-templates` містить файл `readContentFromCeph.json`._

* Відкрийте **Service Task** -> у вікні справа натисніть кнопку `Open Catalog` та оберіть відповідний шаблон (Template) зі списку.
* У полі `Name` вкажіть назву задачі.
* У полі `Ceph key` вкажіть СEPH-ключ документа.
* У полі `Result Variable` введіть значення `Content` -- дані для збереження.

image:registry-develop:bp-modeling/bp/element-temp/bp-element-temp-16.png[]

==== Читання сутності із фабрики даних (Read entity from data factory)

NOTE: _Перш за все, переконайтеся, що папка `/element-templates` містить файл `dataFactoryConnectorReadDelegate.json`._

* Відкрийте **Service Task** -> у вікні справа натисніть кнопку `Open Catalog` та оберіть відповідний шаблон (Template) зі списку.
* У полі `Name` вкажіть назву задачі.
* У полі `Resource` вкажіть ресурс.
* У полі `Resource id` введіть ідентифікатор ресурсу.
* У полі `X-Access-Token source` вкажіть токен доступу до системи користувача, під яким виконується операція.
* У полі `Result variable` вкажіть будь-яке ім'я для вихідного параметра (за замовчуванням -- `response`).

image:registry-develop:bp-modeling/bp/element-temp/bp-element-temp-17.png[]

==== Читання даних для стартової форми з Ceph (Read start from data from Ceph)

NOTE: _Перш за все, переконайтеся, що папка `/element-templates` містить файл `readStartFormDataFromCeph.json`._

* Відкрийте **Service Task** -> у вікні справа натисніть кнопку `Open Catalog` та оберіть відповідний шаблон (Template) зі списку.
* У полі `Name` вкажіть назву задачі.
* У полі `Result variable` вкажіть будь-яке ім'я для вихідного параметра (за замовчуванням -- `readStartForm`).

image:registry-develop:bp-modeling/bp/element-temp/bp-element-temp-18.png[]

==== Читання користувацьких налаштувань (Read user settings)

NOTE: _Перш за все, переконайтеся, що папка `/element-templates` містить файл `userSettingsConnectorReadDelegate.json`._

* Відкрийте **Service Task** -> у вікні справа натисніть кнопку `Open Catalog` та оберіть відповідний шаблон (Template) зі списку.
* У полі `Name` вкажіть назву задачі.
* У полі `X-Access-Token source` зазначте токен доступу до системи користувача, під яким виконується операція.
* У полі `Result variable` вкажіть будь-яке ім'я для вихідного параметра (за замовчуванням -- `response`).

image:registry-develop:bp-modeling/bp/element-temp/bp-element-temp-19.png[]

==== Читання даних користувацької задачі з Ceph (Read user task form data from ceph)

NOTE: _Перш за все, переконайтеся, що папка `/element-templates` містить файл `readFormDataFromCeph.json`._

* Відкрийте **Service Task** -> у вікні справа натисніть кнопку `Open Catalog` та оберіть відповідний шаблон (Template) зі списку.
* У полі `Name` вкажіть назву задачі.
* У полі `Task definition key` введіть ідентифікатор задачі, яку необхідно прочитати.
* У полі `Result variable` вкажіть будь-яке ім'я для вихідного параметра (за замовчуванням -- `formDataOutput`).

image:registry-develop:bp-modeling/bp/element-temp/bp-element-temp-20.png[]

==== Видалення ролі у користувача Keycloak (Remove role from Keycloak user)

NOTE: _Перш за все, переконайтеся, що папка `/element-templates` містить файл `removeRoleFromKeycloakUser.json`._

* Відкрийте **Service Task** -> у вікні справа натисніть кнопку `Open Catalog` та оберіть відповідний шаблон (Template) зі списку.
* У полі `Name` вкажіть назву задачі.
* У полі `User name` вкажіть ідентифікатор користувача у Keycloak.
* У полі `Role` зазначте роль користувача.

image:registry-develop:bp-modeling/bp/element-temp/bp-element-temp-21.png[]

==== Пошук користувачів у Keycloak за їх атрибутами

Розширення *Get users by attributes from keycloak* -- делегат `${getUsersByAttributesFromKeycloak}`, для якого імплементовано однойменний шаблон *Get users by attributes from keycloak*, представлений у вигляді JSON-файлу _getUsersByAttributesFromKeycloak.json_.

Делегат потрібний для того, щоб при виконанні бізнес-процесу отримувати список користувачів (посадових осіб) за певними атрибутами із сервісу керування ідентифікацією та доступом Keycloak.

NOTE: Перед налаштуванням шаблону в Сamunda Modeler переконайтеся, що папка із застосунком _resources_ -> _element-templates_ містить файл _getUsersByAttributesFromKeycloak.json_.

Налаштування шаблону ::

. Змоделюйте нову задачу.
. Визначте її тип, натиснувши іконку ключа та обравши з меню пункт *Service Task* (сервісна задача).
+
image:bp-modeling/bp/element-temp/keycloak-users-attributes/element-temp-keycloak-attributes-delegate-1.png[]

. Перейдіть до панелі налаштувань справа та застосуйте делегат *Get users by attributes from keycloak*. Для цього оберіть відповідний шаблон із каталогу (`Open Catalog`) та натисніть `Apply` для підтвердження.
+
image:bp-modeling/bp/element-temp/keycloak-users-attributes/element-temp-keycloak-attributes-delegate-2.png[]
+
image:bp-modeling/bp/element-temp/keycloak-users-attributes/element-temp-keycloak-attributes-delegate-3.png[]


. Виконайте подальші налаштування:

* У полі `Name` вкажіть назву задачі. Наприклад, `Отримати список користувачів із Keycloak`.
* У полі `Edrpou attribute value` вкажіть значення атрибута `edrpou`. Наприклад, `11111111`.
+
[NOTE]
====
Значення атрибута `edrpou` є обов'язковим для заповнення. Його можна передати як напряму (тобто ввести код ЄДРПОУ, наприклад, `11111111`), так і через функцію `submission()`, вказавши ID останньої користувацької задачі (наприклад, `'userTaskId'`).
====

* У полі `Drfo attribute value` вкажіть значення атрибута `drfo`. Наприклад, `2222222222`.
+
[NOTE]
====
Значення атрибута `drfo` є опціональним. Його можна передати як напряму (тобто ввести код ДРФО, наприклад, `2222222222`), так і через функцію `submission()`, вказавши ID останньої користувацької задачі (наприклад, `'userTaskId'`).
====

* У полі `Result variable` вкажіть назву змінної, до якої необхідно зберегти відповідь -- `usersByAttributes`.
+
[CAUTION]
====
В результаті запита отримуємо список користувачів із Keycloak за їх атрибутами, який зберігатиметься у змінній `usersByAttributes`.

* Якщо користувач передає лише значення параметра `edrpou`, то сервіс повертає список _усіх посадових осіб_ відповідної організації.
* Якщо користувач передає значення параметрів `edrpou` та `drfo`, то сервіс повертає список з іменем _конкретної посадової особи_ відповідної організації.
====
+
image:bp-modeling/bp/element-temp/keycloak-users-attributes/element-temp-keycloak-attributes-delegate-4.png[]

TIP: Детальніше про налаштування та використання делегата у бізнес-процесі -- за xref:bp-modeling/bp/access/bp-limiting-access-keycloak-attributes.adoc[посиланням].

==== Пошук сутностей у фабриці даних (Search for entities in data factory)

NOTE: _Перш за все, переконайтеся, що папка `/element-templates` містить файл `dataFactoryConnectorSearchDelegate.json`._

* Відкрийте **Service Task** -> у вікні справа натисніть кнопку `Open Catalog` та оберіть відповідний шаблон (Template) зі списку.
* У полі `Name` вкажіть назву задачі.
* У полі `Resource` вкажіть ресурс.
* У полі `Result variable` вкажіть будь-яке ім'я для вихідного параметра (за замовчуванням -- `response`.
* У полі `X-Access-Token source` вкажіть токен доступу до системи користувача, під яким виконується операція.

image:registry-develop:bp-modeling/bp/element-temp/bp-element-temp-22.png[]

==== Пошук суб'єкта в ЄДР (Search subjects EDR Registry)

NOTE: _Перш за все, переконайтеся, що папка `/element-templates` містить файл `searchSubjectsEdrRegistryConnectorDelegate.json`._

* Відкрийте **Service Task** -> у вікні справа натисніть кнопку `Open Catalog` та оберіть відповідний шаблон (Template) зі списку.
* У полі `Name` вкажіть назву задачі.
* У полі `Authorization token` вкажіть токен для доступу до СЕВ ДЕІР «Трембіта».
* Поле `Code` визначає змінну, де зберігається код для пошуку в ЄДР.
* У полі `Result variable` вкажіть будь-яке ім'я для вихідного параметра (за замовчуванням -- `response`).

image:registry-develop:bp-modeling/bp/element-temp/bp-element-temp-23.png[]

==== Надсилання системної помилки (Throw system error)

NOTE: _Перш за все, переконайтеся, що папка `/element-templates` містить файл `camundaSystemErrorDelegate.json`._

* Відкрийте **Service Task** -> у вікні справа натисніть кнопку `Open Catalog` та оберіть відповідний шаблон (Template) зі списку.
* У полі `Name` вкажіть назву задачі.
* У полі `Message` зазначте текст помилки, що буде показано.

image:registry-develop:bp-modeling/bp/element-temp/bp-element-temp-24.png[]

==== Надсилання помилки перевірки правдивості (Throw validation error)

NOTE: _Перш за все, переконайтеся, що папка `/element-templates` містить файл `userDataValidationErrorDelegate.json`._

* Відкрийте **Service Task** -> у вікні справа натисніть кнопку `Open Catalog` та оберіть відповідний шаблон (Template) зі списку.
* У полі `Name` вкажіть назву задачі.
* У випадному списку **Validation errors**:
** зазначте у полі `Variable Assignment Type` тип змінної, вказавши значення `List`;
** натисніть `Add Value` та у полі `Value` вкажіть значення помилки, що відображатиметься.

.Приклад
[source, json]
----
{"field": "laboratory", "value": "${submission('start_event').formData.prop('laboratory').prop('laboratoryId').value()}", "message": "Статус в ЄДР "Скаcовано" або "Припинено""}.
----

image:registry-develop:bp-modeling/bp/element-temp/bp-element-temp-25.png[]

==== Оновлення сутності у фабриці даних (Update entity in data factory)

NOTE: _Перш за все, переконайтеся, що папка `/element-templates` містить файл `dataFactoryConnectorUpdateDelegate.json`._

* Відкрийте **Service Task** -> у вікні справа натисніть кнопку `Open Catalog` та оберіть відповідний шаблон (Template) зі списку.
* У полі `Name` вкажіть назву задачі.
* У полі `Resource` вкажіть ресурс.
* У полі `Resource id` вкажіть ідентифікатор ресурсу.
* У полі `Payload` зазначте дані для створення.
* У полі `X-Access-Token source` введіть токен доступу до системи користувача, під яким виконується операція.
* У полі `X-Digital-Signature source` вкажіть джерело для Ceph-документа, де зберігається підпис користувача, накладений на дані UI-форми при внесенні.
* У полі `X-Digital-Signature-Derived source` вкажіть джерело для Ceph-документа, де зберігається системний підпис, автоматично накладений на тіло запита.
* У полі `Result variable` вкажіть будь-яке ім'я для вихідного параметра (за замовчуванням -- `response`).

image:registry-develop:bp-modeling/bp/element-temp/bp-element-temp-26.png[]

[#element-temp-call-activity]
=== Типові розширення для виклику глобальних підпроцесів (Call Activity)

NOTE: Каталог розроблених шаблонів для налаштування делегатів зберігається у сховищі коду Gerrit, в окремому репозиторії _business-process-modeler-extensions_ -> _element-templates_.


TIP: Особливості використання Call Activity у бізнес-процесах дивіться за xref:registry-develop:bp-modeling/bp/bpmn/subprocesses/call-activities.adoc[посиланням].

[#bp-element-temp-call-activity-call-activity]
==== Делегат виклику глобального підпроцесу (Call Activity)

Розширення *Call Activity* -- загальний делегат для виклику глобального підпроцесу, що налаштовується за допомогою розробленого однойменного шаблону *Call Activity* (_callActivity.json_).

Розширення використовується, коли необхідно з одного бізнес-процесу викликати зовнішній підпроцес.

NOTE: Перед налаштуванням шаблону в Сamunda Modeler переконайтеся, що папка із застосунком _resources_ -> _element-templates_ містить файл _callActivity.json_.

[IMPORTANT]
====
Існують певні обмеження щодо кількості рівнів вкладеності бізнес-процесів при викликах зовнішніх підпроцесів за допомогою делегата Call Activity.

Для правильної роботи функціональності виклику зовнішніх підпроцесів через Call Activity, використовуйте не більше 3-х рівнів вкладеності бізнес-процесів, тобто основний процес, глобальний підпроцес 1-го рівня та глобальний підпроцес 2-го рівня.
====

[configure-temp]
===== Налаштування шаблону

. Створіть *Call Activity*.

+
image:bp-modeling/bp/element-temp/call-activity/element-temp-call-activity-1.png[]

. На панелі налаштувань справа натисніть кнопку `Open Catalog`, оберіть відповідний шаблон *Call Activity* зі списку та натисніть `Apply` для підтвердження.

+
image:bp-modeling/bp/element-temp/call-activity/element-temp-call-activity-2.png[]

+
image:bp-modeling/bp/element-temp/call-activity/element-temp-call-activity-3.png[]

. Виконайте подальші налаштування:

* У полі `Name` вкажіть назву задачі (наприклад, `call-activity-task`).
* У полі `Called Element` вкажіть ідентифікатор стороннього процесу або підпроцесу, що викликатиметься (наприклад, `called-process`).
* У полі `Input data` вкажіть вхідні дані, які необхідно передати бізнес-процесу, що викликається. Параметри мають передаватися у вигляді пар _ключ-значення_ (наприклад, `${payload}`).
* У полі `Output variable name` вкажіть назву змінної, до якої необхідно записати дані (payload), отримані в результаті виконання підпроцесу, що викликається (наприклад, `callActivityOutput`).
+
TIP: Якщо підпроцес, що викликали, продукує якісь дані на виході, він запише ці дані до вказаної змінної. Далі, якщо є потреба використати отримані дані в основному процесі, то необхідно звернутися до змінної, де ці дані зберігаються.
+
image:bp-modeling/bp/element-temp/call-activity/element-temp-call-activity-4.png[]

[#element-temp-system-digital-signature]
==== Делегат виклику підпроцесу для підпису даних системним ключем (System digital signature)

Розширення *System digital signature* -- специфікований делегат для виклику підпроцесу підпису даних системним ключем, що налаштовується за допомогою розробленого однойменного шаблону *System digital signature* (_systemDigitalSignatureCallActivity.json_).

NOTE: Перед налаштуванням шаблону в Сamunda Modeler переконайтеся, що папка із застосунком _resources_ -> _element-templates_ містить файл _systemDigitalSignatureCallActivity.json_.

[configure-temp]
===== Налаштування шаблону

. Створіть *Call Activity*.

+
image:bp-modeling/bp/element-temp/call-activity/element-temp-call-activity-1.png[]

. На панелі налаштувань справа натисніть кнопку `Open Catalog`, оберіть відповідний шаблон *System digital signature* зі списку та натисніть `Apply` для підтвердження.

+
image:bp-modeling/bp/element-temp/call-activity/element-temp-call-activity-2.png[]

+
image:bp-modeling/bp/element-temp/call-activity/element-temp-call-activity-system-digital-signature-1.png[]

. Виконайте подальші налаштування:

* У полі `Name` вкажіть назву задачі (наприклад, `call-activity-task`).
* У полі `Input data` вкажіть вхідні дані, які необхідно підписати та передати бізнес-процесу, що викликається -- `${payload}`. Параметри мають передаватися у вигляді пар _ключ-значення_.
* У полі `Output variable name` вкажіть назву змінної -- `system_signature_ceph_key`, до якої необхідно зберегти системний ключ для підпису, отриманий в результаті виконання підпроцесу, що викликається.
+
TIP: Якщо підпроцес, що викликали, продукує якісь дані на виході (тут -- системний ключ для підпису), він запише ці дані до вказаної змінної. Далі, якщо є потреба використати отримані дані в основному процесі, то необхідно звернутися до змінної, де ці дані зберігаються.
+
image:bp-modeling/bp/element-temp/call-activity/element-temp-call-activity-system-digital-signature-2.png[]

NOTE: Всі інші атрибути, як то `Called Element`, `CallActivity Type` тощо, необхідні для налаштування Call Activity вручну, без використання шаблону, визначаються автоматично, "під капотом".

[#element-temp-check-excerpt-status]
==== Делегат виклику підпроцесу для перевірки статусу витягу (Check excerpt status)

Розширення *Check excerpt status* -- специфікований делегат для виклику підпроцесу перевірки статусу витягу, що налаштовується за допомогою розробленого однойменного шаблону *Check excerpt status* (_checkExcerptStatusCallActivity.json_).

NOTE: Перед налаштуванням шаблону в Сamunda Modeler переконайтеся, що папка із застосунком _resources_ -> _element-templates_ містить файл _checkExcerptStatusCallActivity.json_.

[comfigure-temp]
===== Налаштування шаблону

. Створіть *Call Activity*.

+
image:bp-modeling/bp/element-temp/call-activity/element-temp-call-activity-1.png[]

. На панелі налаштувань справа натисніть кнопку `Open Catalog`, оберіть відповідний шаблон *Check excerpt status* зі списку та натисніть `Apply` для підтвердження.

+
image:bp-modeling/bp/element-temp/call-activity/element-temp-call-activity-2.png[]

+
image:bp-modeling/bp/element-temp/call-activity/element-temp-call-activity-check-excerpt-status-1.png[]

. Виконайте подальші налаштування:

* У полі `Name` вкажіть назву задачі (наприклад, `call-activity-task`).
* У полі `Input excerpt identifier` вкажіть ID витягу, який необхідно передати бізнес-процесу, що викликається (наприклад, `${excerptIdentifier}`).
* У полі `Output variable name` вкажіть назву змінної, до якої необхідно зберегти статус витягу, отриманий в результаті виконання підпроцесу, що викликається (наприклад, `excerptStatusOutput`).
+
TIP: Якщо підпроцес, що викликали, продукує якісь дані на виході (тут -- статус витягу), він запише ці дані до вказаної змінної. Далі, якщо є потреба використати отримані дані в основному процесі, то необхідно звернутися до змінної, де ці дані зберігаються.
+
image:bp-modeling/bp/element-temp/call-activity/element-temp-call-activity-check-excerpt-status-2.png[]

NOTE: Всі інші атрибути, як то `Called Element`, `CallActivity Type` тощо, необхідні для налаштування Call Activity вручну, без використання шаблону, визначаються автоматично, "під капотом".