= Налаштування бізнес-ключів у бізнес-процесах
:toc:
:toclevels: 5
:toc-title: ЗМІСТ
:sectnums:
:sectanchors:

Поточний документ описує розширення можливостей моделювання бізнес-процесів за допомогою бізнес-ключів.

== Загальний опис

*Бізнес-ключ* (*Business Key*) -- це специфічний ідентифікатор екземпляра бізнес-процесу в https://camunda.com/bpmn/reference[Camunda BPM]. Він виступає як додатковий атрибут, що застосовується при моделюванні бізнес-процесів для їх однозначної ідентифікації, а також ідентифікації користувацьких задач процесу.

TIP: Зверніться до https://camunda.com/blog/2018/10/business-key/[офіційного джерела] для отримання детальної інформації щодо бізнес-ключів в Camunda.

Бізнес-ключем може виступати будь-який один атрибут або сполучення бізнес-значимих атрибутів конкретного бізнес-процесу чи користувацької задачі.

За допомогою бізнес-ключа користувач може відрізнити один бізнес-процес від іншого (або одну користувацьку задачу від іншої) _в переліку бізнес-задач особистих Кабінетів посадової особи та отримувача послуг_.

== Випадки використання бізнес-ключів

При моделюванні бізнес-ключ може застосовуватись для:

. xref:#bp-key-start[Ідентифікації бізнес-процесу на старті процесу].
. xref:#bp-key-start-message-event[Ідентифікації бізнес-процесу на старті процесу, що ініційований стартовою подією «Повідомлення»].
. xref:#bp-key-bp-stage[Ідентифікації бізнес-процесу на етапі виконання процесу].

[#bp-key-start]
== Створення та налаштування бізнес-ключа на старті бізнес-процесу

Для створення бізнес-ключа на старті бізнес-процесу, необхідно виконати наступні кроки:

. Відкрийте додаток **Camunda Modeler** та створіть нову **діаграму BPMN**, натиснувши кнопку `BPMN diagram`.

В результаті з`явиться вікно нової діаграми.

image:registry-develop:bp-modeling/bp/modeling-instruction/bp-1.png[]

[start=2]
. Перетягніть елемент *Create Pool/Participant* до панелі моделювання (_див. xref:registry-develop:bp-modeling/bp/bp-modeling-instruction.adoc#create-pool-participant[Додавання елемента Create pool/Participant]_).

NOTE: Моделювання діаграми бізнес-процесу має відбуватися в рамках елемента *Create Pool/Participant*.

[start=3]
. Додайте та налаштуйте початкову подію:
* З панелі інструментів зліва перетягніть елемент коло (*Create StartEvent*) до панелі моделювання:
+
image::registry-develop:bp-modeling/bp/bp-keys/bp-keys-create-start-event.png[]
+
image::registry-develop:bp-modeling/bp/bp-keys/bp-keys-create-start-event-1.png[]
* Натисніть на елемент *Create StartEvent* та на панелі налаштувань справа сконфігуруйте початкову подію:
** На вкладці *General* налаштуйте основні параметри для старту бізнес-процесу (_див. xref:registry-develop:bp-modeling/bp/bp-modeling-instruction.adoc#initial-event[Налаштування початкової події]_).
** На вкладці *Forms*, у полі `Form key` вкажіть службову назву форми, параметри якої передаватимуться функції `submission()` при виконанні процесу.
+
image::bp-modeling/bp/bp-keys/bp-keys-create-start-event-02.png[]
** На вкладці *Extensions* налаштуйте параметри бізнес-ключа:
*** у полі `Add Property` натисніть `+` (позначку плюса) та зазначте такі налаштування:
**** для параметра `Name` вкажіть `businessKeyExpression`;
**** у полі `Value` вкажіть вираз, що встановлює значення бізнес-ключа, використовуючи функцію `submission()` (_див. xref:registry-develop:bp-modeling/bp/modeling-facilitation/modelling-with-juel-functions.adoc#submission-fn[Функція submission()]_).
+
image::bp-modeling/bp/bp-keys/bp-keys-create-start-event-2.png[]
+
.Приклад. Функція submission()
[source, juel]
----
${submission('<id початкової події>').formData.prop('<Property Name атрибут1>').value()+" "+submission('<id початкової події>').formData.prop('<Property Name атрибут2>').value()}
----

+
[CAUTION]
====
Для створення виразу `businessKeyExpression` необхідно попередньо визначити, який саме атрибут чи сполучення атрибутів ідентифікуватиме цей бізнес-процес.

Для Кабінетів користувача (посадової особи та отримувача послуг реєстру) результатом виразу `businessKeyExpression` є текстове поле, що складається із конкатенованих, тобто поєднаних, значень атрибутів полів, вказаних у виразі.
====

=== Приклад створення бізнес-процесу внесення паспортних даних особи

Розглянемо приклад створення бізнес-процесу внесення паспортних даних особи із використанням бізнес-ключа та функції `submission()`.

. При моделюванні вказуємо для параметра `businessKeyExpression` (вираз бізнес-ключа) наступне значення:
+
.Приклад. Функція submission()
[source, juel]
----
${submission('<id початкової події>').formData.prop('<Property Name  атрибут1>').value()+" "+submission('id початкової події ').formData.prop('<Property Name атрибут2>').value()}
----

[TIP]
====
* Змінній `<Property Name  атрибут1>` може відповідати, наприклад, параметр `surname` (прізвище користувача).
* Змінній `<Property Name  атрибут2>` може відповідати, наприклад, параметр `name` (ім'я користувача).
* Змінна `<id початкової події>` повинна містити ідентифікатор початкової події, в рамках якої застосовуються бізнес-ключі. ID призначається автоматично при моделюванні події, але може також визначатися вручну (наприклад, `StartEvent_1`).
====

[start=2]
. Підставимо необхідні значення змінних та отримаємо такий вираз:
+
.Приклад. Функція submission() із підстановкою параметрів
[source, juel]
----
${submission('StartEvent_1').formData.prop('surname').value()+" "+submission('StartEvent_1').formData.prop('name').value()}
----

[start=3]
. В результаті, на xref:#_моделювання_користувацьких_форм_для_налаштування_бізнес_ключів[інтерфейсі користувацьких форм] сформований бізнес-ключ буде представлено двома полями: `Прізвище` (API-атрибут -- `surname`) та `Ім'я` (API-атрибут -- `name`).

[#bp-key-start-message-event]
== Створення та налаштування бізнес-ключа на старті бізнес-процесу, що ініційований стартовою подією «Повідомлення»

Для створення бізнес-ключа на старті бізнес-процесу, що ініційований стартовою подією «Повідомлення», необхідно виконати наступні кроки:

. Відкрийте додаток **Camunda Modeler** та створіть нову **діаграму BPMN**, натиснувши кнопку `BPMN diagram`.

В результаті з`явиться вікно нової діаграми.

image:registry-develop:bp-modeling/bp/modeling-instruction/bp-1.png[]

[start=2]
. Перетягніть елемент *Create Pool/Participant* до панелі моделювання (_див. xref:registry-develop:bp-modeling/bp/bp-modeling-instruction.adoc#create-pool-participant[Додавання елемента Create pool/Participant]_).

NOTE: Моделювання діаграми бізнес-процесу має відбуватися в рамках елемента *Create Pool/Participant*.

[start=3]
. Додайте та налаштуйте початкову подію:
* З панелі інструментів зліва перетягніть елемент коло (*Create StartEvent*) до панелі моделювання:
+
image::registry-develop:bp-modeling/bp/bp-keys/bp-keys-create-start-event.png[]
+
image::registry-develop:bp-modeling/bp/bp-keys/bp-keys-create-start-event-1.png[]

* Виділіть елемент *Create StartEvent*, натисніть на іконку ключа та оберіть тип стартової події, що ініціює бізнес-процес -- *Message Start Event*.
+
image:bp-modeling/bp/bp-keys/bp-keys-create-start-message-event.png[]

* На панелі налаштувань справа сконфігуруйте початкову подію:
** На вкладці *General* налаштуйте параметри події;
+
TIP: За детальною інформацією щодо налаштування події «Повідомлення» зверніться до сторінки xref:registry-develop:bp-modeling/bp/events/message-event.adoc[Налаштування стартової події «Повідомлення»].

** На вкладці *Extensions* налаштуйте параметри бізнес-ключа:
*** У полі `Add Property` натисніть `+` (позначку плюса) та вкажіть такі налаштування:
**** для параметра `Name` вкажіть `businessKeyExpression`;
**** у полі `Value` вкажіть вираз, що встановлює значення бізнес-ключа, використовуючи функцію `submission()` (_див. xref:registry-develop:bp-modeling/bp/modeling-facilitation/modelling-with-juel-functions.adoc#submission-fn[Функція submission()]_).

+
image:bp-modeling/bp/bp-keys/bp-keys-create-start-message-event-1.png[]

TIP: Приклад використання бізнес-ключа за допомогою функції `submission()` дивіться у розділі xref:#_приклад_створення_бізнес_процесу_внесення_паспортних_даних_особи[].

//TODO: Clarify with dev
////
[IMPORTANT]
====
Параметри функції `submission()` можуть братися з інтерфейсної форми попереднього бізнес-процесу, але також можуть використовуватися і параметри, надіслані за допомогою події Message Event. Такі параметри можуть приходити на стартову форму у вигляді пар певних параметрів та їх значень -- в такому разі функція `submission()` братиме дані не з користувацької форми, а з тих параметрів, які надійшли у повідомленні Message Event.
====
////

[#bp-key-bp-stage]
== Налаштування ключа бізнес-процесу на етапі виконання процесу

Існує також можливість змоделювати та налаштувати бізнес-ключ на етапі виконання бізнес-процесу.

[IMPORTANT]
====
Для моделювання та налаштування бізнес-ключа, бізнес-процес має містити хоча б одну попередньо змодельовану користувацьку форму (xref:registry-develop:bp-modeling/bp/bp-modeling-instruction.adoc#_створення_та_налаштування_користувацької_задачі_user_task_внести_запис_довідника[користувацька задача] або стартова подія).
====

Для створення бізнес-ключа на етапі виконання бізнес-процесу, необхідно виконати наступні кроки:

. Додайте  сервісну задачу  до бізнес-процесу:
* Вкажіть тип задачі, натиснувши іконку ключа (*Change type*) та оберіть з меню пункт *Service Task*.
+
image::bp-modeling/bp/bp-keys/bp-keys-process-stage-service-task.png[]

. Виділіть сервісну задачу, відкрийте вкладку *General* та перейдіть до каталогу шаблонів. Для цього у полі *Template* натисніть кнопку `Open Catalog` та оберіть відповідний шаблон *Define process business key*.
* Натисніть `Apply` для підтвердження.
+
image::bp-modeling/bp/bp-keys/bp-keys-process-stage.png[]
+
image::bp-modeling/bp/bp-keys/bp-keys-process-stage-1.png[]

. На панелі налаштувань заповніть наступні параметри:

* у полі `Name` введіть назву сервісної задачі (тут -- `Сервісна задача 1`);
* у полі `Business key` вкажіть вираз, що встановлює значення бізнес-ключа, використовуючи функцію `submission()` (_див. xref:registry-develop:bp-modeling/bp/modeling-facilitation/modelling-with-juel-functions.adoc#submission-fn[Функція submission()]_):
+
.Приклад. Функція submission()
[source, juel]
----
${submission('<id початкової події/ User Form id>').formData.prop('<Property Name атрибут1>').value()+" "+submission('<id початкової події/ User Form id').formData.prop('<Property Name атрибут2>').value()}
----
+
TIP: Приклад використання бізнес-ключа за допомогою функції `submission()` дивіться у розділі xref:#_приклад_створення_бізнес_процесу_внесення_паспортних_даних_особи[].
+
image:bp-modeling/bp/bp-keys/bp-keys-process-stage-template-params.png[]

. В результаті сервісна задача є налаштованою та доступною у бізнес-процесі.

[#bp-keys-forms-usage]
== Налаштування ключів бізнес-процесу за допомогою функції submission() для використання у користувацьких формах

Ключі бізнес-процесів, створені в рамках моделювання BPMN-діаграм відображаються користувацьких форм під час проходження бізнес-процесу користувачем.

Розглянемо приклад такого відображення бізнес-ключів у користувацьких формах із застосуванням JUEL-функції `submission()`, що використовується при моделюванні бізнес-процесів.

TIP: Застосування такої функції у бізнес-процесі наочно показано в рамках розділу xref:#bp-key-start[].

.Приклад. Використання атрибутів бізнес-ключів у функції submission()
[source, juel]
----
${submission('Usertask').formData.prop('<Property Name атрибут1>').value()+" "+submission('Usertask').formData.prop('<Property Name атрибут2>').value()}
----

[TIP]
====
* Параметр `Usertask` є ідентифікатором користувацької задачі `Користувацька задача 1`.

Таким чином для бізнес-ключа, що налаштовується у xref:#bp-key-bp-stage[`Сервісній задачі 1`], використовуються атрибути із `Користувацької задачі 1`. Дані налаштовуються за допомогою функції `submission()`.

CAUTION: Заповніть поле `Form key` значенням xref:#_налаштування_ключів_бізнес_процесу_при_моделюванні_користувацьких_форм[службової назви форми], пов'язаної з конкретною користувацькою задачею бізнес-процесу (тут -- `add-usertask`).

image:bp-modeling/bp/bp-keys/bp-keys-process-stage-template-params-userform.png[]

* Змінні `<Property Name атрибут1>` та `<Property Name атрибут2>` -- параметри поля `Property Name`, що використовуються для API-форм користувача (вкладка *API*) в Кабінеті адміністратора регламентів.
====

=== Моделювання користувацьких форм для налаштування бізнес-ключів

TIP: За деталями щодо процесу моделювання форм зверніться до сторінки xref:bp-modeling/forms/registry-admin-modelling-forms.adoc[].

Щоб змоделювати користувацькі форми для подальшого налаштування ключів бізнес-процесу, необхідно виконати наступні кроки:

. Увійдіть до Кабінету адміністратора регламентів, створіть користувацьку форму до бізнес-процесу та налаштуйте бізнес-ключ:

* На панелі компонентів зліва оберіть компонент *Text Field* та перетягніть його до панелі моделювання:
image:bp-modeling/bp/bp-keys/bp-keys-admin-portal-form-1.png[]

* У вікні, що відкрилося, на вкладці *Display*, у полі `Label` введіть значення змінної `<Property Name атрибут 1>` -- `Прізвище`.
image:bp-modeling/bp/bp-keys/bp-keys-admin-portal-form-4.png[]

* Перейдіть на вкладку *API* та у полі `Property Name` введіть службову назву атрибута `Прізвище`, що використовуватиметься у функції `submission()` при моделюванні бізнес-процесу в Camunda, тобто параметр для API-ендпоінту (тут -- `surname`).
* Натисніть кнопку `Save`, щоб зберегти зміни.
image:bp-modeling/bp/bp-keys/bp-keys-admin-portal-form-5.png[]

* На панелі компонентів зліва оберіть новий компонент *Text Field* та перетягніть його до панелі моделювання.

* У вікні, що відкрилося, на вкладці *Display*, у полі `Label` введіть значення змінної `<Property Name атрибут 2>` -- `Ім'я`.
image:bp-modeling/bp/bp-keys/bp-keys-admin-portal-form-2.png[]

* Перейдіть на вкладку *API* та у полі `Property Name` введіть службову назву атрибута `Ім'я`, що використовуватиметься у функції `submission()` при моделюванні бізнес-процесу в Camunda, тобто параметр для API-ендпоінту (тут -- `name`).
* Натисніть кнопку `Save`, щоб зберегти зміни.
image:bp-modeling/bp/bp-keys/bp-keys-admin-portal-form-3.png[]
+
* В результаті отримаємо форму бізнес-процесу із двома полями для вводу даних користувача, що виконуватимуть роль бізнес-ключів (`surname` та `name`).

* Збережіть змодельовану користувацьку форму, натиснувши кнопку `Створити форму` у правому верхньому куті.
image:bp-modeling/bp/bp-keys/bp-keys-admin-portal-form-6.png[]

* Приєднайте створену форму до бізнес-процесу за службовою назвою форми:
** У полі `Form key` при моделюванні бізнес-процесу введіть значення параметра `Службова назва форми` (тут -- `add-usertask`).









