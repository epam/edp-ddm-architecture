= Глобальний підпроцес (Call Activity)
:toc:
:toc-title: ЗМІСТ
:toclevels: 5
:sectanchors:
:sectnums:
:sectnumlevels: 5

== Загальний опис

*Call Activity* (або підпроцес, який можна використовувати повторно) -- це стандартний елемент BPMN-моделювання, що підтримує Camunda Engine, який дозволяє викликати інший процес як частину поточного процесу. Він подібний до xref:bp-modeling/bp/bpmn/subprocesses/embedded-subprocess.adoc[вбудованого підпроцесу], але є зовнішнім, тобто змодельованим в рамках окремого пулу бізнес-процесу, і може використовуватися неодноразово та декількома різними батьківськимиfootnote:[_Батьківський_ або _основний_ процес (*Parent process*) -- процес, що ініціює запуск підпроцесу. Відносно батьківського процесу підпроцес є *Child*-процесом (*Child process*).] бізнес-процесами.

image:bp-modeling/bp/subprocesses/call-activities/bp-call-activity-01.png[]

[NOTE]
====
У Camunda BPMN виклики глобального, тобто зовнішнього підпроцесу, можуть виконуватися між процесами, що змодельовані в окремих файлах _.bpmn_, або ж в рамках одного файлу _.bpmn_. Таким чином один незалежний бізнес-процес може запускати інший і навпаки.

Платформа реєстрів наразі підтримує лише один тип -- виклик глобального підпроцесу з основного (батьківського) процесу. З глобального підпроцесу можна також виконати виклик Call Activity -- підпроцес 2-го рівня (_див. xref:#restrictions[]_).

.Приклад. Виклик між процесами, змодельованими в окремих файлах BPMN
image:bp-modeling/bp/subprocesses/call-activities/call-activity-separate-bpmn.png[]

.Приклад. Виклик підпроцесу із основного процесу в рамках одного файлу BPMN
image:bp-modeling/bp/subprocesses/call-activities/call-activity-same-bpmn.png[]

====

Коли елемент Call Activity вводиться в дію, створюється новий екземпляр процесу, на який він посилається. Новий екземпляр процесу активується під час події none startfootnote:[*None events* є невизначеними подіями, які також називаються «порожніми».]. Процес може мати стартові події інших типів, але вони ігноруються.

[NOTE]
====
Коли створений екземпляр процесу завершується, дія виклику припиняється, і продовжується виконання вихідного потоку послідовності.

Іншими словами як тільки виконано виклик Call Activity, процес, що ініціював виклик (основний процес), чекає на завершення глобального підпроцесу, і тільки після цього продовжується.
====

== Типи розширень шаблонів елементів Call Activity

Для спрощення моделювання бізнес-процесів в рамках Платформи реєстрів, імплементовано декілька типів розширень (делегатів), що налаштовуються за допомогою розроблених шаблонів елементів для виклику зовнішніх процесів (Call Activity):

. xref:registry-develop:bp-modeling/bp/bp-element-templates-installation-configuration.adoc#bp-element-temp-call-activity-call-activity[*Call Activity*] -- загальний шаблон для виклику глобального (зовнішнього) підпроцесу.
. xref:registry-develop:bp-modeling/bp/bp-element-templates-installation-configuration.adoc#element-temp-system-digital-signature[*System digital signature*] -- специфікований шаблон для виклику підпроцесу підпису даних системним ключем.
. xref:registry-develop:bp-modeling/bp/bp-element-templates-installation-configuration.adoc#element-temp-check-excerpt-status[*Check excerpt status*] -- специфікований шаблон для виклику підпроцесу перевірки статусу витягу.

CAUTION: Варто розрізняти Call Activity як стандартний BPMN-елемент і Call Activity як розширення цього самого елемента, що налаштовується за допомогою розробленого шаблону _callActivity.json_, призначеного для виклику глобального (зовнішнього) підпроцесу.

[#element-temp-call-activity]
== Моделювання бізнес-процесів із застосуванням розширень Call Activity

Розглянемо застосування BPMN-елемента Call Activity із використанням розробленого шаблону-розширення _callActivity.json_ для виклику глобальних підпроцесів на прикладі бізнес-процесів оформлення онлайн-замовлення (_далі -- основний або батьківський процес_) та підтвердження цього замовлення (_далі -- підпроцес_).

image:bp-modeling/bp/subprocesses/call-activities/bp-call-activity-1.png[]

[TIP]
====
На етапі моделювання необхідно створити 2 пули бізнес-процесів та зберегти їх в рамках одного файлу _.bpmn_.
====

=== Етапи моделювання процесів

Для того, щоб змоделювати 2 процеси (у нашому випадку -- це основний процес та глобальний підпроцес) із застосуванням Call Activity, необхідно пройти наступні етапи:

. xref:#create-pool-bp-1[].
. xref:#bp-start-event[].
. xref:#bp-user-form-insert-data-online-order[].
. xref:#bp-call-activity[].
. xref:#create-pool-bp-2[].
* xref:#bp-start-event-called-process[].
* xref:#bp-user-form-approval-decision[].
* xref:#bp-script-task[].
* xref:#bp-end-event-called-process[].
. xref:#bp-user-form-order-payment[].
. xref:#bp-end-event-caller-process[].

[#create-pool-bp-1]
=== Створення пулу для основного бізнес-процесу

Найперше, _змоделюйте пул для основного бізнес-процесу_. Для цього виконайте кроки, подані нижче:

NOTE: Моделювання діаграми бізнес-процесу має відбуватися в рамках елемента *Create Pool/Participant*.

. Відкрийте додаток *Camunda Modeler* та створіть нову діаграму BPMN. Для цього у лівому верхньому куті натисніть меню *File* -> *New File* -> *BPMN Diagram*.
+
image:registry-develop:bp-modeling/bp/modeling-instruction/bp-1.png[]

. На панелі інструментів зліва знайдіть елемент *Create pool/Participant* та перетягніть його до панелі моделювання.
+
image:registry-develop:bp-modeling/bp/modeling-instruction/bp-2.png[]

. Заповніть наступні поля відповідними значеннями:

* У полі `Participant Name` введіть назву пулу, що відображатиметься у моделері -- `Оформлення замовлення на сайті`.
* У полі `Process id` введіть ідентифікатор бізнес-процесу -- `create-order`.
* У полі `Process Name` вкажіть бізнес-назву процесу -- `Оформлення замовлення на сайті`.

+
image:bp-modeling/bp/subprocesses/call-activities/bp-call-activity-2.png[]

[#bp-start-event]
=== Моделювання стартової події основного процесу

_Створіть початкову подію_. Для цього виконайте наступні кроки:

. На панелі інструментів, зліва, знайдіть елемент (коло) *CreateStartEvent* та перетягніть його до панелі моделювання.
. На панелі налаштувань справа заповніть наступні параметри відповідними значеннями:
* У полі `Name` введіть назву початкової події -- `Кошик`;
* У полі `Initiator` введіть `initiator`.

+
TIP: `initiator` -- спеціальна змінна, що встановлюється для користувача, який розпочав процес.

+
image:bp-modeling/bp/subprocesses/call-activities/bp-call-activity-3.png[]

[#bp-user-form-insert-data-online-order]
=== Моделювання користувацької задачі внесення даних онлайн-замовлення

Далі _створіть користувацьку задачу, призначену для введення даних користувачем_. Для цього виконайте наступні кроки:

. Створіть нову задачу, вкажіть її тип, натиснувши іконку ключа та обравши з меню пункт *User Task* (Користувацька задача).

. На панелі налаштувань справа натисніть `Open Catalog`, оберіть шаблон *User Form* (Користувацька форма) та натисніть `Apply` для підтвердження.

. На панелі налаштувань справа заповніть наступні поля:

* У полі `Id` вкажіть ідентифікатор задачі -- `user-form-1`.
+
TIP: ID задачі призначається автоматично, за замовчуванням. Введіть значення вручну, якщо це необхідно.

* У полі `Name` вкажіть назву задачі -- `Форма введення даних онлайн-замовлення`.
* У полі `Form key` введіть ключ форми, що відповідатиме службовій назві форми для внесення даних -- `add-order-bp-add-order-test`.
* У полі `Assignee` вкажіть змінну, що використовується для зберігання користувача, який запустив екземпляр процесу, -- `${initiator}`.

+
image:bp-modeling/bp/subprocesses/call-activities/bp-call-activity-4.png[]

[#bp-call-activity]
=== Моделювання Call Activity для виклику зовнішнього підпроцесу

На цьому етапі необхідно _змоделювати *Call Activity* (виклик глобального підпроцесу із зовнішнього пулу)_. Для цього виконайте кроки, подані нижче:

TIP: Приклад налаштування делегата Call Activity наведено за xref:registry-develop:bp-modeling/bp/bp-element-templates-installation-configuration.adoc#bp-element-temp-call-activity-call-activity[посиланням].

. Створіть елемент *Call Activity*.
. Виконайте подальші налаштування:

* У полі `Name` вкажіть назву елемента -- `Рішення щодо підтвердження замовлення`.
* У полі `Called Element` вкажіть ідентифікатор глобального xref:#create-pool-bp-2[підпроцесу, що викликатиметься], -- `order-confirm`.
* У полі `Input data` вкажіть вхідні дані, які необхідно передати бізнес-процесу, що викликається. Параметри мають передаватися у вигляді пар _ключ-значення_ (тут -- `${submission('user-form-1').formData}`).

+
TIP: За деталями щодо використання функції `submission()` у бізнес-процесах перейдіть на сторінку xref:registry-develop:bp-modeling/bp/modeling-facilitation/modelling-with-juel-functions.adoc[].

* У полі `Output variable name` вкажіть назву змінної, до якої необхідно записати дані (payload), отримані в результаті виконання підпроцесу, що викликається (тут -- `callActivityOutput`).

+
image:bp-modeling/bp/subprocesses/call-activities/bp-call-activity-5.png[]

NOTE: Таким чином поточна конфігурація запускає xref:#create-pool-bp-2[глобальний підпроцес] із основного пулу. Основний процес не може завершитися, доки виконується глобальний підпроцес.

[#create-pool-bp-2]
=== Створення пулу для глобального підпроцесу

На прикладі xref:#create-pool-bp-1[], _змоделюйте пул для глобального підпроцесу_.

. На панелі інструментів зліва знайдіть елемент *Create pool/Participant* та перетягніть його до панелі моделювання.
+
image:registry-develop:bp-modeling/bp/modeling-instruction/bp-2.png[]

. Заповніть наступні поля відповідними значеннями:

* У полі `Participant Name` введіть назву пулу, що відображатиметься у моделері -- `Рішення щодо підтвердження замовлення`.
* У полі `Process id` введіть ідентифікатор бізнес-процесу -- `order-confirm`.
* У полі `Process Name` вкажіть бізнес-назву процесу -- `Рішення щодо підтвердження замовлення`.

+
image:bp-modeling/bp/subprocesses/call-activities/bp-call-activity-6.png[]

[#bp-start-event-called-process]
=== Моделювання стартової події глобального підпроцесу

На прикладі xref:#bp-start-event[], _створіть стартову подію підпроцесу_.

Для цього виконайте наступні кроки:

. На панелі інструментів, зліва, знайдіть елемент (коло) *CreateStartEvent* та перетягніть його до панелі моделювання.
. На панелі налаштувань справа заповніть наступні параметри відповідними значеннями:
* У полі `Name` введіть назву початкової події -- `Отримання даних замовлення`.
* У полі `Initiator` введіть `initiator`.

+
TIP: `initiator` -- спеціальна змінна, що встановлюється для користувача, який розпочав процес.

+
image:bp-modeling/bp/subprocesses/call-activities/bp-call-activity-7.png[]

[#bp-user-form-approval-decision]
=== Моделювання користувацької задачі "Рішення про погодження онлайн-замовлення"

На прикладі xref:#bp-user-form-insert-data-online-order[], _створіть задачу "Рішення про погодження онлайн-замовлення"_. Для цього виконайте кроки, подані нижче:

. Створіть нову задачу, вкажіть її тип, натиснувши іконку ключа та обравши з меню пункт *User Task* (Користувацька задача).

. На панелі налаштувань справа натисніть `Open Catalog`, оберіть шаблон *User Form* (Користувацька форма) та натисніть `Apply` для підтвердження.

. На панелі налаштувань справа заповніть наступні поля:

* У полі `Id` вкажіть ідентифікатор задачі -- `user-form-2`.
+
TIP: ID задачі призначається автоматично, за замовчуванням. Введіть значення вручну, якщо це необхідно.

* У полі `Name` вкажіть назву задачі -- `Рішення про погодження онлайн-замовлення`.
* У полі `Form key` введіть ключ форми, що відповідатиме службовій назві форми для внесення даних -- `add-order-bp-order-confirm-test`.
* У полі `Assignee` вкажіть змінну, що використовується для зберігання користувача, який запустив екземпляр процесу, -- `${initiator}`.

+
image:bp-modeling/bp/subprocesses/call-activities/bp-call-activity-8.png[]

[#bp-script-task]
=== Моделювання задачі скриптування для підготовки даних до виведення

На цьому етапі необхідно _створити задачу скриптування для обробки даних та підготовки їх до виведення_.

[TIP]
====
Задача має на меті за допомогою groovy-скрипту із виконанням функції `submission()` взяти дані, введені користувачем на формі, обробити їх, сформувати вивід у форматі JSON та записати його до змінної `callActivityOutput`, зазначеної у полі `Output variable name` при моделюванні xref:#bp-call-activity[Call Activity] основного процесу.
====

. Створіть нову задачу, вкажіть її тип, натиснувши іконку ключа та обравши з меню пункт *Script Task* (Задача скриптування).

. На панелі налаштувань справа заповніть наступні поля:

* У полі `Name` вкажіть назву задачі -- `Підготовка даних до виведення`.
* У полі `Script Format` вкажіть формат скрипту -- `groovy`.
* У полі `Script Type` вкажіть тип скрипту -- `Inline Script`.
* У полі `Script` введіть безпосередньо groovy-скрипт:
+
[source,groovy]
----
var data = submission('user-form-2').formData
execution.removeVariable('outputPayload')
set_transient_variable('outputPayload', S(data, 'application/json'))
----

+
image:bp-modeling/bp/subprocesses/call-activities/bp-call-activity-9.png[]

[#bp-end-event-called-process]
=== Моделювання події завершення глобального підпроцесу

На цьому етапі необхідно _створити подію, яка завершуватиме глобальний підпроцес_.

. Створіть подію завершення бізнес-процесу.

. На панелі налаштувань справа для параметра `Name` вкажіть значення `Замовлення підтвержено`.

+
image:bp-modeling/bp/subprocesses/call-activities/bp-call-activity-10.png[]

TIP: Дані, отримані в результаті виконання глобального підпроцесу "Рішення щодо підтвердження замовлення", записуються до змінної `callActivityOutput`, зазначеної у полі `Output variable name` при моделюванні xref:#bp-call-activity[Call Activity] основного процесу, і можуть бути використані на xref:#bp-user-form-order-payment[формі для оплати замовлення] у основному процесі. Після цього продовжується виконання основного процесу.

[#bp-user-form-order-payment]
=== Моделювання користувацької задачі для оплати онлайн-замовлення

На прикладі xref:#bp-user-form-insert-data-online-order[] _створіть користувацьку задачу, призначену для оплати замовлення користувачем_. Для цього виконайте наступні кроки:

. Створіть нову задачу, вкажіть її тип, натиснувши іконку ключа та обравши з меню пункт *User Task* (Користувацька задача).

. На панелі налаштувань справа натисніть `Open Catalog`, оберіть шаблон *User Form* (Користувацька форма) та натисніть `Apply` для підтвердження.

. На панелі налаштувань справа заповніть наступні поля:

* У полі `Name` вкажіть назву задачі -- `Оплата онлайн-замовлення`.
* У полі `Form key` введіть ключ форми, що відповідатиме службовій назві форми для внесення даних -- `add-order-bp-view-order-test`.
* У полі `Assignee` вкажіть змінну, що використовується для зберігання користувача, який запустив екземпляр процесу, -- `${initiator}`.

+
image:bp-modeling/bp/subprocesses/call-activities/bp-call-activity-11.png[]

[#bp-end-event-caller-process]
=== Моделювання події завершення основного процесу

На цьому етапі необхідно _створити подію, яка завершуватиме основний процес_.

. Створіть подію завершення бізнес-процесу.

. На панелі налаштувань справа для параметра `Name` вкажіть значення `Замовлення сплачено`.

+
image:bp-modeling/bp/subprocesses/call-activities/bp-call-activity-12.png[]

[#restrictions]
== Обмеження рівнів вкладеності при викликах підпроцесів за допомогою Call Activity

Існують певні обмеження на Платформі щодо кількості рівнів вкладеності бізнес-процесів при викликах глобальних підпроцесів за допомогою делегата Call Activity.

[CAUTION]
====
Для правильної роботи функціональності виклику глобальних процесів із застосуванням делегата Call Activity, використовуйте не більше 3-х рівнів вкладеності бізнес-процесів, тобто основний процес, глобальний підпроцес 1-го рівня та глобальний підпроцес 2-го рівня.
====



