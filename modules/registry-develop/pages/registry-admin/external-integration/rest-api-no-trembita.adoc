:toc-title: ЗМІСТ
:toc: auto
:toclevels: 5
:experimental:
:important-caption:     ВАЖЛИВО
:note-caption:          ПРИМІТКА
:tip-caption:           ПІДКАЗКА
:warning-caption:       ПОПЕРЕДЖЕННЯ
:caution-caption:       УВАГА
:example-caption:           Приклад
:figure-caption:            Зображення
:table-caption:             Таблиця
:appendix-caption:          Додаток
:sectnums:
:sectnumlevels: 5
:sectanchors:
:sectlinks:
:partnums:

= Інтеграційна REST-взаємодія реєстрів на Платформі

== Загальний опис

Платформа підтримує [.underline]#інтеграційну взаємодію реєстрів# за допомогою *REST API*-інтерфейсів. Така взаємодія можлива завдяки [.underline]#Підсистемі міжреєстрових інтеграцій#.

Функціональність забезпечує інтероперабельність Платформи з можливістю надавати доступи до бізнес-процесів та API читання даних, а також дозволяє читати дані та викликати бізнес-процеси в інших реєстрах.

За замовчуванням на Платформі використовується інтеграційна взаємодія між реєстрами через шлюз безпечного обміну (ШБО) https://trembita.gov.ua/ua[«Трембіта»]. Така взаємодія здійснюється за протоколом SOAP та вимагає розв'язання підготовчих питань у юридичній площині (_див. детальніше -- xref:registry-develop:registry-admin/external-integration/registration-subsystem-trembita/registration-subsystem-trembita.adoc[]_).

Міжреєстрова взаємодія за допомогою REST дозволяє зменшити надлишкове використання обчислювальних потужностей, зовнішнього трафіку, скоротити час відповіді при інтеграції між реєстрами, не використовуючи SOAP-інтерфейси ШБО «Трембіта», а також відійти від складних бюрократичних механізмів.

Основні функції підсистеми міжреєстрових інтеграцій: ::

* [*] Надання API для виклику бізнес-процесів реєстру сторонніми для реєстру системами.

* [*] Надання доступу іншим реєстрам або системам до окремих запитів читання Підсистеми управління даними реєстру.

* [*] Маршрутизація запитів до зовнішніх реєстрів, до яких було надано доступ.

== Схеми міжреєстрової REST-взаємодії

Виділяють 2 схеми інтеграційної взаємодії реєстрів, що розгорнуті на Платформі: ::

* xref:#int-registry-ext-system[]
* xref:#platform-registries[]

[#int-registry-ext-system]
=== REST-взаємодія реєстрів на Платформі із зовнішньою інформаційною системою

Інтеграційну взаємодію реєстрів із зовнішніми системами можна поділити на [.underline]#вихідну# та [.underline]#вхідну#, залежно від напряму трафіку.

.Взаємодія реєстрів на Платформі зі сторонньою інформаційною системою
image::registry-develop:registry-admin/external-integration/rest-api-no-trembita/int-reg-ext-system.png[]

. [.underline]#Вихідна взаємодія# можлива завдяки інтеграційному [.underline]#REST-конектору# *Connect to external system*. Конектор має REST-інтерфейс для виклику зовнішніх ендпоінтів. Його можна використовувати при моделюванні бізнес-процесів у регламенті певного реєстру. Для автентифікації необхідно використовувати OpenShift (Kubernetes) секрети.

. [.underline]#Вхідна взаємодія# можлива завдяки імплементованим реєстровим сервісам `*external-system-api-kong-proxy*` та `*registry-rest-api-ext*`.
+
[NOTE]
Зовнішня система має спочатку отримати пароль доступу від адміністратора реєстру. З цим паролем -- отримати токен доступу у сервісі Keycloak. З цим токеном надалі можливо авторизуватися у сервісах та отримувати доступ до ресурсів.

* Сервіс `*external-system-api-kong-proxy*` розгортається автоматично, разом з реєстром та має REST-інтерфейс, що дозволяє ініціювати бізнес-процеси у реєстрах на Платформі та отримувати з них дані. Сервіс використовує точку входу (ендпоінт) `*/startBp*` для старту бізнес-процесу.

* Сервіс `*registry-rest-api-ext*` розгортається автоматично, після створення моделі даних у регламенті реєстру. Він дозволяє звертатися до API-представлень операційної бази даних реєстру.

[#platform-registries]
=== REST-взаємодія реєстрів в межах одного екземпляра Платформи

При інтеграційній взаємодії реєстрів в межах Платформи завжди є [.underline]#реєстр-клієнт (споживач/запитувач даних)# та [.underline]#цільовий реєстр (власник даних)#.

.REST-взаємодія реєстрів в межах одного екземпляра Платформи
image::registry-develop:registry-admin/external-integration/rest-api-no-trembita/internal-registries-platform.png[]

Реєстр-клієнт може запитати дані у цільового реєстру 2-ма шляхами: ::
+
[NOTE]
Реєстр-клієнт має спочатку отримати токен доступу іншого реєстру у сервісі Keycloak. З цим токеном надалі можливо авторизуватися у сервісах.

. Через сервіс `*bp-webservice-gateway*` -- розгортається автоматично, разом з реєстром та має REST-інтерфейс, що дозволяє ініціювати бізнес-процеси у реєстрах на Платформі та отримувати з них дані. Сервіс використовує точку входу (ендпоінт) `*/startBp*` для старту бізнес-процесу.
+
[NOTE]
====
* Ініціювати бізнес-процеси в іншому (цільовому) реєстрі можливо за допомогою спеціального розширення-делегата -- *Start business process in another registry*. Він призначений _лише_ для інтеграції реєстрів у межах Платформи.

* Отримати дані з операційної БД реєстру іншого (цільового) реєстру в рамках виконання бізнес-процесів можливо за допомогою спеціального розширення-делегата -- *Search for entities from another registry data factory*. Він призначений _лише_ для інтеграції реєстрів у межах Платформи.
====

. Через сервіс `*registry-rest-api-ext*` -- розгортається автоматично, після створення моделі даних у регламенті реєстру. Він дозволяє звертатися до API-представлень операційної бази даних реєстру з форм Кабінету користувача (за критеріями пошуку).

== Налаштування взаємодії між реєстрами

Налаштуйте REST-взаємодію з іншими реєстрами в межах одного екземпляра Платформи, або зовнішніми системами.

* Якщо ваш реєстр отримує запити та віддає дані, зверніться до розділу xref:#target-registry-setup[].
* Якщо ваш реєстр запитує дані з інших реєстрів на Платформі, зверніться до розділу xref:#client-registry-setup[].

* Для зовнішніх систем важливо отримати токен доступу до реєстру з Keycloak, щоб використовувати його при подальшій авторизації у сервісах реєстру. Приклад реалізації логіки отримання токена через Postman дивіться на сторінці xref:#get-access-token-keycloak[].

* Окремим сценарієм є налаштування вихідної взаємодії із зовнішніми системами, при якій реєстру на Платформі необхідно викликати інші системи. Це можна зробити за допомогою REST-конектора (_дивіться розділ xref:#rest-connector[]_).

[#target-registry-setup]
=== Налаштування цільового реєстру (власника даних)

Налаштуйте взаємодію з іншими реєстрами для цільового реєстру (власника даних): ::

. xref:#regulations-settings[Виконайте налаштування на рівні регламенту реєстру (доступ для виклику бізнес-процесу)].
. xref:#target-registry-bp-modeling[Змоделюйте бізнес-процес, що викликатиметься іншим реєстром].
. xref:#create-data-model[Створіть модель даних (надайте доступ на читання даних реєстру через API-представлення)]
. xref:#cp-add-access-to-registry[Надайте доступ до реєстру для іншого реєстру на Платформі, або зовнішньої системи через адміністративну панель Control Plane].

[#regulations-settings]
==== Налаштування регламенту цільового реєстру (власника даних)

Адміністратор реєстру має виконати налаштування на рівні регламенту.

[NOTE]
====
Виконайте налаштування у 2-х конфігураційних файлах:

* _bp-auth/external-system.yml_ -- відповідає за доступ до бізнес-процесів;
* _trembita/external-system.yml_ -- відповідає за обмін даними для ініціювання/старту бізнес-процесу.
====

. Налаштуйте доступ до бізнес-процесів у цільовому реєстрі, які братимуть участь в обміні даними.
+
Для цього перейдіть до файлу _bp-auth/external-system.yml_ у регламенті та визначте конфігурацію:
+
.Конфігураційний файл для надання доступу до бізнес-процесів у цільовому реєстрі
====
[source,yaml]
----
authorization:
  realm: 'external-system'
  process_definitions:
    - process_definition_id: 'my-process-id'
      process_name: 'Назва вашого бізнес-процесу'
      process_description: 'Опис вашого бізнес-процесу'
      roles:
        - 'trembita-invoker'
----
====
+
У цьому прикладі ми вказуємо, що доступ необхідно надати до бізнес-процесу `my-process-id` для ролі `*trembita-invoker*` з Keycloak-реалму `*-external-system*`. Параметри `process_name` та `process_description` є опціональними, і не впливають на процес авторизації
+
IMPORTANT: Клієнт `*trembita-invoker*` з однойменною роллю створюється автоматично оператором Keycloak в реалмі `*-external-system*` при розгортанні реєстру. Облікові дані цього клієнта необхідно використовувати для всіх зовнішніх систем, яким потрібен доступ до реєстру на Платформі.

. Сконфігуруйте файл _trembita/external-system.yml_ у регламенті:

* Налаштуйте змінні старту бізнес-процесу. Для цього вкажіть, які параметри очікуватиме бізнес-процес у блоці `start_vars`.
+
NOTE: Без цього бізнес-процес не запрацює.

* Налаштуйте змінні повернення. Для цього вкажіть, які параметри повертатиме бізнес-процес у блоці `return_vars`.
+
.Налаштування API-контракту для бізнес-процесу
====
[source,yaml]
----
trembita:
  process_definitions:
    - process_definition_id: 'my-process-id'
      start_vars:
        - eduname
      return_vars:
        - id
        - name
----
====
+
У цьому прикладі ми вказуємо, що для старту бізнес-процесу `*my-process-id*` у цільовому реєстрі, необхідно передати стартові змінні. Без них бізнес-процес не буде ініційований. Тут ми передаємо параметр `eduname` -- умовне ім'я учня.
+
[NOTE]
====
Стартові параметри (змінні) передаються як *`Map`* вхідних параметрів (*Input Parameters*), тобто як _ключ-значення_ при налаштуванні делегата для старту бізнес-процесу.

.Формування стартових змінних процесу у реєстрі-клієнті для передачі до цільового реєстру
image::registry-admin/external-integration/rest-api-no-trembita/pass-map-params-bp.png[]

.Приймання стартових змінних процесу у цільовому реєстрі
image::registry-admin/external-integration/rest-api-no-trembita/accept-map-params-bp.png[]
====
+
Також налаштуйте змінні повернення. Тут ми налаштовуємо, що бізнес-процес повертатиме параметри `id` та `name`. Вони будуть записані до змінної результату в *Output Parameters* цієї ж сервісної задачі з делегатом.

[#target-registry-bp-modeling]
==== Моделювання бізнес-процесу для виклику у цільовому реєстрі

Змоделюйте бізнес-процес, до якого звертатимуться інші реєстри для отримання даних. Це може бути будь-який процес, передбачений бізнес-логікою вашого реєстру.

[TIP]
====
Скористайтеся прикладом такого бізнес-процесу у вкладенні:

* _link:{attachmentsdir}/bp-modeling/rest-api-no-trembita/BPMN-create-school-auto-sign.bpmn[BPMN-create-school-auto-sign.bpmn]_
====

[#create-data-model]
==== Налаштування моделі даних

Створіть модель даних реєстру. Додайте нові критерії пошуку, що надаватимуть доступ на читання даних БД через API-представлення реєстру.

[TIP]
Детальніше про налаштування моделі даних ви можете переглянути на сторінці xref:registry-develop:data-modeling/data/physical-model/rest-api-view-access-to-registry.adoc[].

[#cp-add-access-to-registry]
==== Надання доступу до реєстру в Control Plane

Платформа має зручний інтерфейс для керування реєстрами -- адміністративну панель *Control Plane*. Адміністратор може додавати, видаляти, або призупиняти доступ до реєстру для інших реєстрів на Платформі та зовнішніх систем.

TIP: Деталі дивіться на сторінці xref:admin:registry-management/control-plane-registry-grant-access.adoc[].

[#client-registry-setup]
=== Налаштування реєстру-клієнта (споживача даних)

Налаштуйте взаємодію з іншими реєстрами для реєстру-споживача даних. Для цього: ::
+
. Змоделюйте бізнес-процес з можливістю виклику зовнішнього реєстру.
+
[TIP]
====
Скористайтеся прикладом такого бізнес-процесу у вкладенні: _link:{attachmentsdir}/bp-modeling/rest-api-no-trembita/BPMN-create-school-auto.bpmn[BPMN-create-school-auto.bpmn]_
====

. В рамках бізнес-процесу використовуйте типові інтеграційні розширення для взаємодії з іншими реєстрами на Платформі:

* старту бізнес-процесів в іншому реєстрі на Платформі -- для цього використовуйте типове інтеграційне розширення-конектор *Start business process in another registry*;
* отримання даних з операційної БД іншого реєстру на Платформі -- для цього використовуйте типове інтеграційне розширення-конектор *Search for entities from another registry data factory*.
+
[TIP]
Опис та налаштування делегатів ви можете знайти на сторінці xref:registry-develop:bp-modeling/bp/element-templates/rest-integration-registries/rest-integration-registries-overview.adoc[].

. Змоделюйте UI-форму для читання даних з операційної БД реєстру за критеріями пошуку (search condition). Це дозволить звертатися до БД іншого реєстру з користувацької форми. Для цього:

* Перейдіть до [.underline]#Кабінету адміністратора регламентів# > Відкрийте розділ [.underline]#UI-форми# > Створіть форму введення даних > Відкрийте [.underline]#Конструктор форм#.
* У компоненті *Select* перейдіть на вкладку *Data* > У полі `*Data Source URL*` введіть шлях до ресурсу у фабриці даних іншого реєстру:
+
.Поле Data Source URL на UI-формі
====
----
/api/integration/data-factory/test-registry/resource-name
----


|===
| Параметр/Шлях | Опис

| `/api/integration/data-factory`
| Кореневий шлях (не змінюється).

| `test-registry`
| Службова назва цільового реєстру, вказана у Control Plane.

| `resource-name`
| Назва ресурсу/ендпоінту, до якого звертатися для отримання даних. Наприклад, `/edu-type`.
|===

====
+
.Запит до БД іншого реєстру за критерієм пошуку з UI-форми користувача
image::registry-admin/external-integration/rest-api-no-trembita/create-sc-data-source-url.png[]

[#get-access-token-keycloak]
=== Отримання токена авторизації зовнішніми системами

Щоб отримати дозвіл на звернення до ресурсів реєстру, зовнішня система має отримати спеціальний токен доступу -- JWT-токен. Він призначений для подальшої авторизації зовнішніх систем при взаємодії з реєстрами, що розгорнуті в межах Платформи.

TIP: Детальніше дивіться на сторінці xref:registry-develop:registry-admin/external-integration/api-publish/get-jwt-token-postman.adoc[].

[#rest-connector]
=== Вихідна інтеграція із зовнішніми системами

Якщо необхідно інтегруватися із зовнішнім сервісом, або системою, що знаходиться поза кластером Платформи, використовуйте спеціальний REST-конектор -- *Connect to external system*.

[TIP]
Детальніше дивіться на сторінці xref:registry-develop:bp-modeling/bp/rest-connector.adoc[].

=== Пов'язані сторінки

Опис функціональності охоплює пов'язані сторінки з документацією. Вони подані списком у цьому розділі для зручності.

* xref:admin:registry-management/control-plane-registry-grant-access.adoc[]
* xref:registry-develop:data-modeling/data/physical-model/rest-api-view-access-to-registry.adoc[]
* xref:registry-develop:bp-modeling/bp/element-templates/rest-integration-registries/rest-integration-registries-overview.adoc[]
* xref:registry-develop:registry-admin/external-integration/api-publish/get-jwt-token-postman.adoc[]
* xref:registry-develop:bp-modeling/bp/rest-connector.adoc[]