:toc-title: ЗМІСТ
:toc: auto
:toclevels: 5
:experimental:
:important-caption:     ВАЖЛИВО
:note-caption:          ПРИМІТКА
:tip-caption:           ПІДКАЗКА
:warning-caption:       ПОПЕРЕДЖЕННЯ
:caution-caption:       УВАГА
:example-caption:           Приклад
:figure-caption:            Зображення
:table-caption:             Таблиця
:appendix-caption:          Додаток
:sectnums:
:sectnumlevels: 5
:sectanchors:
:sectlinks:
:partnums:

= Відправка повідомлень користувачам через електронну пошту

== Передумови



Наразі платформа підтримує відправлення електронних повідомлень з використанням SMTP у якості протоколу комунікації та однієї з наступних опцій налаштувань поштового сервера в залежності від вимог реєстру: "платформенний поштовий сервер" або "зовнішній поштовий сервер".

Попередньо необхідно виконати налаштування каналів зв'язку для відправки повідомлень користувачам реєстру.

[NOTE]
====
Детальну інформацію щодо налаштування відправки повідомлень можна отримати за посиланнями:

* xref:registry-develop:registry-admin/config-smtp-server.adoc[]
* xref:admin:installation/internal-smtp-server-setup.adoc[]
====

Відправка повідомлень системою можлива лише зареєстрованим користувачам.

== Налаштування шаблону повідомлення

Для реалізаціії функціональності відправки повідомлень користувачам кабінету через електронну пошту у вигляді email необхідно створити шаблон повідомлення, що буде використовуватися під час моделювання бізнес-процесу.

Шаблон повідомлення необхідно створити у вигляді HTML за допомогою технології шаблонізації  Apache FreeMarker (розширення файлів ".ftlh" та ".ftl" для HTML та текстових документів відповідно).

[NOTE]
====
Детальну інформацію щодо Apache FreeMarker можливо отримати за посиланням:

* https://freemarker.apache.org/
====

Для забезпечення вимог щодо підтримки відправлення повідомлень користувачам, структуру регламенту розширено додатковою директорією _<registry-regulation>/notifications_. Типовий шаблон поштового повідомлення має наступну структуру:

[plantuml, email-notification-structure, svg]
----
@startsalt
{
{T
+ <&folder> registry-regulation
++ ...
++ <&folder> notifications
+++ <&folder> email
++++ <&folder> <b><template-directory></b>
+++++ <&folder> css
++++++ <&file> style.css
+++++ <&folder> images
++++++ <&file> image.jpg
++++++ <&file> ...
+++++ <&file> notification.ftlh
++++ ...
}
}
@endsalt
----

- _``<template-directory>``_ -- директорія з ресурсами шаблону, яка має унікальне ім'я для заданого каналу зв'язку;

- _``<template-directory>/css/style.css``_ -- "єдиний CSS-файл стилів, які використовуються в HTML-документі (Приклад: _<link rel="stylesheet" href="css/style.css">_);

- _``<template-directory>/images/*.*``_ -- перелік файлів зображень, які використовуються в HTML-документі (Приклад: _<img src="images/image.jpg">_);

- _``<template-directory>/notification.ftlh``_ -- HTML-документ шаблону для подальшої генерації тіла повідомлення.

image:registry-develop:registry-admin/e-mail-notification/e-mail-notification-01.png[]

//Шаблон має відповідати загальній стилізації реалізованих кабінетів користувачів Платформи та стайл-гайдів додатку "Дія".

== Моделювання бізнес-процесів

Розглядаються два основних сценарії моделювання відправки повідомлень у межах моделювання бізнес-процесів:

* xref:#send-user-notification[відправка повідомлень одному користувачу];
* xref:#send-many-user-notifications[відправка повідомлень багатьом користувачам].

[#send-user-notification]
=== Відправка повідомлень одному користувачу

Для моделювання бізнес-процесу використовується типове розширення для задач на відправлення повідомлення (Send Task), а саме:

* _Відправлення повідомлення користувачу_ - *Send User Notification*

Розширення *Send User Notification* -- використовується для відправлення повідомлень електронною поштою користувачам кабінетів, з використанням заданого шаблону в HTML-вигляді.

[NOTE]
====
Перед налаштуванням шаблону в Сamunda Modeler переконайтеся, що папка із застосунком _resources → element-templates_ містить _sendUserNotification.json_
====

Для налаштування шаблону виконайте наступні кроки:

. Створіть Send Task.
+
image:registry-develop:registry-admin/e-mail-notification/e-mail-notification-02.png[]

. В Send Task, натисніть кнопку `Open Catalog` та оберіть шаблон (template) Send User Notification, для підтвердження натисніть `Apply`.
+
image:registry-develop:registry-admin/e-mail-notification/e-mail-notification-03.png[]

. Виконайте подальші налаштування:

* у полі `name` -- вкажіть назву задачі (наприклад, `Відправка email користувачу`);

* у полі `Recipient` -- вкажіть унікальний ідентифікатор <username> отримувача повідомлення (наприклад, `${initiator().userName}`);

* у полі `Subject` -- вкажіть текстову назву для використання у якості теми повідомлення (наприклад, `Email successfully generated`);

* у полі `Notification message template` -- вкажіть унікальну назву _FreeMarker_-шаблону для формування тіла повідомлення, яка відповідає назві директорії шаблону згідно структури _<registry-regulation>/notifications/<channel>/<template_name>/*.*_ (наприклад, `add-lab-template`).

* у полі `Notification template model` -- вкажіть набір даних для генерації тіла повідомлення на базі шаблона (наприклад, `${templateModel}`).

[#send-many-user-notifications]
=== Відправка повідомлень багатьом користувачам

Для відправлення повідомлень багатьом користувачам моделювання бізнес-процесу відбувається за аналогією з xref:#send-user-notification[моделюванням бізнес-процесу відправки повідомлення одному користувачу], за виключенням використання функції мультиекземпляра (Multi Instance). Ця функція дозволяє виконати одночасне відправлення повідомлень усім зазначеним користувачам із масиву.

image:registry-develop:registry-admin/e-mail-notification/e-mail-notification-07.png[]

* у полу `Collection` -- вказується масив користувачів;
* у полі `Element Variable` -- зазначається локальна змінна екземпляра під заданим іменем.

Процес відправки повідомлення не блокує основний потік виконання бізнес-процесу та виконується асинхронно.

[NOTE]
====
Детальніше ознайомитися з функцією Multi Instance ви можете за посиланням:

* https://docs.camunda.io/docs/0.26/reference/bpmn-workflows/multi-instance/[Multi-Instance]
====


=== Пов'язані делегати для отримання користувачів

З метою отримання списку користувачів кабінетів для відправки повідомлень доступні типові розширення для сервісних задач:

* делегат `getCitizenUsersByAttributesFromKeycloak` -- використовується для пошуку користувачів Кабінету отримувачів послуг у Keycloak за їх атрибутами.

* делегат `getUsersByAttributesFromKeycloak` -- використовується для пошуку користувачів Кабінету посадових осіб у Keycloak за їх атрибутами.

[NOTE]
====
Детальну інформацію щодо налаштування делегатів можна отримати за посиланнями:

* xref:registry-develop:bp-modeling/bp/bp-element-templates-installation-configuration.adoc#_пошук_користувачів_у_keycloak_за_їх_атрибутами[Пошук користувачів (посадових осіб) у Keycloak за їх атрибутами];
* xref:fffff[Пошук користувачів (отримувачів послуг) у Keycloak за їх атрибутами].
====

////
Пошук користувачів у Keycloak за їх атрибутами

Розширення *Get citizen users by attributes from keycloak* -- делегат `${getCitizenUsersByAttributesFromKeycloak}`, для якого імплементовано однойменний шаблон *Get citizen users by attributes from keycloak*, представлений у вигляді JSON-файлу _getCitizenUsersByAttributesFromKeycloak.json_.

Делегат потрібний для того, щоб при виконанні бізнес-процесу отримувати список користувачів (отримувачів послуг) за певними атрибутами із сервісу керування ідентифікацією та доступом Keycloak.

[NOTE]
====
Перед налаштуванням шаблону в Сamunda Modeler переконайтеся, що папка із застосунком _resources → element-templates містить файл getCitizenUsersByAttributesFromKeycloak.json._
====

_Налаштування шаблону:_

. Змоделюйте нову задачу.
. Визначте її тип, натиснувши іконку ключа та обравши з меню пункт Service Task (сервісна задача).
+
image:registry-develop:registry-admin/e-mail-notification/e-mail-notification-04.png[]

. Перейдіть до панелі налаштувань справа та застосуйте делегат *Get citizen users by attributes from keycloak*. Для цього оберіть відповідний шаблон із каталогу (`Open Catalog`) та натисніть `Apply` для підтвердження.
+
image:registry-develop:registry-admin/e-mail-notification/e-mail-notification-05.png[]

. 4.	Виконайте подальші налаштування:
*	У полі `Name` вкажіть назву задачі. Наприклад, `Отримати список отримувачів послуг із Keycloak`.
*	У полі `Edrpou attribute value` вкажіть значення атрибута edrpou. Наприклад, `11111111`.
+
[NOTE]
====
Значення атрибута `edrpou` є обов’язковим для заповнення. Його можна передати як напряму (тобто ввести код ЄДРПОУ, наприклад, 11111111), так і через функцію `submission()`, вказавши ID останньої користувацької задачі (наприклад, `userTaskId`).
====

*	У полі `Drfo attribute value` вкажіть значення атрибута drfo. Наприклад, `2222222222`.
+
[NOTE]
====
Значення атрибута drfo є опціональним. Його можна передати як напряму (тобто ввести код ДРФО, наприклад, 2222222222), так і через функцію submission(), вказавши ID останньої користувацької задачі (наприклад, 'userTaskId').
====
*	У полі `Result variable` вкажіть назву змінної, до якої необхідно зберегти відповідь -- `citizenUsersByAttributes`.
+
[CAUTION]
====
В результаті запита отримуємо список користувачів із Keycloak за їх атрибутами, який зберігатиметься у змінній `citizenUsersByAttributes`.
*	Якщо користувач передає лише значення параметра `edrpou`, то сервіс повертає список _усіх отримувачів послуг_ відповідної організації.
*	Якщо користувач передає значення параметрів `edrpou` та `drfo`, то сервіс повертає список з іменем _конкретного отримувача послуг_ відповідної організації.
====

+
image:registry-develop:registry-admin/e-mail-notification/e-mail-notification-06.png[]

////