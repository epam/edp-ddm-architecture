= API Рейт-ліміти
:toc:
:toclevels: 5
:toc-title: ЗМІСТ
:sectnums:
:sectnumlevels: 5
:sectanchors:

Метою рейт-лімітів є обмеження кількості HTTP запитів до сервісу чи
маршруту за заданий період секунд, хвилин, годин, днів, місяців або
років. Механізм рейт-лімітів реалізований на базі
https://docs.konghq.com/hub/kong-inc/rate-limiting/[Rate-Limiting]
плагіна для Kong API Gateway. Якщо сервіс/маршрут не має рівня
аутентифікації, ліміт буде встановлено для IP-адреси клієнта, в іншому
випадку для лімітів можна використовувати значення власного заголовка
запиту, що містить інформацію про користувача, наприклад, ідентифікатор
користувача, його роль чи ідентифікатор організації яку він представляє.
Такий заголовок можна додати засобами Kong OIDC плагіну. Проте тут
важливо щоб rate-limiting плагін виконувався після OIDC плагіна, тобто
пріоритет OIDC плагіна був вищий за значення пріоритету для
rate-limiting плагіна який за замовчуванням становить 1000
(https://github.com/Kong/kong/blob/master/kong/plugins/rate-limiting/handler.lua#L49[OidcHandler.PRIORITY
= 1000]). Даний механізм більш детально описаний нижче.

[WARNING]
====
Всі рейт-ліміти обчислюються виключно в межах одного екземпляру Kong API
Gateway. Якщо кількість екземплярів Kong більше одного то загальна
кількість запитів від користувача може бути більшою в _n_ разів за
значення встановлене в налаштуваннях для лімітів, де n це кількість
розгорнутих екземплярів Kong API Gateway. 
====

image:registry-admin/Kong-Rate-Limits.drawio.png[Kong рейт-ліміти]

== Принцип роботи рейт-лімітів для неавтентифікованих користувачів

Для неавтентифікованих користувачів можливо встановити ліміт лише за IP
адресою (config.limit_by: ip). Такий ліміт працюватиме виключно для
публічних АПІ які не потребують автентифікації, адже в разі наявності
автентифікації OIDC плагін, який виконується першим, повертатиме
користувачу HTTP 403 (Forbidden) помилку до того як запит надійде до
Rate-limiting плагіна. 

[plantuml]
----
include::partial$registry-admin/api-rate-limiting-unauthenticated-user.puml[]
----


[arabic]
. Користувач надсилає запит до платформи який надходить до Kong API
Gateway.
. Запит обробляється Kong Rate-Limiting плагіном який базуючись на
правилах для конкретного сервісу/маршруту визначає чи досягнуто ліміт
запитів для IP-адреси користувача.
. Якщо ліміту запитів від користувача не досягнуто, запит
перенаправляється на відповідний сервіс платформи для подальшого
опрацювання
. Користувач отримує відповідь від сервіса
. Якщо ліміт запитів досягнуто, Rate-Limiting плагін повертає відповідь
з помилкою - HTTP 429

== Принцип роботи рейт-лімітів для автентифікованих користувачів

Якщо сервіс/маршрут має рівень автентифікації то в такому разі ліміт
може бути встановлено не лише  для IP-адреси клієнта але і для
конкретного автентифікованого користувача чи їх групи. Для цього для
обчислення ліміту можна використовувати значення власного заголовка
запиту, що містить інформацію про користувача, наприклад, його
ідентифікатор, роль чи ідентифікатор організації яку він представляє.
Такий заголовок можна додати засобами Kong OIDC
плагіну.

[plantuml]
----
include::partial$registry-admin/api-rate-limiting-authenticated-user.puml[]
----

[arabic]
. Користувач надсилає запит до платформи який надходить до Kong API
Gateway.
. Першим запит обробляє Kong OIDC плагін який перевіряє сесію
користувача. Якщо користувач успішно пройшов автентифікацію (існує
активна сесія) то OIDC плагін додає до запиту заголовки з JWT токенами
користувача та заголовок "token-claim" що містить значення атрибута
(claim) з токена доступу автентифікованого користувача. В подальшому
значення цього заголовку використовується rate-limiting плагіном для
обчисленя лімітів для автентифікованого користувача чи групи таких
користувачів.
. Обробка запиту передається в наступний плагін - Rate-Limiting
. Rate-Limiting плагін базуючись на правилах для конкретного
сервісу/маршруту визначає чи досягнуто ліміт запитів для користувача.
Ліміт може бути встановлений як за IP адресою так і на основі значення
"token-claim" заголовка.
. Якщо ліміту запитів від користувача не досягнуто, запит
перенаправляється на відповідний сервіс платформи для подальшого
опрацювання
. Користувач отримує відповідь від сервіса
. Якщо ліміт запитів досягнуто, Rate-Limiting плагін повертає відповідь
з помилкою - HTTP 429

[header-setup-unauth-user]
=== Налаштування власного заголовка для автентифікованого користувача

Для обчислення лімітів для автентифікованих користувачів можна
використовувати значення "token-claim" заголовока запиту що містить
інформацію про користувача. Встановити значення для цього заголовку
можна в налаштуваннях OIDC плагіна для Kong. Даний заголовок може
містити значення корінного атрибуту (claim) з JWT токену доступу
користувача.

Приклад налаштування OIDC плагіна KONG для додавання "token-claim"
заголовка:

[source,yaml]
.OIDC Config
-----------------
config:
  token_claim_header_value: "sub"
-----------------

В даному випадку після обробки запиту OIDC плагіном, до запиту буде
додано заголовок "token-claim" значення для якого буде взято з "sub"
атрибуту (claim) токена доступу користувача. Тобто ми отримає заголовок
"token-claim" що містить ідентифікатор користувача. В подальшому цей
заголовок можна використати в rate-limiting плагіні для обчислення
ліміту по ідентифікатору користувача.

[source,yaml]
.Rate-Limiting Config
-----------------
config:
 limit_by: header
 header_name: "token-claim"
-----------------

Для більш складних варіантів обчислення ліміту можна додати власний
атрибут до JWT токену що містить значення яке обчислюються. Зробити це
можна засобами KeyCloack protocol mappersю

== Налаштування рейт-лімітів адміністратором

image:registry-admin/Rate-limit-configuration.drawio.png[]

[arabic]
. Адміністратор створює або редагує конфігураційний файл в форматі yaml
з налаштуваннями для OIDC та Rate-Limiting розширень Kong API Gateway
. Адміністратор зберігає зміни в Gerrit репозиторії у відповідному
каталозі
. Запускається задача Jenkins яка перевіряє наявність змін в репозиторії
та застосовує змінену конфігурацію для всіх екземплярів Kong API Gateway
запущених в кластері Openshift . 

Опис налаштувань Rate-Limiting плагіна є в його офіційній
https://docs.konghq.com/hub/kong-inc/rate-limiting/#implementation-considerations[документації].
Проте для того щоб налаштувати ліміти для автентифікованих
користувачів чи їх груп що об`єднані за певним атрибутом неоюхідно
спершу додати до запиту заголовки з потрібними атрибутами. Базуючись на
значеннях цих атрибутів Rate-Limiting плагін зможе рахувати ліміти для
кожного автентифікованого користувача чи групи індивідуально. Додати до
запиту заголовки з атрибутами користувача можна з допомогою OIDC плагіна
який дозволяє додати власний заголовок із значенням з JWT токена.
