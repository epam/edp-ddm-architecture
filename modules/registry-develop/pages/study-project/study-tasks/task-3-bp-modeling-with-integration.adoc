= Завдання 3. Моделювання бізнес-процесу з інтеграцією
:sectanchors:
:sectnums:
:sectnumlevels: 5
:toc:
:toclevels: 5
:toc-title: ЗМІСТ

== Мета завдання

Виконання цього завдання має на меті: ::

* Навчити моделювати бізнес-процес, що має інтеграцію з фабрикою даних.
* Навчити моделювати гілки у бізнес-процесі.
* Навчити моделювати уніфіковані кроки у бізнес-процесах  за допомогою `Call Activity`.
* Навчити моделювати форми та налаштовувати компоненти `Select` для отримання даних із фабрики даних.

== Передумови

Перед проходженням завдання необхідно виконати наступні передумови:

. xref:bp-modeling/bp/bp-element-templates-installation-configuration.adoc#business-process-modeler-extensions-installation[Встановіть додаток Camunda Modeler і типові розширення до нього].
. xref:registry-develop:bp-modeling/forms/bp-modeling-forms-general-description.adoc[Ознайомтеся із компонентами FormIO для моделювання форм].

== Процес виконання завдання

[#bp-modeling]
=== Моделювання бізнес-процесу

[TIP]
====
На етапі моделювання бізнес-процесу необхідно створити та зберегти відповідну BPMN-діаграму.

Використовуйте файл _link:{attachmentsdir}/study-project/task-3/bp-schema/add-lab.bpmn[add-lab.bpmn]_ із готовою схемою бізнес-процесу для прикладу.
====

==== Етапи моделювання бізнес-процесу

В рамках цього завдання моделювальник має створити бізнес-процес, що складається з наступних етапів:

. xref:#create-pool-bp[].
. xref:#create-start-event[].
. xref:#create-task-add-lab-data[].
. xref:#create-service-task-search-lab-data[].
. xref:#create-xor-gateway[].
. xref:#create-validation-error-branch[].
. xref:#create-continuation-of-bp-branch[].
. xref:#create-task-lab-data-signing[].
. xref:#create-task-script-data-signing[].
. xref:#create-task-call-activity-data-signing[].
. xref:#call-activity-modeling[].
. xref:#create-service-task-save-data-to-data-factory[].
. xref:#create-service-task-create-entity-end[].
. xref:#create-task-entity-finish[].

CAUTION: *Важливо!* Після проходження всіх етапів, не забудьте зберегти змодельовану схему бізнес-процесу до відповідної папки з регламентом реєстру (_див. xref:#save-bp-schema[Збереження змодельованої схеми бізнес-процесу]_).

[#create-pool-bp]
==== Створення пулу для бізнес-процесу

Найперше, _змоделюйте пул для бізнес-процесу_. Для цього виконайте кроки, подані нижче:

NOTE: Моделювання діаграми бізнес-процесу має відбуватися в рамках елемента *Create Pool/Participant*.

. Відкрийте додаток *Camunda Modeler* та створіть нову діаграму BPMN. Для цього у лівому верхньому куті натисніть меню *File* -> *New File* -> *BPMN Diagram*:
+
image:registry-develop:bp-modeling/bp/modeling-instruction/bp-1.png[]

. На панелі інструментів зліва знайдіть елемент *Create pool/Participant* та перетягніть його до панелі моделювання:
+
image:registry-develop:bp-modeling/bp/modeling-instruction/bp-2.png[]

. Заповніть наступні поля відповідними значеннями:

** у полі `Name` введіть `Створення лабораторії`;
** у полі `Process id` введіть `add-lab`;
** у полі `Process name` вкажіть `Створення лабораторії`.

+
image:registry-develop:study-project/task-3/task-3-1-bp.png[]

[#create-start-event]
==== Створення початкової події

_Створіть початкову подію_. Для цього виконайте наступні кроки:

. На панелі інструментів, зліва, знайдіть елемент (коло) *CreateStartEvent* та перетягніть його до панелі моделювання:
+
image::registry-develop:bp-modeling/bp/bp-keys/bp-keys-create-start-event.png[]
+
image::registry-develop:bp-modeling/bp/bp-keys/bp-keys-create-start-event-1.png[]

. На панелі налаштувань справа заповніть наступні параметри відповідними значеннями:
** у полі `Name` введіть `Початок`;
** у полі `Initiator` введіть `initiator`.

+
image:registry-develop:study-project/task-3/task-3-2-bp.png[]

[#create-task-add-lab-data]
==== Створення користувацької задачі для внесення даних про лабораторію

Далі _створіть користувацьку задачу, призначену для додавання даних користувачем_. Для цього виконайте наступні кроки:

. Оберіть коло з початковою подією, змодельованою на xref:#create-start-event[попередньому етапі], та приєднайте нову задачу, натиснувши іконку *Append Task*:
+
image:study-project/task-3/task-3-3-bp-append-task.png[]

[start=2]
. Вкажіть тип задачі, натиснувши іконку ключа та обравши з меню пункт *User Task* (Користувацька задача):
+
image:study-project/task-3/task-3-3-bp-user-task.png[]

. На панелі налаштувань справа натисніть `Open Catalog`, оберіть шаблон *User Form* (*Користувацька форма*) та натисніть `Apply` для підтвердження:
+
image:study-project/task-3/task-3-3-bp-open-catalog.png[]
+
image:study-project/task-3/task-3-3-bp-user-form.png[]

[start=4]
. На панелі налаштувань справа заповніть наступні поля:

* у полі `Id` зазначте `addLabFormActivity`;
* у полі `Name` введіть `Додати інформацію про лабораторію`;
* у полі `Form key` введіть `add-lab-bp-add-lab`;
* у полі `Assignee` вкажіть `${initiator}`.

+
image:registry-develop:study-project/task-3/task-3-3-bp.png[]

[#create-service-task-search-lab-data]
==== Створення сервісної задачі для пошуку даних про лабораторію

Далі необхідно _створити сервісну задачу (*Service Task*) для пошуку даних про лабораторію_. Для цього виконайте наступні кроки:

. Оберіть прямокутник із користувацькою задачею `Додати інформацію про лабораторію`, змодельованою на xref:#create-task-add-lab-data[попередньому етапі], та приєднайте нову сервісну задачу, натиснувши іконку *Append Task*:
+
image:study-project/task-3/task-3-4-bp-append-task.png[]

. Вкажіть тип задачі, натиснувши іконку ключа та обравши з меню пункт *Service Task* (Сервісна задача):
+
image:study-project/task-3/task-3-4-bp-service-task.png[]

. На панелі налаштувань справа натисніть `Open Catalog`, оберіть шаблон *Search for entities in data factory* (*Пошук значень у фабриці даних*) та натисніть `Apply` для підтвердження:
+
image:study-project/task-3/task-3-4-bp-open-catalog.png[]
+
image:study-project/task-3/task-3-4-bp-choose-temp.png[]

. На панелі налаштувань справа заповніть наступні поля:
* у полі `Id` введіть `searchForLabByNameAndEdrpouActivity`;
* у полі `Name` має бути вказано `Пошук даних про лабораторію (transient var)`;

* у розділі *Input Parameters* -> *Resource* зазначте наступне:
** у полі `Variable Assignment Type` вкажіть `String or Expression`;
** у полі `Variable Assignment Value` вкажіть `laboratory-equal-edrpou-name-count`.

+
image:registry-develop:study-project/task-3/task-3-4-bp.png[]

* у розділі *Input Parameters* -> *Search Variables* вкажіть наступне:
** у полі `Variable Assignment type` вкажіть `Map`.
** у полі `Add Entry` додайте параметри `name` та `edrpou`, натиснувши на позначку плюса (`+`) та вкажіть для них відповідні значення:
+
|===
|Key |Value

|`name` |`${submission('addLabFormActivity').formData.prop('name').value()}`

|`edrpou`
|`${submission('addLabFormActivity').formData.prop('edrpou').value()}`
|===

+
image:registry-develop:study-project/task-3/task-3-5-bp.png[]

* у розділі *Input Parameters* -> *X-Access-Token* вкажіть наступне:
** у полі `Variable Assignment Type` вкажіть `String or Expression`;
** у полі `Variable Assignment Value` вкажіть `${completer('addLabFormActivity').accessToken}`.

+
image:registry-develop:study-project/task-3/task-3-6-bp.png[]

+
* У розділі *Output Parameters* -> *Result Variable* параметр `Assign to Process Variable` заповніть значенням `response`:
+
image:registry-develop:study-project/task-3/task-3-7-bp.png[]

[#create-xor-gateway]
==== Створення та заповнення XOR-шлюзу
Далі необхідно _приєднати XOR-шлюз_. Для цього виконайте кроки, подані нижче:

. Оберіть прямокутник із сервісною задачею `Пошук даних про лабораторію (transient var)`, змодельованою на xref:#create-service-task-search-lab-data[попередньому етапі], та приєднайте XOR-шлюз, натиснувши іконку *Append Gateway*:
+
image:study-project/task-3/task-3-8-bp-append-gw.png[]

. На панелі налаштувань справа вкажіть ID та назву шлюзу:

** у полі `Id` введіть значення `isLaboratoryExistGateway`;
** у полі `Name` введіть значення `Дані присутні?`.

+
image:registry-develop:study-project/task-3/task-3-8-bp.png[]

[#create-validation-error-branch]
==== Створення гілки з валідаційною помилкою
На цьому етапі необхідно _створити гілку з валідаційною помилкою_. Для цього виконайте кроки, подані нижче:

. Оберіть ромб із XOR-шлюзом `Дані присутні?`, змодельованим на xref:#create-xor-gateway[попередньому етапі], та створіть нову сервісну задачу, натиснувши іконку *Append Task*:
+
image:registry-develop:study-project/task-3/task-3-9-bp-append-task.png[]

. Зазначте тип задачі, натиснувши іконку ключа та обравши з меню пункт *Service Task* (Сервісна задача):
+
image:registry-develop:study-project/task-3/task-3-9-bp-service-task.png[]

. Натисніть `Open Catalog`, оберіть шаблон *Throw validation error* та натисніть `Apply` для підтвердження:
+
image:registry-develop:study-project/task-3/task-3-9-bp-open-catalog.png[]
+
image:registry-develop:study-project/task-3/task-3-9-bp-choose-temp.png[]

. На панелі налаштувань справа заповніть наступні поля:
* у полі `Id` введіть `throwDuplicateLabValidationError`;
* у полі `Name` введіть `Формування валідаційної помилки`.

* У розділі *Input Parameters* -> *Validation Errors* зазначте наступне:

** у полі `Variable Assignment Type` вкажіть тип `List`;
** для поля `Value` додайте наступні значення:
+
.Значення 1
[source,json]
----
{"field": "name", "value": "${submission('addLabFormActivity').formData.prop('name').stringValue().replaceAll("\"", "\\\\\"")}", "message": "Дані про цю лабораторію вже присутні"}
----
+
.Значення 2
[source,json]
----
{"field": "edrpou", "value": "${submission('addLabFormActivity').formData.prop('edrpou').value()}", "message": "Дані про цю лабораторію вже присутні"}
----

+
image:registry-develop:study-project/task-3/task-3-9-bp.png[]

. На гілці, що прямує від шлюзу `Дані присутні?` до сервісної задачі `Формування валідаційної помилки`, потрібно налаштувати наступне:
** у полі `Id` введіть `isLaboratoryAlreadyExistFlow`;
** у полі `Name` введіть `так`;
** у полі `Condition Type` введіть тип `Expression`;
** у полі `Expression` введіть `${!response.value.responseBody.elements().isEmpty()}`.

+
image:registry-develop:study-project/task-3/task-3-10-bp.png[]

[#create-continuation-of-bp-branch]
==== Створення гілки з подальшим продовженням бізнес-процесу

На цьому етапі необхідно _створити гілку, що продовжить бізнес-процес_.

Для цього на гілці, що прямує від шлюзу `Дані присутні?` до користувацької задачі `Підписати дані про лабораторію` (_див. нижче xref:#create-task-lab-data-signing[]_) налаштуйте такі параметри:

. У полі `Id` лишіть значення за замовчуванням.
. У полі `Name` вкажіть `ні`.
. у полі `Condition Type` вкажіть `Expression`.
. У полі `Expression` вкажіть `${response.value.responseBody.elements().isEmpty()}`.

+
image:registry-develop:study-project/task-3/task-3-11-bp.png[]

[#create-task-lab-data-signing]
==== Створення користувацької задачі для підпису даних

На цьому етапі необхідно _створити користувацьку задачу для підпису даних_.

На прикладі xref:#create-task-add-lab-data[] змоделюйте нову користувацьку задачу для підпису даних посадовою особою:

. Вкажіть тип задачі, натиснувши іконку ключа та обравши з меню пункт *User Task*.
. На панелі налаштувань справа натисніть `Open Catalog`, оберіть шаблон *Officer Sign Task* та натисніть `Apply` для підтвердження.
. Заповніть наступні поля відповідними значеннями:
* у полі `Id` вкажіть `signLabFormActivity`;
* у полі `Name` введіть `Підписати дані про лабораторію`;
* у полі `Form key` введіть `add-lab-sign-lab-data`;
* у полі `Assignee` вкажіть `${initiator}`;
* у полі `Form data pre-population` введіть `${submission('addLabFormActivity').formData}`.

+
image:registry-develop:study-project/task-3/task-3-12-bp.png[]

[#create-task-script-data-signing]
==== Створення задачі скриптування для підготовки даних до запису (transient var)

На цьому етапі необхідно _змоделювати задачу скриптування для підготовки даних до запису до фабрики даних_. Для цього виконайте наступні кроки:

. Оберіть прямокутник із користувацькою задачею `Підписати дані про лабораторію`, змодельованою на xref:#create-task-lab-data-signing[попередньому етапі], та приєднайте нову задачу, натиснувши іконку *Append Task*:
+
image:study-project/task-3/task-3-13-bp-append-task.png[]

. Вкажіть тип задачі, натиснувши іконку ключа та обравши з меню пункт *Script Task* (Задача скриптування):
+
image:study-project/task-3/task-3-13-bp-script-task.png[]

. Виділіть додану задачу скриптування та налаштуйте наступні параметри:

* у полі `Id` введіть `convertSignFormDataToDataFactoryFormatActivity`;
* у полі `Name` вкажіть `Підготовка даних для запису (transient var)`;
* у полі `Script Format` вкажіть тип (мову) скриптування -- `groovy`;
* у полі `Script Type` вкажіть тип скрипту `InlineScript`;
* у полі `Script` вставте безпосередньо groovy-скрипт:
+
====
[%collapsible]
.Натисніть, щоб розгорнути або згорнути
=====
[source,groovy]
----
        def signedFormData = submission('signLabFormActivity').formData
        signedFormData.prop('oblast', signedFormData.prop('oblast').prop('code').value())

        signedFormData.prop('koatuuId', signedFormData.prop('koatuu').prop('koatuuId').value())
        signedFormData.deleteProp('koatuu')
        signedFormData.prop('ownershipId', signedFormData.prop('ownership').prop('ownershipId').value())
        signedFormData.deleteProp('ownership')

        if(signedFormData.hasProp('premisesFile') && !signedFormData.prop('premisesFile').isNull() &&
!signedFormData.prop('premisesFile').elements().isEmpty()) {
signedFormData.prop('premisesFile', signedFormData.prop('premisesFile').elements()[0])
} else {
signedFormData.prop('premisesFile', null as String)
}
if(signedFormData.hasProp('accreditationFile') && !signedFormData.prop('accreditationFile').isNull() && !signedFormData.prop('accreditationFile').elements().isEmpty()) {
signedFormData.prop('accreditationFile', signedFormData.prop('accreditationFile').elements()[0])
} else {
signedFormData.prop('accreditationFile', null as String)
}

        execution.removeVariable('dataPayload')
        set_transient_variable('dataPayload', signedFormData)
----
=====
====

+
image:registry-develop:study-project/task-3/task-3-13-bp.png[]

[#create-task-call-activity-data-signing]
==== Моделювання Call Activity для підпису даних системним ключем

На цьому етапі необхідно _змоделювати нову задачу *Call Activity* (виклик підпроцесу багаторазового використання) для підпису даних системним ключем_. Для цього виконайте кроки, подані нижче:

. На прикладі xref:#create-task-script-data-signing[попереднього етапу], додайте нову задачу.
. Вкажіть тип задачі, натиснувши іконку ключа та обравши з меню пункт *Call Activity*:
+
image:study-project/task-3/task-3-14-bp-call-activity.png[]

. На панелі налаштувань справа сконфігуруйте параметри для Call Activity:

* На вкладці *General*:
** у полі `Name` введіть `Підписати дані системним ключем`;
** у полі `CallActivity Type` вкажіть тип `BPMN`;
** у полі `Called Element` вкажіть ідентифікатор xref:#call-activity-modeling[стороннього підпроцесу], що викликатиметься, -- `system-signature-bp`;
** у полі `Binding` вкажіть `latest`.
+
image:registry-develop:study-project/task-3/task-3-14-bp.png[]

* На вкладці *Variables*:
** у секції *In Mapping* зазначте наступне:
*** у полі `Type` вкажіть тип `Source`;
*** у полі `Source` вкажіть `dataPayload`;
*** у полі `Target` вкажіть `dataToSign`.
+
image:registry-develop:study-project/task-3/task-3-15-bp.png[]

** у секції *Out Mapping* зазначте наступне:
*** у полі `Type` вкажіть тип `Source`;
*** у полі `Source` вкажіть `system_signature_ceph_key`;
*** у полі `Target` вкажіть `system_signature_ceph_key`.
+
image:registry-develop:study-project/task-3/task-3-16-bp.png[]

[#call-activity-modeling]
==== Моделювання окремого процесу Call Activity

На цьому етапі необхідно _створити нову діаграму BPMN у додатку Camunda Modeler з метою конфігурації зовнішнього процесу Call Activity, що викликатиметься основним процесом_.

Відкрийте нову вкладку із порожньою діаграмою процесу та на панелі налаштувань справа заповніть наступні параметри:

. У полі `Id` вкажіть ідентифікатор процесу -- `system-signature-bp`.
. У полі `Name` введіть `Підписати дані системним ключем`.
. Для параметра `Executable` встановіть прапорець зі значенням `True`.

+
image:registry-develop:study-project/task-3/task-3-17-bp.png[]

===== Створення початкової події

На прикладі xref:#create-start-event[] _змоделюйте початкову подію в рамках нового зовнішнього процесу_ та налаштуйте такі параметри:

. У полі `Name` введіть `Start`.
. У полі `Initiator` вкажіть `initiator`.
+
image:registry-develop:study-project/task-3/task-3-18-bp.png[]

[#create-script-task-prepare-data-for-signing]
===== Створення задачі скриптування "Підготовка даних для системного підпису (transient var)"

. Оберіть коло із початковою подією, доданою на попередньому кроці, та на прикладі xref:#create-task-script-data-signing[] приєднайте нову задачу скриптування `Підготовка даних для системного підпису (transient var)`:

+
image:study-project/task-3/task-3-19-bp-call-activity-script-task.png[]

. Натисніть на задачу скриптування та на панелі налаштувань сконфігуруйте наступні параметри:
* у полі `Name` введіть `Підготовка даних для запису (transient var)`;
* у полі `Script Format` вкажіть формат (мову) скрипту -- `groovy`
* `Script Type` вкажіть тип скрипту -- `InlineScript`;
* у полі `Script` вставте безпосередньо groovy-скрипт:
+
====
[%collapsible]
.Натисніть, щоб розгорнути або згорнути
=====
[source,groovy]
----
  var signObj = ['data':S(dataToSign, 'application/json').toString()]

  execution.removeVariable('dataSignPayload')
  set_transient_variable('dataSignPayload', S(signObj, 'application/json'))
----
=====
====

+
image:registry-develop:study-project/task-3/task-3-19-bp.png[]

[#create-service-task-sign-data-system-key]
===== Створення сервісної задачі "Підписати дані системним ключем"

. На прикладі xref:#create-service-task-search-lab-data[] створіть та приєднайте нову сервісну задачу `Підписати дані системним ключем`, натиснувши іконку ключа та обравши з меню пункт *Service Task*.
. На панелі налаштувань справа натисніть `Open Catalog`, оберіть шаблон *Digital Signature by DSO service* та натисніть `Apply` для підтвердження:
+
image:study-project/task-3/task-3-20-bp-choose-temp.png[]

. Налаштуйте наступні параметри:
** у полі `Name` введіть `Підписати дані системним ключем`;
** у полі `Payload` вкажіть `${dataSignPayload}`;
** у полі `X-Access-Token source` вкажіть `${initiator().accessToken}`;
** у полі `Result Variable` введіть `systemSignatureResponse`.

+
image:registry-develop:study-project/task-3/task-3-20-bp.png[]

===== Створення задачі скриптування "Підготовка даних для запису системного підпису (transient var)"

. На прикладі xref:#create-script-task-prepare-data-for-signing[] створіть та приєднайте скрипт-задачу "Підготовка даних для запису системного підпису (transient var)".

. На панелі налаштувань справа сконфігуруйте наступні параметри:
* у полі `Name` введіть `Підготовка даних для запису системного підпису (transient var)`;
*  у полі `Script Format` формат (мову) скрипту -- `groovy`;
*  у полі `Script Type` вкажіть тип скрипту `InlineScript`;
* у полі `Script` вставте безпосередньо groovy-скрипт:
+
====
[%collapsible]
.Натисніть, щоб розгорнути або згорнути
=====
[source,groovy]
----
  def rootProcessInstanceId = execution.getRootProcessInstanceId()
  def processInstanceId = execution.getProcessInstanceId()

  execution.setVariable('system_signature_ceph_key', "lowcode_${rootProcessInstanceId}_${processInstanceId}_system_signature_ceph_key".toString())

  def systemSignature = systemSignatureResponse.prop('signature').value()

  def cephObj = ['data':S(dataToSign, 'application/json').toString(), 'signature':systemSignature]

  execution.removeVariable('systemSignaturePayload')
  set_transient_variable('systemSignaturePayload', S(cephObj, 'application/json').toString())
----
=====
====

+
image:registry-develop:study-project/task-3/task-3-21-bp.png[]

[#create-service-task-put-system-sign-to-ceph]
===== Створення сервісної задачі "Запис системного підпису до Ceph"

. На прикладі xref:#create-service-task-sign-data-system-key[] створіть та приєднайте нову сервісну задачу `Запис системного підпису до Ceph`, натиснувши іконку ключа та обравши з меню пункт *Service Task*.
. Натисніть `Open Catalog`, оберіть шаблон *Put content to Ceph* та натисніть `Apply` для підтвердження:
+
image:study-project/task-3/task-3-22-bp-choose-temp.png[]

. На панелі налаштувань справа сконфігуруйте наступні параметри:
** у полі `Name` введіть `Запис системного підпису до Ceph`;
** у полі `Ceph key` введіть `${system_signature_ceph_key}`;
** у полі `Content` введіть `${systemSignaturePayload}`.

+
image:registry-develop:study-project/task-3/task-3-22-bp.png[]

[#create-end-event-call-activity]
===== Створення події завершення бізнес-процесу

. Оберіть прямокутник із щойно створеною задачею xref:#create-service-task-put-system-sign-to-ceph[], приєднайте та налаштуйте _подію, що завершує процес_, натиснувши іконку `Append EndEvent`:
+
image:study-project/task-3/task-3-23-bp-end-event.png[]

. На панелі налаштувань справа у полі `Name` вкажіть `end`.
+
image:registry-develop:study-project/task-3/task-3-23-bp.png[]

[#create-service-task-save-data-to-data-factory]
==== Створення сервісної задачі для збереження даних до Фабрики даних

На цьому етапі необхідно _створити та налаштувати нову сервісну задачу для збереження даних до фабрики даних_. Для цього виконайте кроки, зазначені нижче:

. На прикладі xref:#create-service-task-search-lab-data[] створіть нову сервісну задачу `Зберегти дані до Фабрики даних`, натиснувши іконку ключа та обравши з меню пункт *Service Task*.
. Натисніть `Open Catalog`, оберіть шаблон *Create entity in data factory* та натисніть `Apply` для підтвердження:
+
image:study-project/task-3/task-3-24-bp-choose-temp.png[]

. На панелі налаштувань справа сконфігуруйте наступні параметри:
* у полі `Id` введіть `sendLabToDataFactoryActivity`;
* у полі `Name` введіть `Зберегти дані до Фабрики даних`;
* у полі `Resource` вкажіть `laboratory`;
* у полі `Payload` введіть `${dataPayload}`;
* у полі `X-Access-Token` введіть `${completer('signLabFormActivity').accessToken}`;
* у полі `X-Digital-Signature source` введіть `${sign_submission('signLabFormActivity').signatureDocumentId}`;
* у полі `X-Digital-Signature-Derived source` введіть `${system_signature_ceph_key}`;
* у полі `Result Variable` вкажіть `response`.

+
image:registry-develop:study-project/task-3/task-3-24-bp.png[]

[#create-service-task-create-entity-end]
==== Створення сервісної задачі для встановлення результату бізнес-процесу

На цьому етапі необхідно _створити та налаштувати сервісну задачу, що встановлюватиме результат бізнес-процесу_.

. На прикладі xref:#create-service-task-save-data-to-data-factory[] змоделюйте нову сервісну задачу `Результат виконання "Лабораторія створена"`, натиснувши іконку ключа та обравши з меню пункт *Service Task*.
. Натисніть `Open Catalog`, оберіть шаблон *Define business process status* та натисніть `Apply` для підтвердження:

+
image:study-project/task-3/task-3-25-bp-choose-temp.png[]

. На панелі налаштувань справа сконфігуруйте наступні параметри:
** у полі `Name` вкажіть `Результат виконання "Лабораторія створена"`;
** у полі `Status` вкажіть `Лабораторія створена!`.

+
image:registry-develop:study-project/task-3/task-3-25-bp.png[]

[#create-task-entity-finish]
==== Створення події завершення бізнес-процесу

На цьому етапі необхідно _створити подію, яка завершуватиме основний бізнес-процес_.

. На прикладі xref:#create-end-event-call-activity[] (зовнішнього підпроцесу Call Activity) приєднайте та налаштуйте подію завершення бізнес-процесу.

. На панелі налаштувань справа для параметра `Name` вкажіть значення `Лабораторія створена`.

image:registry-develop:study-project/task-3/task-3-26-bp.png[]

TIP: В результаті маємо змодельований складний бізнес-процес із налаштуванням та викликом зовнішнього підпроцесу Call Activity.

[#save-bp-schema]
==== Збереження змодельованої схеми бізнес-процесу

Після завершення процесу моделювання збережіть отримані схеми бізнес-процесів із назвами _add-lab.bpmn_ та _system-signature-bp.bpmn_ до регламентної папки *_bpmn_* проєкту в Gerrit-репозиторії. Для цього у лівому верхньому куті відкрийте меню *File* -> *Save File As..*, введіть відповідну назву та шлях.

[#forms-modeling]
=== Моделювання форм

[TIP]
====
На етапі моделювання форм необхідно створити та прив'язати JSON-форми до попередньо змодельованих задач в рамках бізнес-процесу.

Форми прив'язуються до бізнес-процесів за службовою назвою.

Використовуйте файли _link:{attachmentsdir}/study-project/task-3/bp-forms/add-lab-bp-add-lab.json[add-lab-bp-add-lab.json]_ та _link:{attachmentsdir}/study-project/task-3/bp-forms/add-lab-sign-lab-data.json[add-lab-sign-lab-data.json]_ зі змодельованими формами для прикладу.
====

[#form-insert-data]
==== Створення форми для внесення даних

Найперше, необхідно _створити форму для внесення даних_ користувачем. Для цього виконайте наступні кроки:

. Увійдіть до застосунку [blue]#Кабінет адміністратора регламентів#:

+
image::registry-develop:bp-modeling/forms/admin-portal-form-modeling-step-1.png[]

. Перейдіть до розділу [blue]#Моделювання UI-форм#:

+
image:registry-develop:bp-modeling/forms/admin-portal-form-modelling-step-2.png[]

. Щоб створити нову форму для бізнес-процесу, натисніть кнопку `Створити нову форму`:

+
image:registry-develop:bp-modeling/forms/admin-portal-form-modelling-step-4.png[]

* У новому вікні, у полі `Бізнес-назва форми` вкажіть назву, що відповідає назві змодельованої xref:#create-task-add-lab-data[користувацької задачі] -- `Додати інформацію про лабораторію`.
* Заповніть поле `Службова назва форми` значенням `add-lab-bp-add-lab` (має відповідати значенню поля `Form key` тієї ж xref:#create-task-add-lab-data[користувацької задачі]).

+
image:study-project/task-3/task-3-27-forms-name.png[]

. З панелі компонентів зліва перетягніть компонент *Text Field* до панелі моделювання та виконайте подальші налаштування:

+
image:study-project/task-3/task-3-27-forms-drag-text-field.png[]

* У новому вікні перейдіть на вкладку *Display*, заповніть поле `Label` значенням `Назва лабораторії`:

+
image:registry-develop:study-project/task-3/task-3-27-forms.png[]

* Перейдіть на вкладку *Validation* та встановіть прапорець для параметра  `Required` -- `true`:

+
image:registry-develop:study-project/task-3/task-3-28-forms.png[]

* Перейдіть на вкладку *API* та заповніть поле `Property Name` значенням `name`.
* Натисніть кнопку `Save` для збереження змін:

+
image:registry-develop:study-project/task-3/task-3-29-forms.png[]

+
IMPORTANT: Аналогічно змоделюйте текстові поля (*Text Field*) для `Код ЄДРПОУ або РНОКПП`, `Адреса`, `Телефон`, `Керівник`.

. З панелі компонентів зліва перетягніть компонент *Checkbox* до панелі моделювання та виконайте подальші налаштування:
+
image:study-project/task-3/task-3-30-forms-drag-checkbox.png[]

* Перейдіть на вкладку *Display* та заповніть поле `Label` значенням `Наявність акредитації`:
+
image:registry-develop:study-project/task-3/task-3-30-forms.png[]

* Перейдіть на вкладку *API* та заповніть поле `Property Name` значенням `accreditationFlag`.
* Натисніть кнопку `Save` для збереження змін:
+
image:registry-develop:study-project/task-3/task-3-31-forms.png[]

. З панелі компонентів зліва перетягніть компонент *File* до панелі моделювання та виконайте подальші налаштування:

+
image:study-project/task-3/task-3-32-forms-drag-file.png[]

* Перейдіть на вкладку *Display* та заповніть поле `Label` значенням `Документи про приміщення`:
+
image:registry-develop:study-project/task-3/task-3-32-forms.png[]

* Перейдіть на вкладку *File* та заповніть наступні поля:

** у полі `Storage` вкажіть `Url`;
** у полі `Url` вкажіть `/documents`;
+
image:registry-develop:study-project/task-3/task-3-33-forms.png[]

** у полі вкажіть `File Pattern` вкажіть `application/pdf,image/jpeg,image/png`;
** у полі `File Minimum size` вкажіть `0KB`;
** у полі `File Maximum size` вкажіть `50MB`.
+
image:registry-develop:study-project/task-3/task-3-34-forms.png[]

* Перейдіть на вкладку *Data* та залишіть поле `Multiple Values` порожнім, тобто зі значенням `False`:
+
image:registry-develop:study-project/task-3/task-3-35-forms.png[]

* Перейдіть на вкладку *API* та заповніть поле `Property Name` значенням `premisesFile`.
* Натисніть кнопку `Save` для збереження змін:
+
image:registry-develop:study-project/task-3/task-3-36-forms.png[]

. З панелі компонентів зліва перетягніть компонент *Select* до панелі моделювання та виконайте подальші налаштування для отримання інформації з довідника:
+
image:study-project/task-3/task-3-37-forms-drag-select.png[]

* Перейдіть на вкладку *Display* та заповніть поле `Label` значенням `Форма власності`:

+
image:registry-develop:study-project/task-3/task-3-37-forms.png[]

* Перейдіть на вкладку *Data* та заповніть наступні поля:

** у полі `Data Source Type` вкажіть значення `URL`;
** у полі `Data Source URL` вкажіть `/officer/api/data-factory/ownership-contains-name`,
+
[TIP]
====
де:

* `/officer` -- вказує, що запит до довідника буде виконано із Кабінету посадової особи;
* `/api/data-factory/` -- вказує шлях до фабрики даних;
* `ownership-contains-name` -- назва критерію пошуку (search condition) для отримання даних із довідника форм власності, що був змодельований та доданий до репозиторію.
====

** у полі `Value Property` вкажіть `ownershipId`;
+
image:registry-develop:study-project/task-3/task-3-38-forms.png[]

** у полі `Item Template` вкажіть `<span>{{ item.name }}</span>`,
+
[TIP]
====
де `name` -- назва параметра, що повертає критерій пошуку (search condition) та відображатиметься на формі.
====
+
image:registry-develop:study-project/task-3/task-3-39-forms.png[]

* На вкладці *Validation* встановіть прапорець для параметра `Required` -- `true`;

* На вкладці *API* заповніть поле `Property Name` значенням `ownership`:

+
image:registry-develop:study-project/task-3/task-3-40-forms.png[]

** Натисніть кнопку `Save` для збереження змін.

. За аналогією до попереднього кроку, виконайте налаштування для отримання інформації з довідника "Область". З панелі компонентів зліва перетягніть компонент *Select* до панелі моделювання:

+
image:study-project/task-3/task-3-37-forms-drag-select.png[]

* Перейдіть на вкладку *Display* та заповніть поле `Label` значенням `Область`:

+
image:registry-develop:study-project/task-3/task-3-41-forms.png[]

* Перейдіть на вкладку *Data* та заповніть наступні поля:

** у полі `Data Source Type` вкажіть значення `URL`;
** у полі `Data Source URL` вкажіть `/officer/api/data-factory/koatuu-obl-contains-name`,

+
[TIP]
====
де:

* `/officer` -- вказує, що запит до довідника буде виконано із Кабінету посадової особи;
* `/api/data-factory/` -- вказує шлях до фабрики даних;
* `koatuu-obl-contains-name` -- назва критерію пошуку (search condition) для отримання даних із довідника областей, що був змодельований та доданий до репозиторію.
====

** у полі `Value Property` введіть значення `code`;
+
image:registry-develop:study-project/task-3/task-3-42-forms.png[]
** у полі `Item Template` вкажіть `<span>{{ item.name }}</span>`,
+
[TIP]
====
де `name` -- назва параметра, що повертає критерій пошуку (search condition) та відображатиметься на формі.
====

** у полі `Refresh Options On` зазначте `Область` (поточне значення буде видалено, коли значення в полі `Область` зміниться);
** для поля `Clear Value On Refresh Options` встановіть прапорець -- `True`.
+
image:registry-develop:study-project/task-3/task-3-43-forms.png[]

* Перейдіть на вкладку *Validation* та встановіть прапорець для параметра `Required` -- `True`.

* Перейдіть на вкладку *API* та заповніть поле `Property Name` значенням `oblast`:

+
image:registry-develop:study-project/task-3/task-3-44-forms.png[]

* Натисніть кнопку `Save` для збереження змін.

. Налаштуйте залежний компонент *Select*. З панелі компонентів зліва перетягніть компонент *Select* до панелі моделювання та виконайте подальші налаштування для отримання інформації з довідника:

+
image:study-project/task-3/task-3-37-forms-drag-select.png[]

* Перейдіть на вкладку *Display* та заповніть поле `Label` значенням `Назва населеного пункту`:

+
image:registry-develop:study-project/task-3/task-3-45-forms.png[]

* Перейдіть на вкладку *Data* та заповніть наступні поля:

** у полі `Data Source Type` введіть `URL`;
** у полі `Data Source URL` введіть `/officer/api/data-factory/koatuu-np-starts-with-name-by-obl`,
+
[TIP]
====
де:

* `/officer` -- вказує, що запит до довідника буде виконано із Кабінету посадової особи;
* `/api/data-factory/` -- вказує шлях до фабрики даних;
* `koatuu-np-starts-with-name-by-obl` -- назва критерію пошуку (search condition) для отримання даних із довідника населених пунктів, що був змодельований та доданий до репозиторію.
====

** у полі `Value Property` вкажіть `koatuuId`;
+
image:registry-develop:study-project/task-3/task-3-46-forms.png[]

** у полі `Filter Query` вкажіть `level1={{data.oblast.code}}`,
+
[TIP]
====
де:

* `level1` -- вхідний параметр для ендпоінту `koatuu-np-starts-with-name-by-obl`;
* `{{data.oblast.code}}`-- шлях для отримання даних `data.Property name.Value Property` із попереднього компонента *Select*.
====

** у полі `Item Template` вкажіть `<span>{{ item.name }}</span>`,
+
[TIP]
====
де `name` -- назва параметру, що повертає search condition та буде відображений на формі.
====

** у полі `Refresh options On` введіть значення `Область`  (поточне значення буде видалено, коли значення в полі `Область` зміниться);
** встановіть прапорець для параметра `Clear Value On Refresh Options` -- `True`:
+
image:registry-develop:study-project/task-3/task-3-47-forms.png[]

* Перейдіть на вкладку *Validation* та встановіть прапорець для параметра  `Required` -- `True`.

* Перейдіть на вкладку *API* та заповніть поле `Property Name` значенням `koatuu`.

* Натисніть кнопку `Save`, щоб зберегти зміни.

. Збережіть форму, натиснувши кнопку `Створити форму` у правому верхньому куті:

+
image:registry-develop:study-project/task-3/task-3-48-forms.png[]

[#form-data-signing]
==== Створення форми для підпису даних

Після завершення xref:#form-insert-data[попереднього етапу] зі створенням форми для внесення даних, _створіть ще одну форму для підпису даних_.

Для цього скопіюйте xref:#form-insert-data[попередньо змодельовану форму], натиснувши **іконку копіювання** -- це дозволить створити форму із готового шаблону.

image:registry-develop:study-project/task-3/task-3-49-forms.png[]

_Налаштуйте параметри форми_:

. Введіть назву відповідної xref:#create-task-lab-data-signing[користувацької задачі] `Підписати дані про лабораторію` в полі `Бізнес-назва форми`;
. Заповніть поле `Службова назва форми` значенням `add-lab-sign-lab-data` (відповідає значенню поля `Form key` тієї ж xref:#create-task-lab-data-signing[користувацької задачі]);

. В усіх компонентах:

* На вкладці *Display* встановіть прапорець для параметра *Disabled*.
* Натисніть кнопку `Save` для збереження змін.
+
image:registry-develop:study-project/task-3/task-3-50-forms.png[]

. Збережіть форму, натиснувши кнопку `Зберегти зміни` у правому верхньому куті.

==== Завантаження змодельованих форм бізнес-процесу до локальної директорії

Завантажте форми, натиснувши _іконку завантаження_, та помістіть їх до регламентної папки *_forms_* проєкту в локальному Gerrit-репозиторії.

image:registry-develop:study-project/task-1/task-1-14-forms.png[]

[#bp-access]
=== Моделювання доступу до бізнес-процесу

[TIP]
====
На цьому етапі необхідно надати доступ до бізнес-процесу із Кабінету посадової особи.

Параметри доступу налаштовуються у конфігураційному файлі, що має назву _link:{attachmentsdir}/study-project/task-3/bp-access/officer.yml[officer.yml]_.
====

Створіть файл _officer.yml_ та сконфігуруйте в ньому наступні параметри:

.Приклад. Налаштування доступу до бізнес-процесу із Кабінету посадової особи
[source,yaml]
----
authorization:
  realm: 'officer'
  process_definitions:
    – process_definition_id: 'add-lab'
      process_name: 'Створення лабораторії'
      process_description: 'Створення лабораторії'
      roles:
        – officer
----

[save-officer-yml]
==== Збереження файлу з налаштуваннями доступу

Збережіть файл _officer.yml_ до регламентної папки *_bp-auth_* проєкту в локальному Gerrit-репозиторії.

== Завантаження файлів регламенту до віддаленого репозиторію Gerrit

Для успішного розгортання бізнес-процесу, форм, а також застосування правильних налаштувань доступу до бізнес-процесу у цільовому середовищі, адміністратор регламенту має завантажити збережені локально файли регламенту реєстру до віддаленого сховища коду Gerrit.

Для цього виконайте кроки з інструкції xref:registry-develop:registry-admin/regulations-deploy/registry-admin-deploy-regulation.adoc[].

