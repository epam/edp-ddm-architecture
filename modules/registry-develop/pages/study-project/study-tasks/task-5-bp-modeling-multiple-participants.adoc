= Завдання 5. Моделювання бізнес-процесу із декількома учасниками
:sectnums:
:sectanchors:
:toc:
:toclevels: 5
:toc-title: ЗМІСТ

== Мета завдання

Виконання цього завдання має на меті: ::

* Навчити моделювати бізнес-процес, що має декількох учасників.
* Навчити моделювати форми та налаштовувати їх за допомогою *formVariables*.

== Передумови

Перед проходженням завдання необхідно виконати наступні передумови:

. xref:bp-modeling/bp/element-templates/bp-element-templates-installation-configuration.adoc#business-process-modeler-extensions-installation[Встановіть додаток Camunda Modeler і типові розширення до нього].
. xref:registry-develop:bp-modeling/forms/bp-modeling-forms-general-description.adoc[Ознайомтеся із компонентами FormIO для моделювання форм].

== Процес виконання завдання

=== Моделювання бізнес-процесу

[TIP]
====
На етапі моделювання бізнес-процесу необхідно створити та зберегти відповідну BPMN-діаграму.

Використовуйте файл _link:{attachmentsdir}/study-project/task-5/bp-schema/citizen-add-lab.bpmn[citizen-add-lab.bpmn]_ із готовою схемою бізнес-процесу для прикладу.
====

==== Етапи моделювання бізнес-процесу

В рамках цього завдання моделювальник має створити бізнес-процес, що складається з наступних етапів:

. xref:#create-pool-participant[].
. xref:#create-start-event[].
. xref:#create-script-task-prepare-data-view[].
. xref:#create-user-task-add-lab-data[].
. xref:#create-service-task-search-lab-data-transient-var[].
. xref:#create-xor-gateway[].
. xref:#create-branch-validation-error[].
. xref:#create-branch-continue-bp[].
. xref:#create-user-task-sign-lab-data[].
. xref:#create-service-task-get-users-officer-role[].
. xref:#create-user-task-set-executor-validate-docs[].
. xref:#create-script-task-prepare-doc-data-view[].
. xref:#create-user-task-check-uniqueness-lab-record[].
. xref:#create-xor-gw-lab-unique[].
. xref:#create-branch-negative-bp-result[].
. xref:#create-branch-continue-bp-1[].
. xref:#create-user-task-sign-lab-data[].
. xref:#create-script-task-prepare-data-record-transient-var[].
. xref:#create-call-activity-sign-data-by-system-key[].
. xref:#create-service-task-save-data-to-data-factory[].
. xref:#create-service-task-bp-result-lab-created[].
. xref:#create-end-event[].

CAUTION: *Важливо!* Після проходження всіх етапів, не забудьте зберегти змодельовану схему бізнес-процесу до відповідної папки з регламентом реєстру (_див. xref:#save-bp-schema[Збереження змодельованої схеми бізнес-процесу]_)

[#create-pool-participant]
==== Створення пулу для бізнес-процесу

Найперше, _змоделюйте пул для бізнес-процесу_. Для цього виконайте кроки, подані нижче:

NOTE: Моделювання діаграми бізнес-процесу має відбуватися в рамках елемента *Create Pool/Participant*.


. Відкрийте додаток *Camunda Modeler* та створіть нову діаграму BPMN. Для цього у лівому верхньому куті натисніть меню *File* -> *New File* -> *BPMN Diagram*:
+
image:registry-develop:bp-modeling/bp/modeling-instruction/bp-1.png[]

. На панелі інструментів зліва знайдіть елемент *Create pool/Participant* та перетягніть його до панелі моделювання:
+
image:registry-develop:bp-modeling/bp/modeling-instruction/bp-2.png[]

. Заповніть наступні поля відповідними значеннями:

* у полі `Name` введіть значення `Створення лабораторії`;
* у полі `Process id` вкажіть `citizen-add-lab`;
* у полі `Process name` вкажіть `Процес створення лабораторії`:

+
image:study-project/task-5/task-5-bp-1.png[]

[#create-start-event]
==== Створення початкової події

_Створіть початкову подію_. Для цього виконайте наступні кроки:

. На панелі інструментів, зліва, знайдіть елемент (коло) *CreateStartEvent* та перетягніть його до панелі моделювання:
+
image::registry-develop:bp-modeling/bp/bp-keys/bp-keys-create-start-event.png[]
+
image::registry-develop:bp-modeling/bp/bp-keys/bp-keys-create-start-event-1.png[]

. На панелі налаштувань справа заповніть наступні параметри відповідними значеннями:
** у полі `Name` введіть `Початок`;
** у полі `Initiator` введіть `initiator`.

+
image:study-project/task-5/task-5-bp-2.png[]

[#create-script-task-prepare-data-view]
==== Створення задачі скриптування "Підготовка даних для показу"

На цьому етапі необхідно _змоделювати задачу скриптування для підготовки даних до показу_. Для цього виконайте наступні кроки:

. Оберіть коло із початковою подією, змодельованою на xref:#create-start-event[попередньому етапі], та приєднайте нову задачу, натиснувши іконку *Append Task*:
+
image:study-project/task-5/task-5-bp-03.png[]

. Вкажіть тип задачі, натиснувши іконку ключа та обравши з меню пункт *Script Task* (Задача скриптування):
+
image:study-project/task-5/task-5-bp-03-1.png[]

. Виділіть додану задачу скриптування та налаштуйте наступні параметри:

* у полі `Id` вкажіть `convertSignFormDataToDataFactoryFormatActivity`;
* у полі `Name` введіть `Підготовка даних для показу`;
* у полі `Script Format` зазначте формат (мову) скриптування `groovy`;
* у полі `Script type` вкажіть тип скрипту `InlineScript`;
* у полі `Script` вставте безпосередньо groovy-скрипт:
+
====
[%collapsible]
.Натисніть, щоб розгорнути або згорнути
=====
[source,groovy]
----
def cephData = [:]

cephData['edrpou'] = initiator().edrpou

execution.removeVariable('payload')
set_transient_variable('payload', S(cephData, 'application/json'))
----
=====
====
+
image:study-project/task-5/task-5-bp-3.png[]

[#create-user-task-add-lab-data]
==== Створення користувацької задачі "Додати інформацію про лабораторію"

На цьому етапі необхідно _змоделювати користувацьку задачу_ `Додати інформацію про лабораторію`.

На прикладі xref:study-project/study-tasks/task-3-bp-modeling-with-integration.adoc#create-task-add-lab-data[Завдання 3] створіть користувацьку задачу, призначену для внесення даних користувачем. Для цього виконайте наступні кроки:

. Оберіть прямокутник із задачею скриптування, змодельованою на xref:#create-script-task-prepare-data-view[попередньому етапі], та приєднайте нову задачу.

. Вкажіть тип задачі, натиснувши іконку ключа та обравши з меню пункт *User Task* (Користувацька задача).

. На панелі налаштувань справа натисніть `Open Catalog`, оберіть шаблон *User Form* із каталогу та натисніть `Apply` для підтвердження.

. На панелі налаштувань справа заповніть наступні поля:

* у полі `Id` зазначте `addLabCitizenActivity`;
* у полі `Name` введіть `Додати інформацію про лабораторію`;
* у полі `Form key` введіть `citizen-add-lab-bp-add-lab`;
* у полі `Assignee` вкажіть `${initiator}`;
* у полі `Form data pre-population` вкажіть `${payload}`.

+
image:study-project/task-5/task-5-bp-4.png[]

[#create-service-task-search-lab-data-transient-var]
==== Створення сервісної задачі "Пошук даних про лабораторію (transient var)"

На цьому етапі необхідно _створити сервісну задачу_ `Пошук даних про лабораторію (transient var)`.

На прикладі xref:study-project/study-tasks/task-3-bp-modeling-with-integration.adoc#create-service-task-search-lab-data[Завдання 3] змоделюйте сервісну задачу для пошуку даних про лабораторію. Для цього виконайте наступні кроки:

. Оберіть прямокутник із користувацькою задачею `Додати інформацію про лабораторію`, змодельованою на xref:#create-user-task-add-lab-data[попередньому етапі], та приєднайте нову задачу, натиснувши іконку *Append Task*.

. Вкажіть тип задачі, натиснувши іконку ключа та обравши з меню пункт *Service Task* (Сервісна задача).

. На панелі налаштувань справа натисніть `Open Catalog`, оберіть шаблон *Search for entities in data factory* (Пошук значень у фабриці даних) та натисніть `Apply` для підтвердження.

. На панелі налаштувань справа заповніть наступні поля:

* у полі `Name` має бути вказано `Пошук даних про лабораторію (transient var)`;

* у розділі *Input Parameters* -> *Resource* зазначте наступне:
** у полі `Variable Assignment Type` вкажіть `String or Expression`;
** у полі `Variable Assignment Value` вкажіть `laboratory-equal-edrpou-name-count`;

+
image:study-project/task-5/task-5-bp-5.png[]

* у розділі *Input Parameters* -> *Search Variables* вкажіть наступне:
** у полі `Variable Assignment type` вкажіть `Map`.
** у полі `Add Entry` додайте параметри `name` та `edrpou`, натиснувши на позначку плюса (`+`) та вкажіть для них відповідні значення:
+
|===
|Key |Value

|`name` |`${submission('addLabCitizenActivity').formData.prop('name').value()}`

|`edrpou`
|`${submission('addLabCitizenActivity').formData.prop('edrpou').value()}`
|===
+
image:study-project/task-5/task-5-bp-6.png[]


* у розділі *Input Parameters* -> *X-Access-Token* вкажіть наступне:
** у полі `Variable Assignment Type` вкажіть `String or Expression`;
** у полі `Variable Assignment Value` вкажіть `${completer('addLabCitizenActivity').accessToken}`.

* У розділі *Output Parameters* -> *Result Variable* параметр `Assign to Process Variable` заповніть значенням `response`:

+
image:study-project/task-5/task-5-bp-7.png[]

[#create-xor-gateway]
==== Створення та заповнення XOR-шлюзу "Дані присутні?"

На прикладі xref:study-project/study-tasks/task-3-bp-modeling-with-integration.adoc#create-xor-gateway[Завдання 3] приєднайте XOR-шлюз. Для цього виконайте кроки, подані нижче:

. Оберіть прямокутник із сервісною задачею `Пошук даних про лабораторію (transient var)`, змодельованою на xref:#create-service-task-search-lab-data-transient-var[попередньому етапі], та приєднайте XOR-шлюз, натиснувши іконку *Append Gateway*.

. На панелі налаштувань справа, у полі `Name` вкажіть назву шлюзу -- `Дані присутні?`.

+
image:study-project/task-5/task-5-bp-8.png[]

[#create-branch-validation-error]
==== Створення гілки з валідаційною помилкою

На прикладі xref:study-project/study-tasks/task-3-bp-modeling-with-integration.adoc#create-validation-error-branch[Завдання 3] створіть гілку з валідаційною помилкою. Для цього виконайте кроки, подані нижче:

. Оберіть ромб із XOR-шлюзом `Дані присутні?`, змодельованим на xref:#create-xor-gateway[попередньому етапі], та створіть нову сервісну задачу, натиснувши іконку *Append Task*.

. Визначте тип задачі, натиснувши іконку ключа та обравши з меню пункт *Service Task* (Сервісна задача).

. Натисніть `Open Catalog`, оберіть шаблон *Throw validation error* та натисніть `Apply` для підтвердження.

. На панелі налаштувань справа заповніть наступні поля:

* у полі `Name` введіть `Формування валідаційної помилки`.

* У розділі *Input Parameters* -> *Validation Errors* зазначте наступне:
** у полі `Variable Assignment Type` вкажіть тип `List`;
** для поля `Value` додайте наступне значення:
+
.Значення
[source,json]
----
{"field": "name", "value": "${submission('addLabCitizenActivity').formData.prop('name').stringValue().replaceAll("\"", "\\\\\"")}", "message": "Дані про цю лабораторію вже присутні"}
----

+
image:study-project/task-5/task-5-bp-9.png[]

. На гілці, що прямує від шлюзу `Дані присутні?` до сервісної задачі `Формування валідаційної помилки`, потрібно налаштувати наступне:
** у полі `Name` введіть `так`;
** у полі `Condition Type` введіть тип `Expression`;
** у полі `Expression` введіть `${!response.value.responseBody.elements().isEmpty()}`.

+
image:study-project/task-5/task-5-bp-10.png[]

[#create-branch-continue-bp]
==== Створення гілки з подальшим продовженням бізнес-процесу

На прикладі xref:study-project/study-tasks/task-3-bp-modeling-with-integration.adoc#create-continuation-of-bp-branch[Завдання 3] необхідно _створити гілку, що продовжить бізнес-процес_.

Для цього на гілці, що прямує від шлюзу `Дані присутні?` до користувацької задачі `Підписати дані про лабораторію` (_див. нижче xref:#create-user-task-lab-data-signing[]_) налаштуйте такі параметри:

. У полі `Id` лишіть значення за замовчуванням.
. У полі `Name` вкажіть `ні`.
. у полі `Condition Type` вкажіть `Expression`.
. У полі `Expression` вкажіть `${response.value.responseBody.elements().isEmpty()}`.

+
image:study-project/task-5/task-5-bp-11.png[]

[#create-user-task-lab-data-signing]
==== Створення користувацької задачі для підпису даних

На прикладі xref:study-project/study-tasks/task-3-bp-modeling-with-integration.adoc#create-task-lab-data-signing[Завдання 3] необхідно _створити користувацьку задачу для підпису даних_. Для цього виконайте наступні кроки:

. Визначте тип задачі, натиснувши іконку ключа та обравши з меню пункт *User Task* (Користувацька задача).

. Натисніть `Open Catalog`, оберіть шаблон *Citizen Sign Task* та натисніть `Apply` для підтвердження.

. На панелі налаштувань справа заповніть наступні поля:

* у полі `Id` вкажіть `signLabCitizenActivity`;
* у полі `Name` введіть `Підписати дані про лабораторію`;
* у полі `Form key` введіть `shared-citizen-sign-lab`;
* у полі `Assignee` вкажіть `${initiator}`;
* у полі `Form data pre-population` введіть `${submission('addLabCitizenActivity').formData}`.

* поле `INDIVIDUAL` залиште порожнім (за замовчуванням);
* для поля `ENTREPRENEUR` встановіть прапорець -- `True`;
* для поля `LEGAL` встановіть прапорець -- `True`.

+
image:study-project/task-5/task-5-bp-12.png[]

[#create-service-task-get-users-officer-role]
==== Створення сервісної задачі "Отримання користувачів із роллю 'officer' "

На прикладі xref:#create-service-task-search-lab-data-transient-var[] необхідно _створити сервісну задачу для отримання користувачів із роллю "Посадова особа" із сервісу управління ідентифікацію та доступом Keycloak_. Для цього виконайте наступні кроки:

. Оберіть прямокутник із користувацькою задачею `Підписати дані про лабораторію`, змодельованою на xref:#create-user-task-lab-data-signing[попередньому етапі], та приєднайте нову задачу, натиснувши іконку *Append Task*.

. Вкажіть тип задачі, натиснувши іконку ключа та обравши з меню пункт *Service Task* (Сервісна задача).

. На панелі налаштувань справа натисніть `Open Catalog`, оберіть шаблон *Get users by role from keycloak* (Отримання користувачів у Keycloak за роллю) та натисніть `Apply` для підтвердження.

. На панелі налаштувань справа заповніть наступні поля:

* у полі `Name` введіть `Отримання користувачів з роллю 'officer'`;
* у полі `Result Variable` вкажіть `officerUsers`.

+
image:study-project/task-5/task-5-bp-13.png[]

[#create-user-task-set-executor-validate-docs]
==== Створення користувацької задачі "Призначення виконавця задачі "Перевірка документів на відповідність"

На прикладі xref:#create-user-task-lab-data-signing[] необхідно _створити користувацьку задачу, що дозволить призначати виконавця іншої задачі._ Для цього виконайте наступні кроки:

. Оберіть прямокутник із користувацькою задачею `Отримання користувачів із роллю 'officer'`, змодельованою на xref:#create-service-task-get-users-officer-role[попередньому етапі], та приєднайте нову задачу, натиснувши іконку *Append Task*.

. Вкажіть тип задачі, натиснувши іконку ключа та обравши з меню пункт *User Task* (Користувацька задача).

. На панелі налаштувань справа натисніть `Open Catalog`, оберіть шаблон *User Form* та натисніть `Apply` для підтвердження.

. На панелі налаштувань справа заповніть наступні поля:

* у полі `Id` введіть `dispatchTaskActivity`;
* у полі `Name` введіть `Призначення виконавця задачі "Перевірка документів на відповідність"`;
* у полі `Form key` вкажіть `shared-dispatch-task`;
* у полі `Candidate roles` введіть значення `task-dispatcher` -- роль, для якої буде доступна ця задача;
* у полі `Form variables` вкажіть `officerUsers` -- змінну, що буде передана на форму.

+
image:study-project/task-5/task-5-bp-14.png[]

[#create-script-task-prepare-doc-data-view]
==== Створення задачі скриптування "Підготовка даних документа для показу"

На прикладі xref:#create-script-task-prepare-data-view[] _змоделюйте та приєднайте нову задачу скриптування_. Для цього виконайте наступні кроки:

. Оберіть прямокутник із користувацькою задачею, змодельованою на xref:#create-user-task-set-executor-validate-docs[попередньому етапі], та приєднайте нову задачу, натиснувши іконку *Append Task*.

. Вкажіть тип задачі, натиснувши іконку ключа та обравши з меню пункт *Script Task* (Задача скриптування).

. Виділіть додану задачу скриптування та налаштуйте наступні параметри:

* у полі `Name` вкажіть `Підготовка даних документа для показу`;
* у полі `Script Format` вкажіть тип (мову) скриптування -- `groovy`;
* у полі `Script Type` вкажіть тип скрипту `InlineScript`;
* у полі `Script` вставте безпосередньо groovy-скрипт:
+
====
[%collapsible]
.Натисніть, щоб розгорнути або згорнути
=====
[source,groovy]
----
execution.removeVariable('officerAssignee')
execution.setVariable('officerAssignee', submission('dispatchTaskActivity').formData.prop('userTaskAssignee').prop('userName').value())
----
=====
====

+
image:study-project/task-5/task-5-bp-15.png[]

[#create-user-task-check-uniqueness-lab-record]
==== Створення користувацької задачі "Перевірка унікальности запису про лабораторію"

На прикладі xref:#create-user-task-set-executor-validate-docs[] _створіть нову користувацьку задачу для перевірки унікальності запису про лабораторію_. Для цього виконайте кроки, подані нижче:

. Оберіть прямокутник зі скрипт-задачею, змодельованою на xref:#create-script-task-prepare-doc-data-view[попередньому етапі], та приєднайте нову задачу, натиснувши іконку *Append Task*.

. Вкажіть тип задачі, натиснувши іконку ключа та обравши з меню пункт *User Task* (Користувацька задача).

. На панелі налаштувань справа натисніть `Open Catalog`, оберіть шаблон *User Form* та натисніть `Apply` для підтвердження.

. На панелі налаштувань справа заповніть наступні поля:

* у полі `Id` введіть `checkLabOfficerActivity`;
* у полі `Name` введіть `Перевірка унікальности запису про лабораторію`;
* у полі `Form key` вкажіть `shared-officer-check-lab`;
* у полі `Assignee` введіть `${officerAssignee}`;
* у полі `Form data pre-population` вкажіть `${submission('signLabCitizenActivity').formData}`.

+
image:study-project/task-5/task-5-bp-16.png[]

[#create-xor-gw-lab-unique]
==== Створення XOR-шлюзу "Лабораторія унікальна?"

На прикладі xref:#create-xor-gateway[] змоделюйте та приєднайте новий XOR-шлюз. Для цього виконайте кроки, подані нижче:

. Оберіть прямокутник із користувацькою задачею, змодельованою на xref:#create-user-task-check-uniqueness-lab-record[попередньому етапі], та приєднайте XOR-шлюз, натиснувши іконку *Append Gateway*.

. На панелі налаштувань справа, у полі `Name` вкажіть назву шлюзу -- `Лабораторія Унікальна? labUniqueCheckFlag`.

image:study-project/task-5/task-5-bp-17.png[]


[#create-branch-negative-bp-result]
==== Створення гілки із негативним результатом бізнес-процесу

На прикладі xref:#create-branch-validation-error[] створіть нову гілку із негативним результатом бізнес-процесу. Для цього виконайте кроки, подані нижче:

. Оберіть ромб із XOR-шлюзом `Лабораторія унікальна?`, змодельованим на xref:#create-xor-gw-lab-unique[попередньому етапі], та створіть нову сервісну задачу, натиснувши іконку *Append Task*.

. Визначте тип задачі, натиснувши іконку ключа та обравши з меню пункт *Service Task* (Сервісна задача).

. Натисніть `Open Catalog`, оберіть шаблон *Define business process status* та натисніть `Apply` для підтвердження.

. На панелі налаштувань справа заповніть наступні поля:

* у полі `Name` введіть значення `Результат виконання "Лабораторія не створена - Дублікат"`;
* у полі `Status` введіть `Лабораторія не створена - Така лабораторія вже існує`.

+
image:study-project/task-5/task-5-bp-18.png[]

. Виділіть гілку, що прямує до сервісної задачі `"Результат виконання "Лабораторія не створена - Дублікат"` та налаштуйте такі параметри:

* у полі `Name` введіть значення `ні`;
* у полі `Condition Type` тип `Expression`;
* у полі `Expression` вкажіть вираз `${!submission('checkLabOfficerActivity').formData.hasProp('labUniqueCheckFlag') || submission('checkLabOfficerActivity').formData.prop('labUniqueCheckFlag').value() == false}`.

+
image:study-project/task-5/task-5-bp-19.png[]

[#create-branch-continue-bp-1]
==== Створення гілки із подальшим продовженням бізнес-процесу

На прикладі xref:#create-branch-continue-bp[] _створіть нову гілку для продовження процесу_.

Для цього на гілці, що прямує від шлюзу `Лабораторія унікальна?` (_див. xref:#create-xor-gw-lab-unique[]_) до користувацької задачі `Підписати дані лабораторії` (_див. нижче xref:#create-user-task-sign-lab-data[]_) налаштуйте такі параметри:

. У полі `Id` лишіть значення за замовчуванням.
. У полі `Name` вкажіть `так`.
. у полі `Condition Type` вкажіть `Expression`.
. У полі `Expression` вкажіть вираз `${submission('checkLabOfficerActivity').formData.hasProp('labUniqueCheckFlag') && submission('checkLabOfficerActivity').formData.prop('labUniqueCheckFlag').value() == true}`.

image:study-project/task-5/task-5-bp-20.png[]

[#create-user-task-sign-lab-data]
==== Створення користувацької задачі для підпису даних

На прикладі xref:study-project/study-tasks/task-3-bp-modeling-with-integration.adoc#create-task-lab-data-signing[Завдання 3] необхідно _створити користувацьку задачу для підпису даних_. Для цього виконайте наступні кроки:

. Вкажіть тип задачі, натиснувши іконку ключа та обравши з меню пункт *User Task*.

. На панелі налаштувань справа натисніть `Open Catalog`, оберіть шаблон *User Form* та натисніть `Apply` для підтвердження.

. Заповніть наступні поля відповідними значеннями:
* у полі `Id` вкажіть `signLabOfficerActivity`;
* у полі `Name` введіть `Підписати дані лабораторії`;
* у полі `Form key` введіть `shared-officer-sign-lab`;
* у полі `Assignee` вкажіть `${officerAssignee}`;
* у полі `Form data pre-population` введіть `${submission('checkLabOfficerActivity').formData}`.

+
image:study-project/task-5/task-5-bp-21.png[]

[#create-script-task-prepare-data-record-transient-var]
==== Створення задачі скриптування "Підготовка даних до запису (transient var)"

На прикладі xref:study-project/study-tasks/task-3-bp-modeling-with-integration.adoc#create-task-script-data-signing[Завдання 3] _створіть нову задачу скриптування для підготовки даних до запису_. Для цього виконайте подальші налаштування:

. Оберіть прямокутник із користувацькою задачею, змодельованою на xref:#create-user-task-sign-lab-data[попередньому етапі], та приєднайте нову задачу, натиснувши іконку *Append Task*.

. Вкажіть тип задачі, натиснувши іконку ключа та обравши з меню пункт *Script Task* (Задача скриптування).

. Виділіть додану задачу скриптування та налаштуйте наступні параметри:

* у полі `Name` вкажіть `Підготовка даних для запису (transient var)`;
* у полі `Script Format` вкажіть тип (мову) скриптування -- `groovy`;
* у полі `Script Type` вкажіть тип скрипту `InlineScript`;
* у полі `Script` вставте безпосередньо groovy-скрипт:
+
====
[%collapsible]
.Натисніть, щоб розгорнути або згорнути
=====
[source,groovy]
----
def signedFormData = submission('signLabOfficerActivity').formData

signedFormData.prop('oblast', signedFormData.prop('oblast').prop('code'))

signedFormData.prop('koatuuId', signedFormData.prop('koatuu').prop('koatuuId'))
signedFormData.deleteProp('koatuu')
signedFormData.prop('ownershipId', signedFormData.prop('ownership').prop('ownershipId'))
signedFormData.deleteProp('ownership')

if(signedFormData.hasProp('premisesFile') && !signedFormData.prop('premisesFile').isNull() &&
!signedFormData.prop('premisesFile').elements().isEmpty()) {
signedFormData.prop('premisesFile', signedFormData.prop('premisesFile').elements()[0])
} else {
signedFormData.prop('premisesFile', null as String)
}

if(signedFormData.hasProp('accreditationFile') && !signedFormData.prop('accreditationFile').isNull() && !signedFormData.prop('accreditationFile').elements().isEmpty()) {
signedFormData.prop('accreditationFile', signedFormData.prop('accreditationFile').elements()[0])
} else {
signedFormData.prop('accreditationFile', null as String)
}


execution.removeVariable('dataPayload')
set_transient_variable('dataPayload', signedFormData)
----
=====
====

+
image:study-project/task-5/task-5-bp-22.png[]

[#create-call-activity-sign-data-by-system-key]
==== Моделювання Call Activity для підпису даних системним ключем

На прикладі xref:study-project/study-tasks/task-3-bp-modeling-with-integration.adoc#create-task-call-activity-data-signing[Завдання 3] _змоделюйте *Call Activity* (виклик підпроцесу багаторазового використання) для підпису даних системним ключем_. Для цього виконайте кроки, подані нижче:

. Оберіть прямокутник із користувацькою задачею, змодельованою на xref:#create-script-task-prepare-data-record-transient-var[попередньому етапі], та приєднайте нову задачу, натиснувши іконку *Append Task*.

. Вкажіть тип задачі, натиснувши іконку ключа та обравши з меню пункт *Call Activity*.

. На панелі налаштувань справа сконфігуруйте параметри для Call Activity:

* На вкладці *General*:
** у полі `Name` введіть `Підписати дані системним ключем`;
** у полі `CallActivity Type` вкажіть тип `BPMN`;
** у полі `Called Element` вкажіть ідентифікатор xref:study-project/study-tasks/task-3-bp-modeling-with-integration.adoc#call-activity-modeling[стороннього підпроцесу], що викликатиметься, -- `system-signature-bp`;
** у полі `Binding` вкажіть `latest`.
+
image:study-project/task-5/task-5-bp-23.png[]

* На вкладці *Variables*:
** у секції *In Mapping* зазначте наступне:
*** у полі `Type` вкажіть тип `Source`;
*** у полі `Source` вкажіть `dataPayload`;
*** у полі `Target` вкажіть `dataToSign`.

** у секції *Out Mapping* зазначте наступне:
*** у полі `Type` вкажіть тип `Source`;
*** у полі `Source` вкажіть `system_signature_ceph_key`;
*** у полі `Target` вкажіть `system_signature_ceph_key`.

+
image:study-project/task-5/task-5-bp-24.png[]

[#create-service-task-save-data-to-data-factory]
==== Створення сервісної задачі "Зберегти дані до Фабрики даних"

На прикладі xref:study-project/study-tasks/task-3-bp-modeling-with-integration.adoc#create-service-task-save-data-to-data-factory[Завдання 3] необхідно _створити та налаштувати нову сервісну задачу для збереження даних до фабрики даних_. Для цього виконайте кроки, зазначені нижче:

. Оберіть прямокутник зі створеною на xref:#create-call-activity-sign-data-by-system-key[попередньому етапі] задачею Сall Activity та створіть нову сервісну задачу `Зберегти дані до Фабрики даних`, натиснувши іконку ключа та обравши з меню пункт *Service Task*.
. Натисніть `Open Catalog`, оберіть шаблон *Create entity in data factory* та натисніть `Apply` для підтвердження.

. На панелі налаштувань справа сконфігуруйте наступні параметри:

* у полі `Name` введіть `Зберегти дані до Фабрики даних`;
* у полі `Resource` вкажіть `laboratory`;
* у полі `Payload` введіть `${dataPayload}`;
* у полі `X-Access-Token` введіть `${completer('signLabOfficerActivity').accessToken}`;
* у полі `X-Digital-Signature source` введіть `${sign_submission('signLabOfficerActivity').signatureDocumentId}`;
* у полі `X-Digital-Signature-Derived source` введіть `${system_signature_ceph_key}`;
* у полі `Result Variable` вкажіть `response`.

+
image:study-project/task-5/task-5-bp-25.png[]

[#create-service-task-bp-result-lab-created]
==== Створення сервісної задачі для встановлення результату бізнес-процесу

На прикладі xref:study-project/study-tasks/task-3-bp-modeling-with-integration.adoc#create-service-task-create-entity-end[Завдання 3] _змоделюйте нову сервісну задачу, що встановлюватиме результат бізнес-процесу_. Для цього виконайте кроки, подані нижче:

. Оберіть прямокутник із сервісною задачею, створеною на xref:#create-service-task-save-data-to-data-factory[попередньому етапі], та приєднайте нову задачу, натиснувши іконку *Append Task*.

. Визначте тип задачі, натиснувши іконку ключа та обравши з меню пункт *Service Task*.
. Натисніть `Open Catalog`, оберіть шаблон *Define business process status* та натисніть `Apply` для підтвердження.
. На панелі налаштувань справа сконфігуруйте наступні параметри:

* у полі `Name` вкажіть `Результат виконання "Лабораторія створена"`;
* у полі `Status` вкажіть `Лабораторія створена`.

+
image:study-project/task-5/task-5-bp-26.png[]

[#create-end-event]
==== Створення події завершення бізнес-процесу

На цьому етапі необхідно _створити подію, яка завершуватиме бізнес-процес_.

. На прикладі xref:study-project/study-tasks/task-3-bp-modeling-with-integration.adoc#create-task-entity-finish[Завдання 3] приєднайте та налаштуйте подію завершення бізнес-процесу.

. На панелі налаштувань справа для параметра `Name` вкажіть значення `Лабораторія створена`.

+
image:registry-develop:study-project/task-3/task-3-26-bp.png[]

TIP: В результаті маємо змодельований бізнес-процес для використання декількома учасниками та з викликом зовнішнього підпроцесу Call Activity.


[#save-bp-schema]
==== Збереження змодельованої схеми бізнес-процесу

Після завершення процесу моделювання збережіть отриману схему бізнес-процесу із назвою _citizen-add-lab.bpmn_ до регламентної папки *_bpmn_* проєкту в Gerrit-репозиторії. Для цього у лівому верхньому куті відкрийте меню *File* -> *Save File As..*, введіть відповідну назву та шлях.

[#form-modeling]
=== Моделювання форм

[TIP]
====
На етапі моделювання форм необхідно створити та прив'язати JSON-форми до попередньо змодельованих задач в рамках бізнес-процесу.

Форми прив'язуються до бізнес-процесів за службовою назвою.

Використовуйте файли _link:{attachmentsdir}/study-project/task-5/bp-forms/shared-officer-sign-lab.json[shared-officer-sign-lab.json]_,  _link:{attachmentsdir}/study-project/task-5/bp-forms/shared-officer-check-lab.json[shared-officer-check-lab.json]_, _link:{attachmentsdir}/study-project/task-5/bp-forms/shared-dispatch-task.json[shared-dispatch-task.json]_, _link:{attachmentsdir}/study-project/task-5/bp-forms/shared-officer-sign-lab.json[shared-officer-sign-lab.json]_, _link:{attachmentsdir}/study-project/task-5/bp-forms/citizen-add-lab-bp-add-lab.json[citizen-add-lab-bp-add-lab.json]_  зі змодельованими формами для прикладу.
====

[#form-insert-data]
==== Створення форми для внесення даних

TIP: Змоделюйте форму для внесення даних користувачем, використовуючи приклад із xref:study-project/study-tasks/task-3-bp-modeling-with-integration.adoc#form-insert-data[Завдання 3].

. Увійдіть до застосунку [blue]#Кабінет адміністратора регламентів#:

+
image::registry-develop:bp-modeling/forms/admin-portal-form-modeling-step-1.png[]

. Перейдіть до розділу [blue]#Моделювання UI-форм#:

+
image:registry-develop:bp-modeling/forms/admin-portal-form-modelling-step-2.png[]

. Скопіюйте форму xref:study-project/study-tasks/task-3-bp-modeling-with-integration.adoc#form-insert-data[ add-lab-bp-add-lab], змодельовану в рамках Завдання 3, натиснувши _іконку копіювання_ -- це дозволить створити форму із готового шаблону.

+
image:registry-develop:study-project/task-3/task-3-49-forms.png[]

. У новому вікні введіть назву `Внести дані про лабораторію`, що відповідає назві змодельованої xref:#create-user-task-add-lab-data[користувацької задачі],  в полі `Бізнес-назва форми`;
. Заповніть поле `Службова назва форми` значенням `citizen-add-lab-bp-add-lab` (відповідає значенню поля `Form key` тієї ж xref:#create-user-task-add-lab-data[користувацької задачі]);

+
image:study-project/task-5/task-5-forms-2.png[]

+
[IMPORTANT]
====
* У компонентах "Область", "Населений пункт", та "Форма власності", на вкладці *Data* у полі `Data Source type URL` видаліть `/officer`.

* Переконайтеся, що остаточний вигляд компонентів є наступним:

** компонент "Область" -- `/api/data-factory/koatuu-obl-contains-name`;

** компонент "Населений пункт" -- `/api/data-factory/koatuu-np-starts-with-name-by-obl`;

** компонент "Форма власності" -- `/api/data-factory/ownership-contains-name`.
====

. Збережіть форму, натиснувши кнопку `Зберегти зміни` у правому верхньому куті.

+
image:study-project/task-5/task-5-forms-3.png[]

[#form-sign-data-by-citizen]
==== Моделювання форми підпису даних отримувачем послуг реєстру

Після завершення xref:#form-insert-data[попереднього етапу] зі створенням форми для внесення даних, _створіть ще одну форму -- для підпису даних_.

TIP: Змоделюйте форму для внесення даних користувачем, використовуючи приклад із xref:study-project/study-tasks/task-3-bp-modeling-with-integration.adoc#form-data-signing[Завдання 3].

. Скопіюйте xref:#form-insert-data[попередньо змодельовану форму], натиснувши _іконку копіювання_ -- це дозволить створити форму із готового шаблону.

. У новому вікні введіть назву відповідної xref:#create-user-task-lab-data-signing[користувацької задачі] `Підписати дані про лабораторію` в полі `Бізнес-назва форми`;
. Заповніть поле `Службова назва форми` значенням `shared-citizen-sign-lab` (відповідає значенню поля `Form key` тієї ж xref:#create-user-task-lab-data-signing[користувацької задачі]);

+
image:study-project/task-5/task-5-forms-4.png[]

. В усіх компонентах:

* На вкладці *Display* встановіть прапорець для параметра *Disabled*.
* Натисніть кнопку `Save` для збереження змін.

+
image:registry-develop:study-project/task-3/task-3-50-forms.png[]

. Збережіть форму, натиснувши кнопку `Зберегти зміни` у правому верхньому куті.

=== Моделювання форм за допомогою formVariables

==== Моделювання форми призначення виконавця задачі

. Увійдіть до застосунку [blue]#Кабінет адміністратора регламентів#:

+
image::registry-develop:bp-modeling/forms/admin-portal-form-modeling-step-1.png[]

. Перейдіть до розділу [blue]#Моделювання UI-форм#:

+
image:registry-develop:bp-modeling/forms/admin-portal-form-modelling-step-2.png[]

. Щоб створити нову форму для бізнес-процесу, натисніть кнопку `Створити нову форму`:

+
image:registry-develop:bp-modeling/forms/admin-portal-form-modelling-step-4.png[]

* У новому вікні, у полі `Бізнес-назва форми` вкажіть назву, що відповідає назві змодельованої xref:#create-user-task-set-executor-validate-docs[користувацької задачі] -- `Призначення виконавця задачі`.
* Заповніть поле `Службова назва форми` значенням `shared-dispatch-task` (має відповідати значенню поля `Form key` тієї ж xref:#create-user-task-set-executor-validate-docs[користувацької задачі]).

+
image:study-project/task-5/task-5-forms-5.png[]

. З панелі компонентів зліва перетягніть компонент *Select* до панелі моделювання та виконайте подальші налаштування компонента:

+
image:study-project/task-3/task-3-37-forms-drag-select.png[]

* Перейдіть на вкладку *Display* та заповніть поле `Label` значенням `Оберіть ПІБ виконавця`:

+
image:study-project/task-5/task-5-forms-6.png[]

+
* Перейдіть на вкладку *API* та заповніть поле `Property Name` значенням `userTaskAssignee`:

+
image:study-project/task-5/task-5-forms-7.png[]

+
* Перейдіть на вкладку *Data* та налаштуйте наступні параметри:
** у полі `Data source type` введіть `Custom`;
** у полі `Id Path` вкажіть `userName`;
** у полі `Custom Values` вкажіть `values = formVariables.officerUsers`;
** у полі `Item Template введіть `<span>{{ item.fullName }}</span>`.

* Натисніть кнопку `Save` для збереження.
+
image:study-project/task-5/task-5-forms-8.png[]

. Збережіть форму, натиснувши кнопку `Створити форму` у правому верхньому куті:
+
image:study-project/task-5/task-5-forms-9.png[]

[#form-check-data-by-officer]
==== Моделювання форми перевірки даних посадовою особою

Змоделюйте форму для можливості перевірки даних посадовою особою. Для цього виконайте наступні кроки:

. Скопіюйте форму xref:#form-sign-data-by-citizen[підпису даних отримувачем послуг], змодельовану вище, натиснувши _іконку копіювання_ -- це дозволить створити форму із готового шаблону:

* У новому вікні введіть назву `Перевірка унікальності запису про лабораторію`, що відповідає назві xref:#create-user-task-check-uniqueness-lab-record[користувацької задачі], у полі `Бізнес-назва форми`.

* Заповніть поле `Службова назва форми` значенням `shared-officer-check-lab` (має відповідати значенню поля `Form key` тієї ж xref:#create-user-task-check-uniqueness-lab-record[користувацької задачі]).

+
image:study-project/task-5/task-5-forms-10.png[]

. З панелі компонентів зліва перетягніть компонент *Checkbox* до панелі моделювання та виконайте подальші налаштування:

* Перейдіть на вкладку *Display* та заповніть поле `Label` значенням `Лабораторія не дублюється`:
+
image:study-project/task-5/task-5-forms-11.png[]

* Перейдіть на вкладку *API* та заповніть поле `Property Name` значенням `labUniqueCheckFlag`.
* Натисніть кнопку `Save` для збереження змін:
+
image:study-project/task-5/task-5-forms-12.png[]

. Збережіть форму, натиснувши кнопку `Створити форму` у правому верхньому куті:

image:study-project/task-5/task-5-forms-13.png[]

==== Моделювання форми підпису даних посадовою особою

Змоделюйте форму для можливості підпису даних посадовою особою. Для цього виконайте наступні кроки:

. Скопіюйте форму, змодельовану на xref:#form-check-data-by-officer[попередньому етапі], натиснувши _іконку копіювання_ -- це дозволить створити форму із готового шаблону:

* У новому вікні введіть назву `Підписати дані лабораторії`, що відповідає назві xref:#create-user-task-sign-lab-data[користувацької задачі], у полі `Бізнес-назва форми`.

* Заповніть поле `Службова назва форми` значенням `shared-officer-sign-lab` (має відповідати значенню поля `Form key` тієї ж xref:#create-user-task-sign-lab-data[користувацької задачі]).

. В усіх компонентах на формі налаштуйте:

* Перейдіть на вкладку *Display* та встановіть прапорець для параметра `Disabled` -- `True`.
* Натисніть кнопку `Save` для збереження.

. Збережіть форму, натиснувши кнопку `Створити форму` у правому верхньому куті:

+
image:study-project/task-5/task-5-forms-14.png[]

==== Завантаження змодельованих форм бізнес-процесу до локальної директорії

Завантажте форми, натиснувши _іконку завантаження_, та помістіть їх до регламентної папки *_forms_* проєкту в локальному Gerrit-репозиторії.

image:registry-develop:study-project/task-1/task-1-14-forms.png[]

[#bp-access]
=== Моделювання доступу до бізнес-процесу

[TIP]
====
На цьому етапі необхідно надати доступ до бізнес-процесу із Кабінету отримувача послуг.

Параметри доступу налаштовуються у конфігураційному файлі, що має назву _link:{attachmentsdir}/study-project/task-5/bp-access/citizen.yml[citizen.yml]_.
====

. Створіть файл _citizen.yml_ та сконфігуруйте в ньому наступні параметри:

+
.Приклад. Налаштування доступу до бізнес-процесу із Кабінету отримувача послуг реєстру
[source,yaml]
----
authorization:
  realm: 'citizen'
  process_definitions:
    - process_definition_id: 'citizen-add-lab'
      process_name: 'Процес створення лабораторії'
      process_description: 'Бізнес-процес створення лабораторії отримувачем послуг реєстру'
      roles:
        - 'unregistered-individual'
        - 'unregistered-entrepreneur'
        - 'unregistered-legal'
----

. xref:#save-roles-access-files[Збережіть файл] до папки *_bp-auth_* проєкту.

==== Створення нової ролі для розподілення задач в Кабінеті посадової особи

. Перейдіть до регламентної папки *_roles_*, знайдіть файл _link:{attachmentsdir}/study-project/task-5/bp-access/officer.yml[officer.yml]_ та додайте у ньому до наявних 2 нових параметри:

+
.Приклад. Додавання параметрів для створення ролі для розподілення задач
[source,yaml]
----
  - name: task-dispatcher
  description: Task dispatcher role
----

. xref:#save-roles-access-files[Збережіть файл] до папки *_bp-auth_* проєкту.

[#save-roles-access-files]
==== Збереження файлів із налаштуваннями доступу

Збережіть файл _officer.yml_ до регламентної папки *_bp-auth_* проєкту в локальному Gerrit-репозиторії.

== Завантаження файлів регламенту до віддаленого репозиторію Gerrit

Для успішного розгортання бізнес-процесу, форм, а також застосування правильних налаштувань доступу до бізнес-процесу у цільовому середовищі, адміністратор регламенту має завантажити збережені локально файли регламенту реєстру до віддаленого сховища коду Gerrit.

Для цього виконайте кроки з інструкції xref:registry-develop:registry-admin/regulations-deploy/registry-admin-deploy-regulation.adoc[].

== Додатки

=== Схема бізнес-процесу

* _link:{attachmentsdir}/study-project/task-5/bp-schema/citizen-add-lab.bpmn[citizen-add-lab.bpmn]_

=== Форми для бізнес-процесу

* _link:{attachmentsdir}/study-project/task-5/bp-forms/shared-officer-sign-lab.json[shared-officer-sign-lab.json]_
* _link:{attachmentsdir}/study-project/task-5/bp-forms/shared-officer-check-lab.json[shared-officer-check-lab.json]_
* _link:{attachmentsdir}/study-project/task-5/bp-forms/shared-dispatch-task.json[shared-dispatch-task.json]_
* _link:{attachmentsdir}/study-project/task-5/bp-forms/citizen-add-lab-bp-add-lab.json[citizen-add-lab-bp-add-lab.json]_

=== YAML для доступу до бізнес-процесу для ролі citizen

* _link:{attachmentsdir}/study-project/task-5/bp-access/citizen.yml[citizen.yml]_

=== YAML для створення нової ролі Task Dispatcher

* _link:{attachmentsdir}/study-project/task-5/bp-access/officer.yml[officer.yml]_


