= Завдання 7. Моделювання бізнес-процесу із викликом ШБО "Трембіта"
:sectnums:
:sectanchors:
:toc:
:toclevels: 5
:toc-title: ЗМІСТ

== Мета завдання

Виконання цього завдання має на меті: ::

* Навчитись моделювати бізнес-процес в якому присутній зовнішній виклик Трембіти

== Передумови

Перед проходженням завдання необхідно виконати наступні передумови:

. xref:registry-develop:bp-modeling/bp/bp-element-templates-installation-configuration.adoc#business-process-modeler-extensions-installation[Встановіть додаток Camunda Modeler і типові розширення до нього].
. xref:registry-develop:bp-modeling/forms/bp-modeling-forms-general-description.adoc[Ознайомтеся із компонентами FormIO для моделювання форм].

== Процес виконання завдання

=== Етапи моделювання бізнес-процесу

В рамках цього завдання моделювальник має створити бізнес-процес, що складається з наступних етапів:

* xref:#create-pool-participant[]
* xref:#create-start-event[]
* xref:#create-user-task-1[]
* xref:#create-service-task1[]
* xref:#create-task-script-data-signing[]
* xref:#create-user-task-2[]
* xref:#create-service-task2[]
* xref:#create-task-script-data-signing2[]
* xref:#create-user-task-3[]
* xref:#create-end-event[]
* xref:#save-bp-trembita[]

=== Моделювання бізнес-процесу

[#create-pool-participant]
==== Створення пулу для бізнес-процесу

Найперше, _змоделюйте пул для бізнес-процесу_. Для цього виконайте кроки, подані нижче:

NOTE: Моделювання діаграми бізнес-процесу має відбуватися в рамках елемента *Create Pool/Participant*.

. Відкрийте додаток *Camunda Modeler* та створіть нову діаграму BPMN. Для цього у лівому верхньому куті натисніть меню *File* -> *New File* -> *BPMN Diagram*:
+
image:registry-develop:bp-modeling/bp/modeling-instruction/bp-1.png[]

. На панелі інструментів зліва знайдіть елемент *Create pool/Participant* та перетягніть його до панелі моделювання:
+
image:registry-develop:bp-modeling/bp/modeling-instruction/bp-2.png[]

. Заповніть наступні поля відповідними значеннями:

* у полі `Name` введіть значення `Trembita Integration Demo`;
* у полі `Process id` вкажіть `trembita-integration-demo`;

+
image:registry-develop:study-project/task-7/task-7-1-trembita.png[]


[#create-start-event]
==== Створення початкової події

_Створіть початкову подію_. Для цього виконайте наступні кроки:

. На панелі інструментів, зліва, знайдіть елемент (коло) *CreateStartEvent* та перетягніть його до панелі моделювання:

. На панелі налаштувань справа заповніть наступні параметри відповідними значеннями:
** у полі `id` введіть `StartEvent_1`;
** у полі `Initiator` введіть `initiator`.

+
image:registry-develop:study-project/task-7/task-7-2-trembita.png[]

[#create-user-task-1]
==== Створення користувацької задачі створення форми для заповнення даних

Далі _створіть користувацьку задачу, призначену для додавання даних користувачем_. Для цього виконайте наступні кроки:

. Оберіть коло з початковою подією, змодельованою на xref:#create-start-event[попередньому етапі], та приєднайте нову задачу, натиснувши іконку *Append Task*:
+
image:study-project/task-3/task-3-3-bp-append-task.png[]

. Вкажіть тип задачі, натиснувши іконку ключа та обравши з меню пункт *User Task* (Користувацька задача):
+
image:study-project/task-3/task-3-3-bp-user-task.png[]

. На панелі налаштувань справа натисніть `Open Catalog`, оберіть шаблон *User Form* (*Користувацька форма*) та натисніть `Apply` для підтвердження:
+
image:study-project/task-3/task-3-3-bp-open-catalog.png[]
+
image:study-project/task-3/task-3-3-bp-user-form.png[]

. На панелі налаштувань справа заповніть наступні поля:

* у полі `Id` зазначте `task1`;
* у полі `Name` введіть `user task1`;
* у полі `Form key` введіть `search-subject-form`;
* у полі `Assignee` вкажіть `${initiator}`.

+
image:study-project/task-7/task-7-3-trembita.png[]

[#create-service-task1]
==== Створення сервісної задачі пошуку інформації за суб’єктом в ЄДР

Далі необхідно створити сервісну задачу пошуку інформації за суб’єктом в ЄДР (*search subject*). Для цього виконайте наступні кроки:

. Оберіть прямокутник із користувацькою задачею `user task1`, змодельованою на xref:#create-user-task-1[попередньому етапі], та приєднайте нову сервісну задачу, натиснувши іконку *Append Task*:
+
image:study-project/task-7/task-7-4-trembita.png[]

. Вкажіть тип задачі, натиснувши іконку ключа та обравши з меню пункт Service Task (Сервісна задача):
+
image:study-project/task-7/task-7-5-trembita.png[]

. На панелі налаштувань справа натисніть Open Catalog, оберіть шаблон Search Subjects Edr Registry та натисніть Apply для підтвердження:
+
image:bp-modeling/ext-integration/connectors/edr/element-template-settings-01.png[]

. На панелі налаштувань справа заповніть наступні поля:
* у полі `Id` введіть `Activity_0knm45m`;
* у полі `Name` введіть `search subject`;
* у полі `Authorization token` зазначте `авторизаційний токен системи в, яку робиться запит`;
* у полі `Code` вкажіть `${submission('task1').formData.prop('code').value()}`;
* у полі `VResult` variable вкажіть `ssResponse`.

+
image:study-project/task-7/task-7-7-trembita.png[]

[#create-task-script-data-signing]
==== Створення задачі скриптування підготування даних для користувацької задачі 2

На цьому етапі необхідно змоделювати задачу скриптування *(prepare from data for task2)* для підготовки даних до показу. Для цього виконайте наступні кроки:

. Оберіть прямокутник із сервісною задачею *search subject*, змодельованою на xref:#create-service-task1[попередньому етапі], та приєднайте нову задачу скриптування, натиснувши іконку Append Task:
+
image:study-project/task-7/task-7-8-trembita.png[]

. Вкажіть тип задачі, натиснувши іконку ключа та обравши з меню пункт *Script Task* (Задача скриптування):
+
image:study-project/task-7/task-7-9-trembita.png[]

. Виділіть додану задачу скриптування та налаштуйте наступні параметри:

* у полі `Name` вкажіть `prepare from data for task2`;
* у полі `Script Format` вкажіть тип (мову) скриптування -- `groovy`;
* у полі `Script Type` вкажіть тип скрипту `InlineScript`;
* у полі `Script` вставте безпосередньо groovy-скрипт:
+
[source,groovy]
----
def response = ssResponse.responseBody.elements().get(0)

def formPrePopulation = [:]
formPrePopulation['id'] = response.prop('id').value().toString()
formPrePopulation['code'] = response.prop('code').value()
formPrePopulation['name'] = response.prop('name').value()
formPrePopulation['state'] = response.prop('state').value()

execution.removeVariable('payload')
set_transient_variable('payload', S(formPrePopulation, 'application/json'))
----

+
image:study-project/task-7/task-7-10-trembita.png[]

[#create-user-task-2]
==== Створення користувацької задачі відображення інформації за суб’єктом в ЄДР

На прикладі xref:create-user-task-1[] необхідно створити користувацьку задачу відображення інформації за суб’єктом в ЄДР *(user task2)*. Для цього виконайте наступні кроки:

. Визначте тип задачі, натиснувши іконку ключа та обравши з меню пункт `User Task` (Користувацька задача).

. Натисніть `Open Catalog`, оберіть шаблон `User Form Task` та натисніть `Apply` для підтвердження.

. На панелі налаштувань справа заповніть наступні поля:
* у полі `Id` вкажіть `task2`;
* у полі `Name` введіть `user task2`;
* у полі `Form key` введіть `display-search-subject-form`;
* у полі `Assignee` вкажіть `${initiator}`;
* у полі `Form data pre-population` введіть `${payload}`.

+
image:study-project/task-7/task-7-11-trembita.png[]

[#create-service-task2]
==== Створення сервісної задачі пошуку деталізованої інформації за суб’єктом в ЄДР

. На прикладі xref:create-service-task1[] створіть та приєднайте нову сервісну задачу пошуку деталізованої інформації за суб’єктом в ЄДР *get subject detail*, натиснувши іконку ключа та обравши з меню пункт `Service Task`.

. Натисніть `Open Catalog`, оберіть шаблон *Get Subject Detail Edr Registry* та натисніть Apply для підтвердження.

. На панелі налаштувань справа сконфігуруйте наступні параметри:
* у полі `Named` введіть `get subject detail`;
* у полі `Authorization token` зазначте `Авторизаційний токен системи в яку робиться запит`;
* у полі `Codey` введіть `${submission('task2').formData.prop('id').value()}`;
* у полі `Result variable` вкажіть `sdResponse`.

+
image:study-project/task-7/task-7-12-trembita.png[]

Конектор повертає наступні поля:

[width="100%",cols="10%,60%,40%",options="header",]
|===
|_Поле_|_Опис поля згідно документації ЄДР_|_Приклад значення_
|address|Адреса|м.Харків, Шевченківський район ВУЛИЦЯ 23 СЕРПНЯ буд. 4488
|code|ЄДРПОУ; якщо суб’єкт - фізична особа-підприємець, замість ІПН система поверне десять нулів, бо ці дані є конфіденційною інформацією|1010101014
|email|Електронна адреса|example@mail.com
|name|Назва|Сидоренко Василь Леонідович
|olfCode|Код організаційно-правової форми суб’єкта, якщо суб’єкт – юридична особа|1010
|olfName|Назва організаційно-правової форми суб’єкта, якщо суб’єкт – юридична особа|ОРГАН ДЕРЖАВНОЇ ВЛАДИ 4
|===

[#create-task-script-data-signing2]
==== Створення задачі скриптування підготування даних для користувацької задачі 3

. На прикладі xref:#create-task-script-data-signing[] створіть та приєднайте нову задачу скриптування *prepare from data for task3*, натиснувши іконку ключа та обравши з меню пункт `Script Task`.

. Оберіть прямокутник із сервісною задачею *get subject detail*, змодельованою на xref:#create-service-task2[попередньому етапі], та приєднайте нову задачу скриптування, натиснувши іконку Append Task

. На панелі налаштувань справа сконфігуруйте наступні параметри:
* у полі `Name` вкажіть `prepare form data for task3`;
* у полі `Script Format` вкажіть тип (мову) скриптування -- `groovy`;
* у полі `Script Type` вкажіть тип скрипту `InlineScript`;
* у полі `Script` вставте безпосередньо groovy-скрипт:
+
[source,groovy]
----
def formPrePopulation = [:]

['email', 'address'].each {
    formPrePopulation[it] = sdResponse.responseBody.prop(it).value()
}

execution.removeVariable('payload')
set_transient_variable('payload', S(formPrePopulation, 'application/json'))
----

+
image:study-project/task-7/task-7-13-trembita.png[]

[#create-user-task-3]
==== Створення користувацької задачі відображення деталізованої інформації за суб’єктом в ЄДР

На прикладі xref:create-user-task-1[] необхідно створити користувацьку задачу *(user task3)*. Для цього виконайте наступні кроки:

. Визначте тип задачі, натиснувши іконку ключа та обравши з меню пункт `User Task` (Користувацька задача).

. Натисніть `Open Catalog`, оберіть шаблон `User Form Task` та натисніть `Apply` для підтвердження.

. На панелі налаштувань справа заповніть наступні поля:
* у полі `Name` введіть `user task3`;
* у полі `Form key` введіть `display-additional-info`;
* у полі `Assignee` вкажіть `${initiator}`;
* у полі `Form data pre-population` введіть `${payload}`.

+
image:study-project/task-7/task-7-14-trembita.png[]

[#create-end-event]
==== Створення події завершення бізнес-процесу

. Оберіть прямокутник із щойно створеною задачею xref:#create-user-task-3[], приєднайте та налаштуйте _подію, що завершує процес_, натиснувши іконку `Append EndEvent`:
+
image:study-project/task-7/task-7-15-trembita.png[]


. На панелі налаштувань справа у полі `Name` вкажіть `Кінець`.
+
image:study-project/task-7/task-7-16-trembita.png[]

[#save-bp-trembita]
==== Збереження змодельованої схеми бізнес-процесу

Після завершення процесу моделювання збережіть отриману схему бізнес-процесу із назвою _trembita-invocation.bpmn_ регламентної папки *_bpmn_* проєкту в Gerrit-репозиторії. Для цього у лівому верхньому куті відкрийте меню *File* -> *Save File As..*, введіть відповідну назву та шлях.

=== Моделювання форм

[TIP]
====
На етапі моделювання форм необхідно створити та прив'язати JSON-форми до попередньо змодельованих задач в рамках бізнес-процесу.

Форми прив'язуються до бізнес-процесів за службовою назвою.

Використовуйте файли _link:{attachmentsdir}/study-project/task-7/bp-forms/display-additional-info.json[display-additional-info.json]_, _link:{attachmentsdir}/study-project/task-7/bp-forms/display-search-subject-form.json[display-search-subject-form.json]_  та _link:{attachmentsdir}/study-project/task-7/bp-forms/search-subject-form.json[search-subject-form.json]_ зі змодельованими формами для прикладу.
====

[#search-subject-form]
==== Створення форми для внесення даних

Найперше, необхідно _створити форму внесення даних для пошуку_ користувачем (search-subject-form). Для цього виконайте наступні кроки:

. Увійдіть до застосунку [blue]#Кабінет адміністратора регламентів#:

+
image::registry-develop:bp-modeling/forms/admin-portal-form-modeling-step-1.png[]

. Перейдіть до розділу [blue]#Моделювання UI-форм#:

+
image:registry-develop:bp-modeling/forms/admin-portal-form-modelling-step-2.png[]

. Щоб створити нову форму для бізнес-процесу, натисніть кнопку `Створити нову форму`:

+
image:registry-develop:bp-modeling/forms/admin-portal-form-modelling-step-4.png[]

. У новому вікні, у полі `Бізнес-назва форми` вкажіть назву -- `search-subject-form`,  полі `Службова назва форми` - `search-subject-form`:

+
image:study-project/task-7/task-7-17-trembita.png[]

. З панелі компонентів зліва перетягніть компонент *Text Field* до панелі моделювання та виконайте подальші налаштування:
+
image:study-project/task-3/task-3-27-forms-drag-text-field.png[]

* У новому вікні перейдіть на вкладку *Display*, заповніть поле `Label` значенням `Erdpou or rnokpp`:
+
image:study-project/task-7/task-7-18-trembita.png[]

* Перейдіть на вкладку *Validation* та встановіть прапорець для параметра  `Required` -- `true`:
+
image:study-project/task-7/task-7-19-trembita.png[]

* Перейдіть на вкладку *API* та заповніть поле `Property Name` значенням `code`. Натисніть кнопку `Save` для збереження змін:
+
image:study-project/task-7/task-7-20-trembita.png[]

. Збережіть форму, натиснувши кнопку `Зберегти зміни` у правому верхньому куті:
+
image:study-project/task-7/task-7-21-trembita.png[]

[#display-search-subject-form]
==== Створення форми для відображення даних

Наступним кроком необхідно створити форму для відображення даних пошуку (display-search-subject-form). Для цього виконайте за аналогією xref:#search-subject-form[попереднього пункту] наступні кроки:

. Увійдіть до застосунку [blue]#Кабінет адміністратора регламентів#.

. Перейдіть до розділу [blue]#Моделювання UI-форм#.

. Натисніть кнопку `Створити нову форму`.

. У новому вікні, у полі `Бізнес-назва форми` вкажіть назву -- `display-search-subject-form`,  полі `Службова назва форми` - `display-search-subject-form`.

. З панелі компонентів зліва перетягніть компонент *Text Field* до панелі моделювання. Необхідно змоделювати 4 таких поля: `ID`, `Code`, `Name`, `State`, та виконати їх налаштування:

* Змоделюйте текстове поле `ID`:
** У новому вікні перейдіть на вкладку *Display*, заповніть поле `Label` значенням `ID`.
** Перейдіть на вкладку *API* та заповніть поле `Property Name` значенням `ID`.
** Натисніть кнопку `Save` для збереження змін.

* Змоделюйте текстове поле `Code`:
** У новому вікні перейдіть на вкладку *Display*, заповніть поле `Label` значенням `Code`.
** Перейдіть на вкладку *API* та заповніть поле `Property Name` значенням `Code`.
** Натисніть кнопку `Save` для збереження змін.

* Змоделюйте текстове поле `Name`:
** У новому вікні перейдіть на вкладку *Display*, заповніть поле `Label` значенням `Name`.
** Перейдіть на вкладку *API* та заповніть поле `Property Name` значенням `Name`.
** Натисніть кнопку `Save` для збереження змін.

* Змоделюйте текстове поле `State`:
** У новому вікні перейдіть на вкладку *Display*, заповніть поле `Label` значенням `State`.
** Перейдіть на вкладку *API* та заповніть поле `Property Name` значенням `State`.
** Натисніть кнопку `Save` для збереження змін.

+
image:study-project/task-7/task-7-22-trembita.png[]

. Збережіть форму, натиснувши кнопку `Створити форму` у правому верхньому куті.

[#display-additional-info]
==== Створення форми для відображення додаткової інформації

Наступним кроком необхідно створити форму для відображення додаткової інформації (display-additional-info). Для цього виконайте за аналогією xref:#search-subject-form[попереднього пункту] наступні кроки:

. Увійдіть до застосунку [blue]#Кабінет адміністратора регламентів#.

. Перейдіть до розділу [blue]#Моделювання UI-форм#.

. Натисніть кнопку `Створити нову форму`.

. У новому вікні, у полі `Бізнес-назва форми` вкажіть назву -- `display-additional-info`,  полі `Службова назва форми` - `display-additional-info`.

. З панелі компонентів зліва перетягніть компонент *Text Field* до панелі моделювання. Необхідно змоделювати 2 таких поля: `Address`, `Email`, та виконати їх налаштування:

* Змоделюйте текстове поле `Address`:
** У новому вікні перейдіть на вкладку *Display*, заповніть поле `Label` значенням `Address`.
** Перейдіть на вкладку *API* та заповніть поле `Property Name` значенням `Address`.
** Натисніть кнопку `Save` для збереження змін.

* Змоделюйте текстове поле `Email`:
** У новому вікні перейдіть на вкладку *Display*, заповніть поле `Label` значенням `Email`.
** Перейдіть на вкладку *API* та заповніть поле `Property Name` значенням `Email`.
** Натисніть кнопку `Save` для збереження змін.

+
image:study-project/task-7/task-7-23-trembita.png[]

. Збережіть форму, натиснувши кнопку `Створити форму` у правому верхньому куті.

=== Моделювання доступу до бізнес-процесу

[TIP]
====
На цьому етапі необхідно надати доступ до бізнес-процесу із Кабінету посадової особи.

Параметри доступу налаштовуються у конфігураційному файлі, що має назву _link:{attachmentsdir}/study-project/task-7/bp-access/officer.yml[officer.yml]_.
====

Створіть файл _officer.yml_ та сконфігуруйте в ньому наступні параметри:


.Приклад. Налаштування доступу до бізнес-процесу із Кабінету посадової особи
[source,yaml]
----
authorization:
  realm: 'officer'
  process_definitions:
    - process_definition_id: 'trembita-integration-demo'
      process_name: 'test'
      process_description: 'test'
      roles:
        - officer
----

Збережіть файл _officer.yml_ до регламентної папки *_bp-auth_* проєкту в локальному Gerrit-репозиторії.

== Завантаження файлів регламенту до віддаленого репозиторію Gerrit

Для успішного розгортання бізнес-процесу, форм, а також застосування правильних налаштувань доступу до бізнес-процесу у цільовому середовищі, адміністратор регламенту має завантажити збережені локально файли регламенту реєстру до віддаленого сховища коду Gerrit.

Для цього виконайте кроки з інструкції xref:registry-develop:registry-admin/regulations-deploy/registry-admin-deploy-regulation.adoc[].

== Додатки

=== Схема бізнес-процесу

* _link:{attachmentsdir}/study-project/task-7/bp-schema/trembita-integration.bpmn[trembita-integration.bpmn]_

=== Форми для бізнес-процесу

* _link:{attachmentsdir}/study-project/task-7/bp-forms/display-additional-info.json[display-additional-info.json]_
* _link:{attachmentsdir}/study-project/task-7/bp-forms/display-search-subject-form.json[display-search-subject-form.json]_
* _link:{attachmentsdir}/study-project/task-7/bp-forms/display-search-subject-form.json[display-search-subject-form.json]_

=== YAML для створення ролі officer

* _link:{attachmentsdir}/study-project/task-7/bp-access/officer.yml[officer.yml]_

