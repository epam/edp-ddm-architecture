:toc-title: ЗМІСТ
:toc: auto
:toclevels: 5
:experimental:
:important-caption:     ВАЖЛИВО
:note-caption:          ПРИМІТКА
:tip-caption:           ПІДКАЗКА
:warning-caption:       ПОПЕРЕДЖЕННЯ
:caution-caption:       УВАГА
:example-caption:           Приклад
:figure-caption:            Зображення
:table-caption:             Таблиця
:appendix-caption:          Додаток
:sectnums:
:sectnumlevels: 5
:sectanchors:
:sectlinks:
:partnums:

= Автентифікація користувачів реєстру

== Загальний опис

Платформа реалізовує складні механізми автентифікації кінцевих користувачів, що дозволяє забезпечити належний захист даних користувачів реєстрів, а також нівелювати можливість несанкціонованого доступу до даних.

//TODO: Link to id.gov.ua
В центрі механізму автентифікації стоїть [.underline]#Система управління ідентифікацією та доступом (IAM) Keycloak#, яка взаємодіє із [.underline]#Сервісом для роботи з КЕП# та інтегрованою системою електронної ідентифікації *ID.GOV.UA (ICEI)*. Також на Платформі функціонують специфічні сервіси автентифікації посадових осіб та отримувачів послуг реєстру.

Наразі Платформа підтримує 2 типи автентифікації: ::

* [*] автентифікація користувача за допомогою кваліфікованого електронного підпису (КЕП);
* [*] автентифікація користувача за допомогою інтегрованої системи електронної ідентифікації ID.GOV.UA (ІСЕІ) -- зовнішнього постачальника ідентифікаційних даних та схем електронної ідентифікації, що надаються цією системою, а саме:

** КЕП;
** BankID.

[auth-logic]
=== Логіка автентифікації користувачів

За автентифікацію користувачів реєстру відповідають такі сервіси:

* [.underline]#Сервіс автентифікації отримувачів послуг# -- `*keycloak-ds-citizen-authenticator*`;
* [.underline]#Сервіс автентифікації посадових осіб# -- `*keycloak-ds-officer-authenticator*`.

Для ідентифікації користувача у системі, сервіс автентифікації має отримати з КЕП, або від зовнішнього надавача послуг (`id.gov.ua`) як обов'язкові вхідні параметри наступні атрибути:

* `*drfo*` (`РНОКПП`) -- ідентифікаційний номер, або серія і номер паспорта особи.

* `*edrpou*` (`ЄДРПОУ`) -- код організації, до якої належить особа.

* `*fullName*` (`ПІБ`) -- прізвище, ім'я та по батькові особи.

У процесі автентифікації відбувається пошук користувача у базі даних за атрибутом `drfo`. Якщо користувача з відповідним атрибутом знайдено, то відбувається порівняння атрибутів `fullName` та `edrpou` (за наявності). [.underline]#Порівняння атрибутів `drfo` та `edrpou` відбувається за повним збігом їх значень#.

[TIP]
====
Наприклад: ::

Сервіс автентифікації отримує, РНОКПП особи, виконує запит до сервісу Keycloak, отримує там необхідний атрибут та звіряє його з тим, що вказано у КЕП. Якщо значення у Keycloak та КЕП повністю збігаються, то перевірка проходить успішно, якщо ні -- користувач отримає помилку автентифікації.
====

Для атрибута `*fullName*` (`ПІБ`) застосовується інша стратегія -- [.underline]#нечітке порівняння рядків, що не враховує спеціальні символи#. Вона передбачає наступні валідаційні правила:

* Перед порівнянням рядки приводяться до нижнього регістру.
* Видаляються усі символи, окрім латинських та кириличних літер та цифр.
* Довжина рядка після нормалізації має бути не менш як 50% від оригінального.

[TIP]
====
Наприклад: ::

Якщо користувач заведений у Keycloak як `fullName: "Маряна-Іриna  Сергіївна"`, а у КЕП вказано `fullName: "Мар'яна-Іриna Сергіївна!%?"`, то користувач зможе пройти автентифікацію та увійти до Кабінету.


====


[#kep-auth]
== Автентифікація за допомогою КЕП

Автентифікація користувачів за допомогою [.underline]#кваліфікованого електронного підпису (КЕП)# відбувається з використанням встановленого на стороні браузера стороннього віджета https://iit.com.ua/downloads[IIT] для виконання операцій, що вимагають шифрування та підпису даних, а також сервісу для роботи з КЕП, що використовує окрему криптобібліотеку від IIT на стороні Платформи для перевірки цілісності та незмінності даних, що передаються з вебклієнта.

Взаємодія користувачів з Платформою та розгорнутими на її базі реєстрами відбувається виключно через імплементовані вебінтерфейси -- додатки **Кабінет отримувача послуг** та **Кабінет посадової особи** -- із будь-якого визнаного індустрією браузера останньої версії.

Автентифікація з КЕП передбачає використання асиметричних алгоритмів шифрування, що забезпечують криптографічний захист даних користувачів.

Для отримання доступу до функцій Кабінету, користувач має увійти до системи, виконавши кроки, описані нижче в інструкції.

CAUTION: Автентифікація з КЕП доступна для користувачів Кабінетів посадової особи та отримувача послуг реєстру.


=== Передумови

Отримайте особистий ключ для підпису даних в одному з https://czo.gov.ua/ca-registry[акредитованих центрів сертифікації ключів (АЦСК)]. Відкритий ключ зберігатиметься на сервері постачальника, в той час, як секретний (закритий) ключ необхідно буде зберегти на одному із захищених носіїв, доступних для використання при вході до системи за допомогою КЕП (_див. крок 3 в підрозділі  xref:auth-process-pass[]_).

[#auth-process-pass]
=== Проходження автентифікації

NOTE: Процес автентифікації за допомогою КЕП є ідентичним як для посадових осіб, так і для отримувачів послуг реєстру.

Розглянемо процес проходження автентифікації на прикладі Кабінету отримувача послуг.

[#auth-step-1]
Крок 1 ::

* Відкрийте сторінку входу до [.underline]#Кабінету отримувача послуг# за адресою `http://citizen-portal-<назва-реєстру>-main.apps.envone.dev.registry.eua.gov.ua/`, якщо ви фізична, або юридична особа, або ФОП і хочете замовити послугу.

* Відкрийте сторінку входу до [.underline]#Кабінету посадової особи# за адресою `http://officer-portal-<назва-реєстру>-main.apps.envone.dev.registry.eua.gov.ua/officer/`, якщо ви посадова особа, що уповноважена надавати послуги.
+
CAUTION: Адреси сервісів, що наведені у тексті вище, є шаблонними. Підставте назву свого реєстру в URL сервісу. При виникненні будь-яких питань, зверніться до адміністратора.

[#auth-step-2]
Крок 2 ::

Натисніть kbd:[Увійти до кабінету].
+
image:user:cp-auth-1.png[]

[#iit-digital-sign-widget]
Крок 3 ::

. Оберіть тип послуг:

* [.underline]#Для громадян# -- якщо ви бажаєте увійти як фізична особа (параметр встановлюється за замовчуванням);
* Для бізнесу -- якщо ви бажаєте увійти як ФОП або юридична особа.

. Оберіть тип носія особистого ключа. +
Оберіть [.underline]#Файловий носій# (параметр встановлюється за замовчуванням).
+
image:user:cp-auth-2.png[]

. У полі `Кваліфікований надавач ел. довірчих послуг` оберіть один з акредитованих центрів сертифікації ключів (АЦСК), натиснувши на елемент випадного списку, або залиште значення `Визначити автоматично`, встановлене за замовчуванням.
+
image:user:cp-auth-3.png[]

. Оберіть особистий ключ:

* У полі `Особистий ключ` натисніть kbd:[Обрати].
* Знайдіть особистий ключ (наприклад `Key-6.dat`) та натисніть kbd:[Open] для підтвердження.
+
image:user:cp-auth-4.png[]

. У полі `Пароль захисту ключа` введіть пароль захисту ключа.
. Натисніть kbd:[Зчитати] для перевірки введених даних.
+
image:user:cp-auth-5.png[]

Крок 4 ::

. На формі _підпису даних_ натисніть kbd:[Увійти] для входу до Кабінету.
. (_Альтернативно_) Натисніть kbd:[Змінити ключ], якщо необхідно обрати інший ключ для входу.
+
image:user:cp-auth-6.png[]
+
[WARNING]
====
У разі використання невірного ключа, на кроці підпису даних сервер повертає помилку:

image:user:cp-auth-7-wrong-key.png[]
====
+
[WARNING]
====
У разі введення невірних ідентифікаційних даних (як-от пароль захисту ключа тощо), на кроці підпису даних сервер повертає таку помилку:

image:user:cp-auth-8-wrong-credentials.png[]
====

[NOTE]
====
Після успішного проходження автентифікації у Кабінеті отримувача послуг, під час першого входу, особі буде запропоновано пройти процес онбордингуfootnote:[[.underline]#Онбординг# -- реєстрація в системі.]. Після проходження цього процесу, особа отримає доступ до функцій Кабінету.
====

NOTE: У Кабінеті посадової особи процес онбордингу не передбачений. Тому перед входом до Кабінету необхідно переконатися, що адміністратор доступу створив відповідного користувача.

== Автентифікація з ID.GOV.UA

CAUTION: Розділ у процесі модернізації.

//TODO: Check if that's topical
NOTE: Автентифікація з ID.GOV.UA доступна лише в Кабінеті отримувача послуг реєстру і не передбачається для посадових осіб. Посадові особи мають проходити процедуру автентифікації виключно з КЕП.

На Платформі реалізована можливість проходження електронної ідентифікації за допомогою електронних підписів з використанням вбудованого віджета `*id.gov.ua*`.

[.underline]#Інтегрована система електронної ідентифікації ID.GOV.UA (ІСЕІ)# має атестат відповідності комплексної системи захисту інформації (КСЗІ), тому персональні дані користувачів надійно захищені.

TIP: Для отримання деталей підключення та використання ID.GOV.UA, будь ласка, зверніться до https://id.gov.ua/downloads/IDInfoProcessingD.pdf[технічної документації] або https://id.gov.ua/[офіційного сайту].

=== Передумови

. Найперше, виконайте xref:#auth-step-1[крок 1] та xref:#auth-step-1[крок 2] цього документа.
. Натисніть на відповідний елемент для автентифікації з ID.GOV.UA:
+
//TODO: Updated screenshot
image:user:cp-auth-idgovua-1.png[]

. Оберіть бажану схему (спосіб) автентифікації:

** xref:citizen-officer-portal-auth.adoc#auth-bank-id[BankID]

// TODO: Updated screenshot
image:user:cp-auth-idgovua-2.png[]

** Дотримуйтеся інструкцій, описаних у підрозділах нижче.

////
[#auth-mobile-id]
=== Автентифікація з MobileID

**MobileID** -- послуга електронної ідентифікації та кваліфікованого електронного підпису, яку надає оператор мобільного зв’язку. Ця послуга передбачає, що особистий ключ записується безпосередньо на спеціально призначену для цього SIM-карту.

За більш детальною інформацією щодо можливості надання цієї послуги ви можете звернутись до вашого оператора мобільного зв’язку.

Щоб авторизуватися на сайті за допомогою MobileID, вам необхідно:

1. Обрати вашого мобільного оператора.

2. Ввести ваш номер мобільного телефону.

3. Підтвердити вхід або підпис за допомогою пін-коду, який ви створили ще при підключенні послуги.
////

[#auth-bank-id]
=== Автентифікація з BankID НБУ

Сервіс надається Національним банком України та можливий лише для клієнтів тих банків, які його підтримують.

Після обрання свого банку ви будете переадресовані на його сайт для проходження автентифікації з використанням логіна, пароля, номера картки.

У разі успішної автентифікації на сайті банку, система Bank ID передасть ваші персональні дані, що дозволить вас ідентифікувати.

////
[#auth-dia-signature]
=== Автентифікація з Дія.Підпис

**Дія ID** -- послуга електронної ідентифікації для користувачів, які отримували особистий ключ віддалено за допомогою мобільного застосунку Дія. Дія.Підпис містить дві частини. Одна частина зберігається у вашому смартфоні, а інша — в спеціальному захищеному модулі порталу Дія.

Отримати особистий ключ віддалено за допомогою мобільного застосунку Дія мають можливість громадяни України, які є власниками ID-картки або біометричного закордонного паспорта.

Щоб авторизуватися на сайті за допомогою Дія ID, вам необхідно:

1. Відсканувати QR-код.

2. Зчитати особистий ключ шляхом сканування обличчя (перевірки за фото) та вводу пароля до особистого ключа.

3. У разі успішної автентифікації у мобільному застосунку Дія, система передає ваші персональні дані, що дозволить вас ідентифікувати.
////