:toc-title: ЗМІСТ
:toc: auto
:toclevels: 5
:experimental:
:important-caption:     ВАЖЛИВО
:note-caption:          ПРИМІТКА
:tip-caption:           ПІДКАЗКА
:warning-caption:       ПОПЕРЕДЖЕННЯ
:caution-caption:       УВАГА
:example-caption:           Приклад
:figure-caption:            Зображення
:table-caption:             Таблиця
:appendix-caption:          Додаток
:sectnums:
:sectnumlevels: 5
:sectanchors:
:sectlinks:
:partnums:

= Управління користувачами

[WARNING]
====
Рекомендуємо виконувати усі налаштування, використовуючи браузер link:https://www.google.com/intl/uk_ua/chrome/[Google Chrome] для стабільної роботи усіх сервісів.
====

== Загальний опис

Створення нових користувачів та надання їм прав доступу до інструментів реєстру здійснюється в **консолі адміністратора** сервісу https://www.keycloak.org/[Keycloak].

[TIP]
====
Посилання до сервісу Keycloak відповідного реєстру можливо отримати, наприклад, в *Openshift*, для цього необхідно перейти до меню `Networking` → `Routes`, обрати у `Project` - `user-management`, у пошуку вказати `keycloak` та перейти за посиланням у колонці `Location`.

image:admin:user-management/user-management-01.png[]

Або за наявним посиланням у *Сontrolplane*, обравши відповідний реєстр у меню `Реєстри`, внизу сторінки буде доступне посилання на сервіс Keycloak.

image:admin:user-management/user-management-02.png[]
====

[realms-access]
=== Доступ до реалмів реєстру

Адміністратор Платформи повинен мати доступ до 4-х reamlfootnote:[*Realm* - це концепція в https://www.keycloak.org/[Keycloak], яка відноситься до об'єкта,
що керує набором користувачів, а також їхніми обліковими даними, ролями та групами.] реєстру: `-admin`, `officer-portal`, `-citizen-portal`, `external-system`.

image:admin:user-management/user-management-03.png[]

.Реалми реєстру та їх призначення

|===
|*Realm* |*Призначення*

|`-admin`
|Реалм для доступу до адміністративних інструментів, таких як Gerrit, Jenkins, Camunda реєстру.

|`-officer-portal`
|Призначення ролей для доступу до Кабінету Посадової особи (**Officer Portal**) та звітів (https://redash.io/[Redash]).

|`-citizen-portal`
|Призначення ролей для доступу до Кабінету отримувача послуг (**Citizen Portal**).

|`-external-system`
|Призначення ролей для доступу до зовнішніх систем (наприклад, "Трембіта" та ін.).

|===

[type-roles]
=== Типи ролей для Кабінетів посадової особи та отримувача послуг реєстру

Ролі у системі Keycloak розподілені на **системні** та **регламентні**:

* **Системні** -- створюються Платформою під час розгортання реєстру або встановлення Платформи (наприклад, `officer`, `citizen`, `auditor` тощо).
* **Регламентні** -- створюються під час розгортання реєстру та налаштовуються в регламенті реєстру -> директорія  `roles` -> у відповідному конфігураційному файлі `.yml`.

TIP: _Наприклад, створення ролей Кабінету посадової особи відбувається через налаштування їх у відповідному файлі `officer.yml`:_

image:admin:user-management-auth/keycloak/keycloak-permissions/registry-roles.png[]

<<<

== Адміністрування доступу користувачів до Кабінету посадової особи

=== Створення окремого користувача у Keycloak та надання прав доступу

Для створення нового користувача у Keycloak, необхідно виконати наступні кроки:

["arabic"]
.  Перейдіть до realm `-officer-portal` відповідного реєстру:

** На вкладці *Users* натисніть `View all users`;
** Натисніть кнопку `Add user`.
+
image:admin:user-management/user-management-04.png[]

. У відкритому вікні введіть дані користувача:
+
--
** `Username` -- імя, що буде використовуватись як логін.
** `Email` -- електронна пошта користувача.
** `First Name` -- ім'я користувача.
** `Last Name` -- прізвище.
** `User Enabled` -- позначка, що користувач активований у системі (якщо вона не активна, доступ такого користувача до систем буде обмежено).
** `Email Verified` -- активується у разі необхідності підтвердження електронної пошти.
--
+
image:admin:user-management/user-management-33.png[]

. Натисніть кнопку `Save`.

. Перейдіть до вкладки *Credential*.

. Введіть пароль у полі `Password` та підтвердьте його в полі `Password Confirmation`. +
Активуйте позначку `Temporary`, щоб згенерувати тимчасовий пароль.
+
[CAUTION]
====
З метою безпеки необхідно змінити тимчасовий пароль при першій авторизації в системі.
====
+
image:admin:user-management/user-management-34.png[]

. Натисніть кнопку `Set Password`.
+
image:admin:user-management/user-management-35.png[0,740]


. Перейдіть на вкладку *Role Mappings* та призначте необхідні ролі користувачу.
Натисніть кнопку `Add selected`.
+
[NOTE]
====
Необхідно призначити дві обов'язкові ролі для РПЗМ:

* officer -- надає доступ до Кабінету посадової особи;
* officer-omc -- надає доступ до бізнес-процесів у Кабінеті посадової особи.
====
+
image:admin:user-management/user-management-36.png[]

. Надані ролі будуть показані в секції *Assigned Roles*.
+
image:admin:user-management/user-management-37.png[]

. Перейдіть на вкладку *Attributes* та встановіть значення для ключів параметрів `drfo`, `edrpou`, `fullName`, що пов'язані з кваліфікованим електронним ключем (КЕП) користувача та `KATOTTG`. Новий параметр додається після натискання кнопки `Add`.

* `drfo` -- особистий реєстраційний номер облікової картки платника податків (РНОКПП) посадової особи. Якщо через релігійні переконання особа не отримувала РНОКПП, необхідно вказати серію та номер паспорта або номер ID-картки.

* `edrpou` -- унікальний ідентифікаційний номер юридичної особи в Єдиному державному реєстрі підприємств та організацій України (8 цифр).

* `fullName` -- прізвище, ім'я, по батькові (за наявності).
+
[CAUTION]
====
У разі невідповідності значень атрибутів до значень, заданих у КЕП, користувач не матиме можливості увійти до Кабінету посадової особи та підписувати задачі КЕП.
====

* `KATOTTG` _(до заповнення для реєстрів, які використовують рольову модель за територіальною ознакою)_ -- перелік кодів з Кодифікатора адміністративно-територіальних одиниць та територій територіальних громад. Після визначення коду KATOTTG для до Keycloak потрібно записати скорочене значення коду. Користувач Кабінету посадової особи матиме доступ до записів саме тієї області/району/територіальної громади тощо, код якої буде вказано.
+
[TIP]
====
Для визначення значення коду KATOTTG перейдіть за link:https://www.minregion.gov.ua/napryamki-diyalnosti/rozvytok-mistsevoho-samovryaduvannya/administratyvno/kodyfikator-administratyvno-terytorialnyh-odynycz-ta-terytorij-terytorialnyh-gromad/[посиланням].

Знайдіть найактуальніший файл «Кодифікатор». Для зручності використовуйте додаткове фільтрування по колонці «Категорія об'єкта» файлу, яка містить наступні значення:
|===
|Рівень|Значення
|Перший рівень|«O» – Автономна Республіка Крим, області

«K» – міста, що мають спеціальний статус
|Другий рівень|«P» – райони в областях та Автономній Республіці Крим
|Третій рівень|«H» – території територіальних громад (назви територіальних громад) в областях, територіальні громади Автономної Республіки Крим
|Четвертий рівень|«M» – міста

«T» – селища міського типу

«C» – села

«X» – селища
|Додатковий рівень|«B» – райони в містах
|===

Приклад 1: ::
Необхідно надати доступ користувачу до Кабінету посадової особи на рівні Миргородської територіальної громади (Третій рівень) Полтавської області. Для цього:

* в колонці «Категорія об'єкта» виберіть значення «Н».
* в колонці «Назва об'єкта» введіть в пошуку назву територіальної громади «Миргородська».
* скопіюйте з колонки «Третій рівень» код значення територіальної одиниці (UA53060230000098362).
* згідно розшифровки нижче визначте який з блоків є останнім ненульовим, видаліть всі нульові блоки разом з системним номером і заповніть до Keykloak тільки це значення. В прикладі 1 до Keykloak потрібно занести UA5306023 (блоки до рівня територіальної громади є ненульовими).
+
image:admin:user-management/user-management-41.png[]

Приклад 2: ::
Необхідно надати доступ користувачу до Кабінету посадової особи на рівні Шевченківського району м. Полтава (Додатковий рівень). Для цього:

* спочатку в колонці «Категорія об'єкта» виберіть значення «О».
* в колонці «Назва об'єкта» введіть в пошуку назву області «Полтавська».
* скопіюйте з колонки «Перший рівень» код значення області (UA53000000000028050).
* за допомогою фільтра залиште лише ті значення, які в колонці «Перший рівень» містять значення UA53000000000028050.
* в колонці «Категорія об'єкта» виберіть значення «В».
* в колонці «Назва об'єкта» введіть в пошуку назву району «Шевченківський».
* скопіюйте з колонки «Додатковий рівень» код значення територіальної одиниці (UA53080370010339303).
* згідно з прикладом 1 визначте який з блоків є останнім ненульовим, видаліть усі нульові блоки разом з системним номером і заповніть до Keykloak тільки це значення. В прикладі 2 до Keykloak потрібно занести UA530803700103 (блоки до рівня районів у містах є ненульовими).

Якщо користувач матиме доступ до декількох територіальних одиниць, їх коди вносяться до Keycloak з роздільником ##. Максимально можлива кількість значень для одного кристувача – 16.

У випадку надання користувачу доступу до записів всієї України в значенні KATOTTG потрібно вказати тільки два символи – *UA*.

====

* додатково `будь-який інший атрибут` з довільною назвою та значенням за потреби (наприклад, назва організації, область, район, населений пункт тощо), якщо надалі буде необхідність будувати на основі нього статистику щодо створених користувачів. Заборонено включати до значення спеціальні символи ([, ], {, }, \, "), а також значення, які містять понад 255 символів. Назва кожного додаткового атрибута обов'язково повинна бути однаковою для всіх користувачів реєстру і мати унікальну назву серед інших параметрів.

+
image:admin:user-management/user-management-42.png[]

. Натисніть кнопку `Save`.

Користувача успішно створено.


==== Видалення ролі користувачу

Щоб видалити надані користувачу ролі виконайте наступні кроки:

. Оберіть необхідного користувача. Для цього оберіть відповідний realm, перейдіть до розділу `Users`, натисніть `View all users` та оберіть зі списку користувача.
+
image:admin:user-management/user-management-40.png[]

. Виберіть зі списку ролі, що необхідно видалити та натисніть `Remove selected`.
+
image:admin:user-management/user-management-38.png[]

. Видалені ролі стануть доступними та будуть показані в секції *Available Role*.
+
image:admin:user-management/user-management-39.png[]

<<<

=== Імпорт N користувачів через файл до Keycloak та надання прав доступу

==== Налаштування атрибутів адміністратора в Keycloak

Попередньо необхідно в Keycloak разово виконати наступні дії:

. Перейдіть у відповідний `-admin` реалм і виберіть розділ `Users`.
. Оберіть користувача адміністратора, що імпортує файл, і перейдіть у розділ `Attributes`.
. Створіть три ключі для атрибутів:

* `fullName` -- ПІБ;
* `drfo` -- особистий реєстраційний номер облікової картки платника податків (РНОКПП);
* `edrpou` -- унікальний ідентифікаційний номер юридичної особи в Єдиному державному реєстрі підприємств та організацій України (ЄДРПОУ).

. Натисніть `Save`.

+
image:registry-develop:registry-admin/import-users(officer)/import-users(officer)-00.png[]

[IMPORTANT]
====
Якщо не виконати вищезазначених дій буде показано помилку: ::
В системі управління користувачами не створено необхідні атрибути. Будь ласка, зверніться до адміністратора.
+
image:admin:user-management/user-management-75.png[]
====

[CAUTION]
====
Налаштування атрибутів в Keycloak виконується один раз. При наступних процедурах імпорту користувачів виконувати її немає потреби.
====

==== Імпорт користувачів через Кабінет адміністратора регламенту

. Перейдіть до Кабінету адміністратора регламентів.
+
[TIP]
====
Посилання до Кабінету адміністратора регламентів відповідного реєстру можливо отримати, наприклад, в *Openshift*, для цього необхідно перейти до меню `Networking` → `Routes`, обрати у `Project` необхідний проєкт, у пошуку вказати `admin-portal` та перейти за посиланням у колонці `Location`.
image:admin:user-management/user-management-45.png[]
====
+
image:registry-develop:registry-admin/import-users(officer)/import-users(officer)-01.png[]

. Оберіть розділ `Управління користувачами` та натисніть кнопку `Додати користувачів`.
+
image:admin:user-management/user-management-05.png[]

. Завантажте шаблон файлу `Users_Upload.csv` для заповнення даними користувачів.
+
. Ознайомтесь з `Поясненнями до заповнення таблиці "Users_Upload.csv".pdf`.
+
[IMPORTANT]
====
Обов'язково зверніть увагу на особливості заповнення параметрів шалону файлу, щоб уникнути помилок.

Якщо під час імпорту користувачів з файлу буде виявлена хоча б одна помилка, то процес імпорту буде перервано і жоден з користувачів не буде доданий до системи Keycloak. xref:#validation-rules[Див. схему нижче].
====
+
image:admin:user-management/user-management-08.png[]

. Заповніть файл даними користувачів, яким потрібно надати доступ до реєстру.
+
[WARNING]
====
Вимоги до файлу:

* максимальний розмір файлу -- *`30 МБ`*;
* формат файлу -- *`CSV`*;
* кодування файлу -- *`UTF-8`*.

Якщо файл не відповідає одному з вищеописаних критеріїв, користувач отримає відповідне повідомлення:

* kbd:[Файл занадто великого розміру.]
* kbd:[Невідповідний формат файлу.]
* kbd:[Файл невідповідного кодування.]

Це означатиме, що завантаження файлу не відбулося. xref:#validation-rules[Див. схему нижче].
====
+
[NOTE]
====
Валідаційні правила для даних у файлі:

Атрибут `drfo`: ::
обов'язковий до заповнення, є унікальним у зв'язці з атрибутами `edrpou` та `fullName`;
Атрибут `edrpou`: :: обов'язковий до заповнення, є унікальним у зв'язці з атрибутами `drfo` та `fullName`, для введення доступні лише цифри;
Атрибут `fullName`: ::
обов'язковий до заповнення, є унікальним у зв'язці з атрибутами `drfo` та `edrpou`;
Атрибут `Realm Roles`: ::
обов'язковий до заповнення, може містити декілька ролей (системні та регламентні ролі, при наявності), які вказані через кому. Вказані ролі повинні бути вже створені в Officer Realm у відповідному реєстрі у Keycloak.
Атрибут `KATOTTG`: ::
обов'язковий до заповнення для реєстрів, які використовують рольову модель за територіальною ознакою, для інших випадків необов'язковий. Значення складається із літер «UA», за якими слідують 17 цифр (наприклад, UA53060230000098362). Якщо користувач матиме доступ до декількох територіальних одиниць, їх коди вносяться через кому. Максимально можлива кількість значень для одного кристувача – 16. У випадку надання користувачу доступу до записів всієї України в значенні KATOTTG потрібно вказати тільки два символи – UA.

Будь-який інший атрибут: ::
не обов'язковий атрибут з довільною назвою та значенням за потреби (наприклад, назва організації, область, район, населений пункт тощо), якщо надалі буде необхідність будувати на основі нього статистику щодо створених користувачів. Заборонено включати до значення спеціальні символи ([, ], {, }, \, "), а також значення, які містять понад 255 символів.
+
[.underline]#Назва кожного додаткового атрибута обов'язково повинна бути однаковою для всіх користувачів реєстру і мати унікальну назву серед інших параметрів.#
====

. Завантажте файл перетягнувши його у відповідне поле `Завантажити перелік посадових осіб` або обравши його у відповідній директорії.
+
image:admin:user-management/user-management-06.png[]

. Натисніть кнопку `Почати імпорт`.
+
image:admin:user-management/user-management-07.png[]

. На наступному кроці буде відображено, що файл прийнято в обробку. Зачекайте декілька хвилин до повного завантаження користувачів реєстру.
Також у повідомленні зазначене посилання на сервіс Kibana, де можна переглянути результат опрацювання файлу: кількість оброблених записів, кількість успішних, кількість помилкових.
+
image:admin:user-management/user-management-70.png[]

==== Перегляд результату виконання процесу в сервісі Kibana

Модуль валідує весь файл і пише всі знайдені проблеми в сховище технічних логів `Kibana`. У логах фіксується інформація про кожен запис, який був пропущений при створенні, з зазначеною причиною пропуску, а успішно відпрацьовані порядково не фіксуються (показується лише загальна кількість успішних). Також присвоюється унікальний ідентифікатор користувача в Keycloak (Username), який дублюється.

[CAUTION]
====
Під час першого використання сервісу Kibana необхідно створити `index pattern`.

Для цього слід виконати наступні кроки:

.	Відкрийте додаток, перейдіть до секції *Management*.
. Натисніть `Create index pattern`, щоб отримати можливість прочитати журнали з індексів,
що потрапляють до *Elasticsearch*.
+
image:registry-develop:bp-modeling/bp/kibana/kibana-section1-figure1.png[]

.	У полі *Define Index Pattern*, створіть свій індекс-паттерн
згідно з шаблоном. Наприклад, якщо всі журнали починаються з *app-*,
створіть індекс-паттерн *app-**, щоб відобразити відповідні журнали.

.	Натисніть `Next step`, щоб перейти до наступного кроку.
+
image:registry-develop:bp-modeling/bp/kibana/kibana-section1-figure2.png[]

.	Скористуйтеся фільтром на вкладці *Configure Settings*,
щоб обрати період, дані за який слід відобразити.
+
TIP: За замовчуванням, будуть відображені журнали за останні 15 хвилин.

.	Натисніть `Create Index Pattern`.
+
image:registry-develop:bp-modeling/bp/kibana/kibana-section1-figure3.png[]

.	Після створення індекс-паттерну `app-*`, перейдіть на вкладку
**Discover**, щоб отримати необхідну інформацію.

====


[#validation-rules]
===== Загальні валідаційні правила для перевірки даних користувачів з файлу.

Загальну схему валідаційних правил представлено нижче.

image:registry-develop:registry-admin/import-users(officer)/import-users(officer).jpg[]

У разі порушення валідаційного правила запису даних у файлі буде показана відповідна помилка:

* _обов'язкове поле пусте `або` складається тільки з пробілів `або` має кілька значень через кому замість одного (для поля edrpou, drfo, fullName)_ -- помилка про відсутність обов'язкового атрибута;
* _поле `edrpou` містить недопустимі символи (має складатися лише з цифр)_-- помилка про присутність неприпустимих символів;
* _вказана роль відсутня у переліку наявних ролей Officer Realm відповідного реєстру у Keycloak_ -- помилка про відсутність вказаної ролі;
* _структура файлу не відповідає заданій_  -- помилка про невідповідність файлу закладеній структурі.

В такому випадку процес імпорту користувачів не відбувається.

[CAUTION]
====
Якщо імпорт користувачів у Keycloak відбувся з порушенням валідаційних правил, потрібно повторно з самого початку повторити процедуру імпорту користувачів з файлу, попередньо виконавши потрібні корегування.
====


Виконання часткового імпорту користувачів з помилкою можливе в наступних випадках:

. користувач із таким username і такими атрибутами (`drfo`, `edrpou`, `fullName`) вже є в Keycloak;
. користувач із таким `username`, але з іншими атрибутами вже є в Keycloak;
. користувач із такими атрибутами, але з іншим `username` вже є в Keycloak (тоді в логах буде вказано, який реальний `username` у користувача у Keycloak);
. користувач із такими атрибутами вже зустрівся в CSV-файлі раніше (дублювання записів).
. у процесі імпорту виникла помилка в Keycloak.

В такому випадку процес імпорту користувачів відбувається частково, записи користувачів з помилками фіксуються в логах Kibana як `Failed to import` та `Skipped`, і вони не додаються до системи Keycloak, а усі інші успішні записи користувачів додаються до системи Keycloak.

Алгоритм запису логів при імпорті користувачів з помилкою:

* Якщо один із запитів в групі з N записів повертає помилку, запис користувачів саме з цієї групи починається порядково. Користувач, на якому сталася помилка, пропускається.
* У логах фіксується інформація про всі записи, пропущені при створенні, з фіксацією причини пропуску (позначені як `Skipped` або `Failed  to import`).

[CAUTION]
====
Якщо імпорт користувачів у Keycloak відбувся з помилками (часткове створення користувачів), потрібно наново завантажити файл з користувачами, яких не вдалося створити, виконавши потрібні корегування.
====


===== Результату виконання процесу імпорту з помилкою

Першочергово необхідно в логах знайти відповідний запис з загальним результатом опрацювання імпорту.

image:registry-develop:registry-admin/import-users(officer)/import-users(officer)-08.png[]

* `Total users in file` -- відображає загальну кількість користувачів, що було додано через файл;
* `Successfully imported` -- кількість успішно доданих користувачів;
* `Skipped` - кількість пропущених користувачів;
* `Failed  to import` -- кількість користувачів, що не вдалося додати через помилку з сервісом Keycloak.

За кожним користувачем, що не вдалося додати до сервісу (пропущені) буде показано окремий запис у лолах з інформацією про валідаційну помилку.

image:registry-develop:registry-admin/import-users(officer)/import-users(officer)-09.png[]

Якщо імпорт користувачів у Keycloak відбувся з помилками (часткове створення користувачів), потрібно наново підвантажити файл з користувачами, яких не вдалося створити (виконавши потрібні корегування).

===== Успішний результат виконання процесу імпорту користувачів
У разі успішного проходження валідаційних правил виконується процес імпорту всіх користувачів з файлу у Keycloak. `Skipped` та `Failed to import` вказуються с нулями.
`Total users in file` відповідає кількості `Successfully imported`.

image:admin:user-management/user-management-71.png[]

Створення користувачів у Keycloak відбувається групами (окремими запитами) по N записів (значення N задається в налаштуваннях процесу).

За результатом успішного проведення імпорту користувачів у Keycloak створюються облікові записи користувачів з відповідними атрибутами та ролями.

image:registry-develop:registry-admin/import-users(officer)/import-users(officer)-11.png[]

===== Перегляд логів аудиту в "Журналі управління користувачами" системи Redash

Адміністратор безпеки (з відповідним правом доступу) має можливість переглянути в Redash "Журнал управління користувачами", наприклад, з метою проведення аудиту надання доступу користувачам.

[NOTE]
====
Для надання прав доступу до системи Redash у користувача має бути роль `redash-admin`.

Посилання до системи Redash можна знайти в консолі Openshift → _Networking_ → _Routes_, та обравши необхідний проєкт знайти реалм `redash-viewer`.

image:registry-develop:registry-admin/import-users(officer)/import-users(officer)-14.png[]
====

У журналі відображено всі записи, які відповідають наступним параметрам: applicationName="Keycloak", type="SYSTEM_EVENT".

Кожен користувач, якого було створено через імпорт файлом, відображається окремим рядком з зазначеним набором додаткових параметрів.

image:registry-develop:registry-admin/import-users(officer)/import-users(officer)-12.png[]

Звіт містить наступні параметри::
|===
|_Назва в Redash_|_Назва параметру_|_Опис параметру_
|Ідентифікатор запиту|`requestId`|Ідентифікатор запиту з MDC
|Назва події в БД|`name`|"USER_CREATE"
|Назва додатку/поди	|`sourceApplication`	|Назва пайплайну для імпорту користувачів (pod_name)
|Дата та час операції	|`timestamp`|Мітка часу
|ПІБ адміністратора	|`userName`|ПІБ користувача який запустив процес імпорту
|Ідентифікатор адміністратора	|`userKeycloakId`|Keycloak ідентифікатор користувача який запустив процес імпорту
|ДРФО адміністратора	|`userDrfo`|ДРФО код користувача який запустив процес імпорту
|ID створеного користувача	|`userId`|Keycloak  ідентифікатор створеного користувача
|Username створеного користувача	|`username`|username створеного користувача
|Користувач активний	|`enabled`|true/false
|КАТОТТГ|`katottg`|Кодифікатор адміністративно-територіальних одиниць та територій територіальних громад. Може містити кілька значень.
|Довільні поля|`customAttributes`|Власні (довільні) додаткові атрибути користувача
|Ідентифікатор реалму	|`realmId`|Keycloak  ідентифікатор реалму в якому був створений користувач
|Ім'я реалму	|`realmName`|Ім'я  реалму в якому був створений користувач
|Ім'я клієнта в Keycloak	|`clientId`|Значення "Client ID" атрибуту реалма від імені якого був створений користувач
|Ідентифікатор клієнта в Keycloak	|`keycloakClientId`	|Keycloak-ідентифікатор клієнта від імені якого був створений користувач
|Ролі створеного користувача	|`roles`|Ролі створеного користувача
|Ідентифікатор CSV файлу	|`sourceFileId`|Ідентифікатор CSV файлу у Ceph бакеті
|Оригінальне ім'я CSV файлу	|`sourceFileName`|Оригінальне ім'я CSV файлу, з якого проводився імпорт користувачів
|Контрольна сума CSV файлу 	|`sourceFileSHA256Checksum`	|Чек сума завантаженого користувачем CSV файлу (незашифрованого)
|===

Функціональністю сервісу Redash передбачено можливість фільтрування, сортування параметрів та експорту сформованої вибірки.

image:registry-develop:registry-admin/import-users(officer)/import-users(officer)-13.png[]

////
== Адміністрування доступу користувачів до Кабінету отримувача послуг

Створення користувача Кабінету отримувача послуг відбувається **при першому вході до Кабінету**. Користувачеві пропонується **пройти початковий бізнес-процес** -- **«Створення суб'єкта»**, де необхідно вказати Email.

В результаті дані користувача з'являться в Keycloak, у реалмі `-citizen`, з відповідними ролями (`legal`, `entrepreneur`, `individual` та ін.) та атрибутами.

image:admin:user-management-auth/keycloak/keycloak-permissions/citizen-realm-users-list.png[]

image:admin:user-management-auth/keycloak/keycloak-permissions/citizen-legal-roles.png[]

image:admin:user-management-auth/keycloak/keycloak-permissions/citizen-legal-attributes.png[]
////

<<<

== Адміністрування доступу користувачів до сервісу Redash

За замовчуванням користувачам Кабінету посадової особи встановлюється роль `officer`, яка також використовується для сервісу Redash. Користувачі з цією роллю мають доступ до стандартних звітів відповідного реєстру.

=== Надання розширених прав користувачу (аудитор або адміністратор)

. Перейдіть до redash-viewer. Для цього в консолі openshift виконайте наступні кроки:
+
image:admin:user-management/user-management-60.png[]
+
* Перейдіть до розділу `Networking` → `Routes`.
* Оберіть необхідний проєкт.
* В рядку пошуку вкажіть `redash-viewer`.
* Перейдіть за посиланням у колонці `Location`.

. Виконайте авторизацію в сервісі.
+
image:admin:user-management/user-management-61.png[]
+
* У полі `Email` вкажіть значення -- `user@mail.com`.
* У полі `Password` вкажіть секрет, який можливо отримати, виконавши наступні кроки:
** В консолі openshift перейдіть до розділу `Workloads` → `Secrets`.
** Оберіть необхідний проєкт.
** В рядку пошуку вкажіть `redash-setup-secret`.
** Перейдіть за посиланням у колонці `Name`.
+
image:admin:user-management/user-management-62.png[]

** Копіюйте значення секрету внизу сторінки, щоб використати його для автентифікації.
+
image:admin:user-management/user-management-63.png[]

* Після введення значень `Email` та `Password` натисніть `Log In`.

. Перейдіть до меню `Редагувати профіль`.
+
image:admin:user-management/user-management-64.png[]

. Відкрийте вкладку `Users` та оберіть користувача.
+
image:admin:user-management/user-management-65.png[]

. Оберіть зі списку необхідні ролі для користувача.
+
[NOTE]
====
Оберіть роль `auditor` у разі необхідності доступу до системних звітів Redash - "Журнал подiй системи" та "Журнал дій користувача".
Роль `admin` надає доступ до всіх наявних звітів.
====
+
image:admin:user-management/user-management-66.png[]

. Натисніть `Save` для збереження внесених змін.
+
image:admin:user-management/user-management-67.png[]

<<<

=== Налаштування автентифікації в Redash за логіном

У разі імпорту користувачів через файл, значення email не зазначається, що надалі потребує налаштувань SSO автентифікації в Redash. Потрібно змінити налаштування SAML клієнта в Keycloak для Redash, щоб використовувати поле `username`, як ідентифікатора користувача (NameID).

Для того, щоб змінити параметр для автентифікації, виконайте наступні кроки.

. Перейдіть до realm `-officer-portal` відповідного реєстру у Keycloak. Перейдіть до розділу `Clients` та оберіть `redash-viewer`.
+
image:admin:user-management/user-management-68.png[]

. У параметрі `Force Name ID Format` увімкніть значення `ON`. У параметрі `Name ID Format` зі спадного списку оберіть `username`.
+
image:admin:user-management/user-management-69.png[]

. Внизу сторінки натисніть `Save`, щоб зберегти зміни.

<<<

== Створення та надання доступу адміністраторам

////
=== Призначення адміністратора платформи та надання прав доступу

==== Створення тимчасового (`one-time`) адміністратора платформи

Після розгортання платформи у цільовому оточенні, в системі є лише один адміністратор -- `kube:admin`. Цей користувач потрібний для створення найпершого тимчасового адміністратора платформи та надання йому прав доступу.

. Виконайте вхід до Openshift-консолі під користувачем `kube:admin`.
+
TIP: Логін та пароль для входу під `kube:admin` можна отримати у команди технічної підтримки.
+
image:registry-management/cp-platform-admins/cp-platform-admins-1.png[]
+

. Перейдіть до *Projects* > *user-management*.
+
image:registry-management/cp-platform-admins/cp-platform-admins-3.png[]

. Знайдіть розділ *Networking* та перейдіть за посиланням до сервісу *keycloak*.
+
image:registry-management/cp-platform-admins/cp-platform-admins-4.png[]

. Виконайте вхід до *Keycloak Administration Console* із секретами (username та пароль) Keycloak.
+
image:registry-management/cp-platform-admins/cp-platform-admins-4-1.png[]
+
image:registry-management/cp-platform-admins/cp-platform-admins-7.png[]
+
[NOTE]
====
Отримати username та пароль можна у секретах до Keycloak-сервісу.

Для цього перейдіть до секції *Workloads* > *Secrets* > *keycloak* та скопіюйте секрети.

image:registry-management/cp-platform-admins/cp-platform-admins-5.png[]

image:registry-management/cp-platform-admins/cp-platform-admins-6.png[]
====

. Увійдіть до реалму `openshift`.
+
image:registry-management/cp-platform-admins/cp-platform-admins-8.png[]

. Створіть першого тимчасового адміністратора платформи:

* Для цього відкрийте розділ *Users* > `Add user`.
+
image:registry-management/cp-platform-admins/cp-platform-admins-9.png[]

* Додайте інформацію про користувача, а саме `username` (наприклад, `one-time`), `Email` (`one-time@test.com`) тощо.
* Далі натисніть `Save`, щоб зберегти зміни.
+
image:registry-management/cp-platform-admins/cp-platform-admins-10.png[]

* На вкладці *Credentials* встановіть пароль для адміністратора. Якщо пароль тимчасовий -- активуйте опцію `Temporary` > `On`.
+
image:registry-management/cp-platform-admins/cp-platform-admins-11.png[]

. Додайте групи користувачу:

* Перейдіть до *Groups* > *Available Groups*.
* Призначте групи `Cluster-admins` та `cp-cluster-mgmt-admin`.
+
В результаті групи будуть додані до *Group Membership*.
+
image:registry-management/cp-platform-admins/cp-platform-admins-12.png[]

. Призначте ролі користувачу:

* Перейдіть до *Role Mappings* > *Available Roles*.
* Встановіть роль `cp-cluster-mgmt-admin`.
+
image:registry-management/cp-platform-admins/cp-platform-admins-13.png[]
+
image:registry-management/cp-platform-admins/cp-platform-admins-14.png[]

+
NOTE: Всі групи та ролі для тимчасового адміністратора призначаються вручну.

. Поверніться до консолі Openshift та відкрийте доступ до `control-plane-gerrit` (центрального Gerrit) для тимчасового (`one-time`) адміна.
+
CAUTION: Тобто необхідно видати `one-time`-користувачу права адміністратора для `control-plane-gerrit`.
+
Для цього необхідно зробити його учасником групи адміністраторів Gerrit -- *GerritGroupMember*:

* У проєкті *control-plane* перейдіть до розділу *Home* > *Explore* > *GerritGroupMember*.
* Відкрийте вкладку *Instances* і створіть нового учасника, натиснувши *`Create GerritGroupMember`*.
+
image:registry-management/cp-platform-admins/cp-platform-admins-15.png[]

* У конфігураційному файлі _.yaml_ додайте відповідні параметри адміністратора до секцій `metadata` й `spec`.
+
image:registry-management/cp-platform-admins/cp-platform-admins-16.png[]
+
.Параметри доступу у GerritGroupMember.
====
[source,yaml]
----
kind: GerritGroupMember
metadata:
  name: cp-admin
  namespace: control-plane
spec:
  accoundId: onetime
  groupId: administrators
----

* `cp-admin` -- Назва адміністратора у GerritGroupMember.
* `namespace` -- простір імен/проєкт в Openshift, у рамках якого надається доступ.
* `accoundId` -- ім'я користувача (`username` у сервісі Keycloak).

====

* Натисніть `Save`, щоб зберегти зміни.

==== Створення адміністратора платформи

Тимчасовий (`one-time`) адміністратор створює повноцінних адміністраторів платформи в інтерфейсі Control Plane.

. Увійдіть до консолі Control Plane як тимчасовий адміністратор.
+
image:admin:infrastructure/cluster-mgmt/update-cluster-mgmt-01.png[]

. Перейдіть до розділу _Керування платформою_ > _Редагувати_.
+
image:registry-management/cp-platform-admins/cp-platform-admins-17.png[]
+
image:registry-management/cp-platform-admins/cp-platform-admins-18.png[]

. У секції _Адміністратори_ додайте нового (повноцінного) адміністратора(-ів) платформи:

* Натисніть `+`, введіть дані адміністратора:
** ім'я;
** прізвище;
** username (адреса електронної пошти). Службове ім'я користувача в системі;
** пароль.
* Натисніть `Підтвердити`.
+
image:registry-management/cp-platform-admins/cp-platform-admins-19.png[]
+
В результаті сформується запит на оновлення зі статусом `NEW`.

. Відкрийте необхідний запит на оновлення та перейдіть до системи рецензування коду Gerrit за посиланням.
+
image:registry-management/cp-platform-admins/cp-platform-admins-20.png[]
+
image:registry-management/cp-platform-admins/cp-platform-admins-21.png[]

. Підтвердьте зміни: `Code Review +2` > `Submit`.
+
image:registry-management/cp-platform-admins/cp-platform-admins-22.png[]
+
[TIP]
====
Зміни з даними про адміністратора вносяться до репозиторію _cluster-mgmt_ та записуються до файлу _deploy-templates/values.yaml_.

image:registry-management/cp-platform-admins/cp-platform-admins-23.png[]
====

. Після злиття змін до master-гілки відповідного репозиторію, запускається процес збірки коду -- `MASTER-Build-cluster-mgmt`. Можна перейти за посиланням та переглянути статус виконання.
+
image:registry-management/cp-platform-admins/cp-platform-admins-24.png[]
+
image:registry-management/cp-platform-admins/cp-platform-admins-25.png[]

. Після успішного проходження збірки, адміністратор додається до переліку адмінів платформи.

[NOTE]
====
Такому (повноцінному) адміністратору платформи автоматично призначаються всі права доступу: групи `Cluster-admins` і `cluster-mgmt-admin`, та роль `cp-cluster-mgmt-admin` у Keycloak.
====

IMPORTANT: Створений адміністратор платформи має повний доступ до Openshift та Control Plane. Він може призначати інших адміністраторів платформи, створювати реєстри, а також додавати адміністраторів реєстру.


Groups > Available Groups.
cluster-admins
cp-cluster-mgmt-admin

Role Mappings > Available Roles
cp-cluster-mgmt-admin


////

=== Призначення адміністратора регламенту та надання прав доступу

. У реалмі `-admin` створіть користувача та призначте йому наступні ролі:
+
image:admin:user-management/user-management-43.png[]

** `gerrit-administrators` -- адміністратори Gerrit, роль необхідна для розгортання регламенту та підтвердження змін (проходження Quality gates);
** `jenkins-administrators` -- адміністратори Jenkins, роль необхідна для запуску `clean-up` job, перегляду згенерованих та доданих до Jenkins pipelines, перегляду логів та ін.;
** `camunda-admin` -- адміністратор Camunda Cockpit, роль необхідна для перегляду доступних бізнес-процесів, правил, задач тощо.

. Окрім ролі, користувачеві необхідно призначити групу:
+
image:admin:user-management/user-management-44.png[]

* перейдіть до вкладки **Groups** -> **Available Groups**;
* оберіть `camunda-admin`;
* натисніть `join`.
* в результаті, група має з'явитися в переліку **Group Membership**.

////
KeyCloak:gerrit-administrators

KeyCloak:camunda-admin

KeyCloak:redash-admin

jKeyCloak:jenkins-users (за запитом Адміністратор користувачів може надати jenkins-admin)

KeyCloak:nexus-user
////

<<<

=== Призначення адміністратора реєстру та надання прав доступу

. Увійдіть до адміністративної панелі управління реєстрами *Control Plane*, використовуючи попередньо отримані логін та пароль.
+
image:admin:infrastructure/cluster-mgmt/update-cluster-mgmt-01.png[]

. Перейдіть до розділу `Реєстри` та оберіть відповідний реєстр, в якому необхідно змінити системний ключ.
+
image:admin:user-management/user-management-47.png[]

. Натисніть кнопку `Редагувати`, що розташована у правому верхньому куті.
+
image:admin:user-management/user-management-48.png[]

. У полі `Адміністратори` зазначте адміністраторів регламенту реєстру,
яким буде надано доступ до реєстру. Натисніть `+`, щоб додати нового адміністратора.
+
image:admin:user-management/user-management-49.png[]

. Далі у вікні, що з'явилося, введіть дані адміністратора реєстру, а саме:
+
--
* імя;
* прізвище;
* електронну пошту;
+
[NOTE]
====
Дані електронної пошти мають бути введені у нижньому регістрі.
Доступні символи: `"0-9"`, `"a-z"`, `"_"`, `"-"`, `"@"`, `"."`, `","`.
====
* тимчасовий пароль.
--
+
Та натисніть `Підтвердити`.
+
image:admin:user-management/user-management-50.png[]

+
Для надання доступу декільком адміністраторам реєстру,
необхідно повторити дію для кожного адміністратора окремо (`+` -> вказати дані -> `Підтвердити`).

. Після того як новий адміністратор з'явиться у загальному переліку, натисніть внизу `Підтвердити`.
+
image:admin:user-management/user-management-51.png[]

. У розділі `Запити на оновлення` з'явиться новий запит, натисніть на іконку `Переглянути в Gerrit`.
+
image:admin:user-management/user-management-52.png[]

. Виконайте перевірку якості (quality gates), увійшовши до створеної зміни, та натисніть `REPLY`.
+
image:admin:user-management/user-management-53.png[]

. Натисніть наступні кнопки для підтвердження:
+
--
* `+2` -- для Code-Review;
* `+1` -- для Verified.
* `SEND` -- для збереження.
--
+
image:admin:user-management/user-management-54.png[]

. Натисніть `SUBMIT` для злиття зміни до репозиторію (merge зміни).
+
image:admin:user-management/user-management-55.png[]

. У спливаючому вікні натисніть `CONTINUE` для підтвердження.
+
image:admin:user-management/user-management-56.png[0,700]

. Внизу сторінки Gerrit знайдіть посилання на збірку *CI Jenkins*, та перейдіть за посиланням.
+
image:admin:user-management/user-management-57.png[]

. У новому вікні зліва натисніть `Back to Project`.
+
image:admin:user-management/user-management-58.png[]

. Переконайтеся, що збірка пройшла успішно.
+
image:admin:user-management/user-management-59.png[]

. Після успішного виконання Jenkins job, нового адміністратора реєстру  створено.

+
[NOTE]
====
Користувач-адміністратор реєстру автоматично створюється в realm `openshift` сервісу Keycloak з роллю `cp-registry-admin-<registry-name>` та групою `/cp-registry-admin-<registry-name>`, де `<registry-name>` -- назва реєстру.
====

<<<

== Експорт користувачів з Keycloak

=== Кроки налаштувань для експорту

Для того, щоб експортувати інформацію про наявних користувачів у Keycloak з необхідного -realm виконайте наступні кроки:

. Запустіть програму Windows PowerShell у режимі адміністратора.
+
image:admin:user-management/user-management-09.png[0,800]

. В PowerShell виконайте наступний скрипт:
+
[source, bash]
----
Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
----

. Перейдіть за посиланням https://stedolan.github.io/jq/ та оберіть зі спадного списку `Windows (64-bit)`.

. Збережіть файл `KeyCloak_Get_Users.sh` в одній директорії із попередньо завантаженим файлом `jq-win64.exe`.

. Запустіть командну консоль `cmd` у режимі адміністратора.

. Виконайте у консолі наступну команду:
+
[source, shellscript]
----
chocolatey install jq
----
+
image:admin:user-management/user-management-10.png[0,700]

+
image:admin:user-management/user-management-73.png[0,700]

. Перейдіть до системи Keycloak та оберіть необхідний `-realm` з якого буде експортовано усіх користувачів.

. Перейдіть до розділу `Clients` та натисніть `Create`.
image:admin:user-management/user-management-11.png[]

. Вкажіть значення у полі `Client ID` (наприклад, `export-user`), яке буде використано у подальших кроках, та натисніть `Save`.
+
image:admin:user-management/user-management-12.png[]

. На вкладці `Settings` виконайте налаштування наступних параметрів:
+
--
* `Access Type` - оберіть значення → `cofidential`;
* `Service Accounts Enabled` - перемикніть на стан → ON;
* `Valid Redirect URIs укажіть зірочку` - вкажіть значення зірочки → `*`.
--
+
Натисніть `Save`.
+
image:admin:user-management/user-management-13.png[]

. Перейдіть до вкладки `Service Account Roles` та виконайте наступні налаштування:
+
--
* У полі `Client Roles` оберіть → `realm-management`;
* У полі `Available Role` оберіть усі ролі та натисніть `Add selected`.
--
+
image:admin:user-management/user-management-14.png[]
+
У результаті усі доступні ролі повинні переміститися до поля `Assigned Roles`.
+
image:admin:user-management/user-management-15.png[]

. Відрийте файл `KeyCloak_Get_Users.sh` у текстовому редакторі.
+
image:admin:user-management/user-management-17.png[]

. Вкажіть відповідні значення для параметрів:
+
--
* `KEYCLOAK_URL` -- URL адреси сервісу Keycloak з ".../auth";
* `KEYCLOAK_REALM` -- назву -realm, з якого будуть експортуватися користувачі.
--
+
image:admin:user-management/user-management-74.png[]
+
image:admin:user-management/user-management-18.png[]
+
Збережіть зміни у файлі.

. Завантажте `Git bash` за посиланням https://git-scm.com/downloads, та інсталюйте програму.

. Запустіть файл `KeyCloak_Get_Users.sh` за допомогою `Git bash` .
+
image:admin:user-management/user-management-16.png[]

+
image:admin:user-management/user-management-72.png[0,490]

. Вкажіть логін та код доступу у терміналі.
+
image:admin:user-management/user-management-19.png[]
+
[TIP]
====
Логін та код доступу можливо отримати у Keycloak на вкладці Credentials відповідного клієнта, що було створено на попередніх кроках.

image:admin:user-management/user-management-20.png[]
====
+
[CAUTION]
====
Значення у терміналі вставляються через виклик меню натисканням правою кнопкою миші. Слід зауважити, що значення коду доступу не буде показано як введене, після того, як його вставлено натисніть Enter.
====

. Після запуску скрипту почнеться виконання процесу експорту.
+
image:admin:user-management/user-management-21.png[]

. У результаті успішного виконання експорту користувачів буде створено файл `users.json` з даними користувачів відповідного realm.
+
image:admin:user-management/user-management-22.png[]
+
image:admin:user-management/user-management-23.png[]

<<<

=== Формування табличного представлення

Для того, щоб відкрити сформований файл `users.json` у табличному представлені виконайте наступні кроки:

. Відкрийте новий файл у програмі Excel, перейдіть до вкладки  `Дані` → `Отримати дані` → `З файлу` → `З файлу JSON`.
+
image:admin:user-management/user-management-24.png[]

. Оберіть файл `users.json` та натисніть `Імпорт`.
+
image:admin:user-management/user-management-25.png[]

. У новому вікні натисніть кнопку `До таблиці`.
+
image:admin:user-management/user-management-26.png[]

. На наступному кроці перевірте вибрані параметри та натисніть `ОК`.
+
image:admin:user-management/user-management-27.png[]

. У сформованій колонці натиснути на дві стрілки в правому верхньому куті.
+
image:admin:user-management/user-management-28.png[]

. Виберіть всі стовпці та натисніть `ОК`.
+
image:admin:user-management/user-management-29.png[]

. Перевірте наявність двох стрілок в правому верхньому куті усіх колонок, що з'явилися, натиснуть на кожну з них у разі наявності та оберіть `Розширити на нові рядки`.
+
image:admin:user-management/user-management-30.png[]

. Натисніть `Закрити й завантажити`.
+
image:admin:user-management/user-management-31.png[]

. У результаті буде сформовано табличне представлення файлу `users.json`, де кожен параметр представлено в окремій колонці.
+
image:admin:user-management/user-management-32.png[]

