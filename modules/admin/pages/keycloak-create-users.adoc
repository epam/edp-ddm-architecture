= Створення користувачів та надання їм прав доступу
:sectnums:
:sectanchors:

Створення нових користувачів та надання їм прав доступу до інструментів реєстру здійснюється у адмін-консолі сервісу https://www.keycloak.org/[Keycloak].

//TODO: Додати інструкцію: "Як отримати доступ до Keycloak?"

Адміністратор платформи повинен мати доступ до 4-х реєстрових reamlfootnote:[*Realm* - це концепція в https://www.keycloak.org/[Keycloak], яка відноситься до об’єкта,
що керує набором користувачів, а також їхніми обліковими даними, ролями та групами.] реєстру:

|===
|realm |Призначення

|`-admin`
|доступ до адміністративних інструментів таких, як Gerrit, Jenkins, Camunda реєстру

|`-officer-portal`
|Задвання ролей для доступу до Кабінету Посадової особи (**Officer Portal**) та звітів (https://redash.io/[Redash])

|`-citizen-portal`
|Задавання ролей для доступу до Кабінету Громадянина (**Citizen Portal**)

|`-external-system`
|Задавання ролей для доступу у зовнішні системи, наприклад, до Трембіти та ін.

|===

image:admin:keycloak-permissions/realms-list.png[]

== Як створити нового користувача у Keycloak?

Для створення нового користувача у Keycloak необхідно виконати наступні кроки:

*  Виберіть необхідний realm відповідного реєстру -> далі на вкладці **Users** натисніть `View all users` -> далі натисніть кнопку `Add user`.
image:admin:keycloak_view_users.png[]

*  У відкритому вікні введіть дані користувача:

** `Username` - імя, що буде використовуватись як логін до Gerrit та Jenkins.
** `Email` - електронна пошта користувача.
** `First Name` - ім'я користувача.
** `Last Name` - прізвище.
** `User Enabled` - позначка, що користувач активований у системі (якщо вона не активна, доступ такого користувача буде обмежено до систем).
** `Email Verified` - активується у разі необхідності підтвердження електронної пошти.

* Натисніть кнопку `Save` та перейдіть на вкладку **Credentials**.

image:admin:keycloak_add_user.png[]

* Задайте пароль у полі `Password` та підтвердьте його у полі `Password Confirmation`, активуйте позначку `Temporary`, щоб згенерувати тимчасовий пароль.

CAUTION: З метою безпеки необхідно змінити тимчасовий пароль при першому логіні.

* Натисніть кнопку `Save Password`.

image:admin:keycloak_set_credentials.png[]

* Перейдіть на вкладку **Role Mappings** та встановіть необхідні ролі користувачу.

* Натисніть кнопку `Add selected`, щоб обрана роль відображувалася у секції **Assigned Roles**.
image:admin:keycloak_assign_roles_check.png[]

== Адміністрування доступу адміністратора регламенту

У `-admin` realm створіть користувача та задайте йому наступні ролі:

image:admin:keycloak-permissions/admin-user-roles-list.png[]

** `gerrit-administrators` - адміністратор Gerrit, роль необхідна для розгортяння регламенту та підтвердження змін (проходження Quality gates)
** `jenkins-administrators` - адміністратор Jenkins, роль необхідна для запуску `clean-up` job, перегляду згенегованих та доданих до Jenkins pipelines, перегляду логів та ін.
** `camunda-admin` - адміністратор Camunda Cockpit, роль необхідна для перегляду поступних бізнес процесів, правил, задач тощо. Окрім ролі, користувачеві необхідно задати групу -> Groups -> Available Groups -> вибрати `camunda-admin` -> натиснути `join` -> група повинна з'явитись у переліку Group Membership

image:admin:keycloak-permissions/admin-user-groups.png[]

== Які ролі користувачів бувають для Кабінету Посадової особи та Кабінету Громадянина?

Keycloak ролі рознізняються на системні та регламентні:

* `системні` - створюються платформою під час створення реєстру або встановлення платформи (officer, citizen, auditor та ін)
* `регламентні` - створюються під час розгортання реєстру та задаються у регламенті реєстру -> директорія  `roles` -> у відповідному `.yml`

Наприклад, для створення релой Кабінету Посадової особи необхідно задати їх у officer.yml:
image:admin:keycloak-permissions/registry-roles.png[]


== Адміністрування доступу користувачів до Кабінету Посадової особи

Для створення нового користувача **Кабінету Посадової особи** необхідно виконати наступні кроки:

* Перейдіть до `-officer-portal` realm відповідного реєстру -> вкладка **Users** -> натисніть кнопку `View all users` -> натисніть кнопку `Add user`.

image:admin:keycloak-permissions/officer-realm-users-list.png[]

* Виконайте кроки зі створення користувача, описані вище, та встановіть роль `officer` у вкладці **Role Mappings**.
* Виберить необхідні регламенті ролі наприклад `head-officer`
* Виберіть роль `auditor` у разі необхідності доспуту до системних звітів Redash ("Журнал подiй системи", "Журнал дiй користувача")
* Натисніть кнопку `Add selected`.

image:admin:keycloak-permissions/officer-sidorenko-user-roles.png[]

* Перейдіть на вкладку **Attributes**, та встановіть значення для ключів параметрів `drfo`, `edrpou` та `fullName`, що пов'язані з КЕП користувача, наприклад:

** `drfo:1010101014`;
** `edrpou: 34554362`;
** `fullName: Сидоренко Василь Леонідович`.

image:admin:keycloak-permissions/officer-sidorenko-user-attributes.png[]

CAUTION: *[red]##Увага!##* У разі невідповідності значень атрибутів до значень заданих у КЕП користувач не матиме можливості увійти до Кабінету Посадової особи та підписувати задачі КЕП.

== Адміністрування доступу користувачів до Кабінету Громадянина

Створення користувача Кабінету Громадянина відбувається при першому вході у кабінет. Користувачу пропонується пройти початковий бізнес процес "Створення суб'єкту", де необхідно задати email.
Далі дані користувача з'являться в Keycloak в realm `-citizen` з відповідними ролями (legal, entrepreneur, individual та ін.) та атрибутами.

image:admin:keycloak-permissions/citizen-realm-users-list.png[]

image:admin:keycloak-permissions/citizen-legal-roles.png[]

image:admin:keycloak-permissions/citizen-legal-attributes.png[]

== Адміністрування доступу до зовнішніх систем
Створення користувачів для доступу до зовнішніх систем дизайном платформи не передбачається. Всі доступи вирішуються на рівні ролей та клієнту trembita-invoker (у разі Трембіти). У разі необхідності можливо додати регламентні ролі, що будуть задіяні для побудови бізнес процесів.


