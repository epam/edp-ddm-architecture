= Обробка та збереження завантажених файлів в рамках бізнес-процесу (File upload)

Для забезпечення вимог по роботі з цифровими документами через кабінет користувача, платформа надає наступні можливості:

* Завантаження цифрових документів користувачами через UI-форми задач бізнес-процесів
* Вивантаження та перегляд цифрових документів користувачами через UI-форми задач бізнес-процесів


= Mоделювання та налаштування компоненту File для завантаження файлів на формі у  бізнес-процесах


Моделювання форм, що використовуються при побудові бізнес-процесів, відбувається у Адмін порталі (https://admin-portal-{CP-NAMESAPCE}.{DNS-WILDCARD}/[]).
Для успішного розгортання форм на середовищі, адмінстіратор регламенту має змоделювати форму, вивантажити її у форматі  *Json* та виконати кроки з інструкції ** xref:user:registry-admin-deploy-regulation.adoc[Розгортання регламенту реєстру]
Також передумовою для моделювання форм з файлами є створення файлових полів у дата-моделі.

== Кроки для моделювання компоненту File на формах для бізнес-процесів
* Відкрийте веб-браузер та перейдіть на сторінку Адмін Порталу -> натисність кнопку *"Увійти до сервісу"*

image:file-upload-bp/file-upload-bp-1.png[]

-> перейдіть до розділу *"Моделювання UI-форм"*
image:file-upload-bp/file-upload-bp-2.png[]

-> у відкритій сторінці відображається перелік з формами, що були змодельовані
image:file-upload-bp/file-upload-bp-3.png[]

* Щоб створити нову форму натисніть кнопку _"+ Створити нову форму"_

image:file-upload-bp/file-upload-bp-4.png[]

-> у відкритому вікні заповніть поля:
*[Бізнес-назва форми]* - Створення нового запису довідника
*[Службова назва форми]* - update-dict-bp-add-name
image:file-upload-bp/file-upload-bp-5.png[]

Щоб змоделювати форму необхідно задати параметри компонентів (палітра зліва):

** Перетягніть у поле моделювання компонент "File"  на палітру моделювання -> у відкритому вікні налаштування компонента задайте поля:
image:file-upload-bp/file-upload-bp-6.png[]

*** на вкладці *Display* заповніть поле [Label] - Файл
image:file-upload-bp/file-upload-bp-7.png[]

*** на вкладці *File* заповніть поле [Storage] - URL, та поле [URL] - /documents, поле [File pattern] - application/pdf,image/jpeg,image/png, поле [File Minimum Size] - 0KB, поле [File Maximum Size] - 50MB.
image:file-upload-bp/file-upload-bp-8.png[]
image:file-upload-bp/file-upload-bp-9.png[]

[TIP]
на вкладці *Data* значення чекбоксу Multiple Values має бути порожнім

*** на вкладці *Validation* виберіть позначку *[Required]*
image:file-upload-bp/file-upload-bp-10.png[]

*** на вкладці *API* заповніть поле *[Property Name]* - documentFile
image:file-upload-bp/file-upload-bp-11.png[]
*** натисніть кнопку "*Save*"

** Для збереження змодельованої форми натисніть кнопку **"Створити форму" ** у верхньому правому куті.
Після створення форми автоматично відбувається перехід на сторінку перегляду форми та відображається повідомлення про успішне створення форми.
image:file-upload-bp/file-upload-bp-12.png[]
image:file-upload-bp/file-upload-bp-13.png[]

= Застосування у бізнес-процесах

Після того я форма смодельована вона може бути застосована у бізнес-процесах.

Для завантаження файлу потрібно запустити бізнес-процес у кабінеті Чиновника або Громадянина, відкриється смодельвана форма завантаження файла.

** Завантажте файл натиснув кнопку `Browse`
image:file-upload-bp/file-upload-bp-14.png[]


** або перетягніть файл у виділену область
image:file-upload-bp/file-upload-bp-15.png[]

** При успішному завантаженні файл буде відображено
image:file-upload-bp/file-upload-bp-16.png[]

** При не успішному завантаженні буде відображена валідаційна помилка
image:file-upload-bp/file-upload-bp-17.png[]

** При неуспіншому завантаженні потрібно видалити файл натиснув кнопку `X` та повторно завантажити файл
image:file-upload-bp/file-upload-bp-18.png[]

** Для вивантаження файла перейдіть до форми у бізнес-процесі, натисніть посилання із назвою файлу, завантаження почнеться автоматично

image:file-upload-bp/file-upload-bp-19.png[]


= Сценарії взаємодії користувача з системою

== Завантаження цифрових документів

На даній діаграмі зображено сценарій внесення даних з файловими вкладеннями в рамках виконання задачі користувачем, обробка даних в рамках бізнес-процесу та використання їх для попереднього заповнення наступної задачі користувача.

[plantuml, file_upload, svg]
----
include::admin:image$file-upload-bp/file-upload.puml[]
----

Канонічний вигляд структури документа у тілі запиту на збереження даних форми через серверний додаток
[source, json]
----
{
  "data": {
      "<file_property_name>": [
        {
          "id": "{UUID}",
          "checksum": "{SHA256-hash}"
        }
      ]
  }
}
----

Опис формату збереження документів в Ceph у процесі обробки запиту на виконання задачі
[source, json]
----
{
  "data": {
      "<file_property_name>": [
        {
          "id": "{UUID}",
          "checksum": "{SHA256-hash}"
        }
      ]
  },
  "x-access-token": "<X-Access-Token>"
}
----

== Вивантаження цифрових документів

На даній діаграмі зображено сценарій отримання сутності з файловими вкладеннями, яка була попередньо збережена у Дата Фабриці та послідуюча її підготовка для відображення на UI-формі задачі користувача.

[plantuml, file_download, svg]
----
include::admin:image$file-upload-bp/file-download.puml[]
----

Канонічний вигляд відповіді серверного додатоку на запит отримання даних форми
[source, json]
----
{
  "data": {
      "<file_property_name>": [
        {
          "id": "{UUID}",
          "checksum": "{SHA256-hash}"
        }
      ]
  }
}
----

== Підпис даних UI-форм з цифровими документами

На даній діаграмі зображено сценарій підпису даних з файловими вкладеннями в рамках виконання задачі користувачем, обробка даних в рамках бізнес-процесу та їх збереження в Дата Фабрику.

[plantuml, file_signing, svg]
----
include::admin:image$file-upload-bp/file-signing.puml[]
----

Канонічний вигляд структури документа у тілі запиту на збереження підписаних даних форми через серверний додаток
[source, json]
----
{
  "data": {
      "<file_property_name>": [
        {
          "id": "{UUID}",
          "checksum": "{SHA256-hash}"
        }
      ]
  },
  "signature": "<e-Signature>"
}
----

Опис формату збереження документів з підписом в Ceph
[source, json]
----
{
  "data": {
      "passport_scans": [
        {
          "id": "{UUID}",
          "checksum": "{SHA256-hash}"
        }
      ]
  },
  "x-access-token": "<X-Access-Token>",
  "signature": "<e-Signature>"
}
----