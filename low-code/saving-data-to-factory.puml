@startuml
actor "Чиновник" as officer order 10
participant "Кабінет чиновника" as officer_portal  order 20
participant "Зовнішній API\ngateway" as gateway  order 30
participant "User task mgmt" as user_task_management  order 40
participant "Сервіс перевірки\nцифрового підпису" as digital_sign_service  order 50
participant "Ceph" as ceph  order 60
participant "Camunda" as bmps_service  order 70
participant "Data Rest API" as data_rest  order 80

title Збереження даних у дата фабрику

autonumber
skinparam maxMessageSize 220

group Підпис форми
  officer -> officer_portal: Підписує форму з даними
  activate officer_portal
    officer_portal -> officer_portal: Підпис форми з даними
    officer_portal -> gateway: Передача даних
    activate gateway
      gateway -> gateway: Перевірка авторизації (правильного JWT)
      gateway -> user_task_management: Проксування запиту
      activate user_task_management
        user_task_management -> digital_sign_service: Перевірка підпису
        activate digital_sign_service
        return  публічні сертифікати ЕЦП
        user_task_management -> user_task_management: Формування об'єкту з: body, сертифікати підпису, підпис, JWT
        user_task_management -> ceph: Збереження сформованного об'єкту
        activate ceph
        return  ключ
        user_task_management -> bmps_service: Збереження змінної з ключом
        user_task_management -> bmps_service: Переведення БП в наступний стан
        activate bmps_service
          bmps_service -> ceph: Читання об'єкту по ключу
          activate ceph
          return  об'єкт
          bmps_service -> bmps_service: Формування запиту до потрібного APІ
          bmps_service -> data_rest: Виклик Rest API та передача: body, сертифікати підпису, підпис, JWT
          activate data_rest
            data_rest -> data_rest: Перевірка авторизації (правильного JWT)
            data_rest -> digital_sign_service: Перевірка підпису
            data_rest -> data_rest: Валідація формату даних (у майбутньому)
            data_rest -> data_rest: Збереження виклику до аудиту (у майбутньому)
            data_rest -> data_rest: Збереження даних
          return результат збереження
        return наступний wait state

      return
    return
   return
end
@enduml