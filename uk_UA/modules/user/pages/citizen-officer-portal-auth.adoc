:toc-title: ЗМІСТ
:toc: auto
:toclevels: 5
:experimental:
:important-caption:     ВАЖЛИВО
:note-caption:          ПРИМІТКА
:tip-caption:           ПІДКАЗКА
:warning-caption:       ПОПЕРЕДЖЕННЯ
:caution-caption:       УВАГА
:example-caption:           Приклад
:figure-caption:            Зображення
:table-caption:             Таблиця
:appendix-caption:          Додаток
:sectnums:
:sectnumlevels: 5
:sectanchors:
:sectlinks:
:partnums:

= Автентифікація користувачів реєстру

== Загальний опис

Платформа реалізовує складні механізми автентифікації кінцевих користувачів, що дозволяє забезпечити належний захист даних користувачів реєстрів, а також нівелювати можливість несанкціонованого доступу до даних.

//TODO: Link to id.gov.ua
В центрі механізму автентифікації стоїть [.underline]#Система управління ідентифікацією та доступом (IAM) Keycloak#, яка взаємодіє із [.underline]#Сервісом для роботи з КЕП# та інтегрованою системою електронної ідентифікації *ID.GOV.UA (ICEI)*. Також на Платформі функціонують специфічні сервіси автентифікації посадових осіб та отримувачів послуг реєстру.

Наразі Платформа підтримує 2 типи автентифікації: ::

* [*] автентифікація користувача за допомогою кваліфікованого електронного підпису (КЕП);
* [*] автентифікація користувача за допомогою інтегрованої системи електронної ідентифікації ID.GOV.UA (ІСЕІ) -- зовнішнього постачальника ідентифікаційних даних.

[#auth-logic]
== Логіка автентифікації користувачів

За автентифікацію користувачів реєстру відповідають такі сервіси:

* [.underline]#Сервіс автентифікації отримувачів послуг# -- `*keycloak-ds-citizen-authenticator*`;
* [.underline]#Сервіс автентифікації посадових осіб# -- `*keycloak-ds-officer-authenticator*`.

Для ідентифікації користувача у системі, сервіс автентифікації має отримати з КЕП, або від зовнішнього надавача послуг (`id.gov.ua`) як обов'язкові вхідні параметри наступні атрибути:

* `*drfo*` (`РНОКПП`) -- ідентифікаційний номер, або серія і номер паспорта особи.

* `*edrpou*` (`ЄДРПОУ`) -- код організації, до якої належить особа.

* `*fullName*` (`ПІБ`) -- прізвище, ім'я та по батькові особи.

У процесі автентифікації відбувається пошук користувача у базі даних за атрибутом `drfo`. Якщо користувача з відповідним атрибутом знайдено, то відбувається порівняння атрибутів `fullName` та `edrpou` (за наявності). [.underline]#Порівняння атрибутів `drfo` та `edrpou` відбувається за повним збігом їх значень#.

[TIP]
====
Наприклад: ::

Сервіс автентифікації посадових осіб отримує, РНОКПП особи, виконує запит до сервісу Keycloak, отримує там необхідний атрибут та звіряє його з тим, що вказано у КЕП. Якщо значення у Keycloak та КЕП повністю збігаються, то перевірка проходить успішно, якщо ні -- користувач отримає помилку автентифікації.
+
При автентифікації отримувачів послуг, якщо атрибути не збігаються, тобто користувача не знайдено, то система створить нового користувача.
====

Для атрибута `*fullName*` (`ПІБ`) застосовується інша стратегія -- [.underline]#нечітке порівняння рядків, що не враховує спеціальні символи#.

[NOTE]
====
Проблематика використання стратегії чіткого порівняння (strictIgnoreCase)::

Атрибут `*fullName*` в КЕП, який містить ПІБ особи та є нестандартизованим. Його заповнюють працівники АЦСК без єдиного підходу. Це призводить до незбігу значення `fullName` при перевипуску або використанні КЕП, виданого іншим АЦСК. Наприклад, інший КЕП може містити декілька пробілів замість одного, містити, або не містити спеціальні символи, як-от апостроф або дефіс.
+
Ці зміни в атрибуті `fullName` призводять до того, що користувач не може увійти до Кабінету з новим ключем, оскільки значення атрибута `fullName` у КЕП не збігається зі значенням, що збережене у базі даних сервісу Keycloak. [.underline]#У Keycloak зберігається значення атрибута `fullName` з КЕП користувача, який використовувався при першому вході до реєстру (автореєстрації)#.
+
Реалізація [.underline]#стратегії автентифікації `strictIgnoreCase`# не враховує цю проблему та [.underline]#працює за принципом приведення стрічки до нижнього регістру та видалення лише символів пробілу#.
+
Для розв'язання впроваджено нову стратегію нечіткого порівняння рядків, яка не враховує спецсимволи (`*alphanumericIgnoreCase*`).
====

Стратегія нечіткого порівняння рядків передбачає застосування наступних валідаційних правил:

* Перед порівнянням рядки приводяться до нижнього регістру.
* Видаляються усі символи, окрім латинських та кириличних літер та цифр.
* Довжина рядка після нормалізації має бути не менш як 50% від оригінального.

[TIP]
====
Наприклад: ::

Якщо користувач заведений у Keycloak як `fullName: "Маряна-Іриna  Сергіївна"`, а у КЕП вказано `fullName: "Мар'яна-Іриna Сергіївна!%?"`, то користувач зможе пройти автентифікацію та увійти до Кабінету.
====


[#kep-auth]
== Автентифікація за допомогою КЕП

Автентифікація користувачів за допомогою [.underline]#кваліфікованого електронного підпису (КЕП)# відбувається з використанням встановленого на стороні браузера стороннього віджета https://iit.com.ua/downloads[IIT] для виконання операцій, що вимагають шифрування та підпису даних, а також сервісу для роботи з КЕП, що використовує окрему криптобібліотеку від IIT на стороні Платформи для перевірки цілісності та незмінності даних, що передаються з вебклієнта.

Взаємодія користувачів з Платформою та розгорнутими на її базі реєстрами відбувається виключно через імплементовані вебінтерфейси -- додатки **Кабінет отримувача послуг** та **Кабінет посадової особи** -- із будь-якого визнаного індустрією браузера останньої версії.

Автентифікація з КЕП передбачає використання асиметричних алгоритмів шифрування, що забезпечують криптографічний захист даних користувачів.

Для отримання доступу до функцій Кабінету, користувач має увійти до системи, виконавши кроки, описані нижче в інструкції.

CAUTION: Автентифікація з КЕП доступна для користувачів Кабінетів посадової особи та отримувача послуг реєстру.


=== Передумови

Отримайте особистий ключ для підпису даних в одному з https://czo.gov.ua/ca-registry[акредитованих центрів сертифікації ключів (АЦСК)]. Відкритий ключ зберігатиметься на сервері постачальника, в той час, як секретний (закритий) ключ необхідно буде зберегти на одному із захищених носіїв, доступних для використання при вході до системи за допомогою КЕП (_див. крок 3 в підрозділі  xref:auth-process-pass[]_).

[#auth-process-pass]
=== Проходження автентифікації

NOTE: Процес автентифікації за допомогою КЕП є ідентичним як для посадових осіб, так і для отримувачів послуг реєстру.

Розглянемо процес проходження автентифікації на прикладі Кабінету отримувача послуг.

[#auth-step-1]
Крок 1 ::

* Відкрийте сторінку входу до [.underline]#Кабінету отримувача послуг# за адресою `http://citizen-portal-<назва-реєстру>-main.apps.envone.dev.registry.eua.gov.ua/`, якщо ви фізична, або юридична особа, або ФОП і хочете замовити послугу.

* Відкрийте сторінку входу до [.underline]#Кабінету посадової особи# за адресою `http://officer-portal-<назва-реєстру>-main.apps.envone.dev.registry.eua.gov.ua/officer/`, якщо ви посадова особа, що уповноважена надавати послуги.
+
CAUTION: Адреси сервісів, що наведені у тексті вище, є шаблонними. Підставте назву свого реєстру в URL сервісу. При виникненні будь-яких питань, зверніться до адміністратора.

[#auth-step-2]
Крок 2 ::

Натисніть kbd:[Увійти до кабінету].
+
image:user:cp-auth-1.png[]

[#iit-digital-sign-widget]
Крок 3 ::

. Оберіть тип послуг:

* [.underline]#Для громадян# -- якщо ви бажаєте увійти як фізична особа (параметр встановлюється за замовчуванням);
* Для бізнесу -- якщо ви бажаєте увійти як ФОП або юридична особа.

. Оберіть тип носія особистого ключа. +
Оберіть [.underline]#Файловий носій# (параметр встановлюється за замовчуванням).
+
image:user:cp-auth-2.png[]

. У полі `Кваліфікований надавач ел. довірчих послуг` оберіть один з акредитованих центрів сертифікації ключів (АЦСК), натиснувши на елемент випадного списку, або залиште значення `Визначити автоматично`, встановлене за замовчуванням.
+
image:user:cp-auth-3.png[]

. Оберіть особистий ключ:

* У полі `Особистий ключ` натисніть kbd:[Обрати].
* Знайдіть особистий ключ (наприклад `Key-6.dat`) та натисніть kbd:[Open] для підтвердження.
+
image:user:cp-auth-4.png[]

. У полі `Пароль захисту ключа` введіть пароль захисту ключа.
. Натисніть kbd:[Зчитати] для перевірки введених даних.
+
image:user:cp-auth-5.png[]

Крок 4 ::

. На формі _підпису даних_ натисніть kbd:[Увійти] для входу до Кабінету.
. (_Альтернативно_) Натисніть kbd:[Змінити ключ], якщо необхідно обрати інший ключ для входу.
+
image:user:cp-auth-6.png[]
+
[WARNING]
====
У разі використання невірного ключа, на кроці підпису даних сервер повертає помилку:

image:user:cp-auth-7-wrong-key.png[]
====
+
[WARNING]
====
У разі введення невірних ідентифікаційних даних (як-от пароль захисту ключа тощо), на кроці підпису даних сервер повертає таку помилку:

image:user:cp-auth-8-wrong-credentials.png[]
====

[NOTE]
====
Після успішного проходження автентифікації у Кабінеті отримувача послуг, під час першого входу, особі буде запропоновано пройти процес онбордингуfootnote:[[.underline]#Онбординг# -- реєстрація в системі для надання прав доступу до функцій Кабінету отримувача послуг.]. Після проходження цього процесу, особа отримає доступ до функцій Кабінету.
====

NOTE: У Кабінеті посадової особи процес онбордингу не передбачений. Тому перед входом до Кабінету необхідно переконатися, що адміністратор доступу створив відповідного користувача.

[#auth-id-gov-ua]
== Автентифікація з ID.GOV.UA

Платформа надає можливість здійснювати автентифікацію за вбудованого віджета `*id.gov.ua*` -- [.underline]#Інтегрованої системи електронної ідентифікації (ІСЕІ)#.

Автентифікація через зовнішнього провайдера можлива як [.underline]#для отримувачів послуг#, так і [.underline]#для посадових осіб (надавачів послуг)# реєстру.

ІСЕІ `*id.gov.ua*` має атестат відповідності комплексної системи захисту інформації (КСЗІ), тому персональні дані користувачів надійно захищені.

TIP: Для отримання деталей підключення та використання ID.GOV.UA, будь ласка, зверніться до https://id.gov.ua/downloads/IDInfoProcessingD.pdf[технічної документації] або https://id.gov.ua/[офіційного сайту].

[#auth-officers]
=== Автентифікація посадових осіб (надавачів послуг)

. Найперше, виконайте xref:#auth-step-1[крок 1] та xref:#auth-step-1[крок 2] у попередньому розділі цього документа.
. Натисніть на відповідний елемент для автентифікації з ID.GOV.UA:
+

image:user:cp-auth-idgovua-1.png[]

. Оберіть вхід за допомогою [.underline]#Електронного підпису#.
+
image:user-auth/user-auth-idgovua-4-02.png[]

. Оберіть метод автентифікації -- [.underline]#Файловий носій#.
+
[IMPORTANT]
====
Посадові особи можуть автентифікуватися лише через файловий носій.

TIP: Файловий носій – це спеціальний файл, який містить ваш особистий ключ.
Зазвичай цей файл має назву `*Key-6*` з розширенням `*.dat` (зустрічаються також розширення *.pfx, *.pk8, *.zs2, *.jks).
====
+
image:user-auth/user-auth-idgovua-1.png[]

. Завантажте із зовнішнього носія чи власного комп'ютера файл із вашим особистим ключем.
+
image:user-auth/user-auth-idgovua-2.png[]

. Вкажіть пароль доступу до особистого ключа у відповідному полі та натисніть kbd:[Продовжити].
+
image:user-auth/user-auth-idgovua-3.png[]

+
У разі успішного зчитування ключа та проходження автентифікації, посадова особа зможе увійти до Кабінету.

=== Автентифікація отримувачів послуг

. Увійдіть до Кабінету отримувача послуг (_див. xref:#auth-step-1[крок 1] та xref:#auth-step-1[крок 2] цього документа_).

. Оберіть опцію [.underline]#Для громадян#.
+
image:user:user-auth/user-auth-idgovua-4-01.png[]
+
[IMPORTANT]
====
Автентифікація з id.gov.ua можлива лише _ДЛЯ ГРОМАДЯН_. Якщо ви представник бізнесу, то зможете увійти до Кабінету лише з КЕП. +
Фізичним особам доступні обидві опції для автентифікації: КЕП та id.gov.ua.
====

. Автентифікуйтеся через віджет `*ID.GOV.UA*`.
+
image:user:user-auth/user-auth-idgovua-4-1.png[]

. Оберіть бажану схему (спосіб) автентифікації.
+
[NOTE]
====
Отримувачі послуг реєстру можуть використовувати такі способи автентифікації з `id.gov.ua`:

* Електронний підпис
* Bank ID НБУ
* Дія.Підпис
====
+
image:user:user-auth/user-auth-idgovua-4.png[]

. Дотримуйтеся інструкцій, описаних у підрозділах нижче.
+
NOTE: Уся обробка даних відбувається на стороні `id.gov.ua`. Детальніше про кожен тип автентифікації ви можете дізнатися на https://id.gov.ua/verify[офіційному сайті].

==== Автентифікація з електронним підписом

Електронний підпис є аналогом власноручного підпису та забезпечує правдивість і цілісність інформації, викладеної у документі, а також дає змогу підтвердити цілісність електронного документа та ідентифікувати особу, яка підписала документ.

. Увійдіть за допомогою електронного підпису.
. Оберіть тип ключа, яким ви хочете підписати дані:

* Файловий носій
* Токен
* Хмарне сховище
* ID-картка

image:user:user-auth/user-auth-idgovua-5.png[]

[#auth-bank-id]
==== Автентифікація з BankID НБУ

Сервіс надається Національним банком України та можливий лише для клієнтів тих банків, які його підтримують.

Після обрання свого банку ви будете переадресовані на його сайт для проходження автентифікації з використанням логіну, пароля, номера картки.

image:user:user-auth/user-auth-idgovua-6.png[]

У разі успішної автентифікації на сайті банку, система Bank ID передасть ваші персональні дані, що дозволить вас ідентифікувати.

image:user:user-auth/user-auth-idgovua-7.png[]

[#auth-dia-signature]
==== Автентифікація з Дія.Підпис

**Дія ID** -- послуга електронної ідентифікації для користувачів, які отримували особистий ключ віддалено за допомогою мобільного застосунку Дія. Дія.Підпис містить дві частини. Одна частина зберігається у вашому смартфоні, а інша — в спеціальному захищеному модулі порталу Дія.

Отримати особистий ключ віддалено за допомогою мобільного застосунку Дія мають можливість громадяни України, які є власниками ID-картки або біометричного закордонного паспорта.

Щоб авторизуватися на сайті за допомогою Дія ID, вам необхідно:

1. Відсканувати QR-код.

2. Зчитати особистий ключ шляхом сканування обличчя (перевірки за фото) та вводу пароля до особистого ключа.

3. У разі успішної автентифікації у мобільному застосунку Дія, система передає ваші персональні дані, що дозволить вас ідентифікувати.
+
image:user:user-auth/user-auth-idgovua-8.png[]